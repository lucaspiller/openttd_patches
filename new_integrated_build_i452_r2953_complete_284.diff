Index: station_cmd.c
===================================================================
--- station_cmd.c	(Revision 2953)
+++ station_cmd.c	(Arbeitskopie)
@@ -9,23 +9,24 @@
 #include "functions.h"
 #include "table/sprites.h"
 #include "table/strings.h"
-#include "map.h"
-#include "tile.h"
+//#include "map.h"
+//#include "tile.h"
 #include "station.h"
 #include "gfx.h"
 #include "window.h"
 #include "viewport.h"
 #include "command.h"
 #include "town.h"
-#include "vehicle.h"
+//#include "vehicle.h"
 #include "news.h"
 #include "saveload.h"
 #include "economy.h"
-#include "player.h"
+//#include "player.h"
 #include "airport.h"
-#include "sprite.h"
+//#include "sprite.h"
 #include "depot.h"
 #include "pbs.h"
+#include "network.h"
 
 enum {
 	/* Max stations: 64000 (64 * 1000) */
@@ -430,7 +431,7 @@
 	Station* st;
 
 	FOR_ALL_STATIONS(st) {
-		if (st->xy != 0 && (owner == OWNER_SPECTATOR || st->owner == owner)) {
+		if (st->xy != 0 && (owner == OWNER_SPECTATOR || IsSisterCompany(st->owner, owner) || _patches.shared_stations)) {
 			uint cur_dist = DistanceManhattan(tile, st->xy);
 
 			if (cur_dist < threshold) {
@@ -451,8 +452,8 @@
 	st->airport_tile = st->dock_tile = st->train_tile = 0;
 	st->bus_stops = st->truck_stops = NULL;
 	st->had_vehicle_of_type = 0;
-	st->time_since_load = 255;
-	st->time_since_unload = 255;
+	st->time_since_load = INVALID_TIME;
+	st->time_since_unload = INVALID_TIME;
 	st->delete_ctr = 0;
 	st->facilities = 0;
 
@@ -462,11 +463,14 @@
 		ge->waiting_acceptance = 0;
 		ge->days_since_pickup = 0;
 		ge->enroute_from = INVALID_STATION;
-		ge->rating = 175;
+		ge->rating = RATING_START_VALUE;
 		ge->last_speed = 0;
-		ge->last_age = 0xFF;
+		ge->last_age = INVALID_AGE;
 		ge->feeder_profit = 0;
+		ge->last_vehicle_speed = 0;
+		ge->last_vehicle_type = INVALID_VEHICLE;
 	}
+	InitializeStationStats(st);
 
 	_global_station_sort_dirty = true; // build a new station
 }
@@ -542,10 +546,10 @@
 
 	// expand the region by rad tiles on each side
 	// while making sure that we remain inside the board.
-	x2 = min(x + w + rad, MapSizeX());
+	x2 = min((uint)(x + w + rad), MapSizeX());
 	x1 = max(x - rad, 0);
 
-	y2 = min(y + h + rad, MapSizeY());
+	y2 = min((uint)(y + h + rad), MapSizeY());
 	y1 = max(y - rad, 0);
 
 	assert(x1 < x2);
@@ -591,8 +595,8 @@
 
 	// expand the region by rad tiles on each side
 	// while making sure that we remain inside the board.
-	x2 = min(x + w + rad, MapSizeX());
-	y2 = min(y + h + rad, MapSizeY());
+	x2 = min((uint)(x + w + rad), MapSizeX());
+	y2 = min((uint)(y + h + rad), MapSizeY());
 	x1 = max(x - rad, 0);
 	y1 = max(y - rad, 0);
 
@@ -956,6 +960,7 @@
 	int plat_len, numtracks;
 	int direction;
 	uint finalvalues[3];
+	bool extending = false;
 
 	SET_EXPENSES_TYPE(EXPENSES_CONSTRUCTION);
 
@@ -1004,15 +1009,18 @@
 
 	if (st != NULL) {
 		// Reuse an existing station.
-		if (st->owner != OWNER_NONE && st->owner != _current_player)
+		if (st->owner != OWNER_NONE && !IsSisterCompany(st->owner,_current_player))
 			return_cmd_error(STR_3009_TOO_CLOSE_TO_ANOTHER_STATION);
 
 		if (st->train_tile != 0) {
 			// check if we want to expanding an already existing station?
 			if (_is_old_ai_player || !_patches.join_stations)
 				return_cmd_error(STR_3005_TOO_CLOSE_TO_ANOTHER_RAILROAD);
+
 			if (!CanExpandRailroadStation(st, finalvalues, direction))
 				return CMD_ERROR;
+			else
+				extending = true;
 		}
 
 		//XXX can't we pack this in the "else" part of the if above?
@@ -1050,7 +1058,8 @@
 		st->train_tile = finalvalues[0];
 		if (!st->facilities) st->xy = finalvalues[0];
 		st->facilities |= FACIL_TRAIN;
-		st->owner = _current_player;
+		if(!_patches.subsidiaries || (_patches.subsidiaries && st->facilities == FACIL_TRAIN && !extending))
+			st->owner = _current_player;
 
 		st->trainst_w = finalvalues[1];
 		st->trainst_h = finalvalues[2];
@@ -1168,7 +1177,7 @@
 	// make sure the specified tile belongs to the current player, and that it is a railroad station.
 	if (!IsTileType(tile, MP_STATION) || _m[tile].m5 >= 8 || !_patches.nonuniform_stations) return CMD_ERROR;
 	st = GetStation(_m[tile].m2);
-	if (_current_player != OWNER_WATER && (!CheckOwnership(st->owner) || !EnsureNoVehicle(tile))) return CMD_ERROR;
+	if (_current_player != OWNER_WATER && (!(CheckOwnership(st->owner) && GetPlayer(st->owner)->is_active) || !EnsureNoVehicle(tile))) return CMD_ERROR;
 
 	// if we reached here, it means we can actually delete it. do that.
 	if (flags & DC_EXEC) {
@@ -1384,7 +1393,7 @@
 		return DoCommandByTile(tile, 0, 0, DC_EXEC, CMD_REMOVE_FROM_RAILROAD_STATION);
 
 	/* Current player owns the station? */
-	if (_current_player != OWNER_WATER && !CheckOwnership(st->owner))
+	if (_current_player != OWNER_WATER && !CheckOwnership(st->owner) && GetPlayer(st->owner)->is_active)
 		return CMD_ERROR;
 
 	/* determine width and height of platforms */
@@ -1514,7 +1523,7 @@
 		return_cmd_error( (type) ? STR_3008B_TOO_MANY_TRUCK_STOPS : STR_3008A_TOO_MANY_BUS_STOPS);
 
 	if (st != NULL) {
-		if (st->owner != OWNER_NONE && st->owner != _current_player)
+		if (st->owner != OWNER_NONE && !IsSisterCompany(st->owner, _current_player))
 			return_cmd_error(STR_3009_TOO_CLOSE_TO_ANOTHER_STATION);
 
 		if (!CheckStationSpreadOut(st, tile, 1, 1))
@@ -1554,9 +1563,10 @@
 		InitializeRoadStop(road_stop, prev, tile, st->index);
 		(*currstop)->type = type;
 		if (!st->facilities) st->xy = tile;
+		if(!_patches.subsidiaries || (_patches.subsidiaries && !st->facilities)){
+			st->owner = _current_player;
+		}
 		st->facilities |= (type) ? FACIL_TRUCK_STOP : FACIL_BUS_STOP;
-		st->owner = _current_player;
-
 		st->build_date = _date;
 
 		ModifyTile(tile,
@@ -1582,7 +1592,7 @@
 	RoadStop *cur_stop;
 	bool is_truck = _m[tile].m5 < 0x47;
 
-	if (_current_player != OWNER_WATER && !CheckOwnership(st->owner))
+	if (_current_player != OWNER_WATER && !CheckOwnership(st->owner) && GetPlayer(st->owner)->is_active)
 		return CMD_ERROR;
 
 	if (is_truck) {	//truck stop
@@ -1746,7 +1756,7 @@
 	}
 
 	if (st != NULL) {
-		if (st->owner != OWNER_NONE && st->owner != _current_player)
+		if (st->owner != OWNER_NONE && !IsSisterCompany(st->owner,_current_player))
 			return_cmd_error(STR_3009_TOO_CLOSE_TO_ANOTHER_STATION);
 
 		if (!CheckStationSpreadOut(st, tile, 1, 1))
@@ -1780,8 +1790,9 @@
 
 	if (flags & DC_EXEC) {
 		const AirportFTAClass *afc = GetAirport(p1);
-
-		st->owner = _current_player;
+		if(!st->facilities){
+			st->owner = _current_player;
+		}
 		if (IsLocalPlayer() && afc->nof_depots != 0)
 			_last_built_aircraft_depot_tile = tile + ToTileIndexDiff(afc->airport_depots[0]);
 
@@ -1825,7 +1836,7 @@
 	int w,h;
 	int32 cost;
 
-	if (_current_player != OWNER_WATER && !CheckOwnership(st->owner))
+	if (_current_player != OWNER_WATER && !CheckOwnership(st->owner) && GetPlayer(st->owner)->is_active)
 		return CMD_ERROR;
 
 	tile = st->airport_tile;
@@ -2037,7 +2048,7 @@
 	}
 
 	if (st != NULL) {
-		if (st->owner != OWNER_NONE && st->owner != _current_player)
+		if (st->owner != OWNER_NONE && !IsSisterCompany(st->owner, _current_player))
 			return_cmd_error(STR_3009_TOO_CLOSE_TO_ANOTHER_STATION);
 
 		if (!CheckStationSpreadOut(st, tile, 1, 1)) return CMD_ERROR;
@@ -2066,7 +2077,8 @@
 		st->dock_tile = tile;
 		if (!st->facilities) st->xy = tile;
 		st->facilities |= FACIL_DOCK;
-		st->owner = _current_player;
+		if(!_patches.subsidiaries || (_patches.subsidiaries && st->facilities == FACIL_DOCK))
+			st->owner = _current_player;
 
 		st->build_date = _date;
 
@@ -2096,7 +2108,7 @@
 	TileIndex tile1;
 	TileIndex tile2;
 
-	if (!CheckOwnership(st->owner))
+	if (!CheckOwnership(st->owner) && GetPlayer(st->owner)->is_active)
 		return CMD_ERROR;
 
 	tile1 = st->dock_tile;
@@ -2548,41 +2560,164 @@
 static void UpdateStationRating(Station *st)
 {
 	GoodsEntry *ge;
-	int rating;
+	RatingStats *rs;
 	StationID index;
-	int waiting;
+	int rating=0, waiting, lv_type=0, speed, old_rating=0, points=0, point_clamp;
 	bool waiting_changed = false;
+	byte age, days;
 
 	byte_inc_sat(&st->time_since_load);
 	byte_inc_sat(&st->time_since_unload);
 
 	ge = st->goods;
+	rs = st->rating_stats;
+
 	do {
 		if (ge->enroute_from != INVALID_STATION) {
-			byte_inc_sat(&ge->enroute_time);
-			byte_inc_sat(&ge->days_since_pickup);
-
 			rating = 0;
+			old_rating = 0;
+			points = 0;
+			lv_type = ge->last_vehicle_type;
+			if (lv_type == INVALID_VEHICLE && st->last_vehicle != INVALID_VEHICLE)
+				lv_type = GetVehicle(st->last_vehicle)->type;
+				else
+					lv_type = INVALID_VEHICLE;
+			}
 
+			speed = ge->last_speed;
+			if (_patches.nsr_speed)
 			{
-				int b = ge->last_speed;
-				if ((b-=85) >= 0)
-					rating += b >> 2;
+				points = ge->last_vehicle_speed;
+				if (points == 0)
+					points = speed;
+				rs->last_speed = points;
+				switch (lv_type)
+				{
+					case VEH_Train:
+						if (points <= RP_T_SPEED_CAP) // "normal" trains
+							points += (ge == &st->goods[CT_PASSENGERS]) ? RP_T_SPEED_PASS_BONUS : RP_T_SPEED_CARGO_BONUS;
+						else // monorail + maglev, currently too few trains to be worth more distinction
+							points /= RP_SPEED_MULT;
+						break;
+					case VEH_Road:
+						points *= 3 / 2;
+						points += (ge == &st->goods[CT_PASSENGERS]) ? RP_R_SPEED_PASS_BONUS : RP_R_SPEED_CARGO_BONUS;
+						break;
+					case VEH_Ship:
+						rs->last_speed = points / 2;
+						if (ge != &st->goods[CT_PASSENGERS])
+							points *= RP_SPEED_MULT;
+						break;
+					case VEH_Aircraft:
+						rs->last_speed = (points * 64) / 5; // * 8 * 16 / 10
+						if (ge != &st->goods[CT_PASSENGERS])
+							points *= RP_SPEED_MULT;
+						break;
+					default:	
+						points = 0;
+				}
+				// max 170 >> 2 = 42 points for speedrating
+				rating += clamp(points, 0, RP_MAX_SPEED_POINTS) >> 2;
 			}
+			else
+			{
+				if ((speed -= 85) >= 0)
+					rating += speed >> 2;
+				rs->last_speed = ge->last_speed;
+			}
+			rs->ratings[RATING_SPEED] = rating - old_rating;
+			old_rating = rating;
 
+			age = ge->last_age;
+			if (_patches.nsr_age)
 			{
-				byte age = ge->last_age;
+				if (ge == &st->goods[CT_PASSENGERS]) {
+					switch (lv_type)	// scale age to RP_MAX_AGE years
+					{
+						case VEH_Train:		point_clamp = RP_AGE_T_CLAMP;	break;
+						case VEH_Road:			point_clamp = RP_AGE_R_CLAMP;	break;
+						case VEH_Ship:			point_clamp = RP_AGE_S_CLAMP;	break;
+						case VEH_Aircraft:	point_clamp = RP_AGE_A_CLAMP;	break;
+						default:					point_clamp = RP_MAX_AGE;
+					}
+					points = clamp(points, 0, point_clamp) * RP_MAX_AGE / point_clamp;
+					switch (age) // give bonus to rating for low age
+					{ // uses real age, not scaled age
+						case 0:	rating += RP_AGE_BONUS_0;	break;
+						case 1:	rating += RP_AGE_BONUS_1;	break;
+						case 2:	rating += RP_AGE_BONUS_2;	break;
+						case 3:	rating += RP_AGE_BONUS_3;	break;
+						case 4:	rating += RP_AGE_BONUS_4;	break;
+						case 5:	rating += RP_AGE_BONUS_5;	break;
+					}
+				} else { // non passengers dont care for vehicle-age
+					rating += RP_AGE_BONUS_0;
+					points = 0;
+				}
+				rating += (RP_MAX_AGE_POINTS - points);
+			}
+			else
+			{
 				(age >= 3) ||
 				(rating += 10, age >= 2) ||
 				(rating += 10, age >= 1) ||
 				(rating += 13, true);
 			}
+			rs->last_age = age;
+			rs->ratings[RATING_AGE] = rating - old_rating;
+			old_rating = rating;
 
-			if (st->owner < MAX_PLAYERS && HASBIT(st->town->statues, st->owner))
-				rating += 26;
+			if (_patches.nsr_town_rating)
+			{
+				if (st->owner < MAX_PLAYERS)
+				{
+					if (HASBIT(st->town->statues, st->owner))	rating += RP_OTHER_STATUE;
+					// if townratings are not changed this will be within -20..+20
+					rating += (st->town->ratings[st->owner] / RP_OTHER_LA_MULT);
+				} else {
+					if (st->owner == OWNER_NONE)
+						rating += 26; // oilrigs dont have owner... for now give maxpoints till i know what i want to do here ;)
+				}
+			}
+			else
+			{
+				if (st->owner < MAX_PLAYERS && HASBIT(st->town->statues, st->owner))
+					rating += 26;
+			}
+			rs->ratings[RATING_OTHER] = rating - old_rating;
+			old_rating = rating;
 
+			days = ge->days_since_pickup;
+			if (_patches.nsr_wait_days)
 			{
-				byte days = ge->days_since_pickup;
+				if (ge == &st->goods[CT_PASSENGERS])
+					points = days * 2; // double wait effect for Passengers
+				else
+					points = days;
+				switch (lv_type)	// scale waitdays to RP_MAX_DAYS days
+				{
+					case VEH_Train:		point_clamp = RP_DAYS_T_CLAMP;	break;
+					case VEH_Road:			point_clamp = RP_DAYS_R_CLAMP;	break;
+					case VEH_Ship:			point_clamp = RP_DAYS_S_CLAMP;	break;
+					case VEH_Aircraft:	point_clamp = RP_DAYS_A_CLAMP;	break;
+					default:					point_clamp = RP_MAX_DAYS;
+				}
+				points = clamp(points, 0, point_clamp) * RP_MAX_DAYS / point_clamp;
+				rating += (RP_MAX_DAYS_POINTS - points * RP_MAX_DAYS_POINTS / RP_MAX_DAYS);
+				switch (days) // give bonus for short wait-time
+				{ // uses real days, not scaled days
+					case 0:	rating += RP_DAYS_BONUS_0;	break;
+					case 1:	rating += RP_DAYS_BONUS_1;	break;
+					case 2:	rating += RP_DAYS_BONUS_2;	break;
+					case 3:	rating += RP_DAYS_BONUS_3;	break;
+					case 4:	rating += RP_DAYS_BONUS_4;	break;
+					case 5:	rating += RP_DAYS_BONUS_5;	break;
+					case 6:	rating += RP_DAYS_BONUS_6;	break;
+					case 7:	rating += RP_DAYS_BONUS_7;	break;
+				}
+			}
+			else
+			{
 				if (st->last_vehicle != INVALID_VEHICLE &&
 						GetVehicle(st->last_vehicle)->type == VEH_Ship)
 							days >>= 2;
@@ -2592,9 +2727,42 @@
 				(rating += 45, days > 3) ||
 				(rating += 35, true);
 			}
+			rs->days_since_pickup = ge->days_since_pickup;
+			rs->ratings[RATING_PICKUP] = rating - old_rating;
+			old_rating = rating;
 
+			byte_inc_sat(&ge->enroute_time);
+			byte_inc_sat(&ge->days_since_pickup);
+
+			waiting = ge->waiting_acceptance & MAX_CARGO_WAITING;
+			if (_patches.nsr_wait_cargo)
 			{
-				waiting = ge->waiting_acceptance & 0xFFF;
+				if (ge == &st->goods[CT_PASSENGERS])
+					points = waiting * 2;
+				else
+					points = waiting;
+				switch (lv_type) // scale points to RP_MAX_WAIT
+				{
+					case VEH_Train:		point_clamp = RP_WAIT_T_CLAMP;		break;
+					case VEH_Road:			point_clamp = RP_WAIT_R_CLAMP;		break;
+					case VEH_Ship:			point_clamp = RP_WAIT_S_CLAMP;		break;
+					case VEH_Aircraft:	point_clamp = RP_WAIT_A_CLAMP;		break;
+					default:					point_clamp = RP_MAX_WAIT;
+				}
+				points = clamp(points, 0, point_clamp) * RP_MAX_WAIT / point_clamp;
+				rating += RP_MAX_WAIT_POINTS - points;
+				switch (points) // give bonus for low waiting cargo
+				{ // uses scaled waiting
+					case 0: rating += RP_WAIT_BONUS_0;	break;
+					case 1: rating += RP_WAIT_BONUS_1;	break;
+					case 2: rating += RP_WAIT_BONUS_2;	break;
+					case 3: rating += RP_WAIT_BONUS_3;	break;
+					case 4: rating += RP_WAIT_BONUS_4;	break;
+					case 5: rating += RP_WAIT_BONUS_5;	break;
+				}
+			}
+			else
+			{
 				(rating -= 90, waiting > 1500) ||
 				(rating += 55, waiting > 1000) ||
 				(rating += 35, waiting > 600) ||
@@ -2602,9 +2770,13 @@
 				(rating += 20, waiting > 100) ||
 				(rating += 10, true);
 			}
+			rs->waiting = waiting;
+			rs->ratings[RATING_WAITING] = rating - old_rating;
+			old_rating = rating;
 
 			{
 				int or = ge->rating; // old rating
+				rs->ratings[RATING_TOTAL] = rating;
 
 				// only modify rating in steps of -2, -1, 0, 1 or 2
 				ge->rating = rating = or + clamp(clamp(rating, 0, 255) - or, -2, 2);
@@ -2627,9 +2799,10 @@
 				}
 
 				if (waiting_changed)
-					ge->waiting_acceptance = (ge->waiting_acceptance & ~0xFFF) + waiting;
+					ge->waiting_acceptance = (ge->waiting_acceptance & ~MAX_CARGO_WAITING) + waiting;
 			}
-		}
+		//}
+		rs++;
 	} while (++ge != endof(st->goods));
 
 	index = st->index;
@@ -2638,6 +2811,8 @@
 		InvalidateWindow(WC_STATION_VIEW, index);
 	else
 		InvalidateWindowWidget(WC_STATION_VIEW, index, 5);
+
+	InvalidateWindow(WC_STATION_RATING_DETAIL, index);
 }
 
 /* called for every station each tick */
@@ -2679,12 +2854,55 @@
 
 }
 
+uint32 CalcNewAverage(uint32 average, uint32 lastamount, uint16 times_counted)
+{
+	times_counted -= 1; // number of calculated averages till now is one less than actually counted times
+	if (times_counted == 0)
+		return lastamount;
+	average = (uint32)((uint64)(((uint64)average * (uint64)times_counted + (uint64)lastamount) / ((uint64)times_counted + 1)));
+	return average;
+}
+
 void StationMonthlyLoop(void)
 {
+	Station *st;
+	StationStats *sts;
+	GoodsEntry *ge;
+
+ 	FOR_ALL_STATIONS(st) {
+		if (st->months_counted != STS_NO_MONTHS_COUNTED)
+		{
+			for (ge = st->goods; ge != endof(st->goods); ge++) {
+				if (ge->months_counted != STS_NO_MONTHS_COUNTED) 
+				{
+					// set current months stats to 0 after storing value for last month
+					// do this for all stats (currently In/Out/Transfer)
+					// also determine new min/max-values
+					for (sts = ge->cargo_amount; sts != endof(ge->cargo_amount); sts++) {
+						sts->month_min = min(sts->month_min, sts->this_month);
+						sts->month_max = max(sts->month_max, sts->this_month);
+						sts->average = CalcNewAverage(sts->average, sts->this_month * AVERAGE_MULTIPLIER, ge->months_counted);
+						sts->last_month = sts->this_month;
+						sts->this_month = 0;
+					}
+					ge->months_counted++; // one more month counted
+				}
+			}
+			// update vehicle-counts and min/max
+			for (sts = st->vehicles; sts != endof(st->vehicles); sts++) {
+				sts->month_min = min(sts->month_min, sts->this_month);
+				sts->month_max = max(sts->month_max, sts->this_month);
+				sts->average = CalcNewAverage(sts->average, sts->this_month * AVERAGE_MULTIPLIER, st->months_counted);
+				sts->last_month = sts->this_month;
+				sts->this_month = 0;
+			}
+			st->months_counted++; // one more month counted
+		}
+		InvalidateWindow(WC_STATION_STATS, st->index);
+	}
 }
 
-
-void ModifyStationRatingAround(TileIndex tile, byte owner, int amount, uint radius)
+void ModifyStationRatingAround(TileIndex tile, PlayerID owner, int amount, uint radius)
 {
 	Station *st;
 	GoodsEntry *ge;
@@ -2712,6 +2930,7 @@
 	st->goods[type].enroute_time = 0;
 	st->goods[type].enroute_from = st->index;
 	InvalidateWindow(WC_STATION_VIEW, st->index);
+	InvalidateWindow(WC_STATION_STATS, st->index);
 }
 
 /** Rename a station
@@ -2918,20 +3137,20 @@
 	st->dock_tile = tile;
 	st->train_tile = 0;
 	st->had_vehicle_of_type = 0;
-	st->time_since_load = 255;
-	st->time_since_unload = 255;
+	st->time_since_load = INVALID_TIME;
+	st->time_since_unload = INVALID_TIME;
 	st->delete_ctr = 0;
 	st->last_vehicle = INVALID_VEHICLE;
 	st->facilities = FACIL_AIRPORT | FACIL_DOCK;
 	st->build_date = _date;
-
-	for (j = 0; j != NUM_CARGO; j++) {
+	for(j=0; j!=NUM_CARGO; j++) 
+	{
 		st->goods[j].waiting_acceptance = 0;
 		st->goods[j].days_since_pickup = 0;
 		st->goods[j].enroute_from = INVALID_STATION;
-		st->goods[j].rating = 175;
+		st->goods[j].rating = RATING_START_VALUE;
 		st->goods[j].last_speed = 0;
-		st->goods[j].last_age = 255;
+		st->goods[j].last_age = INVALID_AGE;
 	}
 
 	UpdateStationVirtCoordDirty(st);
@@ -3099,17 +3318,29 @@
 
 	SLE_CONDVAR(Station,class_id,				SLE_UINT8, 3, 255),
 	SLE_CONDVAR(Station,stat_id,				SLE_UINT8, 3, 255),
-	SLE_CONDVAR(Station,build_date,			SLE_UINT16, 3, 255),
+	SLE_CONDVAR(Station,build_date,			SLE_FILE_U16 | SLE_VAR_U32, 3, 15),
+	SLE_CONDVAR(Station,build_date,			SLE_UINT32, 16, 255),
 
 	SLE_CONDREF(Station,bus_stops,					REF_ROADSTOPS, 6, 255),
 	SLE_CONDREF(Station,truck_stops,				REF_ROADSTOPS, 6, 255),
 
+	// station stats data
+//	SLE_CONDVAR(Station,months_counted,	SLE_UINT16, xx, 255),
+
 	// reserve extra space in savegame here. (currently 28 bytes)
 	SLE_CONDARR(NullStruct,null,SLE_FILE_U8 | SLE_VAR_NULL, 32, 2, 255),
 
 	SLE_END()
 };
 
+// station stats data
+//	SLE_CONDVAR(StationStats,this_month,	SLE_UINT16, xx, 255),
+//	SLE_CONDVAR(StationStats,month_min,	SLE_UINT16, xx, 255),
+//	SLE_CONDVAR(StationStats,month_max,	SLE_UINT16, xx, 255),
+//	SLE_CONDVAR(StationStats,average,	SLE_UINT32, xx, 255),
+//	SLE_END()
+//};
+
 static const SaveLoad _goods_desc[] = {
 	SLE_VAR(GoodsEntry,waiting_acceptance,SLE_UINT16),
 	SLE_VAR(GoodsEntry,days_since_pickup,	SLE_UINT8),
@@ -3121,22 +3352,33 @@
 	SLE_VAR(GoodsEntry,last_age,					SLE_UINT8),
 	SLE_CONDVAR(GoodsEntry,feeder_profit,			SLE_INT32, 14, 255),
 
+	// station stats data
+//	SLE_CONDVAR(GoodsEntry,months_counted,	SLE_UINT16, xx, 255),
+
 	SLE_END()
 };
 
 
 static void SaveLoad_STNS(Station *st)
 {
-	int i;
+	int i; //, j;
 
 	SlObject(st, _station_desc);
 	for (i = 0; i != NUM_CARGO; i++) {
 		SlObject(&st->goods[i], _goods_desc);
+//		for (j = 0; j < STS_AMNT_TYPES; j++)
+//			SlObject(&st->goods[i].cargo_amount[j], _stats_desc);
 
+		// initialize new station rating values
+		st->goods[i].last_vehicle_speed = st->goods[i].last_speed;
+		st->goods[i].last_vehicle_type = INVALID_VEHICLE;
+
 		/* In older versions, enroute_from had 0xFF as INVALID_STATION, is now 0xFFFF */
 		if (_sl_full_version < 0x700 && st->goods[i].enroute_from == 0xFF)
 			st->goods[i].enroute_from = 0xFFFF;
 	}
+//	for (i = 0; i < STS_VEH_TYPES; i++) 
+//		SlObject(&st->vehicles[i], _stats_desc);
 }
 
 static void Save_STNS(void)
@@ -3144,7 +3386,7 @@
 	Station *st;
 	// Write the stations
 	FOR_ALL_STATIONS(st) {
-		if (st->xy != 0) {
+		if ( (st->xy != INVALID_TILE) && (st->xy != 0) ) {
 			SlSetArrayIndex(st->index);
 			SlAutolength((AutolengthProc*)SaveLoad_STNS, st);
 		}
@@ -3162,6 +3404,7 @@
 
 		st = GetStation(index);
 		SaveLoad_STNS(st);
+		InitializeStationStats(st);
 
 		// this means it's an oldstyle savegame without support for nonuniform stations
 		if (st->train_tile && st->trainst_h == 0) {
@@ -3228,3 +3471,108 @@
 	{ 'ROAD', Save_ROADSTOP,  Load_ROADSTOP,  CH_ARRAY | CH_LAST},
 };
 
+void SearchVehiclesForStation(Station *st)
+{
+	Vehicle *v;
+	int i;
+	Order* ord;
+	
+	ord = NULL;
+	if (st->xy == INVALID_TILE || st->xy == 0) return;
+	for(i = 0; i < STS_VEH_TYPES; i++) st->veh_scheduled[i] = 0;
+	
+	FOR_ALL_VEHICLES(v) {
+		//Now run this stuff for sane vehicles only
+		if ( (v->num_orders != 0) && (
+			( (v->type == VEH_Train) && (v->subtype == TS_Front_Engine) ) ||       //Trains (first engine, that contains the orders)
+			( (v->type == VEH_Road) && (v->subtype == SUBTYPE_NONE) ) ||       //Road vehicles (subtype should always be 0 anyway)
+			( (v->type == VEH_Ship) && (v->subtype == SUBTYPE_NONE) ) ||       //Ships, subtype should be 0 anyway)
+			( (v->type == VEH_Aircraft) && (
+				(v->subtype == SUBTYPE_NONE) ||                            //Choppers
+				(v->subtype == SUBTYPE_AIRCRAFT) ) ) ) &&                               //Fixed-wing stuff
+			( (v->owner == st->owner) || (v->owner == _local_player) ) )	// station owner or current player for oilrigs
+		{
+			ord = v->orders;
+			while(ord != NULL) {
+				if (ord->station == st->index && ord->type == OT_GOTO_STATION) {
+					switch (v->type) {
+						case VEH_Train:
+							st->veh_scheduled[STS_VEH_TRAIN]++;
+							break;
+						case VEH_Road:
+							st->veh_scheduled[STS_VEH_ROAD]++;
+							if (v->cargo_type == CT_PASSENGERS)
+								st->veh_scheduled[STS_VEH_BUS]++;
+							else
+								st->veh_scheduled[STS_VEH_TRUCK]++;
+							break;
+						case VEH_Ship:
+							st->veh_scheduled[STS_VEH_SHIP]++;
+							break;
+						case VEH_Aircraft:
+							st->veh_scheduled[STS_VEH_AIRCRAFT]++;
+							break;
+						default:
+							NOT_REACHED();
+					}
+					break;
+				}
+				ord = ord->next;
+			}
+		}
+	}
+}
+
+int32 CmdResetStationCheat(int NOT_USED_x, int NOT_USED_y, uint32 NOT_USED_flags, uint32 station, uint32 NOT_USED_p2)
+{
+	Station *st = GetStation(station);
+	GoodsEntry *ge;
+#ifndef _DEBUG
+	if (_networking) return CMD_ERROR;
+#endif
+
+	// Reset all goods at station
+	for(ge = st->goods; ge != endof(st->goods); ge++) {
+		ge->last_speed = 0;
+		ge->waiting_acceptance = 0;
+		ge->days_since_pickup = 0;
+		ge->enroute_from = INVALID_STATION;
+		ge->enroute_time = 0;
+		ge->rating = RATING_START_VALUE;
+		ge->last_age = INVALID_AGE;
+		ge->feeder_profit = 0;
+	}
+	st->had_vehicle_of_type = 0;
+	st->time_since_load = INVALID_TIME;
+	st->time_since_unload = INVALID_TIME;
+	st->last_vehicle = INVALID_VEHICLE;
+
+	UpdateStationAcceptance(st, false);
+	return 0;
+}
+
+void InitializeStationStats(Station *st)
+{
+	StationStats *sts;
+	GoodsEntry *ge;
+
+	for (ge = st->goods; ge != endof(st->goods); ge++) {
+		ge->months_counted = STS_NO_MONTHS_COUNTED;
+		for (sts = ge->cargo_amount; sts != endof(ge->cargo_amount); sts++) {
+			sts->average = 0;
+			sts->last_month = 0;
+			sts->month_max = 0;
+			sts->month_min = STS_INIT_MINIMUM;
+			sts->this_month = 0;
+		}
+	}
+	st->months_counted = STS_NO_MONTHS_COUNTED;
+	for (sts = st->vehicles; sts != endof(st->vehicles); sts++) {
+		sts->last_month = 0;
+		sts->this_month = 0;
+		sts->month_min = STS_INIT_MINIMUM;
+		sts->month_max = 0;
+		sts->average = 0;
+	}
+	SearchVehiclesForStation(st);
+}
Index: graph_gui.c
===================================================================
--- graph_gui.c	(Revision 2953)
+++ graph_gui.c	(Arbeitskopie)
@@ -29,7 +29,7 @@
 	byte num_dataset;
 	byte num_on_x_axis;
 	byte month;
-	byte year;
+	uint32 year;
 	bool include_neg;
 	byte num_vert_lines;
 	uint16 unk61A;
@@ -294,7 +294,8 @@
 	Player *p;
 	uint excludebits = _legend_excludebits;
 	int nums;
-	int mo,yr;
+	int mo;
+	uint32 yr;
 
 	// Exclude the players which aren't valid
 	FOR_ALL_PLAYERS(p) {
Index: engine.c
===================================================================
--- engine.c	(Revision 2953)
+++ engine.c	(Arbeitskopie)
@@ -128,11 +128,10 @@
 
 static void AdjustAvailAircraft(void)
 {
-	uint16 date = _date;
 	byte avail = 0;
-	if (date >= 12784) avail |= 2; // big airport
-	if (date < 14610 || _patches.always_small_airport) avail |= 1;  // small airport
-	if (date >= 15706) avail |= 4; // enable heliport
+	if (_cur_year >= 1955) avail |= 2; // big airport
+	if (_cur_year < 1960 || _patches.always_small_airport) avail |= 1;  // small airport
+	if (_cur_year >= 1963) avail |= 4; // enable heliport
 
 	if (avail != _avail_aircraft) {
 		_avail_aircraft = avail;
@@ -188,7 +187,7 @@
 		e->player_avail = 0;
 
 		r = Random();
-		e->intro_date = GB(r, 0, 9) + ei->base_intro;
+		e->intro_date = (uint32)((r & 0x1FF) + ei->base_intro);
 		if (e->intro_date <= _date) {
 			e->age = (_date - e->intro_date) >> 5;
 			e->player_avail = (byte)-1;
@@ -782,7 +781,7 @@
 {
 	uint i;
 
-	if (_cur_year >= 130) return;
+	if (_cur_year >= 2050) return;
 
 	for (i = 0; i != lengthof(_engines); i++) {
 		Engine* e = &_engines[i];
@@ -907,7 +906,7 @@
 {
 	Engine *e;
 
-	if (_cur_year < 130) {
+	if (_cur_year < 130 + 1920) {
 		for (e = _engines; e != endof(_engines); e++) {
 			// Age the vehicle
 			if (e->flags & ENGINE_AVAILABLE && e->age != 0xFFFF) {
@@ -915,7 +914,7 @@
 				CalcEngineReliability(e);
 			}
 
-			if (!(e->flags & ENGINE_AVAILABLE) && (uint16)(_date - min(_date, 365)) >= e->intro_date) {
+			if (!(e->flags & ENGINE_AVAILABLE) && (_date - min(_date, 365)) >= e->intro_date) {
 				// Introduce it to all players
 				NewVehicleAvailable(e);
 			} else if (!(e->flags & (ENGINE_AVAILABLE|ENGINE_INTRODUCING)) && _date >= e->intro_date) {
@@ -960,8 +959,10 @@
 
 
 static const SaveLoad _engine_desc[] = {
-	SLE_VAR(Engine,intro_date,						SLE_UINT16),
-	SLE_VAR(Engine,age,										SLE_UINT16),
+	SLE_CONDVAR(Engine,intro_date,				SLE_FILE_U16 | SLE_VAR_U32,  0,  15),
+	SLE_CONDVAR(Engine,intro_date,				SLE_UINT32, 16, 255),
+	SLE_CONDVAR(Engine,age,								SLE_FILE_U16 | SLE_VAR_U32,  0,  15),
+	SLE_CONDVAR(Engine,age,								SLE_UINT32, 16, 255),
 	SLE_VAR(Engine,reliability,						SLE_UINT16),
 	SLE_VAR(Engine,reliability_spd_dec,		SLE_UINT16),
 	SLE_VAR(Engine,reliability_start,			SLE_UINT16),
Index: engine.h
===================================================================
--- engine.h	(Revision 2953)
+++ engine.h	(Arbeitskopie)
@@ -66,7 +66,7 @@
   * @see table/engines.h
   */
 typedef struct EngineInfo {
-	uint16 base_intro;
+	uint32 base_intro;
 	byte unk2;              ///< Carriages have the highest bit set in this one
 	byte lifelength;
 	byte base_life;
@@ -74,8 +74,8 @@
 } EngineInfo;
 
 typedef struct Engine {
-	uint16 intro_date;
-	uint16 age;
+	uint32 intro_date;
+	uint32 age;
 	uint16 reliability;
 	uint16 reliability_spd_dec;
 	uint16 reliability_start, reliability_max, reliability_final;
@@ -271,4 +271,16 @@
 	return &_road_vehicle_info[e - ROAD_ENGINES_INDEX];
 }
 
+static inline CargoID GetGlobalCargoID(byte current_landscape, byte cargo_id)
+{
+	assert(current_landscape < NUM_LANDSCAPE && cargo_id < NUM_CARGO);
+	return _global_cargo_id[current_landscape][cargo_id];
+}
+
+static inline CargoID GetLocalCargoID(byte global_cargo_id)
+{
+	assert(global_cargo_id < NUM_GLOBAL_CID);
+	return _local_cargo_id_ctype[global_cargo_id];
+}
+
 #endif
Index: functions.h
===================================================================
--- functions.h	(Revision 2953)
+++ functions.h	(Arbeitskopie)
@@ -75,6 +75,7 @@
 void SubtractMoneyFromPlayerFract(byte player, int32 cost);
 bool CheckOwnership(byte owner);
 bool CheckTileOwnership(TileIndex tile);
+bool CheckSubsidiaryTileOwnership(uint tile);
 StringID GetPlayerNameString(byte player, byte index);
 
 /* standard */
@@ -191,9 +192,9 @@
 #define AllocateNameUnique(name, skip) RealAllocateName(name, skip, true)
 #define AllocateName(name, skip) RealAllocateName(name, skip, false)
 StringID RealAllocateName(const char *name, byte skip, bool check_double);
-void ConvertDayToYMD(YearMonthDay *ymd, uint16 date);
-uint ConvertYMDToDay(uint year, uint month, uint day);
-uint ConvertIntDate(uint date);
+void ConvertDayToYMD(YearMonthDay *ymd, uint32 date);
+uint32 ConvertYMDToDay(uint year, uint month, uint day);
+uint32 ConvertIntDate(uint32 date);
 
 /* misc functions */
 void MarkTileDirty(int x, int y);
@@ -256,7 +257,12 @@
 	SLD_LOAD_SCENARIO = 1,
 	SLD_SAVE_GAME = 2,
 	SLD_SAVE_SCENARIO = 3,
+#ifdef WITH_PNG
+	SLD_LOAD_PNG = 4,	
+	SLD_NEW_GAME = 5,
+#else //WITH_PNG
 	SLD_NEW_GAME = 4,
+#endif //WITH_PNG
 };
 void ShowSaveLoadDialog(int mode);
 
Index: aircraft_cmd.c
===================================================================
--- aircraft_cmd.c	(Revision 2953)
+++ aircraft_cmd.c	(Arbeitskopie)
@@ -16,6 +16,7 @@
 #include "sound.h"
 #include "player.h"
 #include "airport.h"
+#include "economy.h"
 #include "vehicle_gui.h"
 
 static bool AirportMove(Vehicle *v, const AirportFTAClass *Airport);
@@ -1261,6 +1262,13 @@
 		return;
 
 	st = GetStation(v->u.air.targetairport);
+	if ((v->subtype == SUBTYPE_NONE) || (v->subtype == SUBTYPE_AIRCRAFT))
+	{
+		st->vehicles[STS_VEH_AIRCRAFT].this_month++;
+		if (st->months_counted == STS_NO_MONTHS_COUNTED) st->months_counted = 1;
+	}
+	InvalidateWindow(WC_STATION_STATS, st->index);
+	
 	v->last_station_visited = v->u.air.targetairport;
 
 	/* Check if station was ever visited before */
@@ -1547,7 +1555,8 @@
 	// heliport/oilrig, etc --> no airplanes (HELICOPTERS_ONLY)
 	// runway busy or not allowed to use this airstation, circle
 	if (! (v->subtype == Airport->acc_planes ||
-			st->airport_tile == 0 || (st->owner != OWNER_NONE && st->owner != v->owner) )) {
+			st->airport_tile == 0 || (st->owner != OWNER_NONE &&
+			!(IsSisterCompany(st->owner, v->owner) || _patches.shared_stations)))) {
 
 		// {32,FLYING,NOTHING_block,37}, {32,LANDING,N,33}, {32,HELILANDING,N,41},
 		// if it is an airplane, look for LANDING, for helicopter HELILANDING
Index: npf.c
===================================================================
--- npf.c	(Revision 2953)
+++ npf.c	(Arbeitskopie)
@@ -11,6 +11,7 @@
 #include "station.h"
 #include "tile.h"
 #include "depot.h"
+#include "economy.h"
 
 static AyStar _npf_aystar;
 
@@ -80,7 +81,7 @@
 		byte dst_type = GetTileRailType(dst_tile, exitdir);
 		if (!IsCompatibleRail(enginetype, dst_type))
 			return true;
-		if (GetTileOwner(tile) != GetTileOwner(dst_tile))
+		if (GetTileOwner(tile) != GetTileOwner(dst_tile) && !_patches.shared_tracks && !IsSisterCompany(GetTileOwner(tile), GetTileOwner(dst_tile)))
 			return true;
 
 		/* Prevent us from entering a depot from behind */
@@ -417,8 +418,14 @@
 		case MP_STREET:
 			cost = NPF_TILE_LENGTH;
 			/* Increase the cost for level crossings */
-			if ((_m[tile].m5 & 0xF0) == 0x10)
+			if (IsLevelCrossing(tile))
 				cost += _patches.npf_crossing_penalty;
+
+			/* Increase the cost for busy routes, intended to
+			 * spread traffic around. This function may be CPU
+			 * intensive, so we can bypass it here */
+			if (_patches.npf_busy_road_penalty > 0 && !EnsureNoVehicleDirection(tile, current->direction))
+				cost += _patches.npf_busy_road_penalty;
 			break;
 		default:
 			break;
@@ -639,19 +646,23 @@
 static bool VehicleMayEnterTile(Owner owner, TileIndex tile, DiagDirection enterdir)
 {
 	if (
+		IsTileDepotType(tile, TRANSPORT_RAIL) /* Rail depot tile */
+		|| IsTileDepotType(tile, TRANSPORT_ROAD) /* Road depot tile */
+		|| IsTileDepotType(tile, TRANSPORT_WATER) /* Water depot tile */
+		)
+		return _patches.shared_depots || IsSisterCompany(GetTileOwner(tile), owner);
+	if (
 		IsTileType(tile, MP_RAILWAY) /* Rail tile (also rail depot) */
 		|| IsTrainStationTile(tile) /* Rail station tile */
-		|| IsTileDepotType(tile, TRANSPORT_ROAD) /* Road depot tile */
 		|| IsRoadStationTile(tile) /* Road station tile */
-		|| IsTileDepotType(tile, TRANSPORT_WATER) /* Water depot tile */
 		)
-		return IsTileOwner(tile, owner); /* You need to own these tiles entirely to use them */
+		return _patches.shared_tracks || IsSisterCompany(GetTileOwner(tile), owner);
 
 	switch (GetTileType(tile)) {
 		case MP_STREET:
 			/* rail-road crossing : are we looking at the railway part? */
 			if (IsLevelCrossing(tile) && GetCrossingTransportType(tile, TrackdirToTrack(DiagdirToDiagTrackdir(enterdir))) == TRANSPORT_RAIL)
-				return IsTileOwner(tile, owner); /* Railway needs owner check, while the street is public */
+				return _patches.shared_tracks || IsSisterCompany(GetTileOwner(tile), owner); /* Railway needs owner check, while the street is public */
 			break;
 		case MP_TUNNELBRIDGE:
 #if 0
@@ -672,7 +683,7 @@
 				|| (_m[tile].m5 & 0xC6) == 0x80 /* railway bridge ending */
 				|| ((_m[tile].m5 & 0xF8) == 0xE0 && ((unsigned)_m[tile].m5 & 0x1) != (enterdir & 0x1)) /* railway under bridge */
 				)
-				return IsTileOwner(tile, owner);
+				return _patches.shared_tracks || IsSisterCompany(GetTileOwner(tile), owner);
 			break;
 		default:
 			break;
@@ -974,6 +985,7 @@
 		/* Check if this is really a valid depot, it is of the needed type and
 		 * owner */
 		if (IsValidDepot(depot) && IsTileDepotType(depot->xy, type) && IsTileOwner(depot->xy, owner))
+		//if (IsValidDepot(depot) && IsTileDepotType(depot->xy, type) && (_patches.shared_tracks || IsSisterCompany(GetTileOwner(depot->xy),owner)))
 			/* If so, let's add it to the queue, sorted by distance */
 			depots.push(&depots, depot, DistanceManhattan(tile, depot->xy));
 	}
Index: vehicle_gui.c
===================================================================
--- vehicle_gui.c	(Revision 2953)
+++ vehicle_gui.c	(Arbeitskopie)
@@ -16,6 +16,9 @@
 #include "gfx.h"
 #include "variables.h"
 #include "vehicle_gui.h"
+#include "station.h"
+#include "waypoint.h"
+#include "depot.h"
 
 Sorting _sorting;
 
@@ -66,6 +69,7 @@
 		switch (w->window_class) {
 		case WC_TRAINS_LIST: case WC_ROADVEH_LIST:
 		case WC_SHIPS_LIST:  case WC_AIRCRAFT_LIST:
+		case WC_VEHICLES_LIST:
 			WP(w, vehiclelist_d).flags |= VL_REBUILD;
 			SetWindowDirty(w);
 			break;
@@ -81,6 +85,7 @@
 		switch (w->window_class) {
 		case WC_TRAINS_LIST: case WC_ROADVEH_LIST:
 		case WC_SHIPS_LIST:  case WC_AIRCRAFT_LIST:
+		case WC_VEHICLES_LIST:
 			WP(w, vehiclelist_d).flags |= VL_RESORT;
 			SetWindowDirty(w);
 			break;
@@ -88,61 +93,6 @@
 		}
 }
 
-void BuildVehicleList(vehiclelist_d *vl, int type, int owner, int station)
-{
-	int subtype = (type != VEH_Aircraft) ? TS_Front_Engine : 2;
-	int n = 0;
-	int i;
-
-	if (!(vl->flags & VL_REBUILD)) return;
-
-	/* Create array for sorting */
-	_vehicle_sort = realloc(_vehicle_sort, GetVehiclePoolSize() * sizeof(_vehicle_sort[0]));
-	if (_vehicle_sort == NULL)
-		error("Could not allocate memory for the vehicle-sorting-list");
-
-	DEBUG(misc, 1) ("Building vehicle list for player %d station %d...",
-		owner, station);
-
-	if (station != -1) {
-		const Vehicle *v;
-		FOR_ALL_VEHICLES(v) {
-			if (v->type == type && v->subtype <= subtype) {
-				const Order *order;
-
-				FOR_VEHICLE_ORDERS(v, order) {
-					if (order->type == OT_GOTO_STATION && order->station == station) {
-						_vehicle_sort[n].index = v->index;
-						_vehicle_sort[n].owner = v->owner;
-						++n;
-						break;
-					}
-				}
-			}
-		}
-	} else {
-		const Vehicle *v;
-		FOR_ALL_VEHICLES(v) {
-			if (v->type == type && v->subtype <= subtype && v->owner == owner) {
-				_vehicle_sort[n].index = v->index;
-				_vehicle_sort[n].owner = v->owner;
-				++n;
-			}
-		}
-	}
-
-	vl->sort_list = realloc(vl->sort_list, n * sizeof(vl->sort_list[0]));
-	if (n!=0 && vl->sort_list == NULL)
-		error("Could not allocate memory for the vehicle-sorting-list");
-	vl->list_length = n;
-
-	for (i = 0; i < n; ++i)
-		vl->sort_list[i] = _vehicle_sort[i];
-
-	vl->flags &= ~VL_REBUILD;
-	vl->flags |= VL_RESORT;
-}
-
 void SortVehicleList(vehiclelist_d *vl)
 {
 	if (!(vl->flags & VL_RESORT)) return;
@@ -1073,3 +1023,104 @@
 {
 	memset(&_sorting, 0, sizeof(_sorting));
 }
+
+void BuildVehicleListMasked(vehiclelist_d *vl, DisplayListOption *listopt, int owner)
+{
+	const byte landscape = _opt.landscape;
+	int i, n = 0;
+	uint64 cmask;
+
+	if (!(vl->flags & VL_REBUILD)) return;
+
+	/* Create array for sorting */
+	_vehicle_sort = realloc(_vehicle_sort, GetVehiclePoolSize() * sizeof(_vehicle_sort[0]));
+	if (_vehicle_sort == NULL)
+		error("Could not allocate memory for the vehicle-sorting-list");
+
+	DEBUG(misc, 1) ("Building vehicle list for player %d station at %d...",
+		owner, listopt->xy);
+	
+	if (listopt->xy != INVALID_TILE) {  // Build List for a station/waypoint/depot (other?)
+		const Vehicle *v;
+
+		assert(listopt->xy < MapSize()); // not really needed, you will get an empty list when xy is outside the mapbounds
+
+		FOR_ALL_VEHICLES(v) {
+			if (HASBIT(listopt->type_mask, v->type)
+				&& ((v->subtype == TS_Front_Engine)
+					|| (v->type == VEH_Aircraft && v->subtype == SUBTYPE_AIRCRAFT))) {
+				if (listopt->cargo_mask == CARGO_MASK_ALL) {
+					cmask = CARGO_MASK_ALL;
+				} else {
+					const Vehicle *u = v;
+					cmask = 0;
+					for (u = v; u != NULL; u = u->next) { // check cargotypes of all vehicles of the consist (trains/aircraft)
+					// vehicles that cant carry any cargo may have cargotype 0 == CT_PASSENGERS,
+					// so we have to make sure we only get those that could really carry cargo
+					// think we should make them have INVALID_CARGO cargotype instead... (Asterix)
+						if (u->cargo_cap != 0)
+							cmask |= HASBIT(_landscape_global_cargo_mask[landscape], u->cargo_type);
+					}
+				}
+				if (listopt->cargo_mask & cmask) {
+					const Order *order;
+
+					FOR_VEHICLE_ORDERS(v, order) { // check if consist is scheduled for this map-position
+						if (order->type == OT_GOTO_STATION && GetStation(order->station)->xy == listopt->xy) {
+								_vehicle_sort[n].index = v->index;
+								_vehicle_sort[n].owner = v->owner;
+								++n;
+								break;
+						} else if (order->type == OT_GOTO_WAYPOINT && GetWaypoint(order->station)->xy == listopt->xy) {
+								_vehicle_sort[n].index = v->index;
+								_vehicle_sort[n].owner = v->owner;
+								++n;
+								break;
+						} else if (order->type == OT_GOTO_DEPOT && GetDepot(order->station)->xy == listopt->xy) {
+								_vehicle_sort[n].index = v->index;
+								_vehicle_sort[n].owner = v->owner;
+								++n;
+								break;
+						}
+					} // Vehicle Orders
+				}
+			}
+		} // All Vehicles
+	} else {
+		Vehicle *v;
+		FOR_ALL_VEHICLES(v) {
+			if (HASBIT(listopt->type_mask, v->type) && (v->owner == owner)
+				&& ((v->subtype == TS_Front_Engine)
+					|| (v->type == VEH_Aircraft && v->subtype == SUBTYPE_AIRCRAFT))) {
+				if (listopt->cargo_mask == CARGO_MASK_ALL) {
+					_vehicle_sort[n].index = v->index;
+					_vehicle_sort[n].owner = v->owner;
+					++n;
+				} else {
+					Vehicle *u = v;
+					cmask = 0;
+					for (u = v; u != NULL; u = u->next) { // check cargotypes of all vehicles of the consist (trains/aircraft)
+						if (u->cargo_cap != 0)
+							cmask |= HASBIT(_landscape_global_cargo_mask[landscape], u->cargo_type);
+					}
+					if (listopt->cargo_mask & cmask) {
+						_vehicle_sort[n].index = v->index;
+						_vehicle_sort[n].owner = v->owner;
+						++n;
+					}
+				}
+			}
+		} // All Vehicles
+	}
+
+	vl->sort_list = realloc(vl->sort_list, n * sizeof(vl->sort_list[0]));
+	if (n != 0 && vl->sort_list == NULL)
+		error("Could not allocate memory for the vehicle-sorting-list");
+	vl->list_length = n;
+
+	for (i = 0; i < n; ++i)
+		vl->sort_list[i] = _vehicle_sort[i];
+
+	vl->flags &= ~VL_REBUILD;
+	vl->flags |= VL_RESORT;
+}
Index: pbs.c
===================================================================
--- pbs.c	(Revision 2953)
+++ pbs.c	(Arbeitskopie)
@@ -16,19 +16,19 @@
 
 /* reserved track encoding:
  normal railway tracks:
-   map3hi bits 4..6 = 'Track'number of reserved track + 1, if this is zero it means nothing is reserved on this tile
-   map3hi bit  7    = if this is set, then the opposite track ('Track'number^1) is also reserved
+   m4 bits 4..6 = 'Track'number of reserved track + 1, if this is zero it means nothing is reserved on this tile
+   m4 bit  7    = if this is set, then the opposite track ('Track'number^1) is also reserved
  waypoints/stations:
-   map3lo bit 6 set = track is reserved
+   m3 bit 6 set = track is reserved
  tunnels/bridges:
-   map3hi bit 0 set = track with 'Track'number 0 is reserved
-   map3hi bit 1 set = track with 'Track'number 1 is reserved
+   m4 bit 0 set = track with 'Track'number 0 is reserved
+   m4 bit 1 set = track with 'Track'number 1 is reserved
  level crossings:
    map5 bit 0 set = the rail track is reserved
 */
 
 /**
- * maps an encoded reserved track (from map3lo bits 4..7)
+ * maps an encoded reserved track (from m4 bits 4..7)
  * to the tracks that are reserved.
  * 0xFF are invalid entries and should never be accessed.
  */
@@ -38,7 +38,7 @@
 };
 
 /**
- * maps an encoded reserved track (from map3lo bits 4..7)
+ * maps an encoded reserved track (from m4 bits 4..7)
  * to the track(dir)s that are unavailable due to reservations.
  * 0xFFFF are invalid entries and should never be accessed.
  */
@@ -100,7 +100,11 @@
 			} else {
 				// normal track
 				byte res = encrt_to_reserved[(_m[tile].m4 & 0xF0) >> 4];
-				assert(res != 0xFF);
+				if (res == 0xFF) {
+					// autofix wrong values
+					_m[tile].m4 &= ~0xF0;
+					return 0;
+				}
 				return res;
 			}
 		case MP_TUNNELBRIDGE:
@@ -132,7 +136,11 @@
 			} else {
 				// normal track
 				uint16 res = encrt_to_unavail[(_m[tile].m4 & 0xF0) >> 4];
-				assert(res != 0xFFFF);
+				if (res == 0xFFFF) {
+					// autofix wrong values
+					_m[tile].m4 &= ~0xF0;
+					return 0;
+				}
 				return res;
 			}
 		case MP_TUNNELBRIDGE:
Index: langs.vcproj
===================================================================
--- langs.vcproj	(Revision 2953)
+++ langs.vcproj	(Arbeitskopie)
@@ -33,6 +33,26 @@
 				Description="Generating strings.h"
 				CommandLine="strgen\debug\strgen.exe"/>
 		</Configuration>
+		<Configuration
+			Name="Release|Win32"
+			OutputDirectory="$(ConfigurationName)"
+			IntermediateDirectory="$(ConfigurationName)"
+			ConfigurationType="10"
+			UseOfMFC="0"
+			ATLMinimizesCRunTimeLibraryUsage="FALSE">
+			<Tool
+				Name="VCCustomBuildTool"/>
+			<Tool
+				Name="VCMIDLTool"
+				TypeLibraryName="./langs.tlb"
+				HeaderFileName=""/>
+			<Tool
+				Name="VCPostBuildEventTool"/>
+			<Tool
+				Name="VCPreBuildEventTool"
+				Description="Generating strings.h"
+				CommandLine="strgen\debug\strgen.exe"/>
+		</Configuration>
 	</Configurations>
 	<References>
 	</References>
@@ -40,7 +60,8 @@
 		<File
 			RelativePath=".\lang\american.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating american language file"
@@ -48,11 +69,21 @@
 "
 					Outputs="lang\american.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating american language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\american.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\brazilian_portuguese.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating brazilian_portuguese language file"
@@ -60,11 +91,21 @@
 "
 					Outputs="lang\brazilian_portuguese.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating brazilian_portuguese language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\brazilian_portuguese.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\catalan.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating catalan language file"
@@ -72,11 +113,21 @@
 "
 					Outputs="lang\catalan.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating catalan language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\catalan.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\czech.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating czech language file"
@@ -84,11 +135,22 @@
 "
 					Outputs="lang\czech.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32"
+				ExcludedFromBuild="TRUE">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating czech language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\czech.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\danish.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating danish language file"
@@ -96,11 +158,21 @@
 "
 					Outputs="lang\danish.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating danish language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\danish.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\dutch.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating dutch language file"
@@ -108,6 +180,15 @@
 "
 					Outputs="lang\dutch.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating dutch language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\dutch.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath="lang\english.txt">
@@ -120,11 +201,21 @@
 "
 					Outputs="lang\english.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating english language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\english.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\finnish.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating finnish language file"
@@ -132,11 +223,21 @@
 "
 					Outputs="lang\finnish.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating finnish language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\finnish.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\french.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating french language file"
@@ -144,11 +245,21 @@
 "
 					Outputs="lang\french.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating french language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\french.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\galician.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating galician language file"
@@ -156,11 +267,21 @@
 "
 					Outputs="lang\galician.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating galician language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\galician.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\german.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating german language file"
@@ -168,11 +289,21 @@
 "
 					Outputs="lang\german.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating german language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\german.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\hungarian.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating hungarian language file"
@@ -180,11 +311,21 @@
 "
 					Outputs="lang\hungarian.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating hungarian language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\hungarian.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\icelandic.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating icelandic language file"
@@ -192,11 +333,21 @@
 "
 					Outputs="lang\icelandic.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating icelandic language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\icelandic.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\italian.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating italian language file"
@@ -204,11 +355,21 @@
 "
 					Outputs="lang\italian.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating italian language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\italian.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\lithuanian.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating lithuanian language file"
@@ -216,11 +377,22 @@
 "
 					Outputs="lang\lithuanian.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32"
+				ExcludedFromBuild="TRUE">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating lithuanian language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\lithuanian.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\norwegian.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating norwegian language file"
@@ -228,11 +400,21 @@
 "
 					Outputs="lang\norwegian.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating norwegian language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\norwegian.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\origveh.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating Original Vehicle names file"
@@ -240,11 +422,21 @@
 "
 					Outputs="lang\origveh.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating Original Vehicle names file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\origveh.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\polish.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating polish language file"
@@ -252,11 +444,22 @@
 "
 					Outputs="lang\polish.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32"
+				ExcludedFromBuild="TRUE">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating polish language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\polish.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\portuguese.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating portuguese language file"
@@ -264,11 +467,21 @@
 "
 					Outputs="lang\portuguese.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating portuguese language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\portuguese.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\romanian.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating romanian language file"
@@ -276,11 +489,21 @@
 "
 					Outputs="lang\romanian.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating romanian language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\romanian.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\slovak.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating slovak language file"
@@ -288,11 +511,22 @@
 "
 					Outputs="lang\slovak.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32"
+				ExcludedFromBuild="TRUE">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating slovak language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\slovak.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath=".\lang\spanish.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating spanish language file"
@@ -300,11 +534,21 @@
 "
 					Outputs="lang\spanish.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating spanish language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\spanish.lng"/>
+			</FileConfiguration>
 		</File>
 		<File
 			RelativePath="lang\swedish.txt">
 			<FileConfiguration
-				Name="Debug|Win32">
+				Name="Debug|Win32"
+				ExcludedFromBuild="TRUE">
 				<Tool
 					Name="VCCustomBuildTool"
 					Description="Generating swedish language file"
@@ -312,6 +556,15 @@
 "
 					Outputs="lang\swedish.lng"/>
 			</FileConfiguration>
+			<FileConfiguration
+				Name="Release|Win32">
+				<Tool
+					Name="VCCustomBuildTool"
+					Description="Generating swedish language file"
+					CommandLine="strgen\debug\strgen.exe &quot;$(InputPath)&quot;
+"
+					Outputs="lang\swedish.lng"/>
+			</FileConfiguration>
 		</File>
 	</Files>
 	<Globals>
Index: industry.h
===================================================================
--- industry.h	(Revision 2953)
+++ industry.h	(Arbeitskopie)
@@ -25,7 +25,7 @@
 	byte type;
 	byte owner;
 	byte color_map;
-	byte last_prod_year;
+	uint32 last_prod_year;
 	byte was_cargo_delivered;
 
 	uint16 index;
@@ -107,4 +107,12 @@
 	IT_SUGAR_MINE = 36,
 };
 
+enum {
+	AMOUNT_A = 3,
+	AMOUNT_B = 5,
+	CHANCE_A = 2,
+	CHANCE_B = 120,
+	PERCENT_INCREASE = 153,
+};
+
 #endif
Index: vehicle_gui.h
===================================================================
--- vehicle_gui.h	(Revision 2953)
+++ vehicle_gui.h	(Arbeitskopie)
@@ -4,6 +4,7 @@
 #define VEHICLE_GUI_H
 
 #include "vehicle.h"
+#include "window.h"
 
 struct vehiclelist_d;
 
@@ -15,7 +16,15 @@
 void RebuildVehicleLists(void);
 void ResortVehicleLists(void);
 
-void BuildVehicleList(struct vehiclelist_d *vl, int type, int owner, int station);
+/** builds a list of all vehicles that comply with the criteria given
+  *
+  * @param vl: the list to be build/rebuild
+  * @param listopt: struct with the listoptions
+  * @param owner: the owner of the vehicles that are added to the list
+  *
+  * @see DisplayListOption
+  */
+void BuildVehicleListMasked(struct vehiclelist_d *vl, DisplayListOption *listopt, int owner);
 void SortVehicleList(struct vehiclelist_d *vl);
 
 int CDECL GeneralOwnerSorter(const void *a, const void *b);
@@ -57,6 +66,7 @@
 	Listing roadveh;
 	Listing ship;
 	Listing train;
+	Listing masked;
 } Sorting;
 
 extern Sorting _sorting;
@@ -75,5 +85,9 @@
 void DrawAircraftPurchaseInfo(int x, int y, EngineID engine_number);
 void DrawShipPurchaseInfo(int x, int y, EngineID engine_number);
 
+void DrawTrainImage(const Vehicle *v, int x, int y, int count, int skip, VehicleID selection);
+void DrawShipImage(const Vehicle *v, int x, int y, VehicleID selection);
+void DrawAircraftImage(const Vehicle *v, int x, int y, VehicleID selection);
+void DrawRoadVehImage(const Vehicle *v, int x, int y, VehicleID selection);
 
 #endif /* VEHICLE_GUI_H */
Index: network.c
===================================================================
--- network.c	(Revision 2953)
+++ network.c	(Arbeitskopie)
@@ -539,10 +539,19 @@
 
 	if (_network_server) {
 		// We just lost one client :(
-		if (cs->status > STATUS_INACTIVE)
+		_network_clients_connected--;
+		if (cs->status > STATUS_INACTIVE) {
 			_network_game_info.clients_on--;
-		_network_clients_connected--;
 
+			if (cs->status == STATUS_ACTIVE && _network_game_info.clients_on == 0 &&
+					_network_pause_on_no_clients &&	_network_dedicated) {
+				// Pause game as now no active clients connected
+				DoCommandP(0, 1, 0, NULL, CMD_PAUSE);
+			
+				NetworkServer_HandleChat(NETWORK_ACTION_CHAT, DESTTYPE_BROADCAST, 0, "Game paused (no clients)", NETWORK_SERVER_INDEX);
+			}
+		}
+
 		while ((cs + 1) != DEREF_CLIENT(MAX_CLIENTS) && (cs + 1)->socket != INVALID_SOCKET) {
 			*cs = *(cs + 1);
 			*ci = *(ci + 1);
@@ -970,6 +979,14 @@
 	/* Try to register us to the master server */
 	_network_last_advertise_date = 0;
 	NetworkUDPAdvertise();
+
+	// Possible not the correct place for this
+	if (_network_dedicated && _network_pause_on_no_clients) {
+		// Pause server as there are no clients connected yet
+		DoCommandP(0, 1, 0, NULL, CMD_PAUSE);
+		
+		NetworkServer_HandleChat(NETWORK_ACTION_CHAT, DESTTYPE_BROADCAST, 0, "Game paused (no clients)", NETWORK_SERVER_INDEX);
+	}
 	return true;
 }
 
Index: network.h
===================================================================
--- network.h	(Revision 2953)
+++ network.h	(Arbeitskopie)
@@ -72,8 +72,8 @@
 	byte clients_max;																// Max clients allowed on server
 	byte clients_on;																// Current count of clients on server
 	byte spectators_on;															// How many spectators do we have?
-	uint16 game_date;																// Current date
-	uint16 start_date;															// When the game started
+	uint32 game_date;																// Current date
+	uint32 start_date;															// When the game started
 	char map_name[NETWORK_NAME_LENGTH];							// Map which is played ["random" for a randomized map]
 	uint16 map_width;																// Map width
 	uint16 map_height;															// Map height
@@ -103,7 +103,7 @@
 	byte client_lang;                             /// The language of the client
 	byte client_playas;                           /// As which player is this client playing (PlayerID)
 	uint32 client_ip;                             /// IP-address of the client (so he can be banned)
-	uint16 join_date;                             /// Gamedate the player has joined
+	uint32 join_date;                             /// Gamedate the player has joined
 	char unique_id[NETWORK_NAME_LENGTH];          /// Every play sends an unique id so we can indentify him
 } NetworkClientInfo;
 
@@ -171,6 +171,7 @@
 
 VARDEF uint16 _network_max_join_time;             //! Time a client can max take to join
 VARDEF bool _network_pause_on_join;               //! Pause the game when a client tries to join (more chance of succeeding join)
+VARDEF bool _network_pause_on_no_clients; ///< Pause the game if there are no clients connected
 
 VARDEF uint16 _redirect_console_to_client;
 
@@ -197,14 +198,14 @@
 VARDEF byte _network_lan_internet;
 
 VARDEF bool _network_advertise;
-VARDEF uint16 _network_last_advertise_date;
+VARDEF uint32 _network_last_advertise_date;
 VARDEF uint8 _network_advertise_retries;
 
 VARDEF bool _network_autoclean_companies;
 VARDEF uint8 _network_autoclean_unprotected; // Remove a company after X months
 VARDEF uint8 _network_autoclean_protected;   // Unprotect a company after X months
 
-VARDEF uint16 _network_restart_game_date;    // If this year is reached, the server automaticly restarts
+VARDEF uint32 _network_restart_game_date;    // If this year is reached, the server automaticly restarts
 
 NetworkGameList *NetworkQueryServer(const char* host, unsigned short port, bool game_info);
 
Index: intro_gui.c
===================================================================
--- intro_gui.c	(Revision 2953)
+++ intro_gui.c	(Arbeitskopie)
@@ -70,13 +70,16 @@
 		DrawString(283, 121, mapsizes[_patches.map_y - 6], 0x10);
 		break;
 
-	case WE_CLICK:
-		switch (e->click.widget) {
-		case 2: AskForNewGameToStart(); break;
-		case 3: ShowSaveLoadDialog(SLD_LOAD_GAME); break;
-		case 4: CreateScenario(); break;
-		case 5: ShowSaveLoadDialog(SLD_LOAD_SCENARIO); break;
-		case 6: case 7: case 8: case 9:
+ 	case WE_CLICK:
+ 		switch (e->click.widget) {
+ 		case 2: AskForNewGameToStart(); break;
+		case 3: 
+			_is_network_server=false; /*Since we aren't being clicked from network window, we aren't loading a game onto a server*/
+			ShowSaveLoadDialog(SLD_LOAD_GAME); 
+			break;
+ 		case 4: CreateScenario(); break;
+ 		case 5: ShowSaveLoadDialog(SLD_LOAD_SCENARIO); break;
+ 		case 6: case 7: case 8: case 9:
 			SetNewLandscapeType(e->click.widget - 6);
 			break;
 		case 10: case 11: /* Mapsize X */
Index: misc_gui.c
===================================================================
--- misc_gui.c	(Revision 2953)
+++ misc_gui.c	(Arbeitskopie)
@@ -1122,6 +1122,21 @@
 {   WIDGETS_END},
 };
 
+#ifdef WITH_PNG
+static const Widget _load_dialog_3_widgets[] = {
+{    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,						STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,  RESIZE_RIGHT,    14,    11,   256,     0,    13, STR_4011_LOAD_PNG,	STR_018C_WINDOW_TITLE_DRAG_THIS},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,   127,    14,    25, STR_SORT_BY_NAME,		STR_SORT_ORDER_TIP},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   128,   256,    14,    25, STR_SORT_BY_DATE,		STR_SORT_ORDER_TIP},
+{     WWT_IMGBTN,  RESIZE_RIGHT,    14,     0,   256,    26,    47, 0x0,								STR_NULL},
+{     WWT_IMGBTN,     RESIZE_RB,    14,     0,   256,    48,   293, 0x0,								STR_NULL},
+{          WWT_6,     RESIZE_RB,    14,     2,   243,    50,   291, 0x0,								STR_400A_LIST_OF_DRIVES_DIRECTORIES},
+{  WWT_SCROLLBAR,    RESIZE_LRB,    14,   245,   256,    48,   281, 0x0,								STR_0190_SCROLL_BAR_SCROLLS_LIST},
+{  WWT_RESIZEBOX,   RESIZE_LRTB,    14,   245,   256,   282,   293, 0x0,								STR_RESIZE_BUTTON},
+{   WIDGETS_END},
+};
+#endif //WITH_PNG
+
 static const Widget _save_dialog_widgets[] = {
 {    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,						STR_018B_CLOSE_WINDOW},
 {    WWT_CAPTION,  RESIZE_RIGHT,    14,    11,   256,     0,    13, STR_4000_SAVE_GAME,	STR_018C_WINDOW_TITLE_DRAG_THIS},
@@ -1156,9 +1171,8 @@
 {   WIDGETS_END},
 };
 
-
 // Colors for fios types
-const byte _fios_colors[] = {13, 9, 9, 6, 5, 6, 5};
+const byte _fios_colors[] = {13, 9, 9, 6, 5, 6, 5, 6};
 
 void BuildFileList(void)
 {
@@ -1166,6 +1180,10 @@
 	FiosFreeSavegameList();
 	if (_saveload_mode == SLD_NEW_GAME || _saveload_mode == SLD_LOAD_SCENARIO || _saveload_mode == SLD_SAVE_SCENARIO) {
 		_fios_list = FiosGetScenarioList(&_fios_num, _saveload_mode);
+#ifdef WITH_PNG
+	} else if (_saveload_mode == SLD_LOAD_PNG) {
+		_fios_list = FiosGetPNGList(&_fios_num, _saveload_mode);
+#endif //WITH_PNG
 	} else
 		_fios_list = FiosGetSavegameList(&_fios_num, _saveload_mode);
 }
@@ -1229,6 +1247,10 @@
 
 extern void StartupEngines(void);
 
+#ifdef WITH_PNG
+void LoadLandscapeFromPNG(void);
+#endif //WITH_PNG
+
 static void SaveLoadDlgWndProc(Window *w, WindowEvent *e)
 {
 	switch(e->event) {
@@ -1297,6 +1319,12 @@
 					ttd_strlcpy(_file_to_saveload.title, file->title, sizeof(_file_to_saveload.title));
 
 					DeleteWindow(w);
+#ifdef WITH_PNG
+				} else if (_saveload_mode == SLD_LOAD_PNG) {
+					ttd_strlcpy(_file_to_saveload.name, name, sizeof(_file_to_saveload.name));
+					DeleteWindow(w);
+					LoadLandscapeFromPNG();
+#endif //WITH_PNG
 				} else {
 					// SLD_SAVE_GAME, SLD_SAVE_SCENARIO copy clicked name to editbox
 					ttd_strlcpy(WP(w, querystr_d).text.buf, file->name, WP(w, querystr_d).text.maxlength);
@@ -1406,11 +1434,24 @@
 	SaveLoadDlgWndProc,
 };
 
+#ifdef WITH_PNG
+static const WindowDesc _load_png_dialog_desc = {
+	WDP_CENTER, WDP_CENTER, 257, 294,
+	WC_SAVELOAD,0,
+	WDF_STD_TOOLTIPS | WDF_DEF_WIDGET | WDF_STD_BTN | WDF_UNCLICK_BUTTONS | WDF_RESIZABLE,
+	_load_dialog_3_widgets,
+	SaveLoadDlgWndProc,
+};
+#endif //WITH_PNG
+
 static const WindowDesc * const _saveload_dialogs[] = {
 	&_load_dialog_desc,
 	&_load_dialog_scen_desc,
 	&_save_dialog_desc,
 	&_save_dialog_scen_desc,
+#ifdef WITH_PNG
+	&_load_png_dialog_desc,
+#endif //WITH_PNG
 };
 
 void ShowSaveLoadDialog(int mode)
@@ -1635,7 +1676,7 @@
 	YearMonthDay ymd;
 	ConvertDayToYMD(&ymd, _date);
 
-	if((ymd.year==0 && p2==-1) || (ymd.year==170 && p2==1)) return _cur_year;
+	if((ymd.year==0 && p2==-1) || (ymd.year==11758978 && p2==1)) return _cur_year;
 
 	SetDate(ConvertYMDToDay(_cur_year + p2, ymd.month, ymd.day));
 	EnginesMonthlyLoop();
@@ -1651,6 +1692,7 @@
 	CE_INT16 = 2,
 	CE_UINT16 = 3,
 	CE_INT32 = 4,
+	CE_UINT32 = 7,
 	CE_BYTE = 5,
 	CE_CLICK = 6,
 } ce_type;
@@ -1674,6 +1716,7 @@
 	case CE_INT16:  return *(int16*)ce->variable;
 	case CE_UINT16: return *(uint16*)ce->variable;
 	case CE_INT32:  return *(int32*)ce->variable;
+	case CE_UINT32: return *(uint32*)ce->variable;
 	case CE_BYTE:   return *(byte*)ce->variable;
 	case CE_CLICK:  return 0;
 	default:
@@ -1693,6 +1736,7 @@
 	case CE_INT16: *(int16*)ce->variable = (int16)val; break;
 	case CE_UINT16: *(uint16*)ce->variable = (uint16)val; break;
 	case CE_INT32: *(int32*)ce->variable = val; break;
+	case CE_UINT32: *(uint32*)ce->variable = (uint32)val; break;
 	case CE_CLICK: break;
 	default:
 		NOT_REACHED();
@@ -1709,15 +1753,16 @@
 	{CE_BOOL, 0, STR_CHEAT_NO_JETCRASH,			&_cheats.no_jetcrash.value,			&_cheats.no_jetcrash.been_used,			NULL,											0, 0, 0},
 	{CE_BOOL, 0, STR_CHEAT_SETUP_PROD,			&_cheats.setup_prod.value,			&_cheats.setup_prod.been_used,			NULL,											0, 0, 0},
 	{CE_UINT8, 0, STR_CHEAT_SWITCH_CLIMATE, &_opt.landscape, 								&_cheats.switch_climate.been_used,	&ClickChangeClimateCheat,-1, 4, 1},
-	{CE_UINT8, 0, STR_CHEAT_CHANGE_DATE,		&_cur_year,											&_cheats.change_date.been_used,			&ClickChangeDateCheat,	 -1, 1, 1},
+	{CE_UINT32, 0, STR_CHEAT_CHANGE_DATE,		&_cur_year,											&_cheats.change_date.been_used,			&ClickChangeDateCheat,	 -1, 1, 1},
+	{CE_BOOL, 0, STR_CHEAT_RESET_STATION,			&_cheats.reset_station.value,			&_cheats.reset_station.been_used,			&ClickResetStationCheat,											0, 0, 0},
 };
 
 
 static const Widget _cheat_widgets[] = {
 {   WWT_CLOSEBOX,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,		STR_018B_CLOSE_WINDOW},
 {    WWT_CAPTION,   RESIZE_NONE,    14,    11,   399,     0,    13, STR_CHEATS,	STR_018C_WINDOW_TITLE_DRAG_THIS},
-{      WWT_PANEL,   RESIZE_NONE,    14,     0,   399,    14,   159, 0x0,					STR_NULL},
-{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   399,    14,   159, 0x0,					STR_CHEATS_TIP},
+{      WWT_PANEL,   RESIZE_NONE,    14,     0,   399,    14,   173, 0x0,					STR_NULL},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   399,    14,   173, 0x0,					STR_CHEATS_TIP},
 {   WIDGETS_END},
 };
 
@@ -1852,7 +1897,7 @@
 	}
 }
 static const WindowDesc _cheats_desc = {
-	240, 22, 400, 160,
+	240, 22, 400, 174,
 	WC_CHEATS,0,
 	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS,
 	_cheat_widgets,
Index: lang/french.txt
===================================================================
--- lang/french.txt	(Revision 2953)
+++ lang/french.txt	(Arbeitskopie)
@@ -2750,6 +2750,69 @@
 STR_SHORT_DATE                                                  :{WHITE}{DATE_TINY}
 STR_SIGN_LIST_CAPTION                                           :{WHITE}Liste des panneaux - {COMMA} panneau{P "" x}
 
+############ subsidiaries strings
+STR_SUBSIDIARIES                                                :{BLACK}Filiales
+STR_SUBSIDIARIES_MANAGEMENT                                     :{BLACK}grer vos filiales
+STR_YOUR_SUBSIDIARIES                                           :{WHITE}Vos filiales
+STR_SUBSIDIARIES_ADMINISTRATE                                   :{BLACK}Administrer
+STR_SUBSIDIARIES_SEND_MONEY                                     :{BLACK}Envoyer Argent
+STR_SUBSIDIARIES_REQUEST_MONEY                                  :{BLACK}Recevoir Argent
+STR_SUBSIDIARIES_MERGER                                         :{BLACK}Fusionner
+STR_SUBSIDIARIES_ADMINISTRATE_E                                 :{BLACK}Administrer (Jouer avec) la filiale slectione
+STR_SUBSIDIARIES_SEND_MONEY_E                                   :{BLACK}Envoyer de l'argnet  la filiale, la banque prlve 6% de frais sur la transaction 
+STR_SUBSIDIARIES_REQUEST_MONEY_E                                :{BLACK}Recevoir de l'argent de la filiale, la banque prlve 6% de frais sur la transaction 
+STR_SUBSIDIARIES_MERGER_E                                       :{BLACK}Effectue une fusion complte en la filiale slectione et votre compagnie
+STR_SUBSIDIARY_OF                                               :{WHITE}(Filiale de {STRING})
+STR_SUBSIDIARY_CREATE                                           :{BLACK}Crer
+STR_SUBSIDIARY_CREATE_E                                         :{BLACK}Cre une nouvelle filiale
+STR_SUBSIDIARY_ADD_CASH                                         :{BLACK}ajouter {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_ADD_CASH_E                                       :{BLACK}Augmente le montant transfr
+STR_SUBSIDIARY_SUB_CASH                                         :{BLACK}Soustraire {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_SUB_CASH_E                                       :{BLACK}Diminue le montant transfr
+STR_SUBSIDIARY_SEND_TO                                          :{WHITE}Envoyer argent  {STRING}
+STR_SUBSIDIARY_REQUEST_FROM                                     :{WHITE}Recevoir argent de {STRING}
+STR_SUBSIDIARY_SEND_AMOUNT                                      :{WHITE}Montant  envoyer:
+STR_SUBSIDIARY_REQUEST_AMOUNT                                   :{WHITE}Montant prlev:
+STR_SUBSIDIARY_AMOUNT_SEND                                      :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_GET                                       :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_TARGET                                    :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_GET_ERROR                                        :{WHITE}Impossible de recevoir ce montant...
+STR_SUBSIDIARY_SEND_ERROR                                       :{WHITE}Impossible d'envoyer ce montant...
+STR_SUBSIDIARY_PLAYER_ERROR                                     :{WHITE}Impossible de crer la filiale...
+STR_SUBSIDIARY_ASK_MERGER                                       :{YELLOW}Voulez vous fusionner {STRING} avec {STRING}?
+STR_SUBSIDIARY_ASK_MERGER_TITLE                                 :{WHITE}Fusionner
+STR_SUBSIDIARY_TARGET_HAS                                       :{WHITE}Equilibre bancaire de la filiale:
+STR_SUBSIDIARY_TOGGLE                                           :{BLACK}Toggle this subsidiary
+STR_SUBSIDIARY_CASH_REQUEST                                     :{WHITE}Prlvement demand
+STR_SUBSIDIARY_CASH_REQUESTED                                   :{WHITE}{STRING} demande {CURRENCY64}. Voulez vous lui envoyer ce montant?
+STR_SUBSIDIARY_CASH_REQUEST_DENIED                              :{WHITE}Votre prlvement est refus
+STR_SUBSIDIARY_CASH_REQUEST_GRANTED                             :{WHITE}Votre prlvement est accept
+STR_SUBSIDIARY_SELL_SHARE_TITLE                                 :{WHITE}Requete
+STR_SUBSIDIARY_SELL_SHARE                                       :{WHITE}{STRING} veut acheter 25% de vos actions acceptez vous de lui vendre ?
+STR_SUBSIDIARY_SELL_SHARE_GRANTED                               :{WHITE}Votre offre est accepte
+STR_SUBSIDIARY_SELL_SHARE_DENIED                                :{WHITE}Votre offre est refuse
+STR_TOO_MANY_PLAYERS                                            :{WHITE}Trop de joueurs
+
+STR_CONFIG_PATCHES_SUBSIDIARIES                                 :{LTBLUE}Active la gestion des filiales: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_ST_TAX                                :{LTBLUE}Taxe sur les vhicules s'arrtant dans une station de vos filiales: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_SUB_CONFIG        :{LTBLUE}Taxe de base pour l'utilisation des voies de vos filiales: {ORANGE}{STRING} per tile
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_CONFIG            :{LTBLUE}Autorise le partage des voies pour tout le monde: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_OTHER_CONFIG      :{LTBLUE}Taxe de base pour l'utilisation des voies partages: {ORANGE}{STRING} per tile
+STR_CONFIG_PATCHES_SUBS_ALLOW_REMOVE                            :{LTBLUE}Autorise les filiales  supprimer les routes/voies de tout le groupe: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_COOP                                         :{BLACK}Coopration
+STR_CONFIG_PATCHES_SHARED_STATIONS                              :{LTBLUE}Autorise le partage des stations pour tous: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_STATIONS_SUBS_CARGOTAX                :{LTBLUE}Base tax for subsidiaries cargo pickup: {ORANGE}{STRING} per unit
+STR_CONFIG_PATCHES_SHARED_STATIONS_OTHERS_CARGOTAX              :{LTBLUE}Base tax for cargo pickup: {ORANGE}{STRING} per unit
+STR_CONFIG_PATCHES_SHARED_ST_TAX_OTHERS                         :{LTBLUE}Taxe sur les vhicules s'arretant dans la station d'une autre companie: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_YEARS_OF_PROTECTION                          :{LTBLUE}Protection des actions pendant:{ORANGE}{STRING} anne(s)
+
+STR_TRAINS_SUB                                                  :{WHITE}{COMMA} train{P "" s} sur {COMMA} ({COMMA}%)
+STR_ROAD_VEHICLES_SUB                                           :{WHITE}{COMMA} vhicule{P "" s} routier{P "" s} sur {COMMA} ({COMMA}%)
+STR_AIRCRAFT_SUB                                                :{WHITE}{COMMA} aroplane{P "" s} sur {COMMA} ({COMMA}%)
+STR_SHIPS_SUB                                                   :{WHITE}{COMMA} navire{P "" s} sur {COMMA} ({COMMA}%)
+############ end of subsidiaries strings
+
+
 ############ Lists rail types
 
 STR_RAIL_VEHICLES                                               :Vhicules sur rail
Index: lang/german.txt
===================================================================
--- lang/german.txt	(Revision 2953)
+++ lang/german.txt	(Arbeitskopie)
@@ -329,7 +329,7 @@
 STR_0161_QUIT_GAME                                              :{WHITE}Spiel beenden
 STR_SORT_ORDER_TIP                                              :{BLACK}Sortierreihenfolge auswhlen absteigend/aufsteigend
 STR_SORT_CRITERIA_TIP                                           :{BLACK}Sortierkriterium auswhlen
-SRT_SORT_BY                                                     :{BLACK}Sortieren nach
+SRT_SORT_BY                                                     :{BLACK}Sort. nach
 
 STR_SORT_BY_POPULATION                                          :{BLACK}Bevlkerung
 STR_SORT_BY_PRODUCTION                                          :{BLACK}Produktion
@@ -346,6 +346,10 @@
 STR_SORT_BY_RELIABILITY                                         :Zuverlssigkeit
 STR_SORT_BY_TOTAL_CAPACITY_PER_CARGOTYPE                        :Gesamtkapazitt pro Fracht
 STR_SORT_BY_MAX_SPEED                                           :Hchstgeschwindigkeit
+STR_SORT_BY_WAITINGCARGO                                        :Wartende Fracht
+STR_SORT_BY_RATING                                              :Bewertung
+STR_SORT_BY_VISITING_VEHICLE 	                                :Haltende Fahrzeuge
+STR_SORT_BY_DROPDOWN_TYPE			:Type
 
 ############ range for months starts
 STR_0162_JAN                                                    :Jan
@@ -2747,10 +2751,72 @@
 STR_REPLACE_HELP_RAILTYPE                                       :{BLACK}Whle einen Schienentyp fr den Loks ersetzt werden sollen
 STR_REPLACE_HELP_REPLACE_INFO_TAB                               :{BLACK}Hier wird angezeigt, gegen welches Fahrzeug das auf der linken Seite gewhlte ersetzt wird
 STR_REPLACE_HELP                                                :{BLACK}Dieses Feature ermglicht es, einen Fahrzeugtyp auszuwhlen und ihn durch einen anderen ersetzen zu lassen. Dies geschieht automatisch, wenn das Fahrzeug regulr das Depot besucht.
-
 STR_SHORT_DATE                                                  :{WHITE}{DATE_TINY}
 STR_SIGN_LIST_CAPTION                                           :{WHITE}Schilderliste - {COMMA} Schild{P "" er}
 
+############ Subsidiaries strings
+STR_SUBSIDIARIES                                                :{BLACK}Tochterfirmen
+STR_SUBSIDIARIES_MANAGEMENT                                     :{BLACK}verwalte Deine Tochterfirmen
+STR_YOUR_SUBSIDIARIES                                           :{WHITE}Deine Tochterfirmen
+STR_SUBSIDIARIES_ADMINISTRATE                                   :{BLACK}Verwalten
+STR_SUBSIDIARIES_SEND_MONEY                                     :{BLACK}berweise Geld
+STR_SUBSIDIARIES_REQUEST_MONEY                                  :{BLACK}Fordere Geld
+STR_SUBSIDIARIES_MERGER                                         :{BLACK}Fusionieren
+STR_SUBSIDIARIES_ADMINISTRATE_E                                 :{BLACK}Verwalte (spielen als) die ausgewhlte Firma
+STR_SUBSIDIARIES_SEND_MONEY_E                                   :{BLACK}berweise Geld an die ausgewhlte Firma, die Bank kassiert 6 % berweisungsgebhr
+STR_SUBSIDIARIES_REQUEST_MONEY_E                                :{BLACK} berweise Geld von der ausgewhlten Firma, die Bank kassiert 6 % berweisungsgebhr
+STR_SUBSIDIARIES_MERGER_E                                       :{BLACK}Vollziehe eine Fusion mit der ausgewhlten Tochterfirma
+STR_SUBSIDIARY_OF                                               :{WHITE}(Tochterfirma von {STRING})
+STR_SUBSIDIARY_CREATE                                           :{BLACK}Erstellen
+STR_SUBSIDIARY_CREATE_E                                         :{BLACK}Erstelle eine neue Tochterfirma
+STR_SUBSIDIARY_ADD_CASH                                         :{BLACK}Hinzufgen {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_ADD_CASH_E                                       :{BLACK}Erhhe den zu berweisenden Betrag
+STR_SUBSIDIARY_SUB_CASH                                         :{BLACK}Abziehen {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_SUB_CASH_E                                       :{BLACK}Vermindere den zu berweisenden Betrag
+STR_SUBSIDIARY_SEND_TO                                          :{WHITE}Sende Geld an {STRING}
+STR_SUBSIDIARY_REQUEST_FROM                                     :{WHITE}Fordere Geld an von {STRING}
+STR_SUBSIDIARY_SEND_AMOUNT                                      :{WHITE}Betrag zum berweisen:
+STR_SUBSIDIARY_REQUEST_AMOUNT                                   :{WHITE}Betrag der an Dich berwiesen wird:
+STR_SUBSIDIARY_AMOUNT_SEND                                      :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_GET                                       :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_TARGET                                    :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_GET_ERROR                                        :{WHITE}Unmglich diesen Betrag abzufordern...
+STR_SUBSIDIARY_SEND_ERROR                                       :{WHITE}Unmglich diesen Betrag zu berweisen...
+STR_SUBSIDIARY_PLAYER_ERROR                                     :{WHITE}Kann keine Tochterfirma erffnen...
+STR_SUBSIDIARY_ASK_MERGER                                       :{YELLOW}Bist Du sicher da {STRING1} fusionieren soll mit {STRING2}?
+STR_SUBSIDIARY_ASK_MERGER_TITLE                                 :{WHITE}Fusion ausfhren
+STR_SUBSIDIARY_TARGET_HAS                                       :{WHITE}Derzeitiges Bankguthaben der ausgewhlten Tochterfirma:
+STR_SUBSIDIARY_TOGGLE                                           :{BLACK}Erpresse diese Tochterfirma
+STR_SUBSIDIARY_CASH_REQUEST                                     :{WHITE}Ankommende Geldforderung
+STR_SUBSIDIARY_CASH_REQUESTED                                   :{WHITE}{STRING} Angefordert {CURRENCY64}. Aktzeptieren Sie die berweisung?
+STR_SUBSIDIARY_CASH_REQUEST_DENIED                              :{WHITE}berweisung wurde abgelehnt
+STR_SUBSIDIARY_CASH_REQUEST_GRANTED                             :{WHITE}berweisung wurde angenommen
+STR_SUBSIDIARY_SELL_SHARE_TITLE                                 :{WHITE}Anfrage
+STR_SUBSIDIARY_SELL_SHARE                                       :{WHITE}{STRING} mchte 25% Ihrer Aktien kaufen. Wollen Sie die Aktien verkaufen?
+STR_SUBSIDIARY_SELL_SHARE_GRANTED                               :{WHITE}Angebot angemommen
+STR_SUBSIDIARY_SELL_SHARE_DENIED                                :{WHITE}Angebot abgelehnt
+STR_TOO_MANY_PLAYERS                                            :{WHITE}Zu viele Spieler
+
+STR_CONFIG_PATCHES_SUBSIDIARIES                                 :{LTBLUE}Ermgliche Tochterfirmen: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_ST_TAX                                :{LTBLUE}Gebhr fr das Benutzen der Stationen: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_SUB_CONFIG        :{LTBLUE}Gebhr fr das Nutzen der Schienen: {ORANGE}{STRING} per tile
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_CONFIG            :{LTBLUE}Erlaube die Schienennutzung fr jeden: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_OTHER_CONFIG      :{LTBLUE}Gebhr fr FREMDE Stations-Nutzung: {ORANGE}{STRING} per tile
+STR_CONFIG_PATCHES_SUBS_ALLOW_REMOVE                            :{LTBLUE}Tochterfrinem drfen Schienen/Strassen entfernen: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_COOP                                         :{BLACK}Cooperation
+STR_CONFIG_PATCHES_SHARED_STATIONS                              :{LTBLUE}Erlaube die Nutzung der Bahnhfe durch alle: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_STATIONS_SUBS_CARGOTAX                :{LTBLUE}Gebhr fr das Aufnehmen von Gtern(Tchter): {ORANGE}{STRING} per unit
+STR_CONFIG_PATCHES_SHARED_STATIONS_OTHERS_CARGOTAX              :{LTBLUE}Gebhr fr das Aufnehmen von Gtern(Fremde): {ORANGE}{STRING} per unit
+STR_CONFIG_PATCHES_SHARED_ST_TAX_OTHERS                         :{LTBLUE}Gebhr fr das Halten in fremden Stationen: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_YEARS_OF_PROTECTION                          :{LTBLUE}Jahre Aktienschutz:{ORANGE}{STRING} Jahr(e)
+STR_CONFIG_PATCHES_SHARED_DEPOTS                                :{LTBLUE}Erlaube die Depotbenutzung fr alle: {ORANGE}{STRING}
+
+STR_TRAINS_SUB                                                  :{WHITE}{COMMA} Z{P ug ge} von {COMMA} ({COMMA}%)
+STR_ROAD_VEHICLES_SUB                                           :{WHITE}{COMMA} Strassenfahrzeug{P "" e} von {COMMA} ({COMMA}%)
+STR_AIRCRAFT_SUB                                                :{WHITE}{COMMA} Flugzeug{P "" e} von {COMMA} ({COMMA}%)
+STR_SHIPS_SUB                                                   :{WHITE}{COMMA} Schiff{P "" e} von {COMMA} ({COMMA}%)
+################### end of subs strings
+
 ############ Lists rail types
 
 STR_RAIL_VEHICLES                                               :Eisenbahn
@@ -2772,3 +2838,116 @@
 STR_PURCHASE_INFO_COST_SPEED                                    :{BLACK}Kosten: {GOLD}{CURRENCY}{BLACK} Geschwindigk.: {GOLD}{VELOCITY}
 STR_PURCHASE_INFO_AIRCRAFT_CAPACITY                             :{BLACK}Kapazitt: {GOLD}{COMMA} Passagiere, {COMMA} Postscke
 STR_PURCHASE_INFO_PWAGPOWER_PWAGWEIGHT                          :{BLACK}Angetriebene Waggons: {GOLD}+{COMMA} PS{BLACK} Gewicht: {GOLD}+{COMMA}t
+
+STR_CONFIG_PATCHES_SHOW_TOWN_RATING_VALUES						:{LTBLUE}Zeige Statdtbewertung neben Wertung: {ORANGE}{STRING}
+
+STR_CONFIG_PATCHES_NSR_SPEED                                    :{LTBLUE}Aktiviere neue Bewertung fr Fahrzeuggeschwindigkeit: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_NSR_AGE                                      :{LTBLUE}Aktiviere neue Bewertung fr Fahrzeugalter: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_NSR_WAIT_DAYS                                :{LTBLUE}Aktiviere neue Bewertung fr Tage seit letzter Abholung: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_NSR_WAIT_CARGO                               :{LTBLUE}Aktiviere neue Bewertung fr Fracht/Passagiere warten: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_NSR_TOWN_RATING                              :{LTBLUE}Aktiviere neue Bewertung fr Haltung der Stadtverwaltung: {ORANGE}{STRING}
+
+STR_CHEAT_RESET_STATION                                         :{LTBLUE}Aktiviere Stations Reset: {ORANGE}{STRING}
+
+##### PNG-MAP-Loader
+STR_PNGMAP_ARE_YOU_SURE                                         :{WHITE}Bist Du sicher das du die Karte aus Map.png laden willst ?
+STR_PNGMAP_ERROR                                                :{WHITE}Kann Map nicht aus PNG laden...
+STR_PNGMAP_ERR_FILE_NOT_FOUND                                   :{WHITE}...Datei Map.png nicht gefunden
+STR_PNGMAP_ERR_IMAGE_TYPE                                       :{WHITE}...Falsches Daeiformat. 4-bit PNG bentigt.
+STR_PNGMAP_ERR_MISC                                             :{WHITE}...einiges ist fehlgeschlagen. Sorry.
+
+STR_TOWN_RATING							:{STRING} {TINYFONT}{BLACK}({COMMA})
+
+STR_RESET_STATION                                               :{BLACK}* RESET *
+STR_RESET_STATION_TIP                                           :{BLACK}Wenn dieser Button gedrckt wird, wird die Statistik zurck auf Anfangswerte gesetzt.
+STR_CAN_T_RESET_STATION                                         :{WHITE}Kann keinen Reset ausfhren ...
+
+STR_STATION_STATS                                               :{BLACK}Statistik
+STR_STATION_GOODS_IN                                            :{BLACK}In
+STR_STATION_GOODS_OUT                                           :{BLACK}Out
+STR_STATION_GOODS_TRANSFER                                      :{BLACK}Transport
+STR_VEHICLES                                                    :{BLACK}Fahrzeuge
+STR_SCHEDULED                                                   :{BLACK}Geplant
+STR_VEHICLES_MONTH                                              :{BLACK}Letzten Monat
+STR_VEHICLES_CURRENT                                            :{BLACK}Aktueller Monat
+STR_RVS                                                         :{BLACK}Strassen Fahrzeuge
+STR_BUSSES                                                      :{BLACK}Buse
+STR_TRUCKS                                                      :{BLACK}LKW's
+STR_NUMBER                                                      :{YELLOW}{COMMA}
+STR_STATION_MONTHS                                              :{BLACK}Fracht Menge [Diesen Monat (Letzten Monat) ]
+STR_CNUMBERS                                                    :{WHITE}{COMMA} {TINYFONT}{BLACK}({YELLOW}{COMMA}{BLACK})
+STR_VEHICLES_MONTHS_AVERAGE                                     :{BLACK}DurchSchn. / Min / Max
+STR_MONTHS_COUNTED_NUM                                          :{BLACK}Monate gezhlt: {GOLD}{COMMA}
+STR_MONTHS_TINY                                                 :{TINYFONT}{BLACK}Monate
+STR_STATION_MONTHS_AVERAGE                                      :{BLACK}Fracht Menge [Durchschn. (Min/Max) per Monat]
+STR_TOGGLE_MINMAX                                               :{BLACK}Wechseln  -Diesen/Letzten Monnat-   oder   -Durchschn./Min/Max-   Stats
+STR_RESET_STATISTICS                                            :{BLACK}Statistik zurcksetzen
+STR_AVERAGENUMBERS                                              :{SILVER}{COMMA} {BLACK}{TINYFONT}({ORANGE}{COMMA}{BLACK}/{LTBLUE}{COMMA}{BLACK})
+STR_BLACK_SLASH                                                 :{BLACK}/
+STR_TINY_GOLD_NUMBER                                            :{TINYFONT}{GOLD}{COMMA}
+STR_SILVER_NUMBER                                               :{SILVER}{COMMA}
+STR_ORANGE_NUMBER                                               :{ORANGE}{COMMA}
+STR_LTBLUE_NUMBER                                               :{LTBLUE}{COMMA}
+STR_WHITE_NUMBER                                                :{WHITE}{COMMA}
+STR_STS_NOT_SCHEDULED                                           :{BLACK}Nicht geplant
+STR_AVERAGE                                                     :{BLACK}Durchschnitt
+STR_MINIMUM                                                     :{BLACK}Minimum
+STR_MAXIMUM                                                     :{BLACK}Maximum
+STR_STS_VEHICLES_LAST_YEAR                                      :{BLACK}Letztes Jahr
+STR_STS_VEHICLES_THIS_YEAR                                      :{BLACK}Dieses Jahr
+STR_STS_YEARS_COUNTED_NUM                                       :{BLACK}Jahre gezhlt: {GOLD}{COMMA}
+STR_STS_TOGGLE_MONTH_YEAR                                       :{BLACK}Wechsel  -Monatliche-   oder   -Jhrliche-   Stats
+STR_STATION_COVERAGE                                            :{BLACK}Coverage
+STR_VEHICLE_CARGO_LIST                                          :{BLACK}Zeige Liste der erwarteten GFahrzeuge fr diesen Frachttyp
+
+STR_STATION_RATING_DETAIL                                          :{WHITE}Detailed service ratings - {1:STATIONFEATURES}
+STR_STATION_RATING_DETAIL_KEY                                      :{BLACK}Details
+STR_STATION_RATING_DETAIL_SCORES                                   :{BLACK}({NUM}/{NUM})
+STR_STATION_RATING_DETAIL_PERCENT                                  :{WHITE}{NUM}%
+STR_STATION_RATING_DETAIL_INT                                      :{BLACK}{NUM}
+STR_STATION_RATING_DETAIL_WAITING                                  :{BLACK}Wartende Fracht:
+STR_STATION_RATING_DETAIL_WAITING_EX                               :{BLACK}{STRING}
+STR_STATION_RATING_DETAIL_SPEED                                    :{BLACK}Letzte Geschwindigkeit:
+STR_STATION_RATING_DETAIL_SPEED_EX                                 :{BLACK}{NUM}
+STR_STATION_RATING_DETAIL_AGE                                      :{BLACK}Letztes Alter:
+STR_STATION_RATING_DETAIL_AGE_EX                                   :{BLACK}{COMMA} Jahr(e)
+STR_STATION_RATING_DETAIL_PICKUP                                   :{BLACK}Tage seit Abholung:
+STR_STATION_RATING_DETAIL_PICKUP_EX                                :{BLACK}{COMMA} Tag(e)
+STR_STATION_RATING_DETAIL_OTHER                                    :{BLACK}Andere Bewertung:
+STR_STATION_RATING_DETAIL_TOTAL                                    :{BLACK}Totale Bewertung:
+STR_STATION_RATING_DETAIL_SPEED_TIP                                :{BLACK}Maximale Geschwindigkeit des letzten Fahrzeugs (internal value, clipped at 255)
+STR_STATION_RATING_DETAIL_AGE_TIP                                  :{BLACK}Alter des letzten Fahrzeugs
+STR_STATION_RATING_DETAIL_PICKUP_TIP                               :{BLACK}Anzahl der Tage seit der letzten Abholung
+STR_STATION_RATING_DETAIL_WAITING_TIP                              :{BLACK}Fracht die auf Abholung wartet
+STR_STATION_RATING_DETAIL_OTHER_TIP                                :{BLACK}Andere Bewertung. Hauptschlich fr eine Statue in der Stadt der Station
+STR_STATION_RATING_DETAIL_TOTAL_TIP                                :{BLACK}Gesamt Bewertung - Die Stationsbewertung wird in kurzen Abstnden aktualisiert
+STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP                         :{BLACK}Hier klicken um Frachttyp zu wechseln
+
+STR_SIGNAL_SELECTION                                            :{WHITE}Signal Type Selection
+STR_SIGNAL_PRESIG_COMBO                                         :{BLACK}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{STRING}
+STR_SIGNAL_NORMAL                                               :Normales Signal
+STR_SIGNAL_ENTRANCE                                             :Eingans Vorsignal
+STR_SIGNAL_COMBO                                                :Combo Vorsignal
+STR_SIGNAL_EXIT                                                 :Ausgangs Vorsignals
+STR_SIGNAL_PBS                                                  :PBS Signal
+STR_SIGNAL_COMPLETION                                           :{BLACK}Auto Signalbau
+STR_SIGNAL_DENSITY_DESC                                         :{BLACK}Signal Dichte: 
+STR_SIGNAL_DENSITY_TILES                                        :{GOLD}{NUM} Teil(e)
+############ Leave those lines in this order!!
+STR_SIGNAL_TYPE_STANDARD                                        :{GOLD}Licht Signale
+STR_SIGNAL_TYPE_SEMAPHORES                                      :{GOLD}Semaphoren
+############ End of leave-in-this-order
+STR_SIGNAL_TYPE_TIP                                             :{BLACK}Signal Typ auswhlen
+STR_SIGNAL_DENSITY_TIP                                          :{BLACK}Signaldichte fr Auto Signal setzen
+STR_SIGNAL_COMPLETION_TIP                                       :{BLACK}Wenn auto Signal aktiviert, Signale werden bis zur nchsten Kreuzung gesetzt.
+STR_SIGNAL_PRESIG_TIP                                           :{BLACK}Vorsignal auswhlen
+
+STR_LOAD_LANDSCAPE_FROM_PNG                                     :{BLACK}Load Map aus PNG Datei
+STR_LOAD_LAND_FROM_PNG                                          :{BLACK}Load Land
+STR_CONFIG_PATCHES_DAY_LENGTH									:{LTBLUE}Standard Tages lnge {ORANGE}{STRING}
+STR_4011_LOAD_PNG												:{WHITE}Lade PNG
+STR_INCOMPATIBLE_RAIL_TYPE                           			:{WHITE}Incompatibler Zug typ
+
+STR_ZOOM_IN_SMALLMAP                             				:{BLACK}Kleine Map vergrssern
+STR_ZOOM_OUT_SMALLMAP                             				:{BLACK}Kleine Map verkleinern
+STR_RECENTRE_SMALLMAP                             				:{BLACK}Position neu zentrieren
Index: lang/hungarian.txt
===================================================================
--- lang/hungarian.txt	(Revision 2953)
+++ lang/hungarian.txt	(Arbeitskopie)
@@ -2852,6 +2852,68 @@
 STR_SHORT_DATE                                                  :{WHITE}{DATE_TINY}
 STR_SIGN_LIST_CAPTION                                           :{WHITE}Feliratok listja ({COMMA} db)
 
+############ Subsidiairies strings
+STR_SUBSIDIARIES                                                :{BLACK}Lenyvllalatok
+STR_SUBSIDIARIES_MANAGEMENT                                     :{BLACK}Lenyvllalataid irnytsa
+STR_YOUR_SUBSIDIARIES                                           :{WHITE}Lenyvllalataid
+STR_SUBSIDIARIES_ADMINISTRATE                                   :{BLACK}Irnyt
+STR_SUBSIDIARIES_SEND_MONEY                                     :{BLACK}Pnz kldse
+STR_SUBSIDIARIES_REQUEST_MONEY                                  :{BLACK}Pnz fogadsa
+STR_SUBSIDIARIES_MERGER                                         :{BLACK}Egyests
+STR_SUBSIDIARIES_ADMINISTRATE_E                                 :{BLACK}A kivlasztott lenyvllalat irnytsa
+STR_SUBSIDIARIES_SEND_MONEY_E                                   :{BLACK}Pnz kldse a kivlasztott lenyvllalatnak, a bank 6% kezelsi kltsget szmol fel.
+STR_SUBSIDIARIES_REQUEST_MONEY_E                                :{BLACK}Pnz fogadsa a kivlasztott lenyvllalattl, a bank 6% kezelsi kltsget szmol fel.
+STR_SUBSIDIARIES_MERGER_E                                       :{BLACK}A jelenlegi s a kivlasztott lenyvllalatok egyestse
+STR_SUBSIDIARY_OF                                               :{WHITE}({STRING} lenyvllalata)
+STR_SUBSIDIARY_CREATE                                           :{BLACK}Alapt
+STR_SUBSIDIARY_CREATE_E                                         :{BLACK}j lenyvllalatot alapt a semmibl
+STR_SUBSIDIARY_ADD_CASH                                         :{BLACK}{SKIP}{SKIP}{SKIP}{CURRENCY64} hozzadsa
+STR_SUBSIDIARY_ADD_CASH_E                                       :{BLACK}Az tviteli sszeg emelse
+STR_SUBSIDIARY_SUB_CASH                                         :{BLACK}{SKIP}{SKIP}{SKIP}{CURRENCY64} elvtele
+STR_SUBSIDIARY_SUB_CASH_E                                       :{BLACK}Az tviteli sszeg cskkentse
+STR_SUBSIDIARY_SEND_TO                                          :{WHITE}Pnz kldse {STRING} cgnek
+STR_SUBSIDIARY_REQUEST_FROM                                     :{WHITE}Pnz krse {STRING} cgtl
+STR_SUBSIDIARY_SEND_AMOUNT                                      :{WHITE}Az elkldend sszeg:
+STR_SUBSIDIARY_REQUEST_AMOUNT                                   :{WHITE}A krt sszeg:
+STR_SUBSIDIARY_AMOUNT_SEND                                      :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_GET                                       :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_TARGET                                    :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_GET_ERROR                                        :{WHITE}Lehetetlen ennyit kapni...
+STR_SUBSIDIARY_SEND_ERROR                                       :{WHITE}Lehetetlen ennyit kldeni...
+STR_SUBSIDIARY_PLAYER_ERROR                                     :{WHITE}Nem lehet lenyvllalatot alaptani...
+STR_SUBSIDIARY_ASK_MERGER                                       :{YELLOW}Biztos hogy {STRING} egyesljn {STRING} cgbe?
+STR_SUBSIDIARY_ASK_MERGER_TITLE                                 :{WHITE}Egyests
+STR_SUBSIDIARY_TARGET_HAS                                       :{WHITE}A lenyvllalat jelenlegi banki tartozsa:
+STR_SUBSIDIARY_TOGGLE                                           :{BLACK}tkapcsol erre a lenyvllalatra
+STR_SUBSIDIARY_CASH_REQUEST                                     :{WHITE}Bejv sszeg krelem
+STR_SUBSIDIARY_CASH_REQUESTED                                   :{WHITE}{STRING} {CURRENCY64} sszeget kr. Elkldd neki?
+STR_SUBSIDIARY_CASH_REQUEST_DENIED                              :{WHITE}A pnzkrsed elutastottk
+STR_SUBSIDIARY_CASH_REQUEST_GRANTED                             :{WHITE}A pnzkrsed elfogadtk
+STR_SUBSIDIARY_SELL_SHARE_TITLE                                 :{WHITE}Krs
+STR_SUBSIDIARY_SELL_SHARE                                       :{WHITE}{STRING} akar 25%-ot vsrolni a rszvnyeidbl. Beleegyezel?
+STR_SUBSIDIARY_SELL_SHARE_GRANTED                               :{WHITE}A krsed elutastottk
+STR_SUBSIDIARY_SELL_SHARE_DENIED                                :{WHITE}A krsed elfogadtk
+STR_TOO_MANY_PLAYERS                                            :{WHITE}Tl sok jtkos
+
+STR_CONFIG_PATCHES_SUBSIDIARIES                                 :{LTBLUE}Lenyvllalatok engedlyezse: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_ST_TAX                                :{LTBLUE}Ad mrtke a lenyvllalatok meglljban megllskor: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_SUB_CONFIG        :{LTBLUE}Ad mrtke a lenyvllalatok sn hasznlatkor: {ORANGE}{STRING} ngyzetenknt
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_CONFIG            :{LTBLUE}Mindenki hasznlhatja a sneket: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_OTHER_CONFIG      :{LTBLUE}Ad mrtke a megosztott sn hasznlatkor: {ORANGE}{STRING} ngyzetenknt
+STR_CONFIG_PATCHES_SUBS_ALLOW_REMOVE                            :{LTBLUE}A lenyvllalatok trlhetik-e egyms tjait s snjeit: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_COOP                                         :{BLACK}Egyttmkds
+STR_CONFIG_PATCHES_SHARED_STATIONS                              :{LTBLUE}Mindenki hasznlhatja az llomsokat: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_STATIONS_SUBS_CARGOTAX                :{LTBLUE}Ad mrtke a lenyvllalatok rakomnyaihoz: {ORANGE}{STRING} egysgenknt
+STR_CONFIG_PATCHES_SHARED_STATIONS_OTHERS_CARGOTAX              :{LTBLUE}Ad mrtke a megosztott rakomnyokhoz: {ORANGE}{STRING} egysgenknt
+STR_CONFIG_PATCHES_SHARED_ST_TAX_OTHERS                         :{LTBLUE}Ad mrtke a megosztott llomson megllskor: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_YEARS_OF_PROTECTION                          :{LTBLUE}Megosztsok elleni vdelem: {ORANGE}{STRING} vig
+
+STR_TRAINS_SUB                                                  :{WHITE}{COMMA} vonat a {COMMA} darabbl ({COMMA}%)
+STR_ROAD_VEHICLES_SUB                                           :{WHITE}{COMMA} kzti jrm a {COMMA} darabbl ({COMMA}%)
+STR_AIRCRAFT_SUB                                                :{WHITE}{COMMA} replgp a {COMMA} darabbl({COMMA}%)
+STR_SHIPS_SUB                                                   :{WHITE}{COMMA} haj a {COMMA} darabbl ({COMMA}%)
+############ End of Subsidiairies strings
+
 ############ Lists rail types
 
 STR_RAIL_VEHICLES                                               :Norml Vasutak
Index: lang/italian.txt
===================================================================
--- lang/italian.txt	(Revision 2953)
+++ lang/italian.txt	(Arbeitskopie)
@@ -2750,6 +2750,69 @@
 STR_SHORT_DATE                                                  :{WHITE}{DATE_TINY}
 STR_SIGN_LIST_CAPTION                                           :{WHITE}Lista dei Cartelli - {COMMA} Cartelli
 
+############ subsidiaries strings
+STR_SUBSIDIARIES                                                :{BLACK}Filiali
+STR_SUBSIDIARIES_MANAGEMENT                                     :{BLACK}Amministra le tue filiali
+STR_YOUR_SUBSIDIARIES                                           :{WHITE}Tue filiali
+STR_SUBSIDIARIES_ADMINISTRATE                                   :{BLACK}Amministra
+STR_SUBSIDIARIES_SEND_MONEY                                     :{BLACK}Invia denaro
+STR_SUBSIDIARIES_REQUEST_MONEY                                  :{BLACK}Richiedi denaro
+STR_SUBSIDIARIES_MERGER                                         :{BLACK}Fondi
+STR_SUBSIDIARIES_ADMINISTRATE_E                                 :{BLACK}Amministra (gioca con) la filiale selezionata
+STR_SUBSIDIARIES_SEND_MONEY_E                                   :{BLACK}Invia denaro alla filiale selezionata, la banca detrae il 6% della transazione come costi per il servizio
+STR_SUBSIDIARIES_REQUEST_MONEY_E                                :{BLACK}Prendi denaro dalla filiale selezionata, la banca detrae il 6% della transazione come costi per il servizio
+STR_SUBSIDIARIES_MERGER_E                                       :{BLACK}Fondi la filiale attualmente amministrata con quella selezionata
+STR_SUBSIDIARY_OF                                               :{WHITE}(Filiale di {STRING})
+STR_SUBSIDIARY_CREATE                                           :{BLACK}Crea
+STR_SUBSIDIARY_CREATE_E                                         :{BLACK}Crea una nuova filiale
+STR_SUBSIDIARY_ADD_CASH                                         :{BLACK}Aggiungi {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_ADD_CASH_E                                       :{BLACK}Aumenta l'ammontare da trasferire
+STR_SUBSIDIARY_SUB_CASH                                         :{BLACK}Sottrai {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_SUB_CASH_E                                       :{BLACK}Diminuisce l'ammontare da trasferire
+STR_SUBSIDIARY_SEND_TO                                          :{WHITE}Invia denaro a {STRING}
+STR_SUBSIDIARY_REQUEST_FROM                                     :{WHITE}Richiede denaro a {STRING}
+STR_SUBSIDIARY_SEND_AMOUNT                                      :{WHITE}Ammontare da trasferire:
+STR_SUBSIDIARY_REQUEST_AMOUNT                                   :{WHITE}Ammontare netto ricevuto:
+STR_SUBSIDIARY_AMOUNT_SEND                                      :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_GET                                       :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_TARGET                                    :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_GET_ERROR                                        :{WHITE}Impossibile trasferire l'ammontare...
+STR_SUBSIDIARY_SEND_ERROR                                       :{WHITE}Impossibile inviare l'ammontare...
+STR_SUBSIDIARY_PLAYER_ERROR                                     :{WHITE}Impossibile creare filiale...
+STR_SUBSIDIARY_ASK_MERGER                                       :{YELLOW}Sei sicuro di voler fondere {STRING} in {STRING}?
+STR_SUBSIDIARY_ASK_MERGER_TITLE                                 :{WHITE}Eseguire fusione
+STR_SUBSIDIARY_TARGET_HAS                                       :{WHITE}Bilancio attuale della filiale obbiettivo:
+STR_SUBSIDIARY_TOGGLE                                           :{BLACK}Seleziona questa filiale
+STR_SUBSIDIARY_CASH_REQUEST                                     :{WHITE}Richiesta denaro pervenuta
+STR_SUBSIDIARY_CASH_REQUESTED                                   :{WHITE}{STRING} Richiesti {CURRENCY64}. Accetti di inviare l'ammontare richiesto?
+STR_SUBSIDIARY_CASH_REQUEST_DENIED                              :{WHITE}La tua richiesta di denaro  stata rifiutata
+STR_SUBSIDIARY_CASH_REQUEST_GRANTED                             :{WHITE}La tua richiesta di denaro  stata accettata
+STR_SUBSIDIARY_SELL_SHARE_TITLE                                 :{WHITE}Richiesta pervenuta
+STR_SUBSIDIARY_SELL_SHARE                                       :{WHITE}{STRING} vorrebbe acquistare il 25% delle tue azioni. Accetti di vendere queste azioni?
+STR_SUBSIDIARY_SELL_SHARE_GRANTED                               :{WHITE}La tua offerta  stata accettata
+STR_SUBSIDIARY_SELL_SHARE_DENIED                                :{WHITE}La tua offerta  stata rifiutata
+STR_TOO_MANY_PLAYERS                                            :{WHITE}Troppe societ
+
+STR_CONFIG_PATCHES_SUBSIDIARIES                                 :{LTBLUE}Attivare amministrazione filiali: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_ST_TAX                                :{LTBLUE}Tariffa fermata nella stazione di una filiale: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_SUB_CONFIG        :{LTBLUE}Tariffa utilizzo tracciato di una filiale: {ORANGE}{STRING} per quadrato
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_CONFIG            :{LTBLUE}Consentire la condivisione dei tracciati per tutti: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_OTHER_CONFIG      :{LTBLUE}Tariffa utilizzo tracciato di un'altra societ: {ORANGE}{STRING} per quadrato
+STR_CONFIG_PATCHES_SUBS_ALLOW_REMOVE                            :{LTBLUE}Consentire la rimozione di strade e binari alle filiali: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_COOP                                         :{BLACK}Cooperazione
+STR_CONFIG_PATCHES_SHARED_STATIONS                              :{LTBLUE}Consentire la condivisione delle stazioni per tutti: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_STATIONS_SUBS_CARGOTAX                :{LTBLUE}Tariffa scarico nella stazione di una filiale: {ORANGE}{STRING} per unit
+STR_CONFIG_PATCHES_SHARED_STATIONS_OTHERS_CARGOTAX              :{LTBLUE}Tariffa scarico nella stazione di un'altra societ: {ORANGE}{STRING} per unit
+STR_CONFIG_PATCHES_SHARED_ST_TAX_OTHERS                         :{LTBLUE}Tariffa fermata nella stazione di un'altra societ: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_YEARS_OF_PROTECTION                          :{LTBLUE}Proteggi azioni per:{ORANGE}{STRING} anno/i
+STR_CONFIG_PATCHES_SHARED_DEPOTS                                :{LTBLUE}Consentire la condivisione dei depositi con tutti: {ORANGE}{STRING}
+
+STR_TRAINS_SUB                                                  :{WHITE}{COMMA} tren{P o i} su {COMMA} ({COMMA}%)
+STR_ROAD_VEHICLES_SUB                                           :{WHITE}{COMMA} veicol{P o i} stradal{P e i} su {COMMA} ({COMMA}%)
+STR_AIRCRAFT_SUB                                                :{WHITE}{COMMA} aere{P o i} su {COMMA} ({COMMA}%)
+STR_SHIPS_SUB                                                   :{WHITE}{COMMA} nav{P e i} su {COMMA} ({COMMA}%)
+############ end of subsidiaries strings
+
 ############ Lists rail types
 
 STR_RAIL_VEHICLES                                               :Veicoli Ferroviari
Index: lang/english.txt
===================================================================
--- lang/english.txt	(Revision 2953)
+++ lang/english.txt	(Arbeitskopie)
@@ -330,22 +330,25 @@
 STR_SORT_CRITERIA_TIP                                           :{BLACK}Select sorting criteria
 SRT_SORT_BY                                                     :{BLACK}Sort by
 
-STR_SORT_BY_POPULATION                                          :{BLACK}Population
-STR_SORT_BY_PRODUCTION                                          :{BLACK}Production
-STR_SORT_BY_TYPE                                                :{BLACK}Type
-STR_SORT_BY_TRANSPORTED                                         :{BLACK}Transported
-STR_SORT_BY_NAME                                                :{BLACK}Name
-STR_SORT_BY_DROPDOWN_NAME                                       :Name
-STR_SORT_BY_DATE                                                :{BLACK}Date
-STR_SORT_BY_UNSORTED                                            :Unsorted
-STR_SORT_BY_NUMBER                                              :Number
-STR_SORT_BY_PROFIT_LAST_YEAR                                    :Profit last year
-STR_SORT_BY_PROFIT_THIS_YEAR                                    :Profit this year
-STR_SORT_BY_AGE                                                 :Age
-STR_SORT_BY_RELIABILITY                                         :Reliability
-STR_SORT_BY_TOTAL_CAPACITY_PER_CARGOTYPE                        :Total capacity per cargo type
-STR_SORT_BY_MAX_SPEED                                           :Maximum speed
-
+STR_SORT_BY_POPULATION						:{BLACK}Population
+STR_SORT_BY_PRODUCTION						:{BLACK}Production
+STR_SORT_BY_TYPE						:{BLACK}Type
+STR_SORT_BY_TRANSPORTED						:{BLACK}Transported
+STR_SORT_BY_NAME						:{BLACK}Name
+STR_SORT_BY_DROPDOWN_NAME					:Name
+STR_SORT_BY_DATE						:{BLACK}Date
+STR_SORT_BY_UNSORTED						:Unsorted
+STR_SORT_BY_NUMBER						:Number
+STR_SORT_BY_PROFIT_LAST_YEAR					:Profit last year
+STR_SORT_BY_PROFIT_THIS_YEAR					:Profit this year
+STR_SORT_BY_AGE							:Age
+STR_SORT_BY_RELIABILITY						:Reliability
+STR_SORT_BY_TOTAL_CAPACITY_PER_CARGOTYPE			:Total capacity per cargo type
+STR_SORT_BY_MAX_SPEED					:Maximum speed
+STR_SORT_BY_WAITINGCARGO			:Waiting Cargo
+STR_SORT_BY_RATING						:Rating
+STR_SORT_BY_VISITING_VEHICLE 	:Visiting Vehicle
+STR_SORT_BY_DROPDOWN_TYPE			:Type
 ############ range for months starts
 STR_0162_JAN                                                    :Jan
 STR_0163_FEB                                                    :Feb
@@ -557,11 +560,13 @@
 STR_0225                                                        :{BLACK}{DOWNARROW}
 STR_0226_RANDOM_LAND                                            :{BLACK}Random Land
 STR_0227_RESET_LAND                                             :{BLACK}Reset Land
+STR_LOAD_LAND_FROM_PNG                                          :{BLACK}Load Land
 STR_0228_INCREASE_SIZE_OF_LAND_AREA                             :{BLACK}Increase area of land to lower/raise
 STR_0229_DECREASE_SIZE_OF_LAND_AREA                             :{BLACK}Decrease area of land to lower/raise
 STR_022A_GENERATE_RANDOM_LAND                                   :{BLACK}Generate random land
 STR_022B_RESET_LANDSCAPE                                        :{BLACK}Reset landscape
-STR_022C_RESET_LANDSCAPE                                        :{WHITE}Reset Landscape
+STR_022C_RESET_LANDSCAPE                                        :{WHITE}Rebuild Landscape
+STR_LOAD_LANDSCAPE_FROM_PNG                                     :{BLACK}Load land from PNG
 STR_022D_ARE_YOU_SURE_YOU_WANT_TO                               :{WHITE}Are you sure you want to reset the landscape?
 STR_022E_LANDSCAPE_GENERATION                                   :{BLACK}Landscape generation
 STR_022F_TOWN_GENERATION                                        :{BLACK}Town generation
@@ -743,14 +748,20 @@
 STR_02DE_MAP_OF_WORLD                                           :Map of world
 STR_EXTRA_VIEW_PORT                                             :Extra viewport
 STR_SIGN_LIST                                                   :Sign list
+
 STR_02DF_TOWN_DIRECTORY                                         :Town directory
 STR_TOWN_POPULATION                                             :{BLACK}World population: {COMMA}
 STR_EXTRA_VIEW_PORT_TITLE                                       :{WHITE}Viewport {COMMA}
-STR_EXTRA_VIEW_MOVE_VIEW_TO_MAIN                                :{BLACK}Copy to viewport
-STR_EXTRA_VIEW_MOVE_VIEW_TO_MAIN_TT                             :{BLACK}Copy the location of the global view to this viewport
-STR_EXTRA_VIEW_MOVE_MAIN_TO_VIEW                                :{BLACK}Paste from viewport
-STR_EXTRA_VIEW_MOVE_MAIN_TO_VIEW_TT                             :{BLACK}Paste the location of this viewport to the global view
 
+STR_EXTRA_VIEW_MOVE_VIEW_TO_MAIN                                :{BLACK}Go to location
+STR_EXTRA_VIEW_MOVE_VIEW_TO_MAIN_TT                             :{BLACK}Paste the location of this viewport into the global view
+STR_EXTRA_VIEW_MOVE_MAIN_TO_VIEW                                :{BLACK}Set location
+STR_EXTRA_VIEW_MOVE_MAIN_TO_VIEW_TT                             :{BLACK}Copy the location of the global view into this viewport
+ 
+STR_ZOOM_IN_SMALLMAP                             :{BLACK}Zoom in the small map
+STR_ZOOM_OUT_SMALLMAP                             :{BLACK}Zoom out the small map
+STR_RECENTRE_SMALLMAP                             :{BLACK}Recentre the location of the small map  
+
 STR_02E0_CURRENCY_UNITS                                         :{BLACK}Currency units
 STR_02E1                                                        :{BLACK}{SKIP}{STRING}
 STR_02E2_CURRENCY_UNITS_SELECTION                               :{BLACK}Currency units selection
@@ -991,6 +1002,8 @@
 STR_CONFIG_PATCHES_SNOWLINE_HEIGHT                              :{LTBLUE}Snow line height: {ORANGE}{STRING1}
 STR_CONFIG_PATCHES_STATION_SPREAD                               :{LTBLUE}Max station spread: {ORANGE}{STRING1} {RED}Warning: High setting slows game
 STR_CONFIG_PATCHES_SERVICEATHELIPAD                             :{LTBLUE}Service helicopters at helipads automatically: {ORANGE}{STRING1}
+STR_CONFIG_PATCHES_SHOW_TOWN_RATING_VALUES			:{LTBLUE}Show town rating values next to rating: {ORANGE}{STRING}
+#####STR_CONFIG_PATCHES_SHOW_TOWN_RATING_VALUES			:{LTBLUE}Show town rating values next to rating: {ORANGE}{STRING}
 
 STR_CONFIG_PATCHES_MAX_TRAINS                                   :{LTBLUE}Max trains per player: {ORANGE}{STRING1}
 STR_CONFIG_PATCHES_MAX_ROADVEH                                  :{LTBLUE}Max road vehicles per player: {ORANGE}{STRING1}
@@ -1028,6 +1041,8 @@
 STR_CONFIG_PATCHES_SNAP_RADIUS                                  :{LTBLUE}Window snap radius: {ORANGE}{STRING1} px
 STR_CONFIG_PATCHES_SNAP_RADIUS_DISABLED                         :{LTBLUE}Window snap radius: {ORANGE}disabled
 
+STR_CONFIG_PATCHES_DAY_LENGTH					:{LTBLUE}Default day length: {ORANGE}{STRING}
+
 STR_CONFIG_PATCHES_GUI                                          :{BLACK}Interface
 STR_CONFIG_PATCHES_CONSTRUCTION                                 :{BLACK}Construction
 STR_CONFIG_PATCHES_VEHICLES                                     :{BLACK}Vehicles
@@ -1042,6 +1057,12 @@
 STR_CONFIG_PATCHES_QUERY_CAPT                                   :{WHITE}Change setting value
 STR_CONFIG_PATCHES_SERVICE_INTERVAL_INCOMPATIBLE                :{WHITE}Some or all of the default service interval(s) below are incompatible with the chosen setting! 5-90% and 30-800 days are valid
 
+STR_CONFIG_PATCHES_NSR_SPEED                                    :{LTBLUE}Enable new rating for Vehicle-Speed: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_NSR_AGE                                      :{LTBLUE}Enable new rating for Vehicle-Age: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_NSR_WAIT_DAYS                                :{LTBLUE}Enable new rating for days since last pickup: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_NSR_WAIT_CARGO                               :{LTBLUE}Enable new rating for Cargo/Passengers waiting: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_NSR_TOWN_RATING                              :{LTBLUE}Enable new rating for Local Authority Acceptance: {ORANGE}{STRING}
+
 STR_TEMPERATE_LANDSCAPE                                         :Temperate landscape
 STR_SUB_ARCTIC_LANDSCAPE                                        :Sub-arctic landscape
 STR_SUB_TROPICAL_LANDSCAPE                                      :Sub-tropical landscape
@@ -1059,6 +1080,7 @@
 STR_CHEAT_SWITCH_CLIMATE                                        :{LTBLUE}Switch climate: {ORANGE} {STRING}
 STR_CHEAT_CHANGE_DATE                                           :{LTBLUE}Change date: {ORANGE} {DATE_SHORT}
 STR_CHEAT_SETUP_PROD                                            :{LTBLUE}Enable modifying production values: {ORANGE}{STRING1}
+STR_CHEAT_RESET_STATION                                         :{LTBLUE}Enable Resetting of Stations: {ORANGE}{STRING}
 
 STR_HEADING_FOR_WAYPOINT                                        :{LTBLUE}Heading for {WAYPOINT}
 STR_HEADING_FOR_WAYPOINT_VEL                                    :{LTBLUE}Heading for {WAYPOINT}, {VELOCITY}
@@ -1365,6 +1387,15 @@
 STR_CONFIG_PATCHES_MAP_X                                        :{LTBLUE}X-size of map: {ORANGE}{STRING1}
 STR_CONFIG_PATCHES_MAP_Y                                        :{LTBLUE}Y-size of map: {ORANGE}{STRING1}
 
+
+##### PNG-MAP-Loader
+
+STR_PNGMAP_ARE_YOU_SURE                                         :{WHITE}Are you sure you want to load the landscape from map.png?
+STR_PNGMAP_ERROR                                                :{WHITE}Cannot load landscape from PNG...
+STR_PNGMAP_ERR_FILE_NOT_FOUND                                   :{WHITE}...file not found.
+STR_PNGMAP_ERR_IMAGE_TYPE                                       :{WHITE}...wrong file format. 4-bit indexed PNG needed.
+STR_PNGMAP_ERR_MISC                                             :{WHITE}...something just went wrong. Sorry.
+
 ##id 0x0800
 STR_0800_COST                                                   :{TINYFONT}{RED}Cost: {CURRENCY}
 STR_0801_COST                                                   :{RED}Cost: {CURRENCY}
@@ -1454,6 +1485,7 @@
 STR_1816_TREE_LINED_ROAD                                        :Tree-lined road
 STR_1817_ROAD_VEHICLE_DEPOT                                     :Road vehicle depot
 STR_1818_ROAD_RAIL_LEVEL_CROSSING                               :Road/rail level crossing
+STR_TOWN_RATING							:{STRING} {TINYFONT}{BLACK}({COMMA})
 
 ##id 0x2000
 STR_2000_TOWNS                                                  :{WHITE}Towns
@@ -1688,6 +1720,7 @@
 STR_400E_SELECT_NEW_GAME_TYPE                                   :{WHITE}Select New Game Type
 STR_400F_SELECT_SCENARIO_GREEN_PRE                              :{BLACK}Select scenario (green), pre-set game (blue), or random new game
 STR_4010_GENERATE_RANDOM_NEW_GAME                               :Generate random new game
+STR_4011_LOAD_PNG                                              :{WHITE}Load PNG
 
 ##id 0x4800
 STR_4800_IN_THE_WAY                                             :{WHITE}{STRING} in the way
@@ -2393,6 +2426,8 @@
 STR_8830_CAN_T_SEND_TRAIN_TO_DEPOT                              :{WHITE}Can't send train to depot...
 STR_8831_NO_MORE_SPACE_FOR_ORDERS                               :{WHITE}No more space for orders
 STR_8832_TOO_MANY_ORDERS                                        :{WHITE}Too many orders
+STR_INCOMPATIBLE_RAIL_TYPE                           :{WHITE}Incompatible rail type
+
 STR_8833_CAN_T_INSERT_NEW_ORDER                                 :{WHITE}Can't insert new order...
 STR_8834_CAN_T_DELETE_THIS_ORDER                                :{WHITE}Can't delete this order...
 STR_8835_CAN_T_MODIFY_THIS_ORDER                                :{WHITE}Can't modify this order...
@@ -2671,6 +2706,48 @@
 STR_BRIBE_FAILED_2                                              :{WHITE}discovered by a regional investigator
 STR_BUILD_DATE                                                  :{BLACK}Built: {LTBLUE}{DATE_LONG}
 
+STR_RESET_STATION                                               :{BLACK}* RESET *
+STR_RESET_STATION_TIP                                           :{BLACK}When pressing this button the Station is reset, as if it was newly built.
+STR_CAN_T_RESET_STATION                                         :{WHITE}Can't reset station...
+
+STR_STATION_STATS                                               :{BLACK}Statistics
+STR_STATION_GOODS_IN                                            :{BLACK}In
+STR_STATION_GOODS_OUT                                           :{BLACK}Out
+STR_STATION_GOODS_TRANSFER                                      :{BLACK}Transit
+STR_VEHICLES                                                    :{BLACK}Vehicles
+STR_SCHEDULED                                                   :{BLACK}Scheduled
+STR_VEHICLES_MONTH                                              :{BLACK}Last Month
+STR_VEHICLES_CURRENT                                            :{BLACK}Current Month
+STR_RVS                                                         :{BLACK}Road Vehicles
+STR_BUSSES                                                      :{BLACK}Buses
+STR_TRUCKS                                                      :{BLACK}Trucks
+STR_NUMBER                                                      :{YELLOW}{COMMA}
+STR_STATION_MONTHS                                              :{BLACK}Cargo amount [This Month (Last Month) ]
+STR_CNUMBERS                                                    :{WHITE}{COMMA} {TINYFONT}{BLACK}({YELLOW}{COMMA}{BLACK})
+STR_VEHICLES_MONTHS_AVERAGE                                     :{BLACK}Average / Min / Max
+STR_MONTHS_COUNTED_NUM                                          :{BLACK}Months Counted: {GOLD}{COMMA}
+STR_MONTHS_TINY                                                 :{TINYFONT}{BLACK}Months
+STR_STATION_MONTHS_AVERAGE                                      :{BLACK}Cargo amount [Average (Min/Max) per Month]
+STR_TOGGLE_MINMAX                                               :{BLACK}Toggle  -This/Last Month-   or   -Average/Min/Max-   Stats
+STR_RESET_STATISTICS                                            :{BLACK}Reset Statistics
+STR_AVERAGENUMBERS                                              :{SILVER}{COMMA} {BLACK}{TINYFONT}({ORANGE}{COMMA}{BLACK}/{LTBLUE}{COMMA}{BLACK})
+STR_BLACK_SLASH                                                 :{BLACK}/
+STR_TINY_GOLD_NUMBER                                            :{TINYFONT}{GOLD}{COMMA}
+STR_SILVER_NUMBER                                               :{SILVER}{COMMA}
+STR_ORANGE_NUMBER                                               :{ORANGE}{COMMA}
+STR_LTBLUE_NUMBER                                               :{LTBLUE}{COMMA}
+STR_WHITE_NUMBER                                                :{WHITE}{COMMA}
+STR_STS_NOT_SCHEDULED                                           :{BLACK}Not Scheduled
+STR_AVERAGE                                                     :{BLACK}Average
+STR_MINIMUM                                                     :{BLACK}Minimum
+STR_MAXIMUM                                                     :{BLACK}Maximum
+STR_STS_VEHICLES_LAST_YEAR                                      :{BLACK}Last Year
+STR_STS_VEHICLES_THIS_YEAR                                      :{BLACK}This Year
+STR_STS_YEARS_COUNTED_NUM                                       :{BLACK}Years Counted: {GOLD}{COMMA}
+STR_STS_TOGGLE_MONTH_YEAR                                       :{BLACK}Toggle  -Monthly-   or   -Yearly-   Stats
+STR_STATION_COVERAGE                                            :{BLACK}Coverage
+STR_VEHICLE_CARGO_LIST                                          :{BLACK}Show List of Scheduled Vehicles for this Cargo-Type
+
 STR_PERFORMANCE_DETAIL                                          :{WHITE}Detailed performance rating
 STR_PERFORMANCE_DETAIL_KEY                                      :{BLACK}Detail
 STR_PERFORMANCE_DETAIL_AMOUNT_CURRENCY                          :{BLACK}({CURRCOMPACT}/{CURRCOMPACT})
@@ -2750,6 +2827,69 @@
 STR_SHORT_DATE                                                  :{WHITE}{DATE_TINY}
 STR_SIGN_LIST_CAPTION                                           :{WHITE}Sign List - {COMMA} Sign{P "" s}
 
+############ subsidiaries strings
+STR_SUBSIDIARIES                                                :{BLACK}Subsidiaries
+STR_SUBSIDIARIES_MANAGEMENT                                     :{BLACK}Manage your subsidiaries
+STR_YOUR_SUBSIDIARIES                                           :{WHITE}Your Subsidiaries
+STR_SUBSIDIARIES_ADMINISTRATE                                   :{BLACK}Administrate
+STR_SUBSIDIARIES_SEND_MONEY                                     :{BLACK}Send Cash
+STR_SUBSIDIARIES_REQUEST_MONEY                                  :{BLACK}Get Cash
+STR_SUBSIDIARIES_MERGER                                         :{BLACK}Merger
+STR_SUBSIDIARIES_ADMINISTRATE_E                                 :{BLACK}Administrate (play as) the selected subsidiary
+STR_SUBSIDIARIES_SEND_MONEY_E                                   :{BLACK}Send Cash to the selected subsidiary, banks will keep 6% of the transaction amount as service charge
+STR_SUBSIDIARIES_REQUEST_MONEY_E                                :{BLACK}Get Cash from the selected subsidiary, banks will keep 6% of the transaction amount as service charge
+STR_SUBSIDIARIES_MERGER_E                                       :{BLACK}Perform a full merger of the current subsidiary and the selected one
+STR_SUBSIDIARY_OF                                               :{WHITE}(Subsidiary of {STRING})
+STR_SUBSIDIARY_CREATE                                           :{BLACK}Create
+STR_SUBSIDIARY_CREATE_E                                         :{BLACK}Create a new subsidiary company from scratch
+STR_SUBSIDIARY_ADD_CASH                                         :{BLACK}Add {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_ADD_CASH_E                                       :{BLACK}Increase the amount to be transfered
+STR_SUBSIDIARY_SUB_CASH                                         :{BLACK}Subtract {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_SUB_CASH_E                                       :{BLACK}Decrease the amount to be transfered
+STR_SUBSIDIARY_SEND_TO                                          :{WHITE}Send cash to {STRING}
+STR_SUBSIDIARY_REQUEST_FROM                                     :{WHITE}Request cash from {STRING}
+STR_SUBSIDIARY_SEND_AMOUNT                                      :{WHITE}Amount to be sent:
+STR_SUBSIDIARY_REQUEST_AMOUNT                                   :{WHITE}Amount which will be recieved:
+STR_SUBSIDIARY_AMOUNT_SEND                                      :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_GET                                       :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_TARGET                                    :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_GET_ERROR                                        :{WHITE}Impossible to retrieve this amount...
+STR_SUBSIDIARY_SEND_ERROR                                       :{WHITE}Impossible to send this amount...
+STR_SUBSIDIARY_PLAYER_ERROR                                     :{WHITE}Cannot create subsidiary...
+STR_SUBSIDIARY_ASK_MERGER                                       :{YELLOW}Are you sure you want to merge {STRING1} into {STRING2}?
+STR_SUBSIDIARY_ASK_MERGER_TITLE                                 :{WHITE}Perform Merger
+STR_SUBSIDIARY_TARGET_HAS                                       :{WHITE}Target subsidiary current bank balance:
+STR_SUBSIDIARY_TOGGLE                                           :{BLACK}Toggle this subsidiary
+STR_SUBSIDIARY_CASH_REQUEST                                     :{WHITE}Incoming cash request
+STR_SUBSIDIARY_CASH_REQUESTED                                   :{WHITE}{STRING} Requested {CURRENCY64}. Do you accept sending this amount?
+STR_SUBSIDIARY_CASH_REQUEST_DENIED                              :{WHITE}Your cash request was denied
+STR_SUBSIDIARY_CASH_REQUEST_GRANTED                             :{WHITE}Your cash request was granted
+STR_SUBSIDIARY_SELL_SHARE_TITLE                                 :{WHITE}Incomming request
+STR_SUBSIDIARY_SELL_SHARE                                       :{WHITE}{STRING} would like to buy 25% of your shares. Do you accept selling those shares?
+STR_SUBSIDIARY_SELL_SHARE_GRANTED                               :{WHITE}Your offer was accepted
+STR_SUBSIDIARY_SELL_SHARE_DENIED                                :{WHITE}Your offer was denied
+STR_TOO_MANY_PLAYERS                                            :{WHITE}Too many players
+
+STR_CONFIG_PATCHES_SUBSIDIARIES                                 :{LTBLUE}Enable susidiaries management: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_ST_TAX                                :{LTBLUE}Tax vehicles stopping in a subsidiary's station: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_SUB_CONFIG        :{LTBLUE}Base tax for subsidiaries shared tracks usage: {ORANGE}{STRING} per tile
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_CONFIG            :{LTBLUE}Allow track sharing for everyone: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_OTHER_CONFIG      :{LTBLUE}Base tax for shared tracks usage: {ORANGE}{STRING} per tile
+STR_CONFIG_PATCHES_SUBS_ALLOW_REMOVE                            :{LTBLUE}Allow subsidiaries to remove each others tracks and roads: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_COOP                                         :{BLACK}Cooperation
+STR_CONFIG_PATCHES_SHARED_STATIONS                              :{LTBLUE}Allow station sharing for everyone: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_STATIONS_SUBS_CARGOTAX                :{LTBLUE}Base tax for subsidiaries cargo pickup: {ORANGE}{STRING} per unit
+STR_CONFIG_PATCHES_SHARED_STATIONS_OTHERS_CARGOTAX              :{LTBLUE}Base tax for cargo pickup: {ORANGE}{STRING} per unit
+STR_CONFIG_PATCHES_SHARED_ST_TAX_OTHERS                         :{LTBLUE}Tax vehicles stopping in another company's station: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_YEARS_OF_PROTECTION                          :{LTBLUE}Years of shares protection:{ORANGE}{STRING} year(s)
+STR_CONFIG_PATCHES_SHARED_DEPOTS                                :{LTBLUE}Allow depot sharing for everyone: {ORANGE}{STRING}
+
+STR_TRAINS_SUB                                                  :{WHITE}{COMMA} train{P "" s} out of {COMMA} ({COMMA}%)
+STR_ROAD_VEHICLES_SUB                                           :{WHITE}{COMMA} road vehicle{P "" s} out of {COMMA} ({COMMA}%)
+STR_AIRCRAFT_SUB                                                :{WHITE}{COMMA} aircraft out of {COMMA} ({COMMA}%)
+STR_SHIPS_SUB                                                   :{WHITE}{COMMA} ship{P "" s} out of {COMMA} ({COMMA}%)
+############ end of subsidiaries strings
+
 ############ Lists rail types
 
 STR_RAIL_VEHICLES                                               :Rail Vehicles
@@ -2771,3 +2911,48 @@
 STR_PURCHASE_INFO_COST_SPEED                                    :{BLACK}Cost: {GOLD}{CURRENCY}{BLACK} Speed: {GOLD}{VELOCITY}
 STR_PURCHASE_INFO_AIRCRAFT_CAPACITY                             :{BLACK}Capacity: {GOLD}{COMMA} passengers, {COMMA} bags of mail
 STR_PURCHASE_INFO_PWAGPOWER_PWAGWEIGHT                          :{BLACK}Powered Wagons: {GOLD}+{COMMA}hp{BLACK} Weight: {GOLD}+{COMMA}t
+
+############# Signal GUI
+STR_SIGNAL_SELECTION                                            :{WHITE}Signal Type Selection
+STR_SIGNAL_PRESIG_COMBO                                         :{BLACK}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{SKIP}{STRING}
+STR_SIGNAL_NORMAL                                               :Normal Signals
+STR_SIGNAL_ENTRANCE                                             :Entrance Presignals
+STR_SIGNAL_COMBO                                                :Combo Presignals
+STR_SIGNAL_EXIT                                                 :Exit Presignals
+STR_SIGNAL_PBS                                                  :PBS Signals
+STR_SIGNAL_COMPLETION                                           :{BLACK}Auto Completion
+STR_SIGNAL_DENSITY_DESC                                         :{BLACK}Signal Density: 
+STR_SIGNAL_DENSITY_TILES                                        :{GOLD}{NUM} tile(s)
+############ Leave those lines in this order!!
+STR_SIGNAL_TYPE_STANDARD                                        :{GOLD}Light Signals
+STR_SIGNAL_TYPE_SEMAPHORES                                      :{GOLD}Semaphores
+############ End of leave-in-this-order
+STR_SIGNAL_TYPE_TIP                                             :{BLACK}Select signal type
+STR_SIGNAL_DENSITY_TIP                                          :{BLACK}Select signal density for dragging
+STR_SIGNAL_COMPLETION_TIP                                       :{BLACK}With autocompletion on, signals will be built in the direction you were dragging, following the track until a junction is encountered.
+STR_SIGNAL_PRESIG_TIP                                           :{BLACK}Select the type of presignal, if any
+############# End Signal GUI
+############# Station Rating
+STR_STATION_RATING_DETAIL                                          :{WHITE}Detailed service ratings - {1:STATIONFEATURES}
+STR_STATION_RATING_DETAIL_KEY                                      :{BLACK}Detail
+STR_STATION_RATING_DETAIL_SCORES                                   :{BLACK}({NUM}/{NUM})
+STR_STATION_RATING_DETAIL_PERCENT                                  :{WHITE}{NUM}%
+STR_STATION_RATING_DETAIL_INT                                      :{BLACK}{NUM}
+STR_STATION_RATING_DETAIL_WAITING                                  :{BLACK}Waiting cargo:
+STR_STATION_RATING_DETAIL_WAITING_EX                               :{BLACK}{STRING}
+STR_STATION_RATING_DETAIL_SPEED                                    :{BLACK}Last speed:
+STR_STATION_RATING_DETAIL_SPEED_EX                                 :{BLACK}{NUM}
+STR_STATION_RATING_DETAIL_AGE                                      :{BLACK}Last age:
+STR_STATION_RATING_DETAIL_AGE_EX                                   :{BLACK}{COMMA} year(s)
+STR_STATION_RATING_DETAIL_PICKUP                                   :{BLACK}Days since pickup:
+STR_STATION_RATING_DETAIL_PICKUP_EX                                :{BLACK}{COMMA} day(s)
+STR_STATION_RATING_DETAIL_OTHER                                    :{BLACK}Other ratings:
+STR_STATION_RATING_DETAIL_TOTAL                                    :{BLACK}Total rating:
+STR_STATION_RATING_DETAIL_SPEED_TIP                                :{BLACK}Maximum speed of the last vehicle entering the station (internal value, clipped at 255)
+STR_STATION_RATING_DETAIL_AGE_TIP                                  :{BLACK}Age of the last vehicle entering the station
+STR_STATION_RATING_DETAIL_PICKUP_TIP                               :{BLACK}Number of days since the last cargo pickup
+STR_STATION_RATING_DETAIL_WAITING_TIP                              :{BLACK}Cargo waiting at the station
+STR_STATION_RATING_DETAIL_OTHER_TIP                                :{BLACK}Other ratings are mainly if the town of the station has a statue of the company owner
+STR_STATION_RATING_DETAIL_TOTAL_TIP                                :{BLACK}Total rating - The station rating is updated according to this value in small increments
+STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP                         :{BLACK}Click here to toggle cargo type
+############ End Station Rating
Index: lang/czech.txt
===================================================================
--- lang/czech.txt	(Revision 2953)
+++ lang/czech.txt	(Arbeitskopie)
@@ -2803,10 +2803,56 @@
 STR_REPLACE_HELP_RAILTYPE                                       :{BLACK}Vyber typ kolej, pro kter chce vybrat lokomotivy na vymenu
 STR_REPLACE_HELP_REPLACE_INFO_TAB                               :{BLACK}Tady je zobrazeno, za jakou lokomotivu se ta v levm seznamu vymenuje
 STR_REPLACE_HELP                                                :{BLACK}Tato monost hry ti umoznuje vybrat typ lokomotivy, kter nech vymenit za jin. To se bude automaticky provadet, kdy lokomotiva zajede do depa.
-
 STR_SHORT_DATE                                                  :{WHITE}{DATE_TINY}
 STR_SIGN_LIST_CAPTION                                           :{WHITE}Seznam popisku - {COMMA} popis{P ek ky ku}
 
+############ Subsidiaries strings
+STR_SUBSIDIARIES                                                :{BLACK}Podspolecnosti
+STR_SUBSIDIARIES_MANAGEMENT                                     :{BLACK}Spravovat dcerine spolecnosti
+STR_YOUR_SUBSIDIARIES                                           :{WHITE}Tvoje dcerine spolecnosti
+STR_SUBSIDIARIES_ADMINISTRATE                                   :{BLACK}Spravovat
+STR_SUBSIDIARIES_SEND_MONEY                                     :{BLACK}Odeslat penize
+STR_SUBSIDIARIES_REQUEST_MONEY                                  :{BLACK}Vyzadat penize
+STR_SUBSIDIARIES_MERGER                                         :{BLACK}Slouceni
+STR_SUBSIDIARIES_ADMINISTRATE_E                                 :{BLACK}Spravovat (hrat za) vybranou spolecnost
+STR_SUBSIDIARIES_SEND_MONEY_E                                   :{BLACK}Odeslat penize zvolene spolecnosti, bankovni poplatky maji hodnotu 6% z prevadene castky
+STR_SUBSIDIARIES_REQUEST_MONEY_E                                :{BLACK}Ziskat penize ze zvolene spolecnosti, bankovni poplatky maji hodnotu 6% z prevadene castky
+STR_SUBSIDIARIES_MERGER_E                                       :{BLACK}Provst kompletn sloucen teto spolecnsti s vybranou
+STR_SUBSIDIARY_OF                                               :{WHITE}(Dcerina spolecnost pod {STRING})
+STR_SUBSIDIARY_CREATE                                           :{BLACK}Vytvorit
+STR_SUBSIDIARY_CREATE_E                                         :{BLACK}Vytvori novou dcerinou spolecnost na zelene louce
+STR_SUBSIDIARY_ADD_CASH                                         :{BLACK}Pridat {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_ADD_CASH_E                                       :{BLACK}Pridat castku urcenou k prevodu
+STR_SUBSIDIARY_SUB_CASH                                         :{BLACK}Odebrat {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_SUB_CASH_E                                       :{BLACK}Odebrat castku urcenou k prevodu
+STR_SUBSIDIARY_SEND_TO                                          :{WHITE}Zaslat peniza pro {STRING}
+STR_SUBSIDIARY_REQUEST_FROM                                     :{WHITE}Vyzadat penize od {STRING}
+STR_SUBSIDIARY_SEND_AMOUNT                                      :{WHITE}Castka k odeslani:
+STR_SUBSIDIARY_REQUEST_AMOUNT                                   :{WHITE}Castka pripsana na ucet:
+STR_SUBSIDIARY_AMOUNT_SEND                                      :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_GET                                       :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_TARGET                                    :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_GET_ERROR                                        :{WHITE}Neni mozne ziskat takovou castku...
+STR_SUBSIDIARY_SEND_ERROR                                       :{WHITE}Neni mozne odeslat takovou castku...
+STR_SUBSIDIARY_PLAYER_ERROR                                     :{WHITE}Neni mozne vytvorit dcerinou spolecnost...
+STR_SUBSIDIARY_ASK_MERGER                                       :{YELLOW}Opravdu chces sloucit {STRING} do {STRING}?
+STR_SUBSIDIARY_ASK_MERGER_TITLE                                 :{WHITE}Provest spojeni
+STR_SUBSIDIARY_TARGET_HAS                                       :{WHITE}Bank. bilance prijemce:
+STR_SUBSIDIARY_TOGGLE                                           :{BLACK}Prepnout na tuto spolecnost
+STR_SUBSIDIARY_CASH_REQUEST                                     :{WHITE}Prichozi zadost o financni vypomoc
+STR_SUBSIDIARY_CASH_REQUESTED                                   :{WHITE}{STRING} Pozaduje {CURRENCY64}. Souhlasis s odeslanim takove cestky?
+STR_SUBSIDIARY_CASH_REQUEST_DENIED                              :{WHITE}Pozadavek na financni hotovost byl zamitnut
+STR_SUBSIDIARY_CASH_REQUEST_GRANTED                             :{WHITE}Penize byly prislibeny
+STR_SUBSIDIARY_SELL_SHARE_TITLE                                 :{WHITE}Prichozi zadost
+STR_SUBSIDIARY_SELL_SHARE                                       :{WHITE}{STRING} si chce koupit 25% podil ve tve spolecnosti. Povolis odkup tohoto podilu?
+STR_SUBSIDIARY_SELL_SHARE_GRANTED                               :{WHITE}Tvoje nabidka byla zamitnuta
+STR_SUBSIDIARY_SELL_SHARE_DENIED                                :{WHITE}Tvoje nabidka byla prijata
+STR_TOO_MANY_PLAYERS                                            :{WHITE}Prilis mnoho hracu
+
+STR_CONFIG_PATCHES_SUBSIDIARIES                                 :{LTBLUE}Povolit spravu dcerinych spolecnosti: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_ST_TAX                                :{LTBLUE}Poplatek za komercni pouziti stanice: {ORANGE}{STRING}%
+################### end of subs strings
+
 ############ Lists rail types
 
 STR_RAIL_VEHICLES                                               :Zeleznicni lokomotivy
Index: lang/brazilian_portuguese.txt
===================================================================
--- lang/brazilian_portuguese.txt	(Revision 2953)
+++ lang/brazilian_portuguese.txt	(Arbeitskopie)
@@ -2750,6 +2750,69 @@
 STR_SHORT_DATE                                                  :{WHITE}{DATE_TINY}
 STR_SIGN_LIST_CAPTION                                           :{WHITE}Lista de sinais - {COMMA} Sinais
 
+############ subsidiaries strings
+STR_SUBSIDIARIES                                                :{BLACK}Filiais
+STR_SUBSIDIARIES_MANAGEMENT                                     :{BLACK}Administrao das Filiais
+STR_YOUR_SUBSIDIARIES                                           :{WHITE}Suas Filiais
+STR_SUBSIDIARIES_ADMINISTRATE                                   :{BLACK}Administre
+STR_SUBSIDIARIES_SEND_MONEY                                     :{BLACK}Enviar Dinheiro
+STR_SUBSIDIARIES_REQUEST_MONEY                                  :{BLACK}Receber Dinheiro
+STR_SUBSIDIARIES_MERGER                                         :{BLACK}Fuso
+STR_SUBSIDIARIES_ADMINISTRATE_E                                 :{BLACK}Administre (jogue como) a Filial selecionada
+STR_SUBSIDIARIES_SEND_MONEY_E                                   :{BLACK}Enviar Dinheiro para a Filial selecionada. O banco ir taxar em 6% essa transao.
+STR_SUBSIDIARIES_REQUEST_MONEY_E                                :{BLACK}Receber Dinheiro da Filial selecionada. O banco ir taxar em 6% essa transao.
+STR_SUBSIDIARIES_MERGER_E                                       :{BLACK}Efetuar fuso completa entre a Filial atual e a selecionada.
+STR_SUBSIDIARY_OF                                               :{WHITE}(Filial de {STRING})
+STR_SUBSIDIARY_CREATE                                           :{BLACK}Criar
+STR_SUBSIDIARY_CREATE_E                                         :{BLACK}Criar uma nova companhia Filial  partir do zero.
+STR_SUBSIDIARY_ADD_CASH                                         :{BLACK}Adicionar {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_ADD_CASH_E                                       :{BLACK}Aumentar a quantia a ser transferida
+STR_SUBSIDIARY_SUB_CASH                                         :{BLACK}Retirar {SKIP}{SKIP}{SKIP}{CURRENCY64}
+STR_SUBSIDIARY_SUB_CASH_E                                       :{BLACK}Diminuir a quantia a ser transferida
+STR_SUBSIDIARY_SEND_TO                                          :{WHITE}Enviar dinheiro para {STRING}
+STR_SUBSIDIARY_REQUEST_FROM                                     :{WHITE}Pedir dinheiro a {STRING}
+STR_SUBSIDIARY_SEND_AMOUNT                                      :{WHITE}Quantia a ser enviada:
+STR_SUBSIDIARY_REQUEST_AMOUNT                                   :{WHITE}Quantia que ser recebida:
+STR_SUBSIDIARY_AMOUNT_SEND                                      :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_GET                                       :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_AMOUNT_TARGET                                    :{YELLOW}{CURRENCY64}
+STR_SUBSIDIARY_GET_ERROR                                        :{WHITE}Impossvel receber essa quantia...
+STR_SUBSIDIARY_SEND_ERROR                                       :{WHITE}Impossvel enviar essa quantia...
+STR_SUBSIDIARY_PLAYER_ERROR                                     :{WHITE}Impossvel criar Filial...
+STR_SUBSIDIARY_ASK_MERGER                                       :{YELLOW}Voc tem certeza que quer fundir {STRING} com {STRING}?
+STR_SUBSIDIARY_ASK_MERGER_TITLE                                 :{WHITE}Efetuar Fuso
+STR_SUBSIDIARY_TARGET_HAS                                       :{WHITE}Balano bancrio da Filial alvo:
+STR_SUBSIDIARY_TOGGLE                                           :{BLACK}Ativar esta Filial
+STR_SUBSIDIARY_CASH_REQUEST                                     :{WHITE}Pedido de dinheiro encaminhado
+STR_SUBSIDIARY_CASH_REQUESTED                                   :{WHITE}{STRING} Requisitou {CURRENCY64}. Voc aceita enviar esta quantia?
+STR_SUBSIDIARY_CASH_REQUEST_DENIED                              :{WHITE}Sua requisio monetria foi negada
+STR_SUBSIDIARY_CASH_REQUEST_GRANTED                             :{WHITE}Sua requisio monetria foi aceita
+STR_SUBSIDIARY_SELL_SHARE_TITLE                                 :{WHITE}Pedido de negociao
+STR_SUBSIDIARY_SELL_SHARE                                       :{WHITE}{STRING} quer adquirir 25% das suas aes. Voc aceita vender estas aes?
+STR_SUBSIDIARY_SELL_SHARE_GRANTED                               :{WHITE}Sua oferta foi aceita
+STR_SUBSIDIARY_SELL_SHARE_DENIED                                :{WHITE}Sua oferta foi negada
+STR_TOO_MANY_PLAYERS                                            :{WHITE}Excesso de Jogadores
+
+STR_CONFIG_PATCHES_SUBSIDIARIES                                 :{LTBLUE}Ativar administrao de Filiais: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_ST_TAX                                :{LTBLUE}Taxar veculos de uma Filial parando numa estao: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_SUB_CONFIG        :{LTBLUE}Taxa base para as Filiais pelo uso de linhas compartilhadas: {ORANGE}{STRING} por quadrado
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_CONFIG            :{LTBLUE}Permitir compartilhamneto de linhas para todos: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_OTHER_CONFIG      :{LTBLUE}Taxa base para o uso de linhas compartilhadas: {ORANGE}{STRING} por quadrado
+STR_CONFIG_PATCHES_SUBS_ALLOW_REMOVE                            :{LTBLUE}Permitir s Filiais remover linhas e estradas uma das outras: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_COOP                                         :{BLACK}Cooperao
+STR_CONFIG_PATCHES_SHARED_STATIONS                              :{LTBLUE}Permitir compartilhamento de estaes para todos: {ORANGE}{STRING}
+STR_CONFIG_PATCHES_SHARED_STATIONS_SUBS_CARGOTAX                :{LTBLUE}Taxa base para retirada de mercadorias pelas Filiais: {ORANGE}{STRING} por unidade
+STR_CONFIG_PATCHES_SHARED_STATIONS_OTHERS_CARGOTAX              :{LTBLUE}Taxa base para retirada de mercadorias: {ORANGE}{STRING} por unidade
+STR_CONFIG_PATCHES_SHARED_ST_TAX_OTHERS                         :{LTBLUE}Taxar veculos parando na estao de outra companhia: {ORANGE}{STRING}%
+STR_CONFIG_PATCHES_YEARS_OF_PROTECTION                          :{LTBLUE}Anos com as aes protegidas:{ORANGE}{STRING} ano(s)
+STR_CONFIG_PATCHES_SHARED_DEPOTS                                :{LTBLUE}Permitir o compartilhamento de depostos para todos: {ORANGE}{STRING}
+
+STR_TRAINS_SUB                                                  :{WHITE}{COMMA} tre{P m ns} fora de {COMMA} ({COMMA}%)
+STR_ROAD_VEHICLES_SUB                                           :{WHITE}{COMMA} veculo{P "" s} de estrada fora de {COMMA} ({COMMA}%)
+STR_AIRCRAFT_SUB                                                :{WHITE}{COMMA} aeronave{P "" s} fora de {COMMA} ({COMMA}%)
+STR_SHIPS_SUB                                                   :{WHITE}{COMMA} barco{P "" s} fora de {COMMA} ({COMMA}%)
+############ end of subsidiaries strings
+
 ############ Lists rail types
 
 STR_RAIL_VEHICLES                                               :Comboios
Index: network_udp.c
===================================================================
--- network_udp.c	(Revision 2953)
+++ network_udp.c	(Arbeitskopie)
@@ -68,8 +68,8 @@
 	NetworkSend_uint8 (packet, _network_game_info.clients_max);
 	NetworkSend_uint8 (packet, _network_game_info.clients_on);
 	NetworkSend_uint8 (packet, _network_game_info.spectators_on);
-	NetworkSend_uint16(packet, _network_game_info.game_date);
-	NetworkSend_uint16(packet, _network_game_info.start_date);
+	NetworkSend_uint32(packet, _network_game_info.game_date);
+	NetworkSend_uint32(packet, _network_game_info.start_date);
 	NetworkSend_string(packet, _network_game_info.map_name);
 	NetworkSend_uint16(packet, _network_game_info.map_width);
 	NetworkSend_uint16(packet, _network_game_info.map_height);
@@ -103,7 +103,7 @@
 	// Find next item
 	item = NetworkGameListAddItem(inet_addr(inet_ntoa(client_addr->sin_addr)), ntohs(client_addr->sin_port));
 
-	if (game_info_version == 1) {
+	if (game_info_version >= 1) {
 		NetworkRecv_string(&_udp_cs, p, item->info.server_name, sizeof(item->info.server_name));
 		NetworkRecv_string(&_udp_cs, p, item->info.server_revision, sizeof(item->info.server_revision));
 		item->info.server_lang   = NetworkRecv_uint8(&_udp_cs, p);
@@ -111,8 +111,13 @@
 		item->info.clients_max   = NetworkRecv_uint8(&_udp_cs, p);
 		item->info.clients_on    = NetworkRecv_uint8(&_udp_cs, p);
 		item->info.spectators_on = NetworkRecv_uint8(&_udp_cs, p);
-		item->info.game_date     = NetworkRecv_uint16(&_udp_cs, p);
-		item->info.start_date    = NetworkRecv_uint16(&_udp_cs, p);
+		if (game_info_version == 1) {
+			item->info.game_date     = NetworkRecv_uint16(&_udp_cs, p) + (1920 * 365.25);
+			item->info.start_date    = NetworkRecv_uint16(&_udp_cs, p) + (1920 * 365.25);
+		} else {
+			item->info.game_date     = NetworkRecv_uint32(&_udp_cs, p);
+			item->info.start_date    = NetworkRecv_uint32(&_udp_cs, p);
+		}
 		NetworkRecv_string(&_udp_cs, p, item->info.map_name, sizeof(item->info.map_name));
 		item->info.map_width     = NetworkRecv_uint16(&_udp_cs, p);
 		item->info.map_height    = NetworkRecv_uint16(&_udp_cs, p);
@@ -168,7 +173,7 @@
 		NetworkSend_uint8 (packet, current);
 
 		NetworkSend_string(packet, _network_player_info[player->index].company_name);
-		NetworkSend_uint8 (packet, _network_player_info[player->index].inaugurated_year);
+		NetworkSend_uint32(packet, _network_player_info[player->index].inaugurated_year);
 		NetworkSend_uint64(packet, _network_player_info[player->index].company_value);
 		NetworkSend_uint64(packet, _network_player_info[player->index].money);
 		NetworkSend_uint64(packet, _network_player_info[player->index].income);
Index: variables.h
===================================================================
--- variables.h	(Revision 2953)
+++ variables.h	(Arbeitskopie)
@@ -37,8 +37,11 @@
 // Pointer to one of the two _opt OR _opt_newgame structs
 VARDEF GameOptions *_opt_ptr;
 
+
+//VARDEF CurrencySpec _currency_specs[24];
+
 // Current date
-VARDEF uint16 _date;
+VARDEF uint32 _date;
 VARDEF uint16 _date_fract;
 
 // Amount of game ticks
@@ -134,7 +137,7 @@
 	uint16 servint_ships;		// service interval for ships
 
 	bool autorenew;
-	int16 autorenew_months;
+	uint32 autorenew_months;
 	int32 autorenew_money;
 
 	byte pf_maxdepth;				// maximum recursion depth when searching for a train route for new pathfinder
@@ -173,6 +176,19 @@
 	byte drag_signals_density; // many signals density
 	bool ainew_active;  // Is the new AI active?
 
+	bool subsidiaries;
+	bool allow_track_removal;
+	byte shared_stations_tax;
+	int32 shared_tracks_tax_subsidiary;
+	bool shared_tracks;
+	int32 shared_tracks_tax_others;
+	bool shared_stations;
+	byte shared_stations_tax_others;
+	int32 shared_stations_pickuptax_subsidiary;
+	int32 shared_stations_pickuptax_others;
+	byte years_of_protection;
+	bool shared_depots;
+
 	/*
 	 * New Path Finding
 	 */
@@ -197,8 +213,17 @@
 	uint32 npf_water_curve_penalty; /* The penalty for curves */
 	uint32 npf_road_curve_penalty; /* The penalty for curves */
  	uint32 npf_crossing_penalty; /* The penalty for level crossings */
+	uint32 npf_busy_road_penalty; /* The penalty for busy roads */
 
 	bool population_in_label; // Show the population of a town in his label?
+
+	bool show_town_rating_value; 		// Shows the rating value in a number format next to the Very Poor, Good... for town ratings.
+	uint8 day_length;		// Multiplyer for length of one day
+	bool nsr_speed;			// new station rating: vehicle speed
+	bool nsr_age;			// new station rating: vehicle age
+	bool nsr_wait_days;		// new station rating: days since last pickup
+	bool nsr_wait_cargo;	// new station rating: amount of cargo waiting
+	bool nsr_town_rating;	// new station rating: include local authority rating
 } Patches;
 
 VARDEF Patches _patches;
@@ -224,6 +249,8 @@
 	Cheat switch_climate;
 	Cheat change_date;				//changes date ingame
 	Cheat setup_prod;				//setup raw-material production in game
+	Cheat day_length;				// change day length
+	Cheat reset_station;		// allow resetting of Stations
 } Cheats;
 
 VARDEF Cheats _cheats;
@@ -247,7 +274,7 @@
 
 
 // NOSAVE: can be determined from _date
-VARDEF byte _cur_year;
+VARDEF uint32 _cur_year;
 VARDEF byte _cur_month;
 
 VARDEF uint32 _frame_counter;
@@ -314,6 +341,8 @@
 
 VARDEF char _ini_videodriver[16], _ini_musicdriver[16], _ini_sounddriver[16];
 
+VARDEF bool _show_average_stats; // show Average Stats for Station-Stats?
+
 // debug features
 VARDEF char _savedump_path[64];
 VARDEF uint _savedump_first, _savedump_freq, _savedump_last;
Index: players.c
===================================================================
--- players.c	(Revision 2953)
+++ players.c	(Arbeitskopie)
@@ -21,6 +21,7 @@
 #include "saveload.h"
 #include "command.h"
 #include "sound.h"
+#include "economy.h"
 #include "network.h"
 #include "variables.h"
 #include "ai/ai.h"
@@ -274,8 +275,7 @@
 bool CheckOwnership(byte owner)
 {
 	assert(owner <= OWNER_WATER);
-
-	if (owner == _current_player)
+	if (IsSisterCompany(owner, _current_player))
 		return true;
 	_error_message = STR_013B_OWNED_BY;
 	GetNameOfOwner(owner, 0);
@@ -290,6 +290,7 @@
 
 	if (owner == _current_player)
 		return true;
+
 	_error_message = STR_013B_OWNED_BY;
 
 	// no need to get the name of the owner unless we're the local player (saves some time)
@@ -297,6 +298,23 @@
 	return false;
 }
 
+bool CheckSubsidiaryTileOwnership(uint tile)
+{
+	byte owner = GetTileOwner(tile);
+
+	assert(owner <= OWNER_WATER);
+
+	if (IsSisterCompany(owner, _current_player))
+		return true;
+
+	_error_message = STR_013B_OWNED_BY;
+
+	// no need to get the name of the owner unless we're the local player (saves some time)
+	if (_current_player == _local_player)
+		GetNameOfOwner(owner, tile);
+	return false;
+}
+
 static void GenerateCompanyName(Player *p)
 {
 	TileIndex tile;
@@ -571,7 +589,7 @@
 StringID GetPlayerNameString(byte player, byte index)
 {
 	if (IS_HUMAN_PLAYER(player) && player < MAX_PLAYERS) {
-		SetDParam(index, player+1);
+		SetDParam(index, (_patches.subsidiaries && !_networking) ? GetMotherCompany(GetPlayer(player))+1 : player +1);
 		return STR_7002_PLAYER;
 	}
 	return STR_EMPTY;
@@ -1108,7 +1126,8 @@
 	SLE_CONDVAR(Player, location_of_house,     SLE_UINT32, 6, 255),
 	SLE_CONDVAR(Player, last_build_coordinate, SLE_FILE_U16 | SLE_VAR_U32, 0, 5),
 	SLE_CONDVAR(Player, last_build_coordinate, SLE_UINT32, 6, 255),
-	SLE_VAR(Player,inaugurated_year,SLE_UINT8),
+	SLE_CONDVAR(Player, inaugurated_year,		SLE_FILE_U8 | SLE_VAR_U32, 0, 15),
+	SLE_CONDVAR(Player, inaugurated_year,		SLE_UINT32, 16, 255),
 
 	SLE_ARR(Player,share_owners,		SLE_UINT8, 4),
 
Index: tunnelbridge_cmd.c
===================================================================
--- tunnelbridge_cmd.c	(Revision 2953)
+++ tunnelbridge_cmd.c	(Arbeitskopie)
@@ -22,6 +22,7 @@
 #include "debug.h"
 #include "variables.h"
 #include "bridge.h"
+#include "economy.h"
 
 #include "table/bridge_land.h"
 #include "table/tunnel_land.h"
@@ -40,6 +41,7 @@
 	   |  |   |    |    maximum speed
 	   |  |   |    |    |  sprite to use in GUI                string with description
 	   |  |   |    |    |  |                                   |                            */
+/*
 	{  0, 0, 16,  80,  32, 0xA24                             , STR_5012_WOODEN              },
 	{  0, 0,  2, 112,  48, 0xA26 | PALETTE_TO_STRUCT_RED     , STR_5013_CONCRETE            },
 	{ 10, 0,  5, 144,  64, 0xA25                             , STR_500F_GIRDER_STEEL        },
@@ -53,6 +55,20 @@
 	{ 75, 2, 16, 255, 320, 0xA28                             , STR_5014_TUBULAR_STEEL       },
 	{ 85, 2, 32, 380, 512, 0xA28 | PALETTE_TO_STRUCT_YELLOW  , STR_5014_TUBULAR_STEEL       },
 	{ 90, 2, 32, 510, 608, 0xA28 | PALETTE_TO_STRUCT_GREY    , STR_BRIDGE_TUBULAR_SILICON   }
+*/
+	{  0, 0, 16,  80,  32, 0xA24                             , STR_5012_WOODEN              },
+	{  0, 0,  2, 112,  48, 0xA26 | PALETTE_TO_STRUCT_RED     , STR_5013_CONCRETE            },
+	{ 1930, 0,  5, 144,  64, 0xA25                             , STR_500F_GIRDER_STEEL        },
+	{  0, 2, 10, 168,  80, 0xA22 | PALETTE_TO_STRUCT_CONCRETE, STR_5011_SUSPENSION_CONCRETE },
+	{ 1930, 3, 16, 185,  96, 0xA22                             , STR_500E_SUSPENSION_STEEL    },
+	{ 1930, 3, 16, 192, 112, 0xA22 | PALETTE_TO_STRUCT_YELLOW  , STR_500E_SUSPENSION_STEEL	},
+	{ 1930, 3,  7, 224, 160, 0xA23                             , STR_5010_CANTILEVER_STEEL    },
+	{ 1930, 3,  8, 232, 208, 0xA23 | PALETTE_TO_STRUCT_BROWN   , STR_5010_CANTILEVER_STEEL    },
+	{ 1930, 3,  9, 248, 240, 0xA23 | PALETTE_TO_STRUCT_RED     , STR_5010_CANTILEVER_STEEL    },
+	{ 1930, 0,  2, 240, 256, 0xA27                             , STR_500F_GIRDER_STEEL        },
+	{ 1985, 2, 16, 255, 320, 0xA28                             , STR_5014_TUBULAR_STEEL       },
+	{ 1995, 2, 32, 380, 512, 0xA28 | PALETTE_TO_STRUCT_YELLOW  , STR_5014_TUBULAR_STEEL       },
+	{ 2010, 2, 32, 510, 608, 0xA28 | PALETTE_TO_STRUCT_GREY    , STR_BRIDGE_TUBULAR_SILICON   }
 };
 
 // calculate the price factor for building a long bridge.
@@ -642,7 +658,7 @@
 	SET_EXPENSES_TYPE(EXPENSES_CONSTRUCTION);
 
 	// in scenario editor you can always destroy tunnels
-	if (_game_mode != GM_EDITOR && !CheckTileOwnership(tile)) {
+	if (_game_mode != GM_EDITOR && !(CheckTileOwnership(tile) || (_patches.allow_track_removal && IsSisterCompany(_current_player, GetTileOwner(tile)))) && GetPlayer(GetTileOwner(tile))->is_active) {
 		if (!(_patches.extra_dynamite || _cheats.magic_bulldozer.value) || !IsTileOwner(tile, OWNER_TOWN))
 			return CMD_ERROR;
 	}
@@ -719,7 +735,8 @@
 		int32 cost;
 
 		// check if we own the tile below the bridge..
-		if (_current_player != OWNER_WATER && (!CheckTileOwnership(tile) || !EnsureNoVehicleZ(tile, TilePixelHeight(tile))))
+		
+		if (_current_player != OWNER_WATER && ((!(CheckTileOwnership(tile) || (_patches.allow_track_removal && IsSisterCompany(_current_player, GetTileOwner(tile))))&& GetPlayer(GetTileOwner(tile))->is_active) || !EnsureNoVehicleZ(tile, TilePixelHeight(tile))))
 			return CMD_ERROR;
 
 		cost = (_m[tile].m5 & 8) ? _price.remove_road * 2 : _price.remove_rail;
@@ -750,7 +767,7 @@
 	tile = FindEdgesOfBridge(tile, &endtile);
 
 	// floods, scenario editor can always destroy bridges
-	if (_current_player != OWNER_WATER && _game_mode != GM_EDITOR && !CheckTileOwnership(tile)) {
+	if (_current_player != OWNER_WATER && _game_mode != GM_EDITOR && !(CheckTileOwnership(tile) || (_patches.allow_track_removal && IsSisterCompany(_current_player, GetTileOwner(tile))))) {
 		if (!(_patches.extra_dynamite || _cheats.magic_bulldozer.value) || !IsTileOwner(tile, OWNER_TOWN))
 			return CMD_ERROR;
 	}
Index: roadveh_cmd.c
===================================================================
--- roadveh_cmd.c	(Revision 2953)
+++ roadveh_cmd.c	(Arbeitskopie)
@@ -16,9 +16,11 @@
 #include "npf.h"
 #include "player.h"
 #include "sound.h"
+#include "economy.h"
 #include "depot.h"
 #include "vehicle_gui.h"
 
+
 void ShowRoadVehViewWindow(Vehicle *v);
 
 static const uint16 _roadveh_images[63] = {
@@ -121,7 +123,7 @@
 	/* The ai_new queries the vehicle cost before building the route,
 	 * so we must check against cheaters no sooner than now. --pasky */
 	if (!IsTileDepotType(tile, TRANSPORT_ROAD)) return CMD_ERROR;
-	if (!IsTileOwner(tile, _current_player)) return CMD_ERROR;
+	if (!IsSisterCompany(GetTileOwner(tile),_current_player)) return CMD_ERROR;
 
 	v = AllocateVehicle();
 	if (v == NULL || IsOrderPoolFull())
@@ -285,8 +287,7 @@
 
 	if (IsTileType(tile, MP_STREET) &&
 			(_m[tile].m5 & 0xF0) == 0x20 &&
-			IsTileOwner(tile, rfdd->owner)) {
-
+			(IsSisterCompany(GetTileOwner(tile), rfdd->owner) || _patches.shared_stations)){
 		if (length < rfdd->best_length) {
 			rfdd->best_length = length;
 			rfdd->tile = tile;
@@ -798,6 +799,14 @@
 
 static void RoadVehArrivesAt(Vehicle *v, Station *st)
 {
+	st->vehicles[STS_VEH_ROAD].this_month++;
+	if (st->months_counted == STS_NO_MONTHS_COUNTED) st->months_counted = 1;
+	if (v->cargo_type == CT_PASSENGERS)
+		st->vehicles[STS_VEH_BUS].this_month++;
+	else
+		st->vehicles[STS_VEH_TRUCK].this_month++;
+	InvalidateWindow(WC_STATION_STATS, st->index);
+
 	if (v->engine_type < 123) {
 		/* Check if station was ever visited before */
 		if (!(st->had_vehicle_of_type & HVOT_BUS)) {
@@ -1034,11 +1043,11 @@
 	}
 
 	if (IsTileType(tile, MP_STREET)) {
-		if ((_m[tile].m5&0xF0) == 0x20 && IsTileOwner(tile, v->owner))
+		if ((_m[tile].m5&0xF0) == 0x20 && IsSisterCompany(GetTileOwner(tile), v->owner))
 			/* Road crossing */
 			bitmask |= _road_veh_fp_ax_or[_m[tile].m5&3];
 	} else if (IsTileType(tile, MP_STATION)) {
-		if (IsTileOwner(tile, OWNER_NONE) || IsTileOwner(tile, v->owner)) {
+		if (GetTileOwner(tile) == OWNER_NONE || IsSisterCompany(GetTileOwner(tile), v->owner) || _patches.shared_stations){
 			/* Our station */
 			Station *st = GetStation(_m[tile].m2);
 			byte val = _m[tile].m5;
Index: openttd.c
===================================================================
--- openttd.c	(Revision 2953)
+++ openttd.c	(Arbeitskopie)
@@ -318,7 +318,7 @@
 	const char *optformat;
 	char musicdriver[16], sounddriver[16], videodriver[16];
 	int resolution[2] = {0,0};
-	uint startdate = -1;
+	uint32 startdate = -1;
 	bool dedicated;
 
 	musicdriver[0] = sounddriver[0] = videodriver[0] = 0;
@@ -1163,6 +1163,10 @@
 		END_TILE_LOOP(tile_cur, w, h, tile)
 	}
 
+	// From version 14.0, time starts at 0 instead of 1920. Account for this in older games by adding the offset on.
+	if (version <= 0xE00)
+		_date += 701279;
+
 	// convert road side to my format.
 	if (_opt.road_side) _opt.road_side = 1;
 
@@ -1171,7 +1175,7 @@
 
 	// Update current year
 	SetDate(_date);
-
+		
 	// reinit the landscape variables (landscape might have changed)
 	InitializeLandscapeVariables(true);
 
@@ -1281,10 +1285,10 @@
 	}
 
 	if (version < 0x1000) {
-		int i;
+		int z;
 		FOR_ALL_PLAYERS(p) {
-			for (i = 0; i < 256; i++) {
-				p->engine_replacement[i] = INVALID_ENGINE;
+			for (z = 0; z < 256; z++) {
+				p->engine_replacement[z] = INVALID_ENGINE;
 			}
 			p->engine_renew = false;
 			p->engine_renew_months = -6;
@@ -1299,10 +1303,31 @@
 			p->engine_renew_money = _patches.autorenew_money;
 		}
 	}
+	
+	if (version < 0x1000) {
+#define START_OFFSET 701279
+		int j;
+		
+		Station *st;
+		Player *player;
+		Industry *i;
+		
+		FOR_ALL_STATIONS(st)
+			st->build_date += START_OFFSET;
 
+		FOR_ALL_PLAYERS(player)
+			player->inaugurated_year += 1920;
+
+		FOR_ALL_INDUSTRIES(i)
+			i->last_prod_year += 1920;
+
+		for(j = 0; j < TOTAL_NUM_ENGINES; j++)
+			_engines[j].intro_date += START_OFFSET;
+#undef START_OFFSET
+	}
+
 	FOR_ALL_PLAYERS(p) {
 		p->avail_railtypes = GetPlayerRailtypes(p->index);
 	}
-
 	return true;
 }
Index: openttd.h
===================================================================
--- openttd.h	(Revision 2953)
+++ openttd.h	(Arbeitskopie)
@@ -37,7 +37,8 @@
 } SortStruct;
 
 typedef struct YearMonthDay {
-	int year, month, day;
+	uint32 year;
+	int month, day;
 } YearMonthDay;
 
 /* --- 1 Day is 74 ticks ---
@@ -49,9 +50,9 @@
 * * 1 day is thus about 2 seconds (74*27 = 1998) on a machine that can run OpenTTD normally
 */
 #define DAY_TICKS 74
-#define MAX_YEAR_BEGIN_REAL 1920
-#define MAX_YEAR_END_REAL 2090
-#define MAX_YEAR_END 170
+#define MAX_YEAR_BEGIN_REAL 0
+#define MAX_YEAR_END_REAL 11760898
+#define MAX_YEAR_END 11758978
 
 #include "map.h"
 
@@ -77,6 +78,9 @@
 typedef uint16 EngineID; //! All enginenumbers should be of this type
 typedef uint16 UnitID;   //! All unitnumber stuff is of this type (or anyway, should be)
 
+typedef uint64 CargoMask;
+typedef uint32 TypeMask;
+
 typedef uint32 WindowNumber;
 typedef byte WindowClass;
 
@@ -270,7 +274,7 @@
 
 	NUM_CARGO = 12,
 
-	CT_INVALID = 0xFF
+	CT_INVALID = 0xFF,
 };
 
 typedef uint AcceptedCargo[NUM_CARGO];
@@ -278,7 +282,7 @@
 typedef struct TileDesc {
 	StringID str;
 	byte owner;
-	uint16 build_date;
+	uint32 build_date;
 	uint32 dparam[2];
 } TileDesc;
 
@@ -446,6 +450,17 @@
 	WC_HIGHSCORE = 0x4D,
 	WC_ENDSCREEN = 0x4E,
 	WC_SIGN_LIST = 0x4F,
+	//Subsiderie
+	WC_SUBSIDIARIES = 0x50,
+	WC_SUBSIDIARIES_MONEY = 0x51,
+	WC_SUBSIDIARIES_ASK_MERGER = 0x52, 
+	//signal GUI
+	WC_BUILD_SIGNALS = 0x53,
+	//Stats
+	WC_STATION_STATS = 0x54,
+	WC_WAYPOINT_STATS = 0x55,
+	WC_STATION_RATING_DETAIL = 0x56,
+	WC_VEHICLES_LIST = 0x57,
 };
 
 
Index: station_gui.c
===================================================================
--- station_gui.c	(Revision 2953)
+++ station_gui.c	(Arbeitskopie)
@@ -15,7 +15,154 @@
 #include "command.h"
 #include "variables.h"
 #include "vehicle_gui.h"
+#include "engine.h"
+#include "depot.h"
 
+extern int _traininfo_vehicle_pitch;
+static char _bufcache[64];
+static uint16 _last_station_idx;
+static byte _station_sort_order;
+
+DEF_SORTER(StationUnsortedSorter);
+DEF_SORTER(StationNameSorter);
+DEF_SORTER(StationTypeSorter);
+DEF_SORTER(StationWaitingCargoSorter);
+DEF_SORTER(StationRatingSorter);
+DEF_SORTER(StationAgeSorter);
+DEF_SORTER(StationVisitingVehicleSorter);
+
+typedef DEF_SORTER(StationSortListingTypeFunctions);
+
+const StringID _station_sort_listing[] = {
+	STR_SORT_BY_UNSORTED,
+	STR_SORT_BY_DROPDOWN_NAME,
+	STR_SORT_BY_DROPDOWN_TYPE,
+	STR_SORT_BY_WAITINGCARGO,
+	STR_SORT_BY_RATING,   	
+	STR_SORT_BY_AGE,
+	STR_SORT_BY_VISITING_VEHICLE,
+	INVALID_STRING_ID
+};
+
+StationSortListingTypeFunctions * const _station_sorter[] = {
+	&StationUnsortedSorter,
+	&StationNameSorter,
+	&StationTypeSorter,
+	&StationWaitingCargoSorter,
+	&StationRatingSorter,
+	&StationAgeSorter,
+	&StationVisitingVehicleSorter
+};
+
+int CDECL StationUnsortedSorter(const void *a, const void *b)
+{
+	int temp = GetStation(*(const uint16*)a)->index - GetStation(*(const uint16*)a)->index;
+	return (_station_sort_order & 1) ? -temp : temp;
+}
+
+int CDECL StationVisitingVehicleSorter(const void *a, const void *b)
+{
+	int VVNum1 = 0;
+	int VVNum2 = 0;
+	int temp = 0;
+	const Vehicle *v;
+		FOR_ALL_VEHICLES(v) {
+				const Order *order;
+				FOR_VEHICLE_ORDERS(v, order) {
+					if (order->type == OT_GOTO_STATION && order->station == GetStation(*(const uint16*)a)->index) {
+						VVNum1++; 
+						break;
+					}
+					if (order->type == OT_GOTO_STATION && order->station == GetStation(*(const uint16*)b)->index) {
+						VVNum2++; 
+						break;
+					}
+				}
+			}
+		
+	temp = VVNum1 - VVNum2;
+	return (_station_sort_order & 1) ? -temp : temp;
+}
+
+int CDECL StationTypeSorter(const void *a, const void *b)
+{
+	int temp = (GetStation(*(const uint16*)a)->facilities - GetStation(*(const uint16*)b)->facilities);
+	return (_station_sort_order & 1) ? -temp : temp;
+}
+
+int CDECL StationAgeSorter(const void *a, const void *b)
+{
+	int temp = (GetStation(*(const uint16*)a)->build_date - GetStation(*(const uint16*)b)->build_date);
+	return (_station_sort_order & 1) ? -temp : temp;
+}
+
+static float CDECL RatingAverage(const void *a)
+{
+	Station *st = GetStation(*(const uint16*)a);
+	int RatingSum = 0.0;
+	int AcceptNum = 0.0;
+	int j;
+	for(j=0; j!=NUM_CARGO; j++) {
+		int acc = (st->goods[j].waiting_acceptance & 0xFFF);
+		if (acc != 0) {
+			RatingSum += st->goods[j].rating;
+			AcceptNum++;
+		}
+	}
+	return (AcceptNum == 0) ? 0 : RatingSum/AcceptNum;
+}
+
+int CDECL StationRatingSorter(const void *a, const void *b)
+{
+	int temp = (RatingAverage(a)-RatingAverage(b));
+	return (_station_sort_order & 1) ? -temp : temp;
+}
+
+static int CDECL WaitingCargoNumber(const void *a)
+{
+	Station *st = GetStation(*(const uint16*)a);
+	int CargoSum = 0;
+	int j;
+	for(j=0; j!=NUM_CARGO; j++) {
+		int acc = (st->goods[j].waiting_acceptance & 0xFFF);
+	if (acc != 0) {
+			CargoSum += acc;
+		}
+	}
+	return CargoSum;
+}
+
+int CDECL StationWaitingCargoSorter(const void *a, const void *b)
+{
+	
+	int temp = (WaitingCargoNumber(a)-WaitingCargoNumber(b));
+	return (_station_sort_order & 1) ? -temp : temp;
+}
+int CDECL StationNameSorter(const void *a, const void *b)
+{
+	char buf1[64];
+	Station *st;
+	int temp = 0;
+	const SortStruct *cmp1 = (const SortStruct*)a;
+	const SortStruct *cmp2 = (const SortStruct*)b;
+	
+	st = GetStation(cmp1->index);
+	SetDParam(0, st->town->townnametype);
+	SetDParam(1, st->town->townnameparts);
+	GetString(buf1, st->string_id);
+		
+	if ( cmp2->index != _last_station_idx) {
+		_last_station_idx = cmp2->index;
+		st = GetStation(cmp2->index);
+		SetDParam(0, st->town->townnametype);
+		SetDParam(1, st->town->townnameparts);
+		GetString(_bufcache, st->string_id);
+	}
+		
+	temp = strcmp(buf1, _bufcache);	// sort by name
+	return (_station_sort_order & 1) ? -temp : temp;
+}
+
 static void StationsWndShowStationRating(int x, int y, int type, uint acceptance, int rating)
 {
 	static const byte _rating_colors[NUM_CARGO] = {152,32,15,174,208,194,191,55,184,10,191,48};
@@ -57,25 +204,7 @@
 static char _bufcache[64];
 static uint16 _last_station_idx;
 
-static int CDECL StationNameSorter(const void *a, const void *b)
-{
-	char buf1[64];
-	int32 argv[1];
-	const SortStruct *cmp1 = (const SortStruct*)a;
-	const SortStruct *cmp2 = (const SortStruct*)b;
 
-	argv[0] = cmp1->index;
-	GetStringWithArgs(buf1, STR_STATION, argv);
-
-	if ( cmp2->index != _last_station_idx) {
-		_last_station_idx = cmp2->index;
-		argv[0] = cmp2->index;
-		GetStringWithArgs(_bufcache, STR_STATION, argv);
-	}
-
-	return strcmp(buf1, _bufcache); // sort by name
-}
-
 static void GlobalSortStationList(void)
 {
 	const Station *st;
@@ -126,72 +255,90 @@
 	}
 
 	_last_station_idx = 0; // used for "cache" in namesorting
-	qsort(firstelement, n, sizeof(_station_sort[0]), StationNameSorter); // sort by name
-
+	//qsort(firstelement, n, sizeof(_station_sort[0]), StationNameSorter); // sort by name
+  qsort(firstelement, n, sizeof(_station_sort[0]), _station_sorter[_station_sort_order >> 1]);
 	_station_sort_dirty[owner] = false;
 
 	DEBUG(misc, 1) ("Resorting Stations list player %d...", owner+1);
 }
 
+enum {
+  PLY_WND_STS_OFFSET_TOP_WIDGET	= 26,
+	PLY_WND_STS_SIZE_OF_ROW	= 15,
+	PLY_WND_STS_SIZE_OF_COL	= 15,
+	PLY_WND_STS_CARGO_INDICATOR_OFFSET = 200,
+};
+
 static void PlayerStationsWndProc(Window *w, WindowEvent *e)
 {
+	const byte owner = (byte)w->window_number;
 	switch(e->event) {
 	case WE_PAINT: {
 		uint32 i;
-		const byte window_number = (byte)w->window_number;
+		uint32 PlayerStationOffset;
 
 		// resort station window if stations have been added/removed
 		if (_global_station_sort_dirty)
 			GlobalSortStationList();
 
-		if (_station_sort_dirty[window_number]) { // resort in case of a station rename.
-			MakeSortedStationList(window_number);
+		if (_station_sort_dirty[owner]) { // resort in case of a station rename.
+			MakeSortedStationList(owner);
 		}
 
 		// stations are stored as a cummulative index, eg 25, 41, 43. This means
 		// Player0: 25; Player1: (41-25) 16; Player2: (43-41) 2 stations
-		i = (window_number == 0) ? 0 : _num_station_sort[window_number-1];
-		SetVScrollCount(w, _num_station_sort[window_number] - i);
-
-		/* draw widgets, with player's name in the caption */
+		PlayerStationOffset = (owner == 0) ? 0 : _num_station_sort[owner-1];
+		
+		SetVScrollCount(w, _num_station_sort[owner] - PlayerStationOffset);
+ 
+ 		/* draw widgets, with player's name in the caption */
+		if (_station_sort_order == SORT_BY_UNSORTED)
+			w->disabled_state |= (1 << 3);
 		{
-			Player *p = GetPlayer(window_number);
+			Player *p = GetPlayer(w->window_number);
 			SetDParam(0, p->name_1);
 			SetDParam(1, p->name_2);
 			SetDParam(2, w->vscroll.count);
 			DrawWindowWidgets(w);
+			DrawString(85, 15, _station_sort_listing[_station_sort_order >> 1], 0x10);
+  		/* draw arrow pointing up/down for ascending/descending sorting */
+		  DoDrawString(_station_sort_order & 1 ? "\xAA" : "\xA0", 69, 15, 0x10);
 		}
 
 		{
 			byte p = 0;
 			Station *st;
 			int x,xb = 2;
-			int y = 16; // offset from top of widget
+			int y = 26; // offset from top of widget
 			int j;
+			int max = 0;
 
 			if (w->vscroll.count == 0) { // player has no stations
 				DrawString(xb, y, STR_304A_NONE, 0);
 				return;
 			}
 
-			i += w->vscroll.pos; // offset from sorted station list of current player
-			assert(i < _num_station_sort[window_number]); // at least one station must exist
-
-			while (i < _num_station_sort[window_number]) { // do until max number of stations of owner
+			i = PlayerStationOffset+w->vscroll.pos;	// offset from sorted station list of current player
+			assert(i < _num_station_sort[owner]); // at least one station must exist
+      		max = min(w->vscroll.cap + w->vscroll.pos, _num_station_sort[owner]-PlayerStationOffset);
+			for (p = w->vscroll.pos; p < max; p++) {
 				st = GetStation(_station_sort[i].index);
 
-				assert(st->xy && st->owner == window_number);
+				assert(st->xy && st->owner == owner);
 
 				SetDParam(0, st->index);
 				SetDParam(1, st->facilities);
-				x = DrawString(xb, y, STR_3049_0, 0) + 5;
+				DrawString(xb, y+3, STR_3049_0, 0);
+				x = PLY_WND_STS_CARGO_INDICATOR_OFFSET;
 
+
 				// show cargo waiting and station ratings
 				for(j=0; j!=NUM_CARGO; j++) {
 					int acc = (st->goods[j].waiting_acceptance & 0xFFF);
 					if (acc != 0) {
-						StationsWndShowStationRating(x, y, j, acc, st->goods[j].rating);
-						x += 10;
+						if (x+PLY_WND_STS_SIZE_OF_COL > w->width) break;
+						StationsWndShowStationRating(x, y+3, j, acc, st->goods[j].rating);
+						x += PLY_WND_STS_SIZE_OF_COL;
 					}
 				}
 				y += 10;
@@ -203,8 +350,17 @@
 	case WE_CLICK: {
 		switch(e->click.widget) {
 		case 3: {
-			uint32 id_v = (e->click.pt.y - 15) / 10;
-
+		  (_station_sort_order % 2 == 0) ? _station_sort_order++ : _station_sort_order--;
+			_station_sort_dirty[owner] = true;
+			SetWindowDirty(w);
+		} break;
+ 
+		case 4: case 5:/* Select sorting criteria dropdown menu */
+			ShowDropDownMenu(w, _station_sort_listing, _station_sort_order >> 1, 5, 0, 0);
+			return;
+		
+		case 7: {
+			uint32 id_v = (e->click.pt.y - PLY_WND_STS_OFFSET_TOP_WIDGET) / PLY_WND_STS_SIZE_OF_ROW;
 			if (id_v >= w->vscroll.cap) { return;} // click out of bounds
 
 			id_v += w->vscroll.pos;
@@ -226,6 +382,19 @@
 		}
 	} break;
 
+	case WE_DROPDOWN_SELECT: /* we have selected a dropdown item in the list */
+		if (_station_sort_order << 1 != e->dropdown.index) {
+			// value has changed -> resort
+			_station_sort_order = e->dropdown.index << 1;
+			
+			// enable 'Sort By' if a sorter criteria is chosen
+			if (_station_sort_order != SORT_BY_UNSORTED)
+				CLRBIT(w->disabled_state, 3);
+		}
+		_station_sort_dirty[owner] = true;
+		SetWindowDirty(w);
+		break;
+	
 	case WE_4:
 		WP(w,plstations_d).refresh_counter++;
 		if (WP(w,plstations_d).refresh_counter==5) {
@@ -235,25 +404,32 @@
 		break;
 
 	case WE_RESIZE:
-		w->vscroll.cap += e->sizing.diff.y / 10;
+		/* Update the scroll + matrix */
+		w->hscroll.cap += e->sizing.diff.x / 29;
+		w->vscroll.cap += e->sizing.diff.y / PLY_WND_STS_SIZE_OF_ROW;
+		w->widget[7].unkA = (w->vscroll.cap << 8) + 1;
 		break;
 	}
 }
 
 static const Widget _player_stations_widgets[] = {
 {   WWT_CLOSEBOX,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,									STR_018B_CLOSE_WINDOW},
-{    WWT_CAPTION,  RESIZE_RIGHT,    14,    11,   345,     0,    13, STR_3048_STATIONS,				STR_018C_WINDOW_TITLE_DRAG_THIS},
-{  WWT_STICKYBOX,     RESIZE_LR,    14,   346,   357,     0,    13, 0x0,											STR_STICKY_BUTTON},
-{      WWT_PANEL,     RESIZE_RB,    14,     0,   345,    14,   137, 0x0,											STR_3057_STATION_NAMES_CLICK_ON},
-{  WWT_SCROLLBAR,    RESIZE_LRB,    14,   346,   357,    14,   125, 0x0,											STR_0190_SCROLL_BAR_SCROLLS_LIST},
-{  WWT_RESIZEBOX,   RESIZE_LRTB,    14,   346,   357,   126,   137, 0x0,											STR_RESIZE_BUTTON},
+{    WWT_CAPTION,  RESIZE_RIGHT,    14,    11,   255,     0,    13, STR_3048_STATIONS,				STR_018C_WINDOW_TITLE_DRAG_THIS},
+{  WWT_STICKYBOX,     RESIZE_LR,    14,   255,   266,     0,    13, 0x0,											STR_STICKY_BUTTON},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    80,    14,    25, SRT_SORT_BY,							STR_SORT_ORDER_TIP},
+{      WWT_PANEL,   RESIZE_NONE,    14,    81,   232,    14,    25, 0x0,											STR_SORT_CRITERIA_TIP},
+{   WWT_CLOSEBOX,   RESIZE_NONE,    14,   233,   243,    14,    25, STR_0225,									STR_SORT_CRITERIA_TIP},
+{      WWT_PANEL,  RESIZE_RIGHT,    14,   244,   254,    14,    25, 0x0,	  									STR_NULL},
+{     WWT_MATRIX,     RESIZE_RB,    14,     0,   254,    26,   176, 0xA01,										STR_3057_STATION_NAMES_CLICK_ON},
+{  WWT_SCROLLBAR,    RESIZE_LRB,    14,   255,   266,    14,   164, 0x0,											STR_0190_SCROLL_BAR_SCROLLS_LIST},
+{  WWT_RESIZEBOX,   RESIZE_LRTB,    14,   255,   266,   165,   176, 0x0,											STR_RESIZE_BUTTON},
 {   WIDGETS_END},
 };
 
 static const WindowDesc _player_stations_desc = {
-	-1, -1, 358, 138,
-	WC_STATION_LIST,0,
-	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_STICKY_BUTTON | WDF_RESIZABLE,
+	-1, -1, 267, 177,
+ 	WC_STATION_LIST,0,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS | WDF_STICKY_BUTTON | WDF_RESIZABLE,
 	_player_stations_widgets,
 	PlayerStationsWndProc
 };
@@ -265,10 +441,12 @@
 
 	w = AllocateWindowDescFront(&_player_stations_desc, player);
 	if (w) {
-		w->caption_color = (byte)w->window_number;
-		w->vscroll.cap = 12;
-		w->resize.step_height = 10;
-		w->resize.height = w->height - 10 * 7; // minimum if 5 in the list
+		w->caption_color = w->window_number;
+		w->vscroll.cap = 10; // maximum number of station shown
+		w->widget[7].unkA = (w->vscroll.cap << 8) + 1;
+		w->resize.step_height = PLY_WND_STS_SIZE_OF_ROW;
+		w->resize.step_width = 31;
+		w->resize.height = w->height; /* Minimum of 4 vehicles */
 	}
 }
 
@@ -287,9 +465,35 @@
 { WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   207,   220,   198,   209, STR_LORRY, STR_SCHEDULED_ROAD_VEHICLES_TIP },
 { WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   221,   234,   198,   209, STR_PLANE, STR_SCHEDULED_AIRCRAFT_TIP },
 { WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   235,   248,   198,   209, STR_SHIP, STR_SCHEDULED_SHIPS_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    63,   210,   221, STR_STATION_STATS, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,    64,   128,   210,   221, STR_STATION_RATING_DETAIL_KEY,	STR_NULL},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   129,   192,   210,   221, 0x0,	STR_NULL},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   193,   248,   210,   221, STR_STATION_COVERAGE,	STR_NULL},
 {   WIDGETS_END},
 };
 
+static const Widget _station_view_expanded_cheat_widgets[] = {
+{    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,	STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,   RESIZE_NONE,    14,    11,   236,     0,    13, STR_300A_0,	STR_018C_WINDOW_TITLE_DRAG_THIS},
+{  WWT_STICKYBOX,   RESIZE_NONE,    14,   237,   248,     0,    13, 0x0,	STR_STICKY_BUTTON},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   236,    14,    65, 0x0,	STR_NULL},
+{  WWT_SCROLLBAR,   RESIZE_NONE,    14,   237,   248,    14,    65, 0x0,	STR_0190_SCROLL_BAR_SCROLLS_LIST},
+{      WWT_EMPTY,   RESIZE_NONE,     0,     0,     0,     0,     0, 0x0,	STR_NULL},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   248,    66,   197, 0x0,	STR_NULL},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    63,   198,   209, STR_00E4_LOCATION,	STR_3053_CENTER_MAIN_VIEW_ON_STATION},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,    64,   128,   198,   209, STR_3033_ACCEPTS,	STR_3056_SHOW_LIST_OF_ACCEPTED_CARGO},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   129,   192,   198,   209, STR_0130_RENAME,	STR_3055_CHANGE_NAME_OF_STATION},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   193,   206,   198,   209, STR_TRAIN,	STR_SCHEDULED_TRAINS_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   207,   220,   198,   209, STR_LORRY,	STR_SCHEDULED_ROAD_VEHICLES_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   221,   234,   198,   209, STR_PLANE,	STR_SCHEDULED_AIRCRAFT_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   235,   248,   198,   209, STR_SHIP,	STR_SCHEDULED_SHIPS_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    63,   210,   221, STR_STATION_STATS,	0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,    64,   128,   210,   221, STR_STATION_RATING_DETAIL_KEY,	STR_NULL},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   129,   192,   210,   221, STR_RESET_STATION,	0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   193,   248,   210,   221, STR_STATION_COVERAGE,	STR_NULL},
+{   WIDGETS_END},
+};
+
 static const Widget _station_view_widgets[] = {
 {    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,		STR_018B_CLOSE_WINDOW},
 {    WWT_CAPTION,   RESIZE_NONE,    14,    11,   236,     0,    13, STR_300A_0,	STR_018C_WINDOW_TITLE_DRAG_THIS},
@@ -305,9 +509,35 @@
 { WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   207,   220,    98,   109, STR_LORRY, STR_SCHEDULED_ROAD_VEHICLES_TIP },
 { WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   221,   234,    98,   109, STR_PLANE, STR_SCHEDULED_AIRCRAFT_TIP },
 { WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   235,   248,    98,   109, STR_SHIP, STR_SCHEDULED_SHIPS_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    63,   110,   121, STR_STATION_STATS, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,    64,   128,   110,   121, STR_STATION_RATING_DETAIL_KEY,	STR_NULL},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   129,   192,   110,   121, 0x0,	STR_NULL},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   193,   248,   110,   121, STR_STATION_COVERAGE,	STR_NULL},
 {   WIDGETS_END},
 };
 
+static const Widget _station_view_cheat_widgets[] = {
+{    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,	STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,   RESIZE_NONE,    14,    11,   236,     0,    13, STR_300A_0,	STR_018C_WINDOW_TITLE_DRAG_THIS},
+{  WWT_STICKYBOX,   RESIZE_NONE,    14,   237,   248,     0,    13, 0x0,	STR_STICKY_BUTTON},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   236,    14,    65, 0x0,	STR_NULL},
+{  WWT_SCROLLBAR,   RESIZE_NONE,    14,   237,   248,    14,    65, 0x0,	STR_0190_SCROLL_BAR_SCROLLS_LIST},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   248,    66,    97, 0x0,	STR_NULL},
+{      WWT_EMPTY,   RESIZE_NONE,     0,     0,     0,     0,     0, 0x0,	STR_NULL},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    63,    98,   109, STR_00E4_LOCATION,	STR_3053_CENTER_MAIN_VIEW_ON_STATION},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,    64,   128,    98,   109, STR_3032_RATINGS,	STR_3054_SHOW_STATION_RATINGS},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   129,   192,    98,   109, STR_0130_RENAME,	STR_3055_CHANGE_NAME_OF_STATION},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   193,   206,    98,   109, STR_TRAIN,	STR_SCHEDULED_TRAINS_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   207,   220,    98,   109, STR_LORRY,	STR_SCHEDULED_ROAD_VEHICLES_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   221,   234,    98,   109, STR_PLANE,	STR_SCHEDULED_AIRCRAFT_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   235,   248,    98,   109, STR_SHIP,	STR_SCHEDULED_SHIPS_TIP },
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    63,   110,   121, STR_STATION_STATS,	0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,    64,   128,   110,   121, STR_STATION_RATING_DETAIL_KEY,	STR_NULL},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   129,   192,   110,   121, STR_RESET_STATION,	STR_NULL},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   193,   248,   110,   121, STR_STATION_COVERAGE,	STR_NULL},
+{   WIDGETS_END},
+};
+
 static void DrawStationViewWindow(Window *w)
 {
 	Station *st;
@@ -324,7 +554,7 @@
 
 	num = 1;
 	for(i=0; i!=NUM_CARGO; i++) {
-		if ((st->goods[i].waiting_acceptance & 0xFFF) != 0) {
+		if ((st->goods[i].waiting_acceptance & MAX_CARGO_WAITING) != 0) {
 			num++;
 			if (st->goods[i].enroute_from != station_id)
 				num++;
@@ -332,7 +562,11 @@
 	}
 	SetVScrollCount(w, num);
 
-	w->disabled_state = st->owner == _local_player ? 0 : (1 << 9);
+	// 9 = Rename Station, 16 = Reset station
+	if (_cheats.reset_station.value)
+		w->disabled_state = st->owner == _local_player ? 0 : (1 << 9) | (1 << 16);
+	else
+		w->disabled_state = st->owner == _local_player ? 0 : (1 << 9);
 
 	if (!(st->facilities & FACIL_TRAIN)) SETBIT(w->disabled_state,  10);
 	if (!(st->facilities & FACIL_TRUCK_STOP) &&
@@ -351,7 +585,7 @@
 	if (--pos < 0) {
 		str = STR_00D0_NOTHING;
 		for(i=0; i!=NUM_CARGO; i++)
-			if (st->goods[i].waiting_acceptance & 0xFFF)
+			if (st->goods[i].waiting_acceptance & MAX_CARGO_WAITING)
 				str = STR_EMPTY;
 		SetDParam(0, str);
 		DrawString(x, y, STR_0008_WAITING, 0);
@@ -360,7 +594,7 @@
 
 	i = 0;
 	do {
-		uint waiting = (st->goods[i].waiting_acceptance & 0xFFF);
+		uint waiting = (st->goods[i].waiting_acceptance & MAX_CARGO_WAITING);
 		if (waiting == 0)
 			continue;
 
@@ -398,7 +632,8 @@
 		}
 	} while (pos > -5 && ++i != 12);
 
-	if (IsWindowOfPrototype(w, _station_view_widgets)) {
+	if (IsWindowOfPrototype(w, _station_view_widgets) ||
+		IsWindowOfPrototype(w, _station_view_cheat_widgets) ) {
 		char *b = _userstring;
 
 		b = InlineString(b, STR_000C_ACCEPTS);
@@ -437,7 +672,36 @@
 	}
 }
 
+int32 ClickResetStationCheat(int32 cheat_activated, int32 NOT_USED)
+{ // switch all open station-view-windows to new widget-set when cheat toggled
+	Window *w;
 
+	for (w = _windows; w != _last_window; ++w) {
+		if (w->window_class == WC_STATION_VIEW) {
+			/* toggle height/widget set */
+			SetWindowDirty(w);
+			if (IsWindowOfPrototype(w, _station_view_expanded_widgets)
+				|| IsWindowOfPrototype(w, _station_view_expanded_cheat_widgets)) {
+				if (cheat_activated != 0) { // Reset button enabled?
+					AssignWidgetToWindow(w, _station_view_expanded_cheat_widgets);
+				} else {
+					AssignWidgetToWindow(w, _station_view_expanded_widgets);
+				}
+				w->height = ST_VIEW_EXP_HEIGHT;
+			} else {
+				if (cheat_activated != 0) { // Reset button enabled?
+					AssignWidgetToWindow(w, _station_view_cheat_widgets);
+				} else {
+					AssignWidgetToWindow(w, _station_view_widgets);
+				}
+				w->height = ST_VIEW_HEIGHT;
+			}
+			SetWindowDirty(w);
+		}
+	}
+	return 0;
+}
+
 static void StationViewWndProc(Window *w, WindowEvent *e)
 {
 	switch(e->event) {
@@ -447,42 +711,46 @@
 
 	case WE_CLICK:
 		switch(e->click.widget) {
-		case 7:
+		case 7: { // go to Location of station
 			ScrollMainWindowToTile(GetStation(w->window_number)->xy);
 			break;
-
-		case 8:
+		}
+		case 8: { // toggle rating/acceptance
 			SetWindowDirty(w);
 
 			/* toggle height/widget set */
-			if (IsWindowOfPrototype(w, _station_view_expanded_widgets)) {
-				AssignWidgetToWindow(w, _station_view_widgets);
-				w->height = 110;
+			if (IsWindowOfPrototype(w, _station_view_expanded_widgets)
+				|| IsWindowOfPrototype(w, _station_view_expanded_cheat_widgets)) {
+				if (_cheats.reset_station.value)
+					AssignWidgetToWindow(w, _station_view_cheat_widgets);
+				else
+					AssignWidgetToWindow(w, _station_view_widgets);
+				w->height = ST_VIEW_HEIGHT;
 			} else {
-				AssignWidgetToWindow(w, _station_view_expanded_widgets);
-				w->height = 210;
+				if (_cheats.reset_station.value)
+					AssignWidgetToWindow(w, _station_view_expanded_cheat_widgets);
+				else
+					AssignWidgetToWindow(w, _station_view_expanded_widgets);
+				w->height = ST_VIEW_EXP_HEIGHT;
 			}
 
 			SetWindowDirty(w);
 			break;
-
-		case 9: {
+		}
+		case 9: { // Rename Station
 			SetDParam(0, w->window_number);
 			ShowQueryString(STR_STATION, STR_3030_RENAME_STATION_LOADING, 31, 180, w->window_class, w->window_number);
 		} break;
-
 		case 10: { /* Show a list of scheduled trains to this station */
 			const Station *st = GetStation(w->window_number);
 			ShowPlayerTrains(st->owner, w->window_number);
 			break;
 		}
-
 		case 11: { /* Show a list of scheduled road-vehicles to this station */
 			const Station *st = GetStation(w->window_number);
 			ShowPlayerRoadVehicles(st->owner, w->window_number);
 			break;
 		}
-
 		case 12: { /* Show a list of scheduled aircraft to this station */
 			const Station *st = GetStation(w->window_number);
 			/* Since oilrigs have no owners, show the scheduled aircraft of current player */
@@ -490,7 +758,6 @@
 			ShowPlayerAircraft(owner, w->window_number);
 			break;
 		}
-
 		case 13: { /* Show a list of scheduled ships to this station */
 			const Station *st = GetStation(w->window_number);
 			/* Since oilrigs/bouys have no owners, show the scheduled ships of current player */
@@ -498,9 +765,30 @@
 			ShowPlayerShips(owner, w->window_number);
 			break;
 		}
+		case 14: { // Show Statistics for Station
+			ShowStationStatsWindow(w->window_number);
+			break;
 		}
+		case 15: { // Show Details for Station Rating
+			const Station *st = GetStation(w->window_number);
+			ShowStationRatingDetail(st->index);
+			break;
+		}
+		case 16: { // Reset Station
+			Station *st = GetStation(w->window_number);
+			if (_cheats.reset_station.value) {
+				DoCommandP(st->xy, w->window_number, 0, NULL,
+					CMD_RESET_STATION_CHEAT | CMD_MSG(STR_CAN_T_RESET_STATION));
+				SetWindowDirty(w);
+			}
+			InitializeStationStats(st);
+			break;
+ 		}
+		case 17: { //ToDo: show station coverage
+			break;
+		}
+		} // end of switch(e->click.widget)
 		break;
-
 	case WE_ON_EDIT_TEXT: {
 		if (e->edittext.str[0] != '\0') {
 			Station* st = GetStation(w->window_number);
@@ -515,34 +803,784 @@
 		WindowNumber wno =
 			(w->window_number << 16) | GetStation(w->window_number)->owner;
 
+		// Destroy vehicle-windows related to this window, too
 		DeleteWindowById(WC_TRAINS_LIST, wno);
 		DeleteWindowById(WC_ROADVEH_LIST, wno);
 		DeleteWindowById(WC_SHIPS_LIST, wno);
 		DeleteWindowById(WC_AIRCRAFT_LIST, wno);
+		DeleteWindowById(WC_STATION_STATS, w->window_number);
 		break;
 	}
 	}
 }
 
-
 static const WindowDesc _station_view_desc = {
-	-1, -1, 249, 110,
+	-1, -1, 249, ST_VIEW_HEIGHT,
 	WC_STATION_VIEW,0,
-	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS | WDF_STICKY_BUTTON,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS | WDF_STICKY_BUTTON | WDF_RESIZABLE,
 	_station_view_widgets,
 	StationViewWndProc
 };
 
-void ShowStationViewWindow(int station)
+// alternate widget-set if reset-station-cheat is enabled
+static const WindowDesc _station_view_cheat_desc = {
+	-1, -1, 249, ST_VIEW_HEIGHT,
+	WC_STATION_VIEW,0,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS | WDF_STICKY_BUTTON,
+	_station_view_cheat_widgets,
+	StationViewWndProc
+};
+
+void ShowStationViewWindow(StationID station)
 {
 	Window *w;
 	byte color;
 
-	w = AllocateWindowDescFront(&_station_view_desc, station);
+	if (_cheats.reset_station.value)
+		w = AllocateWindowDescFront(&_station_view_cheat_desc, station);
+	else
+		w = AllocateWindowDescFront(&_station_view_desc, station);
 	if (w) {
 		color = GetStation(w->window_number)->owner;
+		if (color != OWNER_NONE)
+			w->caption_color = color;
+		w->vscroll.cap = 5;
+	}
+}
+
+void StationStatsWndProc(Window *w, WindowEvent *e);
+
+Widget _station_stats_widgets[] = {
+{    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5, STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,   RESIZE_NONE,    14,    11,   398,     0,    13, STR_300A_0, STR_018C_WINDOW_TITLE_DRAG_THIS},
+{  WWT_STICKYBOX,   RESIZE_NONE,    14,   399,   410,     0,    13, 0x0,         STR_STICKY_BUTTON},
+{      WWT_EMPTY,   RESIZE_NONE,     0,     0,     0,     0,     0, 0x0, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    90,    14,    25, STR_RESET_STATISTICS, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,    91,   410,    14,    25, STR_TOGGLE_MINMAX, 0x0},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   410,    26,    37, 0x0, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    90,    38,    49, STR_TRAINS, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    90,    50,    61, STR_RVS, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    90,    62,    73, STR_BUSSES, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    90,    74,    85, STR_TRUCKS, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    90,    85,    97, STR_SHIPS, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    90,    98,   109, STR_AIRCRAFT, 0x0},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,    91,   410,    38,   109, 0x0,0x0},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   410,   110,   135, 0x0,0x0},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   398,   136,   191, 0x0,0x0},
+{  WWT_SCROLLBAR,   RESIZE_NONE,    14,   399,   410,   136,   191, 0x0, STR_0190_SCROLL_BAR_SCROLLS_LIST},
+{      WIDGETS_END},
+};
+
+WindowDesc _station_view_stats = {
+	-1, -1, 411, 192,
+	WC_STATION_STATS, 0,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS | WDF_STICKY_BUTTON,
+	_station_stats_widgets,
+	StationStatsWndProc
+};
+
+void DrawStationStatWindow(Window *w, Station *st)
+{
+	int i, y, numcargo = 0, pos;
+	GoodsEntry *ge;
+	
+	// count number of goods at station (months_counted will be 0 if good not delivered/picked up)
+	for (ge = st->goods; ge != endof(st->goods); ge++) {
+		if (ge->months_counted != STS_NO_MONTHS_COUNTED) numcargo++;
+	}
+	SetVScrollCount(w, numcargo);
+		
+	//Get the Station name
+	SetDParam(0, st->index);
+	
+	//and the little carrier type images
+	SetDParam(1, st->facilities);
+	//First draw the widgets
+	DrawWindowWidgets(w);
+
+	DrawStringCentered(45, 28, STR_VEHICLES, 0);
+
+	//Part 1:       Find the number of carriers on the station
+	y = 27;
+	if (_show_average_stats) {
+		DrawStringRightAligned(150, y, STR_SCHEDULED, 0);
+		DrawStringRightAligned(275, y, STR_VEHICLES_MONTHS_AVERAGE, 0);
+		SetDParam(0, max(st->months_counted - 1,0));
+		DrawStringRightAligned(405, y, STR_MONTHS_COUNTED_NUM, 0);
+	} else {
+		DrawStringRightAligned(150, y, STR_SCHEDULED, 0);
+		DrawStringRightAligned(295, y, STR_VEHICLES_MONTH, 0);
+		DrawStringRightAligned(395, y, STR_VEHICLES_CURRENT, 0);	
+	}
+
+	y = 38;
+	for (i = 0; i < STS_VEH_TYPES; i++) {
+		if (w->custom[i] != 0) {
+			SetDParam(0, w->custom[i]);
+			DrawStringRightAligned(150, y+i*12, STR_NUMBER, 0);
+			CLRBIT(w->disabled_state, i+7);
+		} else {
+			SETBIT(w->disabled_state, i+7);
+		}
+		if (_show_average_stats) {
+			if (st->vehicles[i].average != 0 || st->vehicles[i].month_max !=0) {
+				SetDParam(0, st->vehicles[i].average / AVERAGE_MULTIPLIER);
+				DrawStringRightAligned(235, y+i*12, STR_SILVER_NUMBER, 0);
+				DrawStringRightAligned(245, y+i*12, STR_BLACK_SLASH, 0);
+				SetDParam(0, st->vehicles[i].month_min);
+				DrawStringRightAligned(290, y+i*12, STR_ORANGE_NUMBER, 0);
+				DrawStringRightAligned(300, y+i*12, STR_BLACK_SLASH, 0);
+				SetDParam(0, st->vehicles[i].month_max);
+				DrawStringRightAligned(350, y+i*12, STR_LTBLUE_NUMBER, 0);
+			}
+		} else {
+			if (st->vehicles[i].last_month != 0) {
+				SetDParam(0, st->vehicles[i].last_month);
+				DrawStringRightAligned(295, y+i*12, STR_NUMBER, 0);
+			}
+			if (st->vehicles[i].this_month) {
+				SetDParam(0, st->vehicles[i].this_month);
+				DrawStringRightAligned(395, y+i*12, STR_WHITE_NUMBER, 0);
+			}
+		}
+	}
+	
+	y = 124;
+	if (_show_average_stats) {
+		DrawString(5, y-10, STR_STATION_MONTHS_AVERAGE, 0);
+		DrawStringRightAligned(100, y+2, STR_MONTHS_TINY, 0);
+	} else {
+		DrawString(5, y-10, STR_STATION_MONTHS, 0);
+	}
+	DrawStringRightAligned(200, y, STR_STATION_GOODS_IN, 0);
+	DrawStringRightAligned(305, y, STR_STATION_GOODS_OUT, 0);
+	DrawStringRightAligned(395, y, STR_STATION_GOODS_TRANSFER, 0);
+	
+	y += 5;
+	pos = w->vscroll.pos;
+	for (i = 0; i < NUM_CARGO; i++) {
+		ge = &st->goods[i];
+		if (ge->months_counted != 0 && ((--pos < 0) && (pos >= -4)) )
+		{
+			StationStats *sts = ge->cargo_amount;
+			//Print the cargo name
+			y += 12;
+			SetDParam(0, _cargoc.names_s[i]);
+			DrawString(3, y, STR_02BD, 0);
+			if (_show_average_stats) {
+				SetDParam(0, ge->months_counted - 1);
+				DrawStringRightAligned(100, y, STR_TINY_GOLD_NUMBER, 0);
+				if (sts[STS_AMOUNT_IN].average != 0 || sts[STS_AMOUNT_IN].month_max != 0) {
+					SetDParam(0, sts[STS_AMOUNT_IN].average / AVERAGE_MULTIPLIER);
+					SetDParam(1, sts[STS_AMOUNT_IN].month_min);
+					SetDParam(2, sts[STS_AMOUNT_IN].month_max);
+					DrawStringRightAligned(200, y, STR_AVERAGENUMBERS, 0);
+				}
+				if (sts[STS_AMOUNT_OUT].average != 0 || sts[STS_AMOUNT_OUT].month_max != 0) {
+					SetDParam(0, sts[STS_AMOUNT_OUT].average / AVERAGE_MULTIPLIER);
+					SetDParam(1, sts[STS_AMOUNT_OUT].month_min);
+					SetDParam(2, sts[STS_AMOUNT_OUT].month_max);
+					DrawStringRightAligned(305, y, STR_AVERAGENUMBERS, 0);
+				}
+				if (sts[STS_AMOUNT_TRANSFER].average != 0 || sts[STS_AMOUNT_TRANSFER].month_max != 0) {
+					SetDParam(0, sts[STS_AMOUNT_TRANSFER].average / AVERAGE_MULTIPLIER);
+					SetDParam(1, sts[STS_AMOUNT_TRANSFER].month_min);
+					SetDParam(2, sts[STS_AMOUNT_TRANSFER].month_max);
+					DrawStringRightAligned(395, y, STR_AVERAGENUMBERS, 0);
+				}
+			} else {
+				if (sts[STS_AMOUNT_IN].this_month != 0 || sts[STS_AMOUNT_IN].last_month != 0) {
+					SetDParam(0, sts[STS_AMOUNT_IN].this_month);
+					SetDParam(1, sts[STS_AMOUNT_IN].last_month);
+					DrawStringRightAligned(200, y, STR_CNUMBERS, 0);
+				}
+				if (sts[STS_AMOUNT_OUT].this_month != 0 || sts[STS_AMOUNT_OUT].last_month != 0) {
+					SetDParam(0, sts[STS_AMOUNT_OUT].this_month);
+					SetDParam(1, sts[STS_AMOUNT_OUT].last_month);
+					DrawStringRightAligned(305, y, STR_CNUMBERS, 0);
+				}
+				if (sts[STS_AMOUNT_TRANSFER].this_month != 0 || sts[STS_AMOUNT_TRANSFER].last_month != 0) {
+					SetDParam(0, sts[STS_AMOUNT_TRANSFER].this_month);
+					SetDParam(1, sts[STS_AMOUNT_TRANSFER].last_month);
+					DrawStringRightAligned(395, y, STR_CNUMBERS, 0);
+				}
+			}
+		}
+	}
+}
+
+void StationStatsWndProc(Window *w, WindowEvent *e)
+{
+	Station *st = GetStation(w->window_number);
+	switch(e->event)
+	{
+	case WE_TICK: {
+//		static int counter = 0;
+//		if (++counter % 40) return;
+		int i;
+		
+		for (i = 0; i < STS_VEH_TYPES; i++)
+			w->custom[i] = st->veh_scheduled[i];
+		InvalidateWindow(WC_STATION_STATS, w->window_number);
+		break;
+	}
+	case WE_PAINT: {
+		DrawStationStatWindow(w, st);
+		break;
+		}
+	case WE_CLICK: {
+		switch (e->click.widget)
+		{
+			case 4:			// Reset Statistics
+				if (st->owner == _current_player) {
+					InitializeStationStats(st);
+					InvalidateWindow(WC_STATION_STATS, w->window_number);
+				}
+				break;
+			case 5:			// Toggle Average and This Month
+				_show_average_stats ^= 1;
+				InvalidateWindow(WC_STATION_STATS, w->window_number);
+				break;
+			case 7:			//Trains
+				ShowPlayerTrains(st->owner, st->index);
+				break;
+			case 8: 		//Road Vehicles
+				ShowPlayerRoadVehicles(st->owner, st->index);
+				break;
+			case 9:			// Buses
+				ShowPlayerVehicles(st->owner, st->index, 1 << VEH_Road, 1 << GC_PASSENGERS, st->xy);
+				break;
+			case 10:		// Trucks
+				ShowPlayerVehicles(st->owner, st->index, 1 << VEH_Road, CARGO_MASK_ALL &~(1 << GC_PASSENGERS), st->xy);
+				break;
+			case 11: 		//Ships
+				ShowPlayerShips(st->owner, st->index);
+				break;
+			case 12: 		//Aircraft
+				ShowPlayerAircraft(st->owner, st->index);
+				break;
+		}
+	} break;
+	case WE_DESTROY: {
+//		DeleteWindowById(WC_TRAINS_LIST, st->owner + ( (st->index + 1) << 8));
+//		DeleteWindowById(WC_ROADVEH_LIST, st->owner + ( (st->index + 1) << 8) + 64 + 128);
+//		DeleteWindowById(WC_SHIPS_LIST, st->owner + ( (st->index + 1) << 8));
+//		DeleteWindowById(WC_AIRCRAFT_LIST, st->owner + ( (st->index + 1) << 8));
+	} break;
+	}
+}
+
+void ShowStationStatsWindow(StationID station)
+{
+	Window *w;
+	byte color;
+
+	Station *st = GetStation(station);
+
+	w = AllocateWindowDescFront(&_station_view_stats, st->index);
+	if (w) {
+		int i;
+		color = st->owner;
 		if (color != 0x10)
 			w->caption_color = color;
+		w->vscroll.cap = 4;
+		for (i = 0; i < STS_VEH_TYPES; i++)
+			w->custom[i] = st->veh_scheduled[i];
+	}
+}
+
+static void StationRatingDetailWndProc(Window *w, WindowEvent *e)
+{
+	// String IDs to display
+	static const uint16 rating_str[] = {
+		STR_STATION_RATING_DETAIL_WAITING,
+		STR_STATION_RATING_DETAIL_SPEED,
+		STR_STATION_RATING_DETAIL_AGE,
+		STR_STATION_RATING_DETAIL_PICKUP,
+		STR_STATION_RATING_DETAIL_OTHER,
+		STR_STATION_RATING_DETAIL_TOTAL
+	};
+	// More string IDs to display
+	static const uint16 rating_str_ex[] = {
+		STR_STATION_RATING_DETAIL_WAITING_EX,
+		STR_STATION_RATING_DETAIL_SPEED_EX,
+		STR_STATION_RATING_DETAIL_AGE_EX,
+		STR_STATION_RATING_DETAIL_PICKUP_EX,
+		STR_NULL,
+		STR_NULL
+	};
+	static const int rating_max_score[] = {40, 42, 33, 130, 26, 255};
+
+	switch(e->event) {
+	case WE_PAINT: {
+		int i, x, cur_x, val;
+		byte cargo;
+		uint16 y = 16;
+		int color_done, color_notdone;
+		int max_score;
+		Station *st = GetStation(w->window_number);
+		RatingStats *rs;
+
+		// Disable cargo types that don't have ratings and click first cargo
+		w->disabled_state = 0;
+		for (i=0; i!=NUM_CARGO; i++) {
+			if(st->goods[i].enroute_from == INVALID_STATION) {
+				SETBIT(w->disabled_state, i + 9);
+				CLRBIT(w->click_state, i + 9);
+			} else if(w->click_state == 0) {
+				SETBIT(w->click_state, i + 9);
+			}
+		}
+		if(w->click_state == 0)
+			SETBIT(w->disabled_state, 21);
+
+		// Draw standard stuff
+		SetDParam(0, st->index);
+		SetDParam(1, st->facilities);
+		DrawWindowWidgets(w);
+
+		// Paint the cargo icons
+		cur_x = 9;
+		for (i = 0; i != NUM_CARGO; i++) {
+			if(st->goods[i].enroute_from != INVALID_STATION)
+				DrawSprite(_cargoc.sprites[i], cur_x, y);
+			cur_x += 28;
+		}
+
+		// The colors used to show how the progress is going
+		color_done = _color_list[6].window_color_1b;
+		color_notdone = _color_list[4].window_color_1b;
+
+		// No cargo type selected
+		if(w->click_state == 0)
+			break;
+
+		// The type of cargo of which we check the detail service rating
+		cargo = FindFirstBit(w->click_state) - 9;
+		
+		if (cargo < NUM_CARGO) 
+			w->listopt.cargo_mask = 1 << GetGlobalCargoID(_opt_ptr->landscape, cargo);
+		else
+			w->listopt.cargo_mask = CARGO_MASK_ALL;
+		w->listopt.type_mask = VEHICLE_TYPE_ALL;
+		w->listopt.xy = st->xy;
+
+		rs = &st->rating_stats[cargo];
+
+		y += 18;
+
+		for(i=0; i<NUM_RATINGS; i++) {
+			DrawString(7, y, rating_str[i], 0);
+
+			// Draw the raw values
+			switch(i) {
+				case RATING_WAITING:
+					SetDParam(1, rs->waiting);
+					SetDParam(0, _cargoc.names_long[cargo]);
+					break;
+				case RATING_SPEED:
+					SetDParam(0, rs->last_speed);
+					break;
+				case RATING_AGE:
+					SetDParam(0, rs->last_age);
+					break;
+				case RATING_PICKUP:
+					SetDParam(0, rs->days_since_pickup);
+					break;
+				default:
+					break;
+			}
+
+			if(rating_str_ex[i] != STR_NULL)
+				DrawStringRightAligned(205, y, rating_str_ex[i], 0);
+
+			// Calculate the %-bar
+			val = rs->ratings[i];
+
+			max_score = rating_max_score[i];
+			if (val > max_score) x = 50;
+			else if (val <= 0) x = 0;
+			else x = ((val * 50) / max_score);
+
+			// Draw the bar
+			if (x != 0)
+				GfxFillRect(210, y-2, x + 210, y+10, color_done);
+			if (x != 50)
+				GfxFillRect(x + 210, y-2, 50 + 210, y+10, color_notdone);
+
+			// Calculate the %
+			if (val > max_score) x = 100;
+			else x = ((val * 100) / max_score);
+
+			// Draw it
+			SetDParam(0, x);
+			DrawStringCentered(235, y, STR_STATION_RATING_DETAIL_PERCENT, 0);
+
+			// Draw the score and max_score
+			SetDParam(0, val);
+			SetDParam(1, max_score);
+			DrawString(265, y, STR_STATION_RATING_DETAIL_SCORES, 0);
+
+			y += 20;
+		}
+
+		break;
+	}
+
+	case WE_CLICK:
+		// Check which button is clicked
+		if (IS_INT_INSIDE(e->click.widget, 9, 21)) {
+			// Is it no on disable?
+			if ((w->disabled_state & (1 << e->click.widget)) == 0) {
+				Station *st = GetStation(w->window_number);
+				Window *w2 = FindWindowById(WC_VEHICLES_LIST, (st->index << 16) | st->owner);
+				vehiclelist_d *vl;
+				w->click_state = 1 << e->click.widget;
+				w->listopt.cargo_mask = 1 << GetGlobalCargoID(_opt_ptr->landscape, FindFirstBit(w->click_state) - 9);
+				SetWindowDirty(w);
+				if (w2) {
+					vl = &WP(w2, vehiclelist_d);
+					vl->flags |= VL_REBUILD;
+					w2->listopt.cargo_mask = w->listopt.cargo_mask;
+					SetWindowDirty(w2);
+				}
+			}
+		} else if (e->click.widget == 21) {
+			Station *st = GetStation(w->window_number);
+			ShowPlayerVehicles(st->owner, st->index, w->listopt.type_mask, w->listopt.cargo_mask, w->listopt.xy);
+			w->click_state = 1 << (GetLocalCargoID(FindFirstBit(w->listopt.cargo_mask)) + 9);
+			SetWindowDirty(w);
+		}
+		break;
+
+	case WE_CREATE:
+		{
+			w->hidden_state = 0;
+			w->disabled_state = 0;
+			w->click_state = 0;
+
+			SetWindowDirty(w);
+		}
+		break;
+	}
+}
+
+static const Widget _station_rating_detail_widgets[] = {
+{    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,   RESIZE_NONE,    14,    11,   325,     0,    13, STR_STATION_RATING_DETAIL,	STR_018C_WINDOW_TITLE_DRAG_THIS},
+{  WWT_STICKYBOX,   RESIZE_NONE,    14,   326,   337,     0,    13, 0x0, STR_STICKY_BUTTON},
+
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   337,    28,    47, 0x0,STR_STATION_RATING_DETAIL_WAITING_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   337,    48,    67, 0x0,STR_STATION_RATING_DETAIL_SPEED_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   337,    68,    87, 0x0,STR_STATION_RATING_DETAIL_AGE_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   337,    88,   107, 0x0,STR_STATION_RATING_DETAIL_PICKUP_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   337,   108,   127, 0x0,STR_STATION_RATING_DETAIL_OTHER_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   337,   128,   147, 0x0,STR_STATION_RATING_DETAIL_TOTAL_TIP},
+
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     1,    28,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,    29,    56,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,    57,    84,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,    85,   112,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   113,   140,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   141,   168,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   169,   196,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   197,   224,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   225,   252,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   253,   280,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   281,   308,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,   309,   336,    14,    27, 0x0,STR_STATION_RATING_DETAIL_TOGGLE_CARGO_TIP},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,   336,    148,   160, STR_VEHICLE_CARGO_LIST, 0x0},
+{   WIDGETS_END},
+};
+
+static const WindowDesc _station_rating_detail_desc = {
+	-1, -1, 338, 161,
+	WC_STATION_RATING_DETAIL,0,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS | WDF_STICKY_BUTTON,
+	_station_rating_detail_widgets,
+	StationRatingDetailWndProc
+};
+
+void ShowStationRatingDetail(StationID station)
+{
+	Window *w;
+	byte color;
+
+	w = AllocateWindowDescFront(&_station_rating_detail_desc, station);
+	if (w) {
+		color = GetStation(w->window_number)->owner;
+		if (color != 0x10)
+			w->caption_color = color;
 		w->vscroll.cap = 5;
 	}
 }
+
+static void PlayerVehiclesWndProc(Window *w, WindowEvent *e)
+{
+	int station = (int)w->window_number >> 16;
+	int owner = w->window_number & 0xff;
+	vehiclelist_d *vl = &WP(w, vehiclelist_d);
+
+	switch(e->event) {
+	case WE_PAINT: {
+		int x = 2;
+		int y = PLY_WND_PRC__OFFSET_TOP_WIDGET;
+		int max;
+		int i;
+
+		BuildVehicleListMasked(vl, &w->listopt, owner);
+		SortVehicleList(vl);
+
+		SetVScrollCount(w, vl->list_length);
+		// disable 'Sort By' tooltip on Unsorted sorting criteria
+		if (vl->sort_type == SORT_BY_UNSORTED)
+			w->disabled_state |= (1 << 3);
+
+		/* draw the widgets */
+		{
+			const Player *p = GetPlayer((owner != OWNER_NONE) ? owner : _current_player);
+			if (station == -1) {
+				/* Company Name -- (###) Trains */
+				SetDParam(0, p->name_1);
+				SetDParam(1, p->name_2);
+				SetDParam(2, w->vscroll.count);
+				w->widget[1].unkA = STR_VEHICLES;
+			} else {
+				/* Station Name -- (###) Trains */
+				SetDParam(0, station);
+				SetDParam(1, w->vscroll.count);
+				w->widget[1].unkA = STR_SCHEDULED;
+			}
+			DrawWindowWidgets(w);
+		}
+		/* draw sorting criteria string */
+		DrawString(85, 15, _vehicle_sort_listing[vl->sort_type], 0x10);
+		/* draw arrow pointing up/down for ascending/descending sorting */
+		DoDrawString(vl->flags & VL_DESC ? "\xAA" : "\xA0", 69, 15, 0x10);
+
+		max = min(w->vscroll.pos + w->vscroll.cap, vl->list_length);
+		for (i = w->vscroll.pos; i < max; ++i) {
+			Vehicle *v = GetVehicle(vl->sort_list[i].index);
+			StringID str;
+
+			assert(v->owner == owner || v->owner == _current_player);
+
+			switch (v->type) {
+				case VEH_Train:
+				{
+					DrawTrainImage(
+						v, x + 21, y + 6 + _traininfo_vehicle_pitch, w->hscroll.cap, 0, INVALID_VEHICLE);
+
+					SetDParam(0, v->unitnumber);
+					if (IsTileDepotType(v->tile, TRANSPORT_RAIL) && (v->vehstatus & VS_HIDDEN))
+						str = STR_021F;
+					else
+						str = v->age > v->max_age - 366 ? STR_00E3 : STR_00E2;
+					DrawString(x, y + 2, str, 0);
+					if (v->string_id != STR_SV_TRAIN_NAME) {
+						SetDParam(0, v->string_id);
+						DrawString(x + 21, y, STR_01AB, 0);
+					}
+					break;
+				}
+				case VEH_Road:
+				{
+					DrawRoadVehImage(v, x + 22, y + 6, INVALID_VEHICLE);
+					SetDParam(0, v->unitnumber);
+					if (IsTileDepotType(v->tile, TRANSPORT_ROAD) && (v->vehstatus & VS_HIDDEN))
+						str = STR_021F;
+					else
+						str = v->age > v->max_age - 366 ? STR_00E3 : STR_00E2;
+					DrawString(x, y + 2, str, 0);
+					if (v->string_id != STR_SV_ROADVEH_NAME) {
+						SetDParam(0, v->string_id);
+						DrawString(x + 24, y, STR_01AB, 0);
+					}
+					break;
+				}
+				case VEH_Aircraft:
+				{
+					DrawAircraftImage(v, x + 19, y + 6, INVALID_VEHICLE);
+					SetDParam(0, v->unitnumber);
+					if (IsAircraftHangarTile(v->tile) && (v->vehstatus & VS_HIDDEN))
+						str = STR_021F;
+					else
+						str = v->age > v->max_age - 366 ? STR_00E3 : STR_00E2;
+					DrawString(x, y + 2, str, 0);
+					if (v->string_id != STR_SV_AIRCRAFT_NAME) {
+						SetDParam(0, v->string_id);
+						DrawString(x + 19, y, STR_01AB, 0);
+					}
+					break;
+				}
+				case VEH_Ship:
+				{
+					DrawShipImage(v, x + 19, y + 6, INVALID_VEHICLE);
+					SetDParam(0, v->unitnumber);
+					if (IsTileDepotType(v->tile, TRANSPORT_WATER) && (v->vehstatus & VS_HIDDEN))
+						str = STR_021F;
+					else
+						str = v->age > v->max_age - 366 ? STR_00E3 : STR_00E2;
+					DrawString(x, y + 2, str, 0);
+					if (v->string_id != STR_SV_SHIP_NAME) {
+						SetDParam(0, v->string_id);
+						DrawString(x + 12, y, STR_01AB, 0);
+					}
+					break;
+				}
+				default:
+					continue;
+			}
+			DrawVehicleProfitButton(v, x, y + 13);
+			SetDParam(0, v->profit_this_year);
+			SetDParam(1, v->profit_last_year);
+			DrawString(x + 21, y + 18, STR_0198_PROFIT_THIS_YEAR_LAST_YEAR, 0);
+
+			y += PLY_WND_PRC__SIZE_OF_ROW_BIG;
+		}
+		break;
+	}
+
+	case WE_CLICK: {
+		switch(e->click.widget) {
+		case 3: /* Flip sorting method ascending/descending */
+			vl->flags ^= VL_DESC;
+			vl->flags |= VL_RESORT;
+			_sorting.masked.order = !!(vl->flags & VL_DESC);
+			SetWindowDirty(w);
+			break;
+
+		case 4: case 5:/* Select sorting criteria dropdown menu */
+			ShowDropDownMenu(w, _vehicle_sort_listing, vl->sort_type, 5, 0, 0);
+			return;
+
+		case 7: { /* Matrix to show vehicles */
+			uint32 id_v = (e->click.pt.y - PLY_WND_PRC__OFFSET_TOP_WIDGET) / PLY_WND_PRC__SIZE_OF_ROW_BIG;
+
+			if (id_v >= w->vscroll.cap) { return;} // click out of bounds
+
+			id_v += w->vscroll.pos;
+			{
+				Vehicle *v;
+				if (id_v >= vl->list_length) return; // click out of list bound
+				v = GetVehicle(vl->sort_list[id_v].index);
+
+				assert(v->owner == owner);
+				
+				switch (v->type)
+				{
+				case VEH_Train:
+					ShowTrainViewWindow(v);
+					break;
+				case VEH_Ship:
+					ShowShipViewWindow(v);
+					break;
+				case VEH_Road:
+					ShowRoadVehViewWindow(v);
+					break;
+				case VEH_Aircraft:
+					ShowAircraftViewWindow(v);
+					break;
+				}
+			}
+		} break;
+		}
+	}	break;
+
+	case WE_DROPDOWN_SELECT: /* we have selected a dropdown item in the list */
+		if (vl->sort_type != e->dropdown.index) {
+			// value has changed -> resort
+			vl->flags |= VL_RESORT;
+			vl->sort_type = e->dropdown.index;
+			_sorting.masked.criteria = vl->sort_type;
+
+			// enable 'Sort By' if a sorter criteria is chosen
+			if (vl->sort_type != SORT_BY_UNSORTED)
+				CLRBIT(w->disabled_state, 3);
+		}
+		SetWindowDirty(w);
+		break;
+
+	case WE_CREATE: /* set up resort timer */
+		vl->sort_list = NULL;
+		vl->flags = VL_REBUILD | (_sorting.train.order << (VL_DESC - 1));
+		vl->sort_type = _sorting.masked.criteria;
+		vl->resort_timer = DAY_TICKS * PERIODIC_RESORT_DAYS;
+		break;
+
+	case WE_DESTROY:
+		free(vl->sort_list);
+		break;
+
+	case WE_TICK: /* resort the list every 20 seconds orso (10 days) */
+		if (--vl->resort_timer == 0) {
+			DEBUG(misc, 1) ("Periodic resort trains list player %d station %d",
+				owner, station);
+			vl->resort_timer = DAY_TICKS * PERIODIC_RESORT_DAYS;
+			vl->flags |= VL_RESORT;
+			SetWindowDirty(w);
+		}
+		break;
+
+	case WE_RESIZE:
+		/* Update the scroll + matrix */
+		w->hscroll.cap += e->sizing.diff.x / 29;
+		w->vscroll.cap += e->sizing.diff.y / PLY_WND_PRC__SIZE_OF_ROW_BIG;
+		w->widget[7].unkA = (w->vscroll.cap << 8) + 1;
+		break;
+	}
+}
+
+static const Widget _player_vehicles_widgets[] = {
+{   WWT_CLOSEBOX,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,							STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,  RESIZE_RIGHT,    14,    11,   312,     0,    13, STR_VEHICLES,				STR_018C_WINDOW_TITLE_DRAG_THIS},
+{  WWT_STICKYBOX,     RESIZE_LR,    14,   313,   324,     0,    13, 0x0,										STR_STICKY_BUTTON},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,    80,    14,    25, SRT_SORT_BY,						STR_SORT_ORDER_TIP},
+{      WWT_PANEL,   RESIZE_NONE,    14,    81,   232,    14,    25, 0x0,										STR_SORT_CRITERIA_TIP},
+{   WWT_CLOSEBOX,   RESIZE_NONE,    14,   233,   243,    14,    25, STR_0225,							STR_SORT_CRITERIA_TIP},
+{      WWT_PANEL,  RESIZE_RIGHT,    14,   244,   324,    14,    25, 0x0,										STR_NULL},
+{     WWT_MATRIX,     RESIZE_RB,    14,     0,   312,    26,   207, 0x701,									STR_883D_TRAINS_CLICK_ON_TRAIN_FOR},
+{  WWT_SCROLLBAR,    RESIZE_LRB,    14,   313,   324,    26,   207, 0x0,										STR_0190_SCROLL_BAR_SCROLLS_LIST},
+{      WWT_PANEL,    RESIZE_RTB,    14,     0,   312,   208,   219, 0x0,										STR_NULL},
+{  WWT_RESIZEBOX,   RESIZE_LRTB,    14,   313,   324,   208,   219, 0x0,										STR_RESIZE_BUTTON},
+{   WIDGETS_END},
+};
+
+static const WindowDesc _player_vehicles_desc = {
+	-1, -1, 325, 220,
+	WC_VEHICLES_LIST,0,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS | WDF_STICKY_BUTTON | WDF_RESIZABLE,
+	_player_vehicles_widgets,
+	PlayerVehiclesWndProc
+};
+
+void ShowPlayerVehicles(PlayerID player, StationID station, TypeMask type_mask, CargoMask cargo_mask, TileIndex xy)
+{
+	Window *w;
+
+	w = AllocateWindowDescFront(&_player_vehicles_desc, (station << 16) | player);
+	if (w) {
+		w->listopt.cargo_mask = cargo_mask;
+		w->listopt.type_mask = type_mask;
+		w->listopt.xy = xy;
+
+		w->caption_color = (player != OWNER_NONE) ? player : _current_player;
+		w->hscroll.cap = 10;
+		w->vscroll.cap = 5; // maximum number of vehicles shown
+		w->widget[7].unkA = (w->vscroll.cap << 8) + 1;
+		w->resize.step_height = PLY_WND_PRC__SIZE_OF_ROW_BIG;
+		w->resize.step_width = 29;
+		w->resize.height = 220 - (PLY_WND_PRC__SIZE_OF_ROW_BIG * 3); /* Minimum of 4 vehicles */
+	} else {
+		w = FindWindowById(WC_VEHICLES_LIST, (station << 16) | player);
+		if (w) {
+			vehiclelist_d *vl;
+			vl = &WP(w, vehiclelist_d);
+			vl->flags |= VL_REBUILD;
+			w->listopt.cargo_mask = cargo_mask;
+			w->listopt.type_mask = type_mask;
+			w->listopt.xy = xy;
+			SetWindowDirty(w);
+		}
+	}
+}
Index: network_data.h
===================================================================
--- network_data.h	(Revision 2953)
+++ network_data.h	(Arbeitskopie)
@@ -18,9 +18,9 @@
 #define NETWORK_EMPTY_INDEX 0
 
 // What version of game-info do we use?
-#define NETWORK_GAME_INFO_VERSION 1
+#define NETWORK_GAME_INFO_VERSION 2
 // What version of company info is this?
-#define NETWORK_COMPANY_INFO_VERSION 3
+#define NETWORK_COMPANY_INFO_VERSION 4
 // What version of master-server-protocol do we use?
 #define NETWORK_MASTER_SERVER_VERSION 1
 
Index: gfx.h
===================================================================
--- gfx.h	(Revision 2953)
+++ gfx.h	(Arbeitskopie)
@@ -78,6 +78,8 @@
 
 bool FillDrawPixelInfo(DrawPixelInfo *n, DrawPixelInfo *o, int left, int top, int width, int height);
 
+void ScrollSmallmap(int mx, int my);
+
 /* window.c */
 void DrawOverlappedWindowForAll(int left, int top, int right, int bottom);
 
Index: strings.c
===================================================================
--- strings.c	(Revision 2953)
+++ strings.c	(Arbeitskopie)
@@ -306,7 +306,7 @@
 }
 
 
-static char *FormatYmdString(char *buff, uint16 number)
+static char *FormatYmdString(char *buff, uint32 number)
 {
 	const char *src;
 	YearMonthDay ymd;
@@ -322,7 +322,7 @@
 	return FormatNoCommaNumber(buff+4, ymd.year + MAX_YEAR_BEGIN_REAL);
 }
 
-static char *FormatMonthAndYear(char *buff, uint16 number)
+static char *FormatMonthAndYear(char *buff, uint32 number)
 {
 	const char *src;
 	YearMonthDay ymd;
@@ -335,7 +335,7 @@
 	return FormatNoCommaNumber(buff, ymd.year + MAX_YEAR_BEGIN_REAL);
 }
 
-static char *FormatTinyDate(char *buff, uint16 number)
+static char *FormatTinyDate(char *buff, uint32 number)
 {
 	YearMonthDay ymd;
 
Index: aircraft_gui.c
===================================================================
--- aircraft_gui.c	(Revision 2953)
+++ aircraft_gui.c	(Arbeitskopie)
@@ -17,6 +17,8 @@
 #include "engine.h"
 #include "viewport.h"
 #include "player.h"
+#include "economy.h"
+#include "network.h"
 #include "depot.h"
 #include "vehicle_gui.h"
 
@@ -50,7 +52,7 @@
 	y += 10;
 
 	/* Design date - Life length */
-	SetDParam(0, ymd.year + 1920);
+	SetDParam(0, ymd.year);
 	SetDParam(1, e->lifelength);
 	DrawString(x, y, STR_PURCHASE_INFO_DESIGNED_LIFE, 0);
 	y += 10;
@@ -61,7 +63,7 @@
 	y += 10;
 }
 
-static void DrawAircraftImage(const Vehicle *v, int x, int y, VehicleID selection)
+void DrawAircraftImage(const Vehicle *v, int x, int y, VehicleID selection)
 {
 	int image = GetAircraftImage(v, 6);
 	uint32 ormod = SPRITE_PALETTE(PLAYER_SPRITE_COLOR(v->owner));
@@ -332,7 +334,7 @@
 
 		/* Draw running cost */
 		{
-			int year = v->age / 366;
+			uint32 year = v->age / 366;
 
 			SetDParam(1, year);
 
@@ -378,7 +380,7 @@
 			do {
 				if (v->subtype <= 2) {
 					SetDParam(0, GetCustomEngineName(v->engine_type));
-					SetDParam(1, 1920 + v->build_year);
+					SetDParam(1, v->build_year);
 					SetDParam(2, v->value);
 					DrawString(60, y, STR_A011_BUILT_VALUE, 0);
 					y += 10;
@@ -523,7 +525,7 @@
 						disabled = 0;
 		}
 
-		if (v->owner != _local_player)
+		if (!IsSisterCompany(v->owner,_local_player))
 			disabled |= 1<<8 | 1<<7;
 		w->disabled_state = disabled;
 
@@ -659,8 +661,7 @@
 	tile = w->window_number;
 
 	/* setup disabled buttons */
-	w->disabled_state =
-		IsTileOwner(tile, _local_player) ? 0 : ((1<<4) | (1<<7) | (1<<8));
+	w->disabled_state = IsSisterCompany(GetTileOwner(tile), _local_player) ? 0 : ((1<<4) | (1<<7) | (1<<8));
 
 	/* determine amount of items for scroller */
 	num = 0;
@@ -879,7 +880,9 @@
 		case 4:
 			if (!HASBIT(w->disabled_state, 4) &&
 					WP(w,traindepot_d).sel != INVALID_VEHICLE)	{
+
 				Vehicle *v;
+				byte backup = _current_player;
 
 				HandleButtonClick(w, 4);
 
@@ -889,8 +892,10 @@
 				_backup_orders_tile = v->tile;
 				BackupVehicleOrders(v, _backup_orders_data);
 
+				_current_player = v->owner;
 				if (!DoCommandP(v->tile, v->index, 0, NULL,  CMD_SELL_AIRCRAFT | CMD_MSG(STR_A01C_CAN_T_SELL_AIRCRAFT)))
 					_backup_orders_tile = 0;
+				_current_player = backup;
 			}
 			break;
 		default:
@@ -1022,9 +1027,19 @@
 		int max;
 		int i;
 
-		BuildVehicleList(vl, VEH_Aircraft, owner, station);
+		BuildVehicleListMasked(vl, &w->listopt, owner);
 		SortVehicleList(vl);
 
+		if (_local_player != owner){
+			if(IsWindowOfPrototype(w,_player_aircraft_widgets)){
+				w->disabled_state |= (1<<10);
+			}else{
+				w->disabled_state |= (1<<9);
+			}
+		}else{
+			w->disabled_state &= ~(1<<9);
+		}
+
 		SetVScrollCount(w, vl->list_length);
 
 		// disable 'Sort By' tooltip on Unsorted sorting criteria
@@ -1211,13 +1226,20 @@
 {
 	Window *w;
 
-	if (player == _local_player) {
+	if (IsSisterCompany(player,_local_player)) {
 		w = AllocateWindowDescFront(&_player_aircraft_desc, (station << 16) | player);
 	} else  {
 		w = AllocateWindowDescFront(&_other_player_aircraft_desc, (station << 16) | player);
 	}
 
 	if (w) {
+		w->listopt.cargo_mask = CARGO_MASK_ALL;
+		w->listopt.type_mask = 1 << VEH_Aircraft;
+		if (station != INVALID_STATION)
+			w->listopt.xy = GetStation(station)->xy;
+		else
+			w->listopt.xy = INVALID_TILE;
+
 		w->caption_color = w->window_number;
 		w->vscroll.cap = 4;
 		w->widget[7].unkA = (w->vscroll.cap << 8) + 1;
Index: train_cmd.c
===================================================================
--- train_cmd.c	(Revision 2953)
+++ train_cmd.c	(Arbeitskopie)
@@ -17,6 +17,8 @@
 #include "engine.h"
 #include "player.h"
 #include "sound.h"
+#include "economy.h"
+#include "network.h"
 #include "depot.h"
 #include "debug.h"
 #include "waypoint.h"
@@ -229,10 +231,10 @@
 			}
 		}
 
-		//if we have a 90 degree turn, fix the speed limit to 60
+		//if we have a 90 turn/go to depot, fix the speed limit to 64
 		if (_curve_neighbours90[dir][0] == ndir ||
 				_curve_neighbours90[dir][1] == ndir) {
-			max_speed = 61;
+			max_speed = 64 + (v->cur_speed >> 3);
 		}
 	}
 
@@ -255,19 +257,21 @@
 			int station_length = 0;
 			TileIndex tile = v->tile;
 			int delta_v;
-
-			max_speed = 120;
+			
+			max_speed = 64 + (v->u.rail.cached_max_speed >> 2);
 			do {
 				station_length++;
 				tile = TILE_ADD(tile, TileOffsByDir(v->direction / 2));
 			} while (IsCompatibleTrainStationTile(tile, v->tile));
 
-			delta_v = v->cur_speed / (station_length + 1);
-			if (v->max_speed > (v->cur_speed - delta_v))
-				max_speed = v->cur_speed - (delta_v / 10);
+			delta_v = max_speed / (station_length + 1);
+			if (max_speed > delta_v)
+				max_speed = v->max_speed - delta_v;
 
-			max_speed = max(max_speed, 25 * station_length);
-		}
+			}
+		
+		max_speed = 64 + (v->u.rail.cached_max_speed >> 2);
+	
 	}
 
 	mass = v->u.rail.cached_weight;
@@ -313,9 +317,6 @@
 				force = power / 25;
 				break;
 		}
-	} else {
-		//"kickoff" acceleration
-		force = (mass * 8) + resistance;
 	}
 
 	if (force <= 0) force = 10000;
@@ -407,8 +408,17 @@
 	SET_EXPENSES_TYPE(EXPENSES_NEW_VEHICLES);
 
 	rvi = RailVehInfo(engine);
+	
 	value = (rvi->base_cost * _price.build_railwagon) >> 8;
 
+	e = GetEngine(engine);
+
+	/* Check to make sure train type is same as depot type */
+	if (e->railtype != GetRailType(tile)) {
+		_error_message = STR_INCOMPATIBLE_RAIL_TYPE;
+		return CMD_ERROR;
+	}
+		
 	if (!(flags & DC_QUERY_COST)) {
 		_error_message = STR_00E1_TOO_MANY_VEHICLES_IN_GAME;
 
@@ -462,7 +472,6 @@
 			v->value = value;
 //			v->day_counter = 0;
 
-			e = GetEngine(engine);
 			v->u.rail.railtype = e->railtype;
 
 			v->build_year = _cur_year;
@@ -579,6 +588,14 @@
 	Engine *e;
 	TileIndex tile = TileVirtXY(x, y);
 
+	e = GetEngine(p1);
+	
+	/* Check to make sure train type is same as depot type */
+	if (e->railtype != GetRailType(tile)) {
+		_error_message = STR_INCOMPATIBLE_RAIL_TYPE;
+		return CMD_ERROR;
+	}
+
 	/* Check if the engine-type is valid (for the player) */
 	if (!IsEngineBuildable(p1, VEH_Train)) return CMD_ERROR;
 
@@ -586,7 +603,7 @@
 	 * to the player. Doesn't matter if only the cost is queried */
 	if (!(flags & DC_QUERY_COST)) {
 		if (!IsTileDepotType(tile, TRANSPORT_RAIL)) return CMD_ERROR;
-		if (!IsTileOwner(tile, _current_player)) return CMD_ERROR;
+		if (!IsSisterCompany(GetTileOwner(tile),_current_player)) return CMD_ERROR;
 	}
 
 	_cmd_build_rail_veh_var1 = 0;
@@ -1573,7 +1590,7 @@
 
 static bool NtpCallbFindDepot(TileIndex tile, TrainFindDepotData *tfdd, int track, uint length)
 {
-	if (IsTileType(tile, MP_RAILWAY) && IsTileOwner(tile, tfdd->owner)) {
+	if (IsTileType(tile, MP_RAILWAY) && (IsSisterCompany(GetTileOwner(tile), tfdd->owner) || _patches.shared_stations)) {
 		if ((_m[tile].m5 & ~0x3) == 0xC0) {
 			tfdd->best_length = length;
 			tfdd->tile = tile;
@@ -1730,14 +1747,17 @@
 {
 	Vehicle *u;
 
-	if (v->vehstatus & VS_TRAIN_SLOWING || v->load_unload_time_rem != 0 || v->cur_speed < 2)
+	if (v->vehstatus & VS_TRAIN_SLOWING || 
+		v->vehstatus & VS_STOPPED ||
+		v->load_unload_time_rem != 0 || 
+		v->cur_speed < 2)
 		return;
 
 	u = v;
 
 	do {
 		int engtype = v->engine_type;
-
+		
 		// no smoke?
 		if (RailVehInfo(engtype)->flags & 2 ||
 				GetEngine(engtype)->railtype > 0 ||
@@ -1747,7 +1767,9 @@
 		switch (RailVehInfo(engtype)->engclass) {
 		case 0:
 			// steam smoke.
-			if ( (v->tick_counter&0xF) == 0 && !IsTileDepotType(v->tile, TRANSPORT_RAIL) && !IsTunnelTile(v->tile)) {
+			if ( (v->tick_counter&0x7) == 0 && 
+				!IsTileDepotType(v->tile, TRANSPORT_RAIL) && 
+				!IsTunnelTile(v->tile)) {
 				CreateEffectVehicleRel(v,
 					(_vehicle_smoke_pos[v->direction]),
 					(_vehicle_smoke_pos[v->direction+8]),
@@ -1758,14 +1780,21 @@
 
 		case 1:
 			// diesel smoke
-			if (u->cur_speed <= 40 && !IsTileDepotType(v->tile, TRANSPORT_RAIL) && !IsTunnelTile(v->tile) && (uint16)Random() <= 0x1E00) {
+			if (!IsTileDepotType(v->tile, TRANSPORT_RAIL) && 
+				!IsTunnelTile(v->tile) && 
+				(uint16)Random() <= ((32000 >> (u->cur_speed >> 5)) + 
+				(u->u.rail.cached_weight << 4) - (u->u.rail.cached_power >> 2))) {
 				CreateEffectVehicleRel(v, 0, 0, 10, EV_DIESEL_SMOKE);
 			}
 			break;
 
 		case 2:
 			// blue spark
-			if ( (v->tick_counter&0x3) == 0 && !IsTileDepotType(v->tile, TRANSPORT_RAIL) && !IsTunnelTile(v->tile) && (uint16)Random() <= 0x5B0) {
+			if ( (v->tick_counter&0x3) == 0 && 
+				!IsTileDepotType(v->tile, TRANSPORT_RAIL) && 
+				!IsTunnelTile(v->tile) && 
+				(uint16)Random() <= (1456 + (32000 >> (u->cur_speed >> 4)) + 
+				(u->u.rail.cached_weight << 3))) {
 				CreateEffectVehicleRel(v, 0, 0, 10, EV_ELECTRIC_SPARK);
 			}
 			break;
@@ -2337,6 +2366,9 @@
 			v->index,
 			0);
 	}
+	if (v->subtype == TS_Front_Engine) st->vehicles[STS_VEH_TRAIN].this_month++;
+	if (st->months_counted == 0) st->months_counted = 1;
+	InvalidateWindow(WC_STATION_STATS, st->index);
 
 	// Did we reach the final destination?
 	if (v->current_order.type == OT_GOTO_STATION &&
@@ -2460,7 +2492,7 @@
 		case MP_STREET:
 			// tracks over roads, do owner check of tracks
 			return
-				IsTileOwner(tile, v->owner) &&
+				(_patches.shared_tracks || IsSisterCompany(GetTileOwner(tile), v->owner)) &&
 				(v->subtype != TS_Front_Engine || (_m[tile].m4 & 0xF) == v->u.rail.railtype);
 
 		default:
@@ -2468,7 +2500,7 @@
 	}
 
 	return
-		IsTileOwner(tile, v->owner) &&
+		(_patches.shared_tracks || IsSisterCompany(GetTileOwner(tile), v->owner)) &&
 		(v->subtype != TS_Front_Engine ||
 		IsCompatibleRail(v->u.rail.railtype, GetRailType(tile)));
 }
@@ -2825,8 +2857,20 @@
 					assert(v->u.rail.track);
 				}
 
-				if (v->subtype == TS_Front_Engine)
-				TrainMovedChangeSignals(gp.new_tile, enterdir);
+				if (v->subtype == TS_Front_Engine) {
+					TrainMovedChangeSignals(gp.new_tile, enterdir);
+					if (v->current_order.type == OT_GOTO_WAYPOINT && v->tile == v->dest_tile) {
+						Waypoint *wp = GetWaypointByTile(v->tile);
+						if (wp->months_counted == 0) wp->months_counted = 1;
+						wp->vehicles[WPS_ORDER_MONTH].this_month++;
+						wp->vehicles[WPS_ORDER_YEAR].this_month++;
+					} else if (IsRailWaypoint(_m[v->tile].m5)) {
+						Waypoint *wp = GetWaypointByTile(v->tile);
+						if (wp->months_counted == 0) wp->months_counted = 1;
+						wp->vehicles[WPS_PATHFIND_MONTH].this_month++;
+						wp->vehicles[WPS_PATHFIND_YEAR].this_month++;
+					}
+				}	
 
 				/* Signals can only change when the first
 				 * (above) or the last vehicle moves. */
Index: player.h
===================================================================
--- player.h	(Revision 2953)
+++ player.h	(Arbeitskopie)
@@ -116,7 +116,7 @@
 	byte action;
 
 	int last_id; // here is stored the last id of the searched city/industry
-	uint last_vehiclecheck_date; // Used in CheckVehicle
+	uint32 last_vehiclecheck_date; // Used in CheckVehicle
 	Ai_SpecialVehicle special_vehicles[AI_MAX_SPECIAL_VEHICLES]; // Some vehicles have some special flags
 
 	TileIndex from_tile;
@@ -171,7 +171,7 @@
 
 	byte share_owners[4];
 
-	byte inaugurated_year;
+	uint32 inaugurated_year;
 	byte num_valid_stat_ent;
 
 	byte quarters_of_bankrupcy;
Index: industry_cmd.c
===================================================================
--- industry_cmd.c	(Revision 2953)
+++ industry_cmd.c	(Arbeitskopie)
@@ -1015,7 +1015,7 @@
 		int x = (i->width>>1) + Random() % 31 - 16;
 		int y = (i->height>>1) + Random() % 31 - 16;
 		tile = TileAddWrap(i->xy, x, y);
-		if (tile != INVALID_TILE)
+		if (tile != INVALID_TILE && GetMapExtraBits(tile) != 1)
 			PlantFarmField(tile);
 	}
 }
@@ -1127,7 +1127,7 @@
 		i->cargo_waiting[0] = min(0xffff, i->cargo_waiting[0] + i->production_rate[0]);
 		i->cargo_waiting[1] = min(0xffff, i->cargo_waiting[1] + i->production_rate[1]);
 
-		if (i->type == IT_FARM)
+		if (i->type == IT_FARM || i->type == IT_FARM_2)
 			MaybePlantFarmField(i);
 		else if (i->type == IT_LUMBER_MILL && (i->counter & 0x1FF) == 0)
 			ChopLumberMillTrees(i);
@@ -1698,7 +1698,7 @@
 			return;
 
 		case INDUSTRY_CLOSABLE:
-			if ((byte)(_cur_year - i->last_prod_year) < 5 || !CHANCE16(1, 180))
+			if ((_cur_year - i->last_prod_year) < 5 || !CHANCE16(1, 180))
 				closeit = false;
 			break;
 
@@ -1707,13 +1707,17 @@
 				uint32 r = Random();
 				int old, new, percent;
 				int mag;
+				int influence = (i->pct_transported[j] > PERCENT_INCREASE) ? 1 : -1;
 
 				new = old = i->production_rate[j];
-				if (CHANCE16I(20, 1024, r))
-					new -= ((RandomRange(50) + 10) * old) >> 8;
-				if (CHANCE16I(20 + (i->pct_transported[j] * 20 >> 8), 1024, r >> 16))
-					new += ((RandomRange(50) + 10) * old) >> 8;
+				//if more than 60% of cargo is transported, there's a up to 3% chance we increase
+				if (CHANCE16I((CHANCE_A + influence), CHANCE_B, r))
+					new += (((old >> 1) - (old >> 2) - (old >> 4) - (old >> 5)) - RandomRange(old >> 3));
 
+				//if less than 60% of cargo is transported, there's up to 3% chance we decrease
+				if (CHANCE16I((CHANCE_A - influence), CHANCE_B, r))
+					new -= ((AMOUNT_A + RandomRange(AMOUNT_B)) * old) >> 5;
+
 				// make sure it doesn't exceed 255 or goes below 0
 				new = clamp(new, 0, 255);
 				if (new == old) {
@@ -1808,10 +1812,10 @@
 	Industry *i;
 
 	type = _new_industry_rand[_opt.landscape][GB(r, 16, 5)];
-	if (type == IT_OIL_WELL && _date > 10958)
+	if (type == IT_OIL_WELL && _cur_year > 1950)
 		return;
 
-	if (type == IT_OIL_RIG && _date < 14610)
+	if (type == IT_OIL_RIG && _cur_year < 1960)
 		return;
 
 	j = 2000;
@@ -1886,7 +1890,7 @@
 
 		case INDUSTRY_CLOSABLE:
 			/* maybe close */
-			if ( (byte)(_cur_year - i->last_prod_year) >= 5 && CHANCE16(1,2)) {
+			if ( (_cur_year - i->last_prod_year) >= 5 && CHANCE16(1,2)) {
 				i->prod_level = 0;
 				str = _industry_close_strings[type];
 			}
@@ -1976,7 +1980,8 @@
 	SLE_VAR(Industry,type,						SLE_UINT8),
 	SLE_VAR(Industry,owner,						SLE_UINT8),
 	SLE_VAR(Industry,color_map,				SLE_UINT8),
-	SLE_VAR(Industry,last_prod_year,	SLE_UINT8),
+	SLE_CONDVAR(Industry, last_prod_year,	SLE_FILE_U8 | SLE_VAR_U32, 0, 15),
+	SLE_CONDVAR(Industry, last_prod_year,	SLE_UINT32, 16, 255),
 	SLE_VAR(Industry,was_cargo_delivered,SLE_UINT8),
 
 	// reserve extra space in savegame here. (currently 32 bytes)
Index: texteff.c
===================================================================
--- texteff.c	(Revision 2953)
+++ texteff.c	(Arbeitskopie)
@@ -30,7 +30,7 @@
 typedef struct TextMessage {
 	char message[MAX_TEXTMESSAGE_LENGTH];
 	uint16 color;
-	uint16 end_date;
+	uint32 end_date;
 } TextMessage;
 
 #define MAX_CHAT_MESSAGES 10
Index: table/sprites.h
===================================================================
--- table/sprites.h	(Revision 2953)
+++ table/sprites.h	(Arbeitskopie)
@@ -71,6 +71,7 @@
 	SPR_CLONE_SHIP = SPR_OPENTTD_BASE + 99,
 
 	/* Network GUI sprites */
+	SPR_SEMA = SPR_OPENTTD_BASE +24,
 	SPR_SQUARE = SPR_OPENTTD_BASE + 23,     // colored square (used for newgrf compatibility)
 	SPR_LOCK = SPR_OPENTTD_BASE + 22,       // lock icon (for password protected servers)
 	SPR_FLAGS_BASE = SPR_OPENTTD_BASE + 90, // start of the flags block (in same order as enum NetworkLanguage)
Index: table/town_land.h
===================================================================
--- table/town_land.h	(Revision 2953)
+++ table/town_land.h	(Arbeitskopie)
@@ -2019,120 +2019,122 @@
 
 
 typedef struct {
-	byte min,max;
+	uint32 min,max;
 } HousetypeYear;
 
+#define START_OFFSET 1920
+
 static const HousetypeYear _housetype_years[] = {
-	{43, 255},
-	{37, 255},
-	{48, 255},
-	{0,  255},
-	{55, 255},
-	{55, 255},
-	{0,  255},
-	{39, 255},
-	{39, 255},
-	{25, 255},
-	{25, 255},
-	{0, 255},
-	{15, 255},
-	{31, 255},
-	{10, 40},
-	{10, 40},
-	{10, 40},
-	{57, 255},
-	{63, 255},
-	{65, 255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  31},
-	{0,  32},
-	{11, 255},
-	{15, 255},
-	{43, 255},
-	{0,  35},
-	{53, 255},
-	{0,  255},
-	{38, 255},
-	{38, 255},
-	{38, 255},
-	{38, 255},
-	{80, 255},
-	{0,  40},
-	{0,  40},
-	{25, 255},
-	{63, 255},
-	{63, 255},
-	{63, 255},
-	{63, 255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  43},
-	{0,  43},
-	{46, 255},
-	{46, 255},
-	{50, 255},
-	{50, 255},
-	{54, 255},
-	{54, 255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  40},
-	{0,  40},
-	{52, 255},
-	{52, 255},
-	{52, 255},
-	{52, 255},
-	{43, 255},
-	{43, 255},
-	{58, 255},
-	{58, 255},
-	{47, 255},
-	{47, 255},
-	{47, 255},
-	{47, 255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{53, 255},
-	{42, 255},
-	{64, 255},
-	{64, 255},
-	{0,  255},
-	{73, 255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
-	{0,  255},
+	{START_OFFSET + 43, MAX_YEAR_END},
+	{START_OFFSET + 37, MAX_YEAR_END},
+	{START_OFFSET + 48, MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{START_OFFSET + 55, MAX_YEAR_END},
+	{START_OFFSET + 55, MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{START_OFFSET + 39, MAX_YEAR_END},
+	{START_OFFSET + 39, MAX_YEAR_END},
+	{START_OFFSET + 25, MAX_YEAR_END},
+	{START_OFFSET + 25, MAX_YEAR_END},
+	{0, MAX_YEAR_END},
+	{START_OFFSET + 15, MAX_YEAR_END},
+	{START_OFFSET + 31, MAX_YEAR_END},
+	{START_OFFSET + 10, START_OFFSET + 40},
+	{START_OFFSET + 10, START_OFFSET + 40},
+	{START_OFFSET + 10, START_OFFSET + 40},
+	{START_OFFSET + 57, MAX_YEAR_END},
+	{START_OFFSET + 63, MAX_YEAR_END},
+	{START_OFFSET + 65, MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  START_OFFSET + 31},
+	{0,  START_OFFSET + 32},
+	{START_OFFSET + 11, MAX_YEAR_END},
+	{START_OFFSET + 15, MAX_YEAR_END},
+	{START_OFFSET + 43, MAX_YEAR_END},
+	{0,  START_OFFSET + 35},
+	{START_OFFSET + 53, MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{START_OFFSET + 38, MAX_YEAR_END},
+	{START_OFFSET + 38, MAX_YEAR_END},
+	{START_OFFSET + 38, MAX_YEAR_END},
+	{START_OFFSET + 38, MAX_YEAR_END},
+	{START_OFFSET + 80, MAX_YEAR_END},
+	{0,  START_OFFSET + 40},
+	{0,  START_OFFSET + 40},
+	{START_OFFSET + 25, MAX_YEAR_END},
+	{START_OFFSET + 63, MAX_YEAR_END},
+	{START_OFFSET + 63, MAX_YEAR_END},
+	{START_OFFSET + 63, MAX_YEAR_END},
+	{START_OFFSET + 63, MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  START_OFFSET + 43},
+	{0,  START_OFFSET + 43},
+	{START_OFFSET + 46, MAX_YEAR_END},
+	{START_OFFSET + 46, MAX_YEAR_END},
+	{START_OFFSET + 50, MAX_YEAR_END},
+	{START_OFFSET + 50, MAX_YEAR_END},
+	{START_OFFSET + 54, MAX_YEAR_END},
+	{START_OFFSET + 54, MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  START_OFFSET + 40},
+	{0,  START_OFFSET + 40},
+	{START_OFFSET + 52, MAX_YEAR_END},
+	{START_OFFSET + 52, MAX_YEAR_END},
+	{START_OFFSET + 52, MAX_YEAR_END},
+	{START_OFFSET + 52, MAX_YEAR_END},
+	{START_OFFSET + 43, MAX_YEAR_END},
+	{START_OFFSET + 43, MAX_YEAR_END},
+	{START_OFFSET + 58, MAX_YEAR_END},
+	{START_OFFSET + 58, MAX_YEAR_END},
+	{START_OFFSET + 47, MAX_YEAR_END},
+	{START_OFFSET + 47, MAX_YEAR_END},
+	{START_OFFSET + 47, MAX_YEAR_END},
+	{START_OFFSET + 47, MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{START_OFFSET + 53, MAX_YEAR_END},
+	{START_OFFSET + 42, MAX_YEAR_END},
+	{START_OFFSET + 64, MAX_YEAR_END},
+	{START_OFFSET + 64, MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{START_OFFSET + 73, MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
+	{0,  MAX_YEAR_END},
 };
 assert_compile(lengthof(_housetype_years) == HOUSE_MAX);
 
Index: table/engines.h
===================================================================
--- table/engines.h	(Revision 2953)
+++ table/engines.h	(Arbeitskopie)
@@ -15,7 +15,8 @@
   * @param e Rail Type of the vehicle
   * @param f Bitmask of the climates
   */
-#define MK(a,b,c,d,e,f) {a,b,c,d,((e)<<4)|(f)}
+#define MK(a,b,c,d,e,f) {701280 + a,b,c,d,((e)<<4)|(f)}
+//#define MK(a,b,c,d,e,f) {a,b,c,d,((e)<<4)|(f)}
 /** Writes the properties of a train carriage into the EngineInfo struct.
   * @see EngineInfo
   * @param a Introduction date
@@ -23,7 +24,8 @@
   * @param f Bitmask of the climates
   * @note the 0x80 in parameter b sets the "is carriage bit"
   */
-#define MW(a,b,c,d,e,f) {a,b|0x80,c,d,((e)<<4)|(f)}
+#define MW(a,b,c,d,e,f) {701280 + a,b|0x80,c,d,((e)<<4)|(f)}
+//#define MW(a,b,c,d,e,f) {a,b|0x80,c,d,((e)<<4)|(f)}
 
 EngineInfo _engine_info[TOTAL_NUM_ENGINES] = {
 	MK(  1827,  20,  15,  30,   0,   1), /*   0 Kirby Paul Tank (Steam) */
@@ -442,7 +444,7 @@
 	{  6, 18, 240, 3, SND_09_JET,                     40,  74, 30, 200 }, /*  5 */
 	{  2, 17, 150, 1, SND_09_JET,                     35,  74, 15, 100 }, /*  6 */
 	{  2, 18, 245, 3, SND_09_JET,                     40,  74, 30, 150 }, /*  7 */
-	{	 3, 19, 192, 3, SND_09_JET,                     40,  74, 40, 220 }, /*  8 */
+	{  3, 19, 192, 3, SND_09_JET,                     40,  74, 40, 220 }, /*  8 */
 	{  3, 20, 190, 3, SND_09_JET,                     40,  74, 25, 230 }, /*  9 */
 	{  2, 16, 135, 3, SND_09_JET,                     35,  74, 10,  95 }, /* 10 */
 	{  2, 18, 240, 3, SND_09_JET,                     40,  74, 35, 170 }, /* 11 */
Index: road_cmd.c
===================================================================
--- road_cmd.c	(Revision 2953)
+++ road_cmd.c	(Arbeitskopie)
@@ -14,6 +14,7 @@
 #include "town.h"
 #include "gfx.h"
 #include "sound.h"
+#include "economy.h"
 #include "depot.h"
 #include "pbs.h"
 #include "debug.h"
@@ -91,7 +92,19 @@
 	// Only do the special processing if the road is owned
 	// by a town
 	if (owner != OWNER_TOWN) {
-		return owner == OWNER_NONE || CheckOwnership(owner);
+		if(owner == OWNER_NONE || (!_patches.allow_track_removal && owner == _current_player)){
+			return true;
+		}
+		if(_patches.allow_track_removal && IsSisterCompany(owner,_current_player)){
+			return true;
+		}
+		if(!GetPlayer(owner)->is_active){
+			return true;
+		}
+
+		_error_message = STR_013B_OWNED_BY;
+		GetNameOfOwner(owner, 0);
+		return false;
 	}
 
 	if (_cheats.magic_bulldozer.value)
@@ -679,7 +692,7 @@
 
 static int32 RemoveRoadDepot(TileIndex tile, uint32 flags)
 {
-	if (!CheckTileOwnership(tile) && _current_player != OWNER_WATER)
+	if ((!CheckTileOwnership(tile) && !(_patches.allow_track_removal && IsSisterCompany(_current_player, GetTileOwner(tile))))&& _current_player != OWNER_WATER)
 		return CMD_ERROR;
 
 	if (!EnsureNoVehicle(tile))
Index: rail_cmd.c
===================================================================
--- rail_cmd.c	(Revision 2953)
+++ rail_cmd.c	(Arbeitskopie)
@@ -23,6 +23,7 @@
 #include "npf.h"
 #include "rail.h"
 #include "railtypes.h" // include table for railtypes
+#include "economy.h"
 
 extern uint16 _custom_sprites_base;
 
@@ -321,7 +322,7 @@
 				return CMD_ERROR;
 			}
 			if (m5 & RAIL_TYPE_SPECIAL ||
-					!IsTileOwner(tile, _current_player) ||
+					!(_patches.shared_tracks || IsSisterCompany(GetTileOwner(tile),_current_player)) ||
 					(_m[tile].m3 & 0xFU) != p1) {
 				// Get detailed error message
 				return DoCommandByTile(tile, 0, 0, flags, CMD_LANDSCAPE_CLEAR);
@@ -427,7 +428,9 @@
 	if (!IsTileType(tile, MP_TUNNELBRIDGE) && !IsTileType(tile, MP_STREET) && !IsTileType(tile, MP_RAILWAY))
 		return CMD_ERROR;
 
-	if (_current_player != OWNER_WATER && !CheckTileOwnership(tile))
+	if (_current_player != OWNER_WATER &&
+				((_patches.allow_track_removal && !CheckSubsidiaryTileOwnership(tile)) ||
+				(!_patches.allow_track_removal && !CheckTileOwnership(tile))))
 		return CMD_ERROR;
 
 	// allow building rail under bridge
@@ -716,25 +719,30 @@
 }
 
 /** Build signals, alternate between double/single, signal/semaphore,
- * pre/exit/combo-signals, and what-else not
- * @param x,y coordinates where signals is being built
- * @param p1 various bitstuffed elements
- * - p1 = (bit 0-2) - track-orientation, valid values: 0-5 (Track enum)
- * - p1 = (bit 3)   - choose semaphores/signals or cycle normal/pre/exit/combo depending on context
- * @param p2 used for CmdBuildManySignals() to copy direction of first signal
- * TODO: p2 should be replaced by two bits for "along" and "against" the track.
- */
++  * pre/exit/combo-signals, and what-else not
++  * @param x,y coordinates where signals is being built
++  * @param p1 various bitstuffed elements
++  * - p1 = (bit 0-2) - track-orientation, valid values: 0-5 (Track enum)
++  * - p1 = (bit 3)   - choose semaphores/signals or cycle normal/pre/exit/combo depending on context
++  * - p1 (bit 0-2) - track-orientation, valid values: 0-5 (Track enum)
++  * - p1 (bit 3)   - cycle normal/pre/exit/combo (only applies when signals already exist)
++  * - p1 (bit 4)   - choose semaphores/light signals (only applies when no signals already exist)
++  * - p1 (bit 5-7) - choose presignal type (only aplies when no signals already exist)
++  * @param p2 used for CmdBuildManySignals() to copy direction of first signal
++  * TODO: p2 should be replaced by two bits for "along" and "against" the track.
++  */
 int32 CmdBuildSingleSignal(int x, int y, uint32 flags, uint32 p1, uint32 p2)
 {
 	TileIndex tile = TileVirtXY(x, y);
 	bool semaphore;
-	bool pre_signal;
+	bool pre_signal_cycle;
+	byte pre_signal_type;
 	Track track = (Track)(p1 & 0x7);
 	byte m5;
 	int32 cost;
 
 	// Same bit, used in different contexts
-	semaphore = pre_signal = HASBIT(p1, 3);
+//	semaphore = pre_signal = HASBIT(p1, 3);
 
 	if (!ValParamTrackOrientation(track) || !IsTileType(tile, MP_RAILWAY) || !EnsureNoVehicle(tile))
 		return CMD_ERROR;
@@ -763,6 +771,14 @@
 
 	SET_EXPENSES_TYPE(EXPENSES_CONSTRUCTION);
 
+	// for when signals already exist
+	pre_signal_cycle = HASBIT(p1, 3);
+	// for placing new signals
+	semaphore = HASBIT(p1, 4);
+ 	pre_signal_type = (p1 >> 5) & 7;
+ 
+
+	//if ((_m[tile].m3 & _signals_table_both[track]) == 0) {
 	if (!HasSignalOnTrack(tile, track)) {
 		// build new signals
 		cost = _price.build_signals;
@@ -779,10 +795,10 @@
 	if (flags & DC_EXEC) {
 		if (GetRailTileType(tile) != RAIL_TYPE_SIGNALS) {
 			// there are no signals at all on this tile yet
-			_m[tile].m5 |= RAIL_TYPE_SIGNALS; // change into signals
-			_m[tile].m2 |= 0xF0;              // all signals are on
-			_m[tile].m3 &= ~0xF0;          // no signals built by default
-			_m[tile].m4 = semaphore ? 0x08 : 0;
+ 			_m[tile].m5 |= RAIL_TYPE_SIGNALS; // change into signals
+ 			_m[tile].m2 |= 0xF0;              // all signals are on
+ 			_m[tile].m3 &= ~0xF0;          // no signals built by default
+			_m[tile].m4 = (semaphore ? 0x08 : 0) + pre_signal_type;
 		}
 
 		if (p2 == 0) {
@@ -790,7 +806,7 @@
 				// build new signals
 				_m[tile].m3 |= SignalOnTrack(track);
 			} else {
-				if (pre_signal) {
+				if (pre_signal_cycle) {
 					// cycle between normal -> pre -> exit -> combo -> pbs ->...
 					byte type = ((GetSignalType(tile, track) + 1) % 5);
 					_m[tile].m4 &= ~0x07;
@@ -837,13 +853,237 @@
 	return cost;
 }
 
+static const byte _dir_from_track[14] = {
+	0,1,0,1,2,1, 0,0,
+	2,3,3,2,3,0,
+};
+
+/**  Build many signals automagically,
+ * Copy a signal along the entire length of connected rail, stopping only when a junction is reached
+ * @param x,y tile to start from
+ * @param railbit the railbit (direction in which to start placing signals)
+ * @param signals type of signals to copy
+ * @param p2 various bitstuffed elements
+ * - p2 (bit 0)     - 1 = remove signals, 0 = build signals
+ * - p2 (bit 3)     - 0 = signals, 1 = semaphores
+ * - p2 (bit 24-31) - user defined signals_density
+ */
+int32 BuildAutoSignals(int x, int y, Trackdir trackdir, uint32 flags, uint32 p2, byte signals)
+{
+  byte signal_density = (p2 >> 24);
+	int16 signal_ctr = signal_density * 2;
+	byte signal_dir = 0;	// direction in which signals are placed 1=forward  2=backward  3=twoway
+	byte track_mode = 0;	// 128=bridge, 64=tunnel, 192=end of tunnel/bridge, 0=normal track
+	byte track_height = 0; // height of tunnel currently in
+	int32 retr, total_cost = 0;
+	TileIndex tile = TileVirtXY/*TILE_FROM_XY*/(x, y);
+	byte m5 = _m[tile].m5;
+	byte m3 = _m[tile].m3;
+	byte semaphores = (_m[tile].m4 & ~3) ? 16 : 0;
+	int mode = p2 & 0x1;
+	int lx, ly;
+	byte dir;
+
+
+	// remember start position and direction
+	int sx = x, sy = y;
+	Trackdir srb = trackdir;
+
+	// get first signal mode
+	if (signals & _signals_table[trackdir]) signal_dir |= 1;
+	if (signals & _signals_table_other[trackdir]) signal_dir |= 2;
+
+	// check for semaphores
+/*
+	if (!(m5 & RAIL_TYPE_SPECIAL) && (m5 & RAIL_BIT_MASK) && (m5 & RAIL_TYPE_SIGNALS))
+		semaphores = (_m[tile].m3 & ~3) ? 16 : 0; // copy signal/semaphores style (independent of GUI)
+*/
+	if (signal_dir == 0)
+		return CMD_ERROR; // no signal on start tile to copy
+
+	semaphores = (HasSemaphores(tile, TrackdirToTrack(trackdir)) ? 16 : 0); // copy signal/semaphores style (independent of CTRL)
+	
+	signals = 0;
+	lx = 0;
+	ly = 0;
+
+	for(;;) {
+		x += _railbit.xinc[trackdir];
+		y += _railbit.yinc[trackdir];
+
+		tile = TileVirtXY(x, y);
+
+		m5 = _m[tile].m5;
+
+		m3 = _m[tile].m3;
+
+		dir = _dir_from_track[trackdir];
+
+		if (track_mode & 128) { // currently on bridge
+			if (IsTileType(tile, MP_TUNNELBRIDGE) && ((m5 & 192) == 128))
+				// end of bridge
+				track_mode = 192;
+		} else if (track_mode & 64) { // currently in tunnel
+			if (IsTileType(tile, MP_TUNNELBRIDGE)
+			&& ((m5 & 0xF0) == 0)
+			&& ((m5 & 3) == (dir ^ 2))
+			&& (GetSlopeZ(x+8, y+8) == track_height))
+ 				// end of tunnel
+					track_mode = 192;
+		} else { // currently not on bridge/in tunnel
+			if (IsTileType(tile,MP_TUNNELBRIDGE)
+			&& (((m5 >> 1) & 3) == 0)
+			&& ((m5 & 192) == 128)
+			&& ((m5 & 1) == (dir & 1)) ) {
+				// start of bridge
+				track_mode = 128;
+			} else if (IsTileType(tile, MP_TUNNELBRIDGE)
+			&& ((m5 & 0xF0) == 0)
+			&& (((m5 >> 2) & 3) == 0) ) {
+				// start of tunnel
+				track_mode = 64;
+				track_height = GetSlopeZ(x+8, y+8);
+			};
+		};
+
+		/* for pieces that we cannot build signals on but are not an end of track or a junction, we continue counting. When a signal
+			 should be placed in one of these tiles, it is instead placed on the last possible place for signals, and the counting is
+			 reset from that place. If a signal already is there, one will be placed one the first possible tile encountered.
+		   last place where a signal could be placed is remembered by lx,ly
+			 if signal==0 a signal is already on lx,ly
+		*/
+		if ( (IsTileType(tile, MP_RAILWAY) && ((m5 & ~1) == RAIL_TYPE_WAYPOINT)	&& ((m5 & 1) == (dir & 1))) // check for waypoints
+			|| (IsTileType(tile, MP_STREET) && ((m5 >> 4) == 1)										&& (!(m5 & 8) != !(dir & 1))) // check for road crossings
+			|| (IsTileType(tile,MP_TUNNELBRIDGE) && ((m5 & 0xF8) == 0xE0)					&& ((m5 & 1) != (dir & 1))) // check overhanging bridges
+			|| (track_mode != 0) // are we on a bridge/in a tunnel
+		) {
+			if (track_mode == 192) track_mode = 0; // end of tunnel/bridge
+			signal_ctr -= 2; // these pieces are always diagonal, so count faster
+			if (signal_ctr <= 0) {
+				if (signals == 0) {
+					// signal will be placed on next available tile
+					signal_ctr = 1;
+				} else {
+					// signal will be placed on last possible tile, counting will reset from there
+					signal_ctr += signal_density * 2;
+					x = lx;
+					y = ly;
+					// Place Signal
+					retr = DoCommand(x, y, TrackdirToTrack(trackdir) | semaphores, signals, flags, (mode == 1) ? CMD_REMOVE_SIGNALS : CMD_BUILD_SIGNALS);
+					if (retr == CMD_ERROR) return CMD_ERROR;
+					total_cost += retr;
+					signals = 0;
+					track_mode = 0;
+				};
+			};
+			continue;
+		};
+
+		if (!IsTileType(tile, MP_RAILWAY))
+			return total_cost;  // no more track, we are finished
+
+		if ((m5 & RAIL_TYPE_SPECIAL) || !(m5 & 0x3F))
+			return total_cost;  // no more track, we are finished
+
+		// check for valid track combination, and calculate the railbit
+		m5 &= 0x3F;
+		switch (trackdir) {
+			case 0: case 2: case 13: { // from SW
+				if (m5 == TRACK_BIT_DIAG1) {	// SW to NE track
+					trackdir = 0;
+				} else if ((m5 & ~TRACK_BIT_UPPER) == TRACK_BIT_LOWER) { // SW to SE track
+					trackdir = 3;
+				} else if ((m5 & ~TRACK_BIT_RIGHT) == TRACK_BIT_LEFT) { // SW to NW track
+					trackdir = 12;
+				} else {
+					return total_cost; // unsuitable track for signals, we are finished
+				}
+			} break;
+			case 8: case 4: case 11: { // from NE
+				if (m5 == TRACK_BIT_DIAG1) { // NE to SW track
+					trackdir = 8;
+				} else if ((m5 & ~TRACK_BIT_LOWER) == TRACK_BIT_UPPER) { // NE to NW track
+					trackdir = 10;
+				} else if ((m5 & ~TRACK_BIT_LEFT) == TRACK_BIT_RIGHT) { // NE to SE track
+					trackdir = 5;
+				} else {
+					return total_cost; // unsuitable track for signals, we are finished
+				}
+			} break;
+			case 9: case 10: case 12: { // from SE
+				if (m5 == TRACK_BIT_DIAG2) { // SE to NW track
+					trackdir = 9;
+				} else if ((m5 & ~TRACK_BIT_UPPER) == TRACK_BIT_LOWER ) { // SE to SW track
+					trackdir = 11;
+				} else if ((m5 & ~TRACK_BIT_LEFT) == TRACK_BIT_RIGHT) { // SE to NE track
+					trackdir = 13;
+				} else {
+					return total_cost; // unsuitable track for signals, we are finished
+				}
+			} break;
+			case 1: case 3: case 5: { // from NW
+				if (m5 == TRACK_BIT_DIAG2) { // NW to SE track
+					trackdir = 1;
+				} else if ((m5 & ~TRACK_BIT_LOWER) == TRACK_BIT_UPPER) { // NW to NE track
+					trackdir = 2;
+				} else if((m5 & ~TRACK_BIT_RIGHT) == TRACK_BIT_LEFT) { // NW to SW track
+					trackdir = 4;
+				} else {
+					return total_cost; // unsuitable track for signals, we are finished
+				}
+			} break;
+			default:
+				assert(0);
+		}
+
+		// calculate signals to place
+		signals = 0;
+		if (signal_dir & 1) signals |= _signals_table[trackdir];
+		if (signal_dir & 2) signals |= _signals_table_other[trackdir];
+
+		if (x == sx && y == sy && trackdir == srb)
+			return total_cost; // back at the start, we are finished
+
+		// remember last place signals could be placed
+		lx = x;			ly = y;
+
+		m5 = _m[tile].m5;
+		if (mode)
+			// when removing signals, remove all signals we encounter
+			signal_ctr =( (((m5 & RAIL_TILE_TYPE_MASK) == RAIL_TYPE_SIGNALS)) && (m3 & _signals_table_both[trackdir]) ) ? 0 : 1;
+		else if (m5 & 0x3)
+			// count faster on diagonal tracks
+			signal_ctr -= 2;
+		else
+			signal_ctr -= 1;
+
+		if (signal_ctr <= 0) {
+			signal_ctr += signal_density * 2;
+			// Place Signal
+			retr = DoCommand(lx, ly, (trackdir & 7) | semaphores, signals , flags, (mode == 1) ? CMD_REMOVE_SIGNALS : CMD_BUILD_SIGNALS);
+			if (retr == CMD_ERROR) return CMD_ERROR;
+			total_cost += retr;
+			signals = 0;
+		};
+
+		// when removing signals, the last position is always handled
+		if (mode) signals = 0;
+
+	};
+
+
+};
+
+
+
 /**	Build many signals by dragging; AutoSignals
  * @param x,y start tile of drag
  * @param p1  end tile of drag
  * @param p2 various bitstuffed elements
- * - p2 = (bit  0)    - 0 = build, 1 = remove signals
- * - p2 = (bit  3)    - 0 = signals, 1 = semaphores
- * - p2 = (bit  4- 6) - track-orientation, valid values: 0-5 (Track enum)
+ * - p2 = (bit 0)     - 0 = build, 1 = remove signals
+ * - p2 = (bit 1)     - 1 = autocompletion on, 0 = off
+ * - p2 = (bit 3)     - 0 = signals, 1 = semaphores
+ * - p2 = (bit 4- 6)  - track-orientation, valid values: 0-5
  * - p2 = (bit 24-31) - user defined signals_density
  */
 static int32 CmdSignalTrackHelper(int x, int y, uint32 flags, uint32 p1, uint32 p2)
@@ -857,7 +1097,7 @@
 	int mode = p2 & 0x1;
 	Track track = GB(p2, 4, 3);
 	Trackdir trackdir = TrackToTrackdir(track);
-	byte semaphores = (HASBIT(p2, 3)) ? 8 : 0;
+	byte semaphores = (HASBIT(p2, 3)) ? 16 : 0;
 	byte signal_density = (p2 >> 24);
 
 	if (p1 > MapSize()) return CMD_ERROR;
@@ -886,7 +1126,7 @@
 		signals = _m[tile].m3 & SignalOnTrack(track);
 		if (signals == 0) signals = SignalOnTrack(track); /* Can this actually occur? */
 
-		semaphores = (HasSemaphores(tile, track) ? 8 : 0); // copy signal/semaphores style (independent of CTRL)
+		semaphores = (HasSemaphores(tile, track) ? 16 : 0); // copy signal/semaphores style (independent of CTRL)
 	} else // no signals exist, drag a two-way signal stretch
 		signals = SignalOnTrack(track);
 
@@ -911,6 +1151,15 @@
 			} else {
 				error = false;
 				total_cost += ret;
+
+				/* when autocompletion is on, use that to place the rest of the signals */
+				if HASBIT(p2, 1) {
+					ret = BuildAutoSignals(x, y, trackdir, flags, p2, signals);
+					if (ret == CMD_ERROR)
+						return CMD_ERROR;
+					total_cost += ret;
+					return total_cost;
+				}
 			}
 		}
 
@@ -952,7 +1201,10 @@
 		return CMD_ERROR;
 
 	/* Only water can remove signals from anyone */
-	if (_current_player != OWNER_WATER && !CheckTileOwnership(tile)) return CMD_ERROR;
+	if (_current_player != OWNER_WATER && 
+				((_patches.allow_track_removal && !CheckSubsidiaryTileOwnership(tile)) ||
+				(!_patches.allow_track_removal && !CheckTileOwnership(tile))))
+			return CMD_ERROR;
 
 	SET_EXPENSES_TYPE(EXPENSES_CONSTRUCTION);
 
@@ -1088,7 +1340,8 @@
 		if (m5 & RAIL_TYPE_SPECIAL)
 			return_cmd_error(STR_2004_BUILDING_MUST_BE_DEMOLISHED);
 
-		if (!IsTileOwner(tile, _current_player))
+		if ((_patches.allow_track_removal && !IsSisterCompany(GetTileOwner(tile), _current_player)) ||
+			 (!_patches.allow_track_removal && !IsTileOwner(tile, _current_player)))
 			return_cmd_error(STR_1024_AREA_IS_OWNED_BY_ANOTHER);
 
 		return_cmd_error(STR_1008_MUST_REMOVE_RAILROAD_TRACK);
@@ -1801,10 +2054,6 @@
 	}
 }
 
-static const byte _dir_from_track[14] = {
-	0,1,0,1,2,1, 0,0,
-	2,3,3,2,3,0,
-};
 
 
 static void ChangeSignalStates(SetSignalsData *ssd)
@@ -2112,8 +2361,7 @@
 	if (IsTileDepotType(tile, TRANSPORT_RAIL))
 		ShowTrainDepotWindow(tile);
 	else if (IsRailWaypoint(_m[tile].m5))
-		ShowRenameWaypointWindow(GetWaypointByTile(tile));
-
+		ShowWaypointStatsWindow(GetWaypointByTile(tile));
 }
 
 static void GetTileDesc_Track(TileIndex tile, TileDesc *td)
Index: smallmap_gui.c
===================================================================
--- smallmap_gui.c	(Revision 2953)
+++ smallmap_gui.c	(Arbeitskopie)
@@ -30,9 +30,11 @@
 {    WWT_IMGBTN,   RESIZE_LRTB,    13,   380,   401,   280,   301, SPR_IMG_SHOW_ROUTES,     STR_0194_SHOW_TRANSPORT_ROUTES_ON},
 {    WWT_IMGBTN,   RESIZE_LRTB,    13,   402,   423,   280,   301, SPR_IMG_PLANTTREES,      STR_0195_SHOW_VEGETATION_ON_MAP},
 {    WWT_IMGBTN,   RESIZE_LRTB,    13,   424,   445,   280,   301, SPR_IMG_COMPANY_GENERAL, STR_0196_SHOW_LAND_OWNERS_ON_MAP},
-{    WWT_IMGBTN,   RESIZE_LRTB,    13,   358,   379,   258,   279, 0x0,                     STR_NULL},
+{     WWT_PANEL,   RESIZE_LRTB,    13,   358,   379,   258,   279, 683,				STR_RECENTRE_SMALLMAP},
 {    WWT_IMGBTN,   RESIZE_LRTB,    13,   358,   379,   280,   301, SPR_IMG_TOWN,            STR_0197_TOGGLE_TOWN_NAMES_ON_OFF},
-{    WWT_IMGBTN,    RESIZE_RTB,    13,     0,   357,   258,   301, 0x0,                     STR_NULL},
+{     WWT_PANEL,   RESIZE_LRTB,    13,   336,   357,   258,   279, 0x2DF,					STR_ZOOM_IN_SMALLMAP},
+{     WWT_PANEL,   RESIZE_LRTB,    13,   336,   357,   280,   301, 0x2E0,					STR_ZOOM_OUT_SMALLMAP},
+{     WWT_IMGBTN,    RESIZE_RTB,    13,     0,   335,   258,   301, 0x0,					STR_NULL},
 {     WWT_PANEL,    RESIZE_RTB,    13,     0,   433,   302,   313, 0x0,                     STR_NULL},
 { WWT_RESIZEBOX,   RESIZE_LRTB,    13,   434,   445,   302,   313, 0x0,                     STR_RESIZE_BUTTON},
 {  WIDGETS_END},
@@ -40,6 +42,9 @@
 
 static int _smallmap_type;
 static bool _smallmap_show_towns = true;
+static double smallmap_zoom;
+ 
+void SmallMapRecentre(void);
 
 #define MK(a,b) a, b
 #define MKEND() 0xFFFF
@@ -322,7 +327,7 @@
  * @param yc The Y coordinate of the first tile in the column
  * @param pitch Number of pixels to advance in the screen buffer each time a pixel is written.
  * @param reps Number of lines to draw
- * @param mask ?
+ * @param mask The mask for which type to draw
  * @param proc Pointer to the colour function
  * @see GetSmallMapPixels(TileIndex)
  */
@@ -332,10 +337,10 @@
 
 	do {
 		// check if the tile (xc,yc) is within the map range
-		if (xc < MapMaxX() && yc < MapMaxY()) {
+		if (xc * smallmap_zoom < MapMaxX() && yc * smallmap_zoom < MapMaxY()) {
 			// check if the dst pointer points to a pixel inside the screen buffer
 			if (dst > _screen.dst_ptr && dst < dst_ptr_end)
-				WRITE_PIXELS_OR(dst, proc(TileXY(xc, yc)) & mask);
+				WRITE_PIXELS_OR(dst, proc(TileXY(xc * smallmap_zoom, yc * smallmap_zoom)) & mask);
 		}
 	// switch to next tile in the column
 	} while (xc++, yc++, dst += pitch, --reps != 0);
@@ -699,8 +704,8 @@
 					(v->vehstatus & (VS_HIDDEN | VS_UNCLICKABLE)) == 0) {
 				// Remap into flat coordinates.
 				Point pt = RemapCoords(
-					(v->x_pos - WP(w,smallmap_d).scroll_x) / 16,
-					(v->y_pos - WP(w,smallmap_d).scroll_y) / 16,
+					((v->x_pos / smallmap_zoom) - WP(w,smallmap_d).scroll_x) / 16,
+					((v->y_pos / smallmap_zoom)  - WP(w,smallmap_d).scroll_y) / 16,
 					0);
 				x = pt.x;
 				y = pt.y;
@@ -747,8 +752,8 @@
 			if (t->xy != 0) {
 				// Remap the town coordinate
 				Point pt = RemapCoords(
-					(int)(TileX(t->xy) * 16 - WP(w, smallmap_d).scroll_x) / 16,
-					(int)(TileY(t->xy) * 16 - WP(w, smallmap_d).scroll_y) / 16,
+					(int)((TileX(t->xy) / smallmap_zoom) * 16 - WP(w, smallmap_d).scroll_x) / 16,
+					(int)((TileY(t->xy) / smallmap_zoom) * 16 - WP(w, smallmap_d).scroll_y) / 16,
 					0);
 				x = pt.x - WP(w,smallmap_d).subscroll + 3 - (t->sign.width_2 >> 1);
 				y = pt.y;
@@ -775,10 +780,10 @@
 
 		pt = RemapCoords(WP(w, smallmap_d).scroll_x, WP(w, smallmap_d).scroll_y, 0);
 
-		x = vp->virtual_left - pt.x;
-		y = vp->virtual_top - pt.y;
-		x2 = (x + vp->virtual_width) / 16;
-		y2 = (y + vp->virtual_height) / 16;
+		x = (vp->virtual_left / smallmap_zoom) - pt.x;
+		y = (vp->virtual_top / smallmap_zoom) - pt.y;
+		x2 = (x + (vp->virtual_width / smallmap_zoom)) / 16;
+		y2 = (y + (vp->virtual_height / smallmap_zoom)) / 16;
 		x /= 16;
 		y /= 16;
 
@@ -797,6 +802,9 @@
 static void SmallMapWindowProc(Window *w, WindowEvent *e)
 {
 	switch (e->event) {
+	case WE_CREATE: {
+		smallmap_zoom = 1;
+	} break;
 	case WE_PAINT: {
 		const uint16 *tbl;
 		int x,y,y_org;
@@ -844,8 +852,8 @@
 			w2 = FindWindowById(WC_MAIN_WINDOW, 0);
 
 			pt = RemapCoords(WP(w,smallmap_d).scroll_x, WP(w,smallmap_d).scroll_y, 0);
-			WP(w2,vp_d).scrollpos_x = pt.x + ((_cursor.pos.x - w->left + 2) << 4) - (w2->viewport->virtual_width >> 1);
-			WP(w2,vp_d).scrollpos_y = pt.y + ((_cursor.pos.y - w->top - 16) << 4) - (w2->viewport->virtual_height >> 1);
+			WP(w2,vp_d).scrollpos_x = (pt.x * smallmap_zoom) + (((_cursor.pos.x - w->left + 2) << 4) * smallmap_zoom)  - (w2->viewport->virtual_width >> 1);
+			WP(w2,vp_d).scrollpos_y = (pt.y * smallmap_zoom) + (((_cursor.pos.y - w->top - 16) << 4) * smallmap_zoom) - (w2->viewport->virtual_height >> 1);
 		} break;
 
 		case 5: /* Show land contours */
@@ -862,12 +870,33 @@
 			SndPlayFx(SND_15_BEEP);
 			break;
 
+		case 11: /* centre location */
+			SmallMapRecentre();
+			SetWindowDirty(w);
+			SndPlayFx(SND_15_BEEP);
+			break;
 		case 12: /* toggle town names */
 			w->click_state ^= (1 << 12);
 			_smallmap_show_towns = (w->click_state >> 12) & 1;
 			SetWindowDirty(w);
 			SndPlayFx(SND_15_BEEP);
 			break;
+		case 13: /* zoom in */
+			if (smallmap_zoom > 0.04) // can zoom in up to 5 times
+				smallmap_zoom /= 2;
+			
+			SmallMapRecentre();
+			SetWindowDirty(w);
+			SndPlayFx(SND_15_BEEP);
+			break;
+		case 14: /* zoom out */
+			if (smallmap_zoom < 32)
+				smallmap_zoom *= 2;
+			
+			SmallMapRecentre();
+			SetWindowDirty(w);
+			SndPlayFx(SND_15_BEEP);
+			break;
 		}
 		break;
 
@@ -889,6 +918,79 @@
 	}
 }
 
+void SmallMapRecentre(void)
+{
+	int x,y;
+	Window *w;
+	ViewPort *vp;
+	
+	/* recentre the map */
+	w = FindWindowById(WC_SMALLMAP, 0);
+	vp = FindWindowById(WC_MAIN_WINDOW, 0)->viewport;
+
+	x =  ((((vp->virtual_width  / smallmap_zoom) - (220*32)) / 2) + (vp->virtual_left / smallmap_zoom)) / 4;
+	y = (((((vp->virtual_height  / smallmap_zoom) - (120*32)) / 2) + (vp->virtual_top / smallmap_zoom)) / 2) - 32;
+
+
+	WP(w,smallmap_d).scroll_x = (y-x) & ~0xF;
+	WP(w,smallmap_d).scroll_y = (x+y) & ~0xF;
+	WP(w,smallmap_d).subscroll = 0;
+
+	/* handle disabled states of buttons */
+	CLRBIT(w->disabled_state, 13);
+	CLRBIT(w->disabled_state, 14);
+
+	if (smallmap_zoom <= 0) {
+		SETBIT(w->disabled_state, 13);
+	}if (smallmap_zoom >= 32) {
+		SETBIT(w->disabled_state, 14);
+	}
+}	
+
+void ScrollSmallmap(int mx, int my)
+{
+	int hx, hy;
+	int hvx, hvy;
+	int x, y, sub;
+	
+	Window *w = FindWindowById(WC_SMALLMAP, 0);
+
+	x = WP(w,smallmap_d).scroll_x;
+	y = WP(w,smallmap_d).scroll_y;
+
+	sub = WP(w,smallmap_d).subscroll + mx;
+
+	x -= (sub >> 2) << 4;
+	y += (sub >> 2) << 4;
+	sub &= 3;
+
+	x += (my >> 1) << 4;
+	y += (my >> 1) << 4;
+
+	if (my & 1) {
+		x += 16;
+		sub += 2;
+		if (sub > 3) {
+			sub -= 4;
+			x -= 16;
+			y += 16;
+		}
+	}
+
+	hx = (w->widget[4].right  - w->widget[4].left) / 2;
+	hy = (w->widget[4].bottom - w->widget[4].top ) / 2;
+	hvx = hx * -4 + hy * 8;
+	hvy = hx *  4 + hy * 8;
+	if (x < -hvx) { x = -hvx; sub = 0; }
+	if (x > (int)((MapMaxX() * 16) / smallmap_zoom) - hvx) { x = ((MapMaxX() * 16) / smallmap_zoom) - hvx; sub = 0; }
+	if (y < -hvy) { y = -hvy; sub = 0; }
+	if (y > (int)((MapMaxY() * 16) / smallmap_zoom) - hvy) { y = ((MapMaxY() * 16) / smallmap_zoom) - hvy; sub = 0; }
+
+	WP(w,smallmap_d).scroll_x = x;
+	WP(w,smallmap_d).scroll_y = y;
+	WP(w,smallmap_d).subscroll = sub;
+}
+
 static const WindowDesc _smallmap_desc = {
 	-1,-1, 446, 314,
 	WC_SMALLMAP,0,
@@ -911,8 +1013,8 @@
 
 		vp = FindWindowById(WC_MAIN_WINDOW, 0)->viewport;
 
-		x =  (((vp->virtual_width - (220*32)) / 2) + vp->virtual_left) / 4;
-		y = ((((vp->virtual_height- (120*32)) / 2) + vp->virtual_top ) / 2) - 32;
+		x =  ((((vp->virtual_width / smallmap_zoom) - (220*32)) / 2) + vp->virtual_left) / (4  * smallmap_zoom);
+		y = (((((vp->virtual_height  / smallmap_zoom) - (120*32)) / 2) + vp->virtual_top) / (2 * smallmap_zoom)) - 32;
 		WP(w,smallmap_d).scroll_x = (y-x) & ~0xF;
 		WP(w,smallmap_d).scroll_y = (x+y) & ~0xF;
 		WP(w,smallmap_d).subscroll = 0;
@@ -928,8 +1030,8 @@
 {          WWT_6,     RESIZE_RB,    14,     2,   297,    16,   231, 0x0,				STR_NULL},
 {      WWT_PANEL,     RESIZE_TB,    14,     0,    21,   234,   255, 0x2DF,			STR_017F_ZOOM_THE_VIEW_IN},
 {      WWT_PANEL,     RESIZE_TB,    14,    22,    43,   234,   255, 0x2E0,			STR_0180_ZOOM_THE_VIEW_OUT},
-{ WWT_PUSHTXTBTN,     RESIZE_TB,    14,    44,   171,   234,   255, STR_EXTRA_VIEW_MOVE_MAIN_TO_VIEW,STR_EXTRA_VIEW_MOVE_MAIN_TO_VIEW_TT},
-{ WWT_PUSHTXTBTN,     RESIZE_TB,    14,   172,   298,   234,   255, STR_EXTRA_VIEW_MOVE_VIEW_TO_MAIN,STR_EXTRA_VIEW_MOVE_VIEW_TO_MAIN_TT},
+{ WWT_PUSHTXTBTN,     RESIZE_TB,    14,    44,   171,   234,   255, STR_EXTRA_VIEW_MOVE_VIEW_TO_MAIN,STR_EXTRA_VIEW_MOVE_VIEW_TO_MAIN_TT},
+{ WWT_PUSHTXTBTN,     RESIZE_TB,    14,   172,   298,   234,   255, STR_EXTRA_VIEW_MOVE_MAIN_TO_VIEW,STR_EXTRA_VIEW_MOVE_MAIN_TO_VIEW_TT},
 {      WWT_PANEL,    RESIZE_RTB,    14,   299,   299,   234,   255, 0x0,				STR_NULL},
 {      WWT_PANEL,    RESIZE_RTB,    14,     0,   287,   256,   267, 0x0,				STR_NULL},
 {  WWT_RESIZEBOX,   RESIZE_LRTB,    14,   288,   299,   256,   267, 0x0,				STR_RESIZE_BUTTON},
@@ -1013,7 +1115,7 @@
 		v = FindWindowById(WC_MAIN_WINDOW, 0);
 		// New viewport start ats (zero,zero)
 		AssignWindowViewport(w, 3, 17, 294, 214, 0 , 0);
-
+		
 		// center on same place as main window (zoom is maximum, no adjustment needed)
 		x = WP(v, vp_d).scrollpos_x;
 		y = WP(v, vp_d).scrollpos_y;
Index: viewport.c
===================================================================
--- viewport.c	(Revision 2953)
+++ viewport.c	(Arbeitskopie)
@@ -582,10 +582,65 @@
 
 #endif
 
+// [direction][side]
+static const int AutorailType[6][2] = {
+	{ HT_DIR_X,  HT_DIR_X },
+	{ HT_DIR_Y,  HT_DIR_Y },
+	{ HT_DIR_HU, HT_DIR_HL },
+	{ HT_DIR_HL, HT_DIR_HU },
+	{ HT_DIR_VL, HT_DIR_VR },
+	{ HT_DIR_VR, HT_DIR_VL }
+};
+
+#include "table/autorail.h"
+
 static void DrawSelectionSprite(uint32 image, const TileInfo *ti)
 {
+	uint dir;
+	uint32 i;
+	uint height;
+	TileIndex end = TileVirtXY(_thd.selend.x, _thd.selend.y);
+	bool en = 0;
+	
 	if (_added_tile_sprite && !(_thd.drawstyle & HT_LINE)) { // draw on real ground
-		DrawGroundSpriteAt(image, ti->x, ti->y, ti->z + 7);
+		if ((_thd.userdata == VPM_X_OR_Y) && _thd.height_follow > 0 && (TileHeight(ti->tile) * 8) <= _thd.height_follow + 8)
+		{
+			if (_thd.selstart.x - _thd.selend.x > 0)
+				dir = 0;
+			else if (_thd.selstart.y - _thd.selend.y < 0)
+				dir = 1;
+			else if (_thd.selstart.x - _thd.selend.x < 0)
+				dir = 2;
+			else
+				dir = 3;
+				
+			height = _thd.height_follow;
+			if (height < (GetTileZ(ti->tile))) height = GetTileZ(ti->tile);
+			
+			// check end tile to make sure it is valid	
+			if ((GetTileSlope(end, NULL) == 0 && (TileHeight(end) * 8) == height - 8) || (GetTileSlope(end, NULL) != 0 && GetTileZ(end) + 8 == height))
+				en = 1;
+			
+			if ((GetTileZ(ti->tile)) + 8 > height || !en)
+					i = PALETTE_TILE_RED_PULSATING;
+			else
+					i = 0;
+				
+			if (TileVirtXY(_thd.selstart.x, _thd.selstart.y) == ti->tile && GetTileSlope(ti->tile, NULL) == 0 && (TileHeight(ti->tile) * 8) == height - 8) {
+				i |= SPR_AUTORAIL_BASE + AutorailTilehSprite[GetTileSlopeToHeight(height, height + 8, dir)][ AutorailType[dir & 1][0] ];
+				AddSortableSpriteToDraw(i,ti->x, ti->y, 0x10, 0x10, 1, height);
+			} else if (TileVirtXY(_thd.selend.x, _thd.selend.y) == ti->tile && GetTileSlope(ti->tile, NULL) == 0 && (TileHeight(ti->tile) * 8) == height - 8) {
+				i |= SPR_AUTORAIL_BASE + AutorailTilehSprite[GetTileSlopeToHeight(height, height + 8, (dir + 2) % 4)][ AutorailType[(dir + 2) & 1][0] ];
+				AddSortableSpriteToDraw(i,ti->x, ti->y, 0x10, 0x10, 1, height);
+			} else {
+				i |= SPR_AUTORAIL_BASE + AutorailTilehSprite[GetTileSlopeAtHeight(ti->tile, height + 7)][ AutorailType[dir & 1][0] ];
+				AddSortableSpriteToDraw(i,ti->x, ti->y, 0x10, 0x10, 1, height + 8);
+			}
+		}
+		if (_thd.userdata == VPM_X_OR_Y && _thd.height_follow > 0)
+			DrawGroundSpriteAt(0x3228000 | image, ti->x, ti->y, ti->z + 7);
+		else
+			DrawGroundSpriteAt(image, ti->x, ti->y, ti->z + 7);
 	} else { // draw on top of foundation
 		AddSortableSpriteToDraw(image, ti->x, ti->y, 0x10, 0x10, 1, ti->z + 7);
 	}
@@ -611,18 +666,6 @@
 	return 0;
 }
 
-// [direction][side]
-static const int AutorailType[6][2] = {
-	{ HT_DIR_X,  HT_DIR_X },
-	{ HT_DIR_Y,  HT_DIR_Y },
-	{ HT_DIR_HU, HT_DIR_HL },
-	{ HT_DIR_HL, HT_DIR_HU },
-	{ HT_DIR_VL, HT_DIR_VR },
-	{ HT_DIR_VR, HT_DIR_VL }
-};
-
-#include "table/autorail.h"
-
 static void DrawTileSelection(const TileInfo *ti)
 {
 	uint32 image;
@@ -1909,6 +1952,7 @@
 // highlighting tiles while only going over them with the mouse
 void VpStartPlaceSizing(TileIndex tile, int user)
 {
+	_thd.height_follow = (TileHeight(tile) + 1) * 8;	
 	_thd.userdata = user;
 	_thd.selend.x = TileX(tile) * 16;
 	_thd.selstart.x = TileX(tile) * 16;
@@ -2110,7 +2154,7 @@
 	}
 
 	sx = _thd.selstart.x;
-	sy = _thd.selstart.y;
+	sy = _thd.selstart.y;		
 
 	switch (method) {
 		case VPM_FIX_X:
Index: vehicle.c
===================================================================
--- vehicle.c	(Revision 2953)
+++ vehicle.c	(Arbeitskopie)
@@ -17,6 +17,7 @@
 #include "player.h"
 #include "engine.h"
 #include "sound.h"
+#include "economy.h"
 #include "debug.h"
 #include "vehicle_gui.h"
 #include "depot.h"
@@ -81,6 +82,29 @@
 	_error_message = id;
 }
 
+static void *EnsureNoVehicleDirectionProc(Vehicle *v, void *data)
+{
+	const uint *tmp = data;
+	TileIndex tile = tmp[0];
+	uint direction = TrackdirToExitdir(tmp[1]);
+
+	if ((uint)v->direction >> 1 != direction)
+		return NULL;
+	if (v->tile != tile || v->type == VEH_Disaster)
+		return NULL;
+
+	return v;
+}
+
+bool EnsureNoVehicleDirection(TileIndex tile, uint direction)
+{
+	uint data[2];
+	data[0] = tile;
+	data[1] = direction;
+
+	return VehicleFromPos(tile, &data, EnsureNoVehicleDirectionProc) == NULL;
+}
+
 static void *EnsureNoVehicleProc(Vehicle *v, void *data)
 {
 	if (v->tile != *(const TileIndex*)data || v->type == VEH_Disaster)
@@ -1442,7 +1466,7 @@
 	/* Check if there is money for the upgrade.. if not, give a nice news-item
 	    (that is needed, because this CMD is called automaticly) */
 	if ( p->money64 < (int32)(p->engine_renew_money + build_cost + rear_engine_cost - v->value)) {
-		if (( _local_player == v->owner ) && ( v->unitnumber != 0 )) {  //v->unitnumber = 0 for train cars
+		if (IsSisterCompany(v->owner,_local_player) && ( v->unitnumber != 0 )) {  //v->unitnumber = 0 for train cars
 			int message;
 			SetDParam(0, v->unitnumber);
 			switch (v->type) {
@@ -2002,9 +2026,12 @@
 
 	SLE_REF(Vehicle,orders,						REF_ORDER),
 
-	SLE_VAR(Vehicle,age,							SLE_UINT16),
-	SLE_VAR(Vehicle,max_age,					SLE_UINT16),
-	SLE_VAR(Vehicle,date_of_last_service,SLE_UINT16),
+	SLE_CONDVAR(Vehicle,age,			SLE_FILE_U16 | SLE_VAR_U32, 0, 15),
+	SLE_CONDVAR(Vehicle,age,			SLE_UINT32, 16, 255),
+	SLE_CONDVAR(Vehicle,max_age,			SLE_FILE_U16 | SLE_VAR_U32, 0, 15),
+	SLE_CONDVAR(Vehicle,max_age,			SLE_UINT32, 16, 255),
+	SLE_CONDVAR(Vehicle,date_of_last_service,	SLE_FILE_U16 | SLE_VAR_U32, 0, 15),
+	SLE_CONDVAR(Vehicle,date_of_last_service,	SLE_UINT32, 16, 255),
 	SLE_VAR(Vehicle,service_interval,	SLE_UINT16),
 	SLE_VAR(Vehicle,reliability,			SLE_UINT16),
 	SLE_VAR(Vehicle,reliability_spd_dec,SLE_UINT16),
@@ -2012,7 +2039,8 @@
 	SLE_VAR(Vehicle,breakdown_delay,	SLE_UINT8),
 	SLE_VAR(Vehicle,breakdowns_since_last_service,	SLE_UINT8),
 	SLE_VAR(Vehicle,breakdown_chance,	SLE_UINT8),
-	SLE_VAR(Vehicle,build_year,				SLE_UINT8),
+	SLE_CONDVAR(Vehicle,build_year,		SLE_FILE_U8 | SLE_VAR_U32, 0, 15),
+	SLE_CONDVAR(Vehicle,build_year,		SLE_UINT32, 16, 255),
 
 	SLE_VAR(Vehicle,load_unload_time_rem,	SLE_UINT16),
 
@@ -2165,7 +2193,8 @@
 	SLE_CONDVARX(offsetof(Vehicle, current_order) + offsetof(Order, station), SLE_UINT16, 5, 255),
 
 	SLE_VAR(Vehicle,cur_image,				SLE_UINT16),
-	SLE_VAR(Vehicle,age,							SLE_UINT16),
+	SLE_CONDVAR(Vehicle,age,			SLE_FILE_U16 | SLE_VAR_U32, 0, 15),
+	SLE_CONDVAR(Vehicle,age,			SLE_UINT32, 16, 255),
 
 	SLE_VAR(Vehicle,tick_counter,			SLE_UINT8),
 
Index: viewport.h
===================================================================
--- viewport.h	(Revision 2953)
+++ viewport.h	(Arbeitskopie)
@@ -118,6 +118,8 @@
 
 	int userdata;
 	TileIndex redsq;
+	
+	uint height_follow;
 } TileHighlightData;
 
 
Index: vehicle.h
===================================================================
--- vehicle.h	(Revision 2953)
+++ vehicle.h	(Arbeitskopie)
@@ -147,7 +147,7 @@
 
 struct Vehicle {
 	byte type;	// type, ie roadven,train,ship,aircraft,special
-	byte subtype;     // subtype (Filled with values from EffectVehicles or TrainSubTypes)(Filled with values from EffectVehicles or TrainSubTypes)
+	byte subtype;     // subtype (Filled with values from EffectVehicles or TrainSubTypes)
 
 	VehicleID index;	// NOSAVE: Index in vehicle array
 
@@ -222,9 +222,9 @@
 	uint16 next_hash;
 
 	// Related to age and service time
-	uint16 age;				// Age in days
-	uint16 max_age;		// Maximum age
-	uint16 date_of_last_service;
+	uint32 age;				// Age in days
+	uint32 max_age;		// Maximum age
+	uint32 date_of_last_service;
 	uint16 service_interval;
 	uint16 reliability;
 	uint16 reliability_spd_dec;
@@ -232,7 +232,7 @@
 	byte breakdown_delay;
 	byte breakdowns_since_last_service;
 	byte breakdown_chance;
-	byte build_year;
+	uint32 build_year;
 
 	uint16 load_unload_time_rem;
 
@@ -329,6 +329,7 @@
 int CheckTrainStoppedInDepot(const Vehicle *v);
 
 bool VehicleNeedsService(const Vehicle *v);
+bool EnsureNoVehicleDirection(TileIndex tile, uint direction);
 
 typedef struct GetNewVehiclePosResult {
 	int x,y;
Index: openttd.sln
===================================================================
--- openttd.sln	(Revision 2953)
+++ openttd.sln	(Arbeitskopie)
@@ -17,21 +17,28 @@
 Global
 	GlobalSection(SolutionConfiguration) = preSolution
 		Debug = Debug
+		Quick Release = Quick Release
 		Release = Release
 	EndGlobalSection
 	GlobalSection(ProjectConfiguration) = postSolution
 		{A133A442-BD0A-4ADE-B117-AD7545E4BDD1}.Debug.ActiveCfg = Debug|Win32
 		{A133A442-BD0A-4ADE-B117-AD7545E4BDD1}.Debug.Build.0 = Debug|Win32
-		{A133A442-BD0A-4ADE-B117-AD7545E4BDD1}.Release.ActiveCfg = Debug|Win32
-		{A133A442-BD0A-4ADE-B117-AD7545E4BDD1}.Release.Build.0 = Debug|Win32
+		{A133A442-BD0A-4ADE-B117-AD7545E4BDD1}.Quick Release.ActiveCfg = Debug|Win32
+		{A133A442-BD0A-4ADE-B117-AD7545E4BDD1}.Quick Release.Build.0 = Debug|Win32
+		{A133A442-BD0A-4ADE-B117-AD7545E4BDD1}.Release.ActiveCfg = Release|Win32
+		{A133A442-BD0A-4ADE-B117-AD7545E4BDD1}.Release.Build.0 = Release|Win32
 		{668328A0-B40E-4CDB-BD72-D0064424414A}.Debug.ActiveCfg = Debug|Win32
 		{668328A0-B40E-4CDB-BD72-D0064424414A}.Debug.Build.0 = Debug|Win32
+		{668328A0-B40E-4CDB-BD72-D0064424414A}.Quick Release.ActiveCfg = Quick Release|Win32
+		{668328A0-B40E-4CDB-BD72-D0064424414A}.Quick Release.Build.0 = Quick Release|Win32
 		{668328A0-B40E-4CDB-BD72-D0064424414A}.Release.ActiveCfg = Release|Win32
 		{668328A0-B40E-4CDB-BD72-D0064424414A}.Release.Build.0 = Release|Win32
 		{0F066B23-18DF-4284-8265-F4A5E7E3B966}.Debug.ActiveCfg = Debug|Win32
 		{0F066B23-18DF-4284-8265-F4A5E7E3B966}.Debug.Build.0 = Debug|Win32
-		{0F066B23-18DF-4284-8265-F4A5E7E3B966}.Release.ActiveCfg = Debug|Win32
-		{0F066B23-18DF-4284-8265-F4A5E7E3B966}.Release.Build.0 = Debug|Win32
+		{0F066B23-18DF-4284-8265-F4A5E7E3B966}.Quick Release.ActiveCfg = Debug|Win32
+		{0F066B23-18DF-4284-8265-F4A5E7E3B966}.Quick Release.Build.0 = Debug|Win32
+		{0F066B23-18DF-4284-8265-F4A5E7E3B966}.Release.ActiveCfg = Release|Win32
+		{0F066B23-18DF-4284-8265-F4A5E7E3B966}.Release.Build.0 = Release|Win32
 	EndGlobalSection
 	GlobalSection(ExtensibilityGlobals) = postSolution
 	EndGlobalSection
Index: landscape.c
===================================================================
--- landscape.c	(Revision 2953)
+++ landscape.c	(Arbeitskopie)
@@ -7,6 +7,7 @@
 #include "player.h"
 #include "spritecache.h"
 #include "table/sprites.h"
+#include "table/strings.h"
 #include "tile.h"
 #include <stdarg.h>
 #include "viewport.h"
@@ -665,6 +666,173 @@
 		CreateDesertOrRainForest();
 }
 
+#ifdef WITH_PNG
+#include "png.h"
+#include "debug.h"
+#include "gfx.h"
+#include "gui.h"
+
+void LoadLandscapeFromPNG(void) {
+	uint width, height, img_width, img_height;
+	uint row, col, img_row, img_col;
+	uint row_pad, col_pad, col_flip;
+	uint img_aspect, img_scale;
+	const uint num_div = 10000;
+	int i;
+	
+	byte current_tile;
+	
+	png_byte color_type;
+	png_byte bit_depth;
+
+	png_structp png_ptr;
+	png_infop info_ptr;
+	png_bytep * row_pointers=NULL;
+
+	FILE *fp=fopen(_file_to_saveload.name, "rb"); //TODO load it from a dialog!
+	if (!fp) {
+		ShowErrorMessage(STR_PNGMAP_ERR_FILE_NOT_FOUND, STR_PNGMAP_ERROR,0,0);
+		return;
+	}
+
+	png_ptr = png_create_read_struct (PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);
+	if (!png_ptr) {
+		fclose(fp);
+		ShowErrorMessage(STR_PNGMAP_ERR_MISC, STR_PNGMAP_ERROR,0,0);
+		return;
+	}
+	info_ptr = png_create_info_struct(png_ptr);
+	if (!info_ptr || setjmp(png_jmpbuf(png_ptr))) {
+		png_destroy_read_struct(&png_ptr, &info_ptr, NULL);
+		fclose(fp);
+		ShowErrorMessage(STR_PNGMAP_ERR_MISC, STR_PNGMAP_ERROR,0,0);
+		return;
+	}
+	png_init_io(png_ptr, fp);
+
+	png_set_packing(png_ptr);
+	png_read_png(png_ptr, info_ptr, PNG_TRANSFORM_PACKING, NULL); //allocates memory for image
+	row_pointers = png_get_rows(png_ptr, info_ptr);
+	fclose(fp);
+
+	img_width = info_ptr->width;
+	img_height = info_ptr->height;
+	color_type = info_ptr->color_type;
+	bit_depth = info_ptr->bit_depth;
+
+
+	// maps of wrong color-depth are not used
+	if ((color_type != PNG_COLOR_TYPE_PALETTE) || (bit_depth != 8)) {
+		png_destroy_read_struct(&png_ptr, &info_ptr, NULL);
+		ShowErrorMessage(STR_PNGMAP_ERR_IMAGE_TYPE, STR_PNGMAP_ERROR,0,0);
+		return;
+	}
+
+
+	// get map size and calculate scale and padding values
+	width = MapSizeX();
+	height = MapSizeY();
+	row_pad = 0;
+	col_pad = 0;
+	
+	img_aspect = (img_width * num_div) / img_height;
+	if (img_aspect > ((width * num_div) / height)) {
+		// image is wider than map - center vertically
+		img_scale = (width * num_div) / img_width;
+		row_pad = (height - ((img_height * img_scale) / num_div)) / 2;
+	} else {
+		// image is taller than map - center horizontally
+		img_scale = (height * num_div) / img_height;
+		col_pad = (width - ((img_width * img_scale) / num_div)) / 2;
+	}
+	
+	
+	// form the landscape
+	for (row = 0; row < height; row++) {
+		for (col = 0; col < width; col++) {
+			// check if current tile is within the 1-pixel map edge or padding regions
+			if ((DistanceFromEdge(TileXY(col, row)) <= 1) ||
+					(row < row_pad) || (row >= (height - row_pad)) ||
+					(col < col_pad) || (col >= (width - col_pad))) {
+				current_tile = 0;
+			} else {
+				col_flip = width - col - 1; // flip image horizontally - TTD map is "backwards" horizontally
+
+				// use nearest neighbor resizing to scale map data
+				img_row = (((row - row_pad) * num_div) / img_scale);
+				img_col = (((col_flip - col_pad) * num_div) / img_scale);
+				
+				if ((img_row < img_height) && (img_col < img_width)) {
+					current_tile = row_pointers[img_row][img_col];
+				} else {
+					DEBUG(map, 0) ("Attempted image load outside of boundaries: %d,%d", img_col, img_row);
+					current_tile = 0;
+				}
+			}
+
+			SetTileHeight(TileXY(col, row), current_tile);
+            SetTileType(TileXY(col, row), MP_CLEAR);
+            _m[TileXY(col, row)].m5 = 0;
+			SetTileOwner(TileXY(col, row), OWNER_NONE);
+		}
+	}
+
+
+	// adjust height difference to 1 maximum horizontal/vertical
+	// top and left edges
+	for (row = 1; row < height - 2; row++) {
+		for (col = 1; col < width - 2; col++) {
+			// find lowest tile out of top and left
+			current_tile = TileHeight(TileXY(col-1, row)); // top edge
+			if (TileHeight(TileXY(col, row-1)) < current_tile) {
+				current_tile = TileHeight(TileXY(col, row-1)); // left edge
+			}
+			
+			// set current point to only 1 level higher than neighbors if it's higher
+			current_tile++;
+			if (current_tile > 15) {
+				current_tile = 15;
+			}
+			if (TileHeight(TileXY(col, row)) > current_tile) {
+				SetTileHeight(TileXY(col, row), current_tile);
+			}
+		}
+	}
+	
+	// bottom and right edges
+	for (row = height - 2; row > 0; row--) {
+		for (col = width - 2; col > 0; col--) {
+			// find lowest tile out of bottom and right
+			current_tile = TileHeight(TileXY(col+1, row)); // bottom edge
+			if (TileHeight(TileXY(col, row+1)) < current_tile) {
+				current_tile = TileHeight(TileXY(col, row+1)); // right edge
+			}
+			
+			// set current point to only 1 level higher than neighbors if it's higher
+			current_tile++;
+			if (current_tile > 15) {
+				current_tile = 15;
+			}
+			if (TileHeight(TileXY(col, row)) > current_tile) {
+				SetTileHeight(TileXY(col, row), current_tile);
+			}
+		}
+	}
+
+	
+	ConvertGroundTilesIntoWaterTiles();
+
+	for(i=0x500; i!=0; i--)
+		RunTileLoop();	
+	
+	MarkWholeScreenDirty();
+
+	png_destroy_read_struct(&png_ptr, &info_ptr, NULL); //free all memory of libpng
+}
+
+
+#endif//WITH_PNG
+
 void OnTick_Town(void);
 void OnTick_Trees(void);
 void OnTick_Station(void);
Index: misc.c
===================================================================
--- misc.c	(Revision 2953)
+++ misc.c	(Arbeitskopie)
@@ -74,7 +74,7 @@
 	return (uint16)InteractiveRandom() * max >> 16;
 }
 
-void SetDate(uint date)
+void SetDate(uint32 date)
 {
 	YearMonthDay ymd;
 	ConvertDayToYMD(&ymd, _date = date);
@@ -136,8 +136,8 @@
 	_cur_tileloop_tile = 0;
 
 	{
-		uint starting = ConvertIntDate(_patches.starting_date);
-		if ( starting == (uint)-1) starting = 10958;
+		uint32 starting = ConvertIntDate(_patches.starting_date);
+		if ( starting == (uint)-1) starting = 712238; //10958;
 		SetDate(starting);
 	}
 
@@ -312,9 +312,9 @@
 };
 
 
-void ConvertDayToYMD(YearMonthDay *ymd, uint16 date)
+void ConvertDayToYMD(YearMonthDay *ymd, uint32 date)
 {
-	uint yr = date / (365+365+365+366);
+	uint32 yr = date / (365+365+365+366);
 	uint rem = date % (365+365+365+366);
 	uint x;
 
@@ -339,7 +339,7 @@
 // year is a number between 0..?
 // month is a number between 0..11
 // day is a number between 1..31
-uint ConvertYMDToDay(uint year, uint month, uint day)
+uint32 ConvertYMDToDay(uint32 year, uint month, uint day)
 {
 	uint rem;
 
@@ -359,26 +359,25 @@
 // 19200101 - 20901231
 // or if > 2090 and below 65536, treat it as a daycount
 // returns -1 if no conversion was possible
-uint ConvertIntDate(uint date)
+uint32 ConvertIntDate(uint32 date)
 {
 	uint year, month = 0, day = 1;
+	//printf("Converting %d\n", date);
 
-	if (IS_INT_INSIDE(date, 1920, MAX_YEAR_END_REAL + 1)) {
-		year = date - 1920;
-	} else if (IS_INT_INSIDE(date, 192001, 209012+1)) {
+	if (IS_INT_INSIDE(date, 0, 9999)) {
+		year = date;
+	} else if (IS_INT_INSIDE(date, 10001, 999912+1)) {
 		month = date % 100 - 1;
-		year = date / 100 - 1920;
-	} else if (IS_INT_INSIDE(date, 19200101, 20901231+1)) {
+		year = date / 100;
+	} else if (IS_INT_INSIDE(date, 1000101, 99991231+1)) {
 		day = date % 100; date /= 100;
 		month = date % 100 - 1;
-		year = date / 100 - 1920;
-	} else if (IS_INT_INSIDE(date, 2091, 65536))
-		return date;
-	else
-		return (uint)-1;
+		year = date / 100;
+	} else
+		return (uint32)-1;
 
 	// invalid ranges?
-	if (month >= 12 || !IS_INT_INSIDE(day, 1, 31+1)) return (uint)-1;
+	if (month >= 12 || !IS_INT_INSIDE(day, 1, 31+1)) return (uint32)-1;
 
 	return ConvertYMDToDay(year, month, day);
 }
@@ -459,6 +458,7 @@
 void TownsMonthlyLoop(void);
 void IndustryMonthlyLoop(void);
 void StationMonthlyLoop(void);
+void WaypointMonthlyLoop(void);
 
 void PlayersYearlyLoop(void);
 void TrainsYearlyLoop(void);
@@ -506,7 +506,7 @@
 	_tick_counter++;
 
 	_date_fract++;
-	if (_date_fract < DAY_TICKS)
+	if (_date_fract < (DAY_TICKS*_patches.day_length))
 		return;
 	_date_fract = 0;
 
@@ -541,6 +541,7 @@
 		TownsMonthlyLoop();
 		IndustryMonthlyLoop();
 		StationMonthlyLoop();
+		WaypointMonthlyLoop();
 #ifdef ENABLE_NETWORK
 		if (_network_server)
 			NetworkServerMonthlyLoop();
@@ -548,7 +549,7 @@
 	}
 
 	/* check if we entered a new year? */
-	if ((byte)ymd.year == _cur_year)
+	if (ymd.year == _cur_year)
 		return;
 	_cur_year = ymd.year;
 
@@ -565,26 +566,11 @@
 #endif /* ENABLE_NETWORK */
 
 	/* check if we reached end of the game (31 dec 2050) */
-	if (_cur_year == _patches.ending_date - MAX_YEAR_BEGIN_REAL) {
-			ShowEndGameChart();
-	/* check if we reached 2090 (MAX_YEAR_END_REAL), that's the maximum year. */
-	} else if (_cur_year == (MAX_YEAR_END + 1)) {
-		Vehicle *v;
-		_cur_year = MAX_YEAR_END;
-		_date = 62093;
-		FOR_ALL_VEHICLES(v) {
-			v->date_of_last_service -= 365; // 1 year is 365 days long
-		}
+	if (_cur_year == _patches.ending_date - MAX_YEAR_BEGIN_REAL)
+		ShowEndGameChart();
 
-		/* Because the _date wraps here, and text-messages expire by game-days, we have to clean out
-		 *  all of them if the date is set back, else those messages will hang for ever */
-		InitTextMessage();
-	}
-
 	if (_patches.auto_euro)
 		CheckSwitchToEuro();
-
-	/* XXX: check if year 2050 was reached */
 }
 
 int FindFirstBit(uint32 value)
@@ -676,7 +662,8 @@
 
 
 static const SaveLoadGlobVarList _date_desc[] = {
-	{&_date, 										SLE_UINT16, 0, 255},
+	{&_date, 			SLE_FILE_U16 | SLE_VAR_U32, 0, 15},
+	{&_date,			SLE_UINT32,	16, 255},
 	{&_date_fract, 							SLE_UINT16, 0, 255},
 	{&_tick_counter, 						SLE_UINT16, 0, 255},
 	{&_vehicle_id_ctr_day, 			SLE_UINT16, 0, 255},
Index: player_gui.c
===================================================================
--- player_gui.c	(Revision 2953)
+++ player_gui.c	(Arbeitskopie)
@@ -21,12 +21,19 @@
 #include "network_client.h"
 #endif
 
+extern void DrawPlayerIcon(int p, int x, int y);
+extern Player *DoStartupNewPlayer(bool is_ai);
+
+static uint64 _subsidiaries_money_amount = 0;
+static byte _subsidiaries_money_target = 0;
+void ShowSubsidiariesManagement(void);
+
 static void DoShowPlayerFinances(int player, bool show_small, bool show_stickied);
 
-
 static void DrawPlayerEconomyStats(Player *p, byte mode)
 {
-	int x,y,i,j,year;
+	int x,y,i,j;
+	uint32 year;
 	int64 (*tbl)[13], sum,cost;
 	StringID str;
 
@@ -44,7 +51,7 @@
 		tbl = p->yearly_expenses + 2;
 		do {
 			if (year >= p->inaugurated_year) {
-				SetDParam(0, year + 1920);
+				SetDParam(0, year);
 				DrawStringCenterUnderline(x-17, 15, STR_7010, 0);
 				sum = 0;
 				for(i=0; i!=13; i++) {
@@ -99,6 +106,259 @@
 	DrawStringRightAligned(182, y, STR_7028, 0);
 }
 
+static const Widget _ask_merge_subsidiaries_widgets[] = {
+{    WWT_TEXTBTN,    RESIZE_NONE,	4,     0,    10,     0,    13, STR_00C5,			STR_NULL},
+{    WWT_CAPTION,    RESIZE_NONE,	4,    11,   179,     0,    13, STR_SUBSIDIARY_ASK_MERGER_TITLE,	STR_NULL},
+{     WWT_IMGBTN,    RESIZE_NONE,	4,     0,   179,    14,    91, 0x0,						STR_NULL},
+{    WWT_TEXTBTN,    RESIZE_NONE,	12,    25,    84,    72,    83, STR_00C9_NO,		STR_NULL},
+{    WWT_TEXTBTN,    RESIZE_NONE,	12,    95,   154,    72,    83, STR_00C8_YES,	STR_NULL},
+{   WIDGETS_END},
+};
+
+static void AskMergeSubsidiariesWndProc(Window *w, WindowEvent *e) {
+	int i = 0;
+	WindowClass clss;
+	WindowNumber n;
+	Player *p;
+	Player *local;
+
+	p = GetPlayer(w->window_number);
+	local = GetPlayer(_local_player);
+
+	switch(e->event) {
+	case WE_PAINT:
+		DrawWindowWidgets(w);
+
+		if((GetMotherCompany(GetPlayer(_local_player)) == w->window_number)){
+			SetDParam(0, local->name_1);
+			SetDParam(1, local->name_2);
+
+			SetDParam(2, p->name_1);
+			SetDParam(3, p->name_2);
+		}else{
+			SetDParam(0, p->name_1);
+			SetDParam(1, p->name_2);
+
+			SetDParam(2, local->name_1);
+			SetDParam(3, local->name_2);
+		}
+
+		DrawStringMultiCenter(0x5A, 0x26, STR_SUBSIDIARY_ASK_MERGER, 178);
+		return;
+
+	case WE_CLICK:
+		switch(e->click.widget) {
+
+			case 3:
+				DeleteWindowById(WC_SUBSIDIARIES_ASK_MERGER, w->window_number);
+				break;
+
+			case 4:
+	do_merger:;
+				/* Ugly hack to go around the w pointer modification during DoAcquireCompany() calls */
+				clss = w->window_class;
+				n = w->window_number;
+
+				if((GetMotherCompany(GetPlayer(_local_player)) == w->window_number)){
+					i = _current_player;
+					_current_player = w->window_number;
+					_local_player = w->window_number;
+					DoAcquireCompany(GetPlayer(i));
+				}else{
+					DoAcquireCompany(GetPlayer(w->window_number));
+				}
+
+				DeleteWindowById(clss,n);
+				break;
+			}
+		break;
+
+	case WE_KEYPRESS: /* Perform the merger on pressing 'Enter' */
+		if (e->keypress.keycode == WKC_RETURN)
+			goto do_merger;
+		break;
+	}
+}
+
+static const Widget _ask_send_money_widgets[] = {
+{    WWT_TEXTBTN,	RESIZE_NONE,     4,     0,    10,     0,    13, STR_00C5,			STR_NULL},
+{    WWT_CAPTION,   RESIZE_NONE,	 4,    11,   179,     0,    13, STR_SUBSIDIARY_CASH_REQUEST,	STR_NULL},
+{     WWT_IMGBTN,   RESIZE_NONE,	4,     0,   179,    14,    91, 0x0,						STR_NULL},
+{    WWT_TEXTBTN,   RESIZE_NONE,	12,    25,    84,    72,    83, STR_00C9_NO,		STR_NULL},
+{    WWT_TEXTBTN,   RESIZE_NONE,	12,    95,   154,    72,    83, STR_00C8_YES,	STR_NULL},
+{   WIDGETS_END},
+};
+
+static const Widget _ask_sell_share_widgets[] = {
+{    WWT_TEXTBTN,	RESIZE_NONE,     4,     0,    10,     0,    13, STR_00C5,			STR_NULL},
+{    WWT_CAPTION,   RESIZE_NONE,	 4,    11,   179,     0,    13, STR_SUBSIDIARY_SELL_SHARE_TITLE,	STR_NULL},
+{     WWT_IMGBTN,   RESIZE_NONE,	4,     0,   179,    14,    91, 0x0,						STR_NULL},
+{    WWT_TEXTBTN,   RESIZE_NONE,	12,    25,    84,    72,    83, STR_00C9_NO,		STR_NULL},
+{    WWT_TEXTBTN,   RESIZE_NONE,	12,    95,   154,    72,    83, STR_00C8_YES,	STR_NULL},
+{   WIDGETS_END},
+};
+
+int32 _ask_send_money_amount;
+
+static void AskSellShareWndProc(Window *w, WindowEvent *e) {
+	//int i = 0;
+	WindowClass clss;
+	WindowNumber n;
+	Player *p;
+	Player *local;
+
+	p = GetPlayer(w->window_number);
+	local = GetPlayer(_local_player);
+
+	/* Ugly hack to go around the w pointer modification during DoAcquireCompany() calls */
+	clss = w->window_class;
+	n = w->window_number;
+
+	switch(e->event) {
+	case WE_PAINT:
+		DrawWindowWidgets(w);
+
+		SetDParam(0, p->name_1);
+		SetDParam(1, p->name_2);
+
+		SetDParam(2, _ask_send_money_amount);
+
+		DrawStringMultiCenter(0x5A, 0x26, STR_SUBSIDIARY_SELL_SHARE, 178);
+		return;
+
+	case WE_CLICK:
+		switch(e->click.widget) {
+
+			case 3:
+				DoCommandP(0, n, 0, NULL, CMD_SUBSIDIARY_BUY_SHARE_RESPONSE | CMD_MSG(STR_SUBSIDIARY_GET_ERROR));
+				DeleteWindowById(clss, n);
+				break;
+
+			case 4:
+	do_send:;
+				DoCommandP(0, n, 1, NULL, CMD_SUBSIDIARY_BUY_SHARE_RESPONSE | CMD_MSG(STR_SUBSIDIARY_GET_ERROR));
+				DeleteWindowById(clss,n);
+				break;
+			}
+		break;
+
+	case WE_KEYPRESS: /* Perform the merger on pressing 'Enter' */
+		if (e->keypress.keycode == WKC_RETURN)
+			goto do_send;
+		break;
+	}
+}
+
+static void AskSendMoneyWndProc(Window *w, WindowEvent *e) {
+	//int i = 0;
+	WindowClass clss;
+	WindowNumber n;
+	Player *p;
+	Player *local;
+
+	p = GetPlayer(w->window_number);
+	local = GetPlayer(_local_player);
+
+	/* Ugly hack to go around the w pointer modification during DoAcquireCompany() calls */
+	clss = w->window_class;
+	n = w->window_number;
+
+	switch(e->event) {
+	case WE_PAINT:
+		DrawWindowWidgets(w);
+
+		SetDParam(0, p->name_1);
+		SetDParam(1, p->name_2);
+
+		SetDParam(2, _ask_send_money_amount);
+
+		DrawStringMultiCenter(0x5A, 0x26, STR_SUBSIDIARY_CASH_REQUESTED, 178);
+		return;
+
+	case WE_CLICK:
+		switch(e->click.widget) {
+
+			case 3:
+				DoCommandP(0, n, -1, NULL, CMD_SUBSIDIARY_SEND_MONEY_ON_REQUEST | CMD_MSG(STR_SUBSIDIARY_GET_ERROR));
+				DeleteWindowById(clss, n);
+				break;
+
+			case 4:
+	do_send:;
+				DoCommandP(0, n, _ask_send_money_amount, NULL, CMD_SUBSIDIARY_SEND_MONEY_ON_REQUEST | CMD_MSG(STR_SUBSIDIARY_GET_ERROR));
+
+				DeleteWindowById(clss,n);
+				break;
+			}
+		break;
+
+	case WE_KEYPRESS: /* Perform the merger on pressing 'Enter' */
+		if (e->keypress.keycode == WKC_RETURN)
+			goto do_send;
+		break;
+	}
+}
+
+static const WindowDesc _ask_merge_subsidiaries_desc = {
+	WDP_CENTER, WDP_CENTER, 180, 92,
+	WC_SUBSIDIARIES_ASK_MERGER,0,
+	WDF_STD_TOOLTIPS | WDF_DEF_WIDGET | WDF_STD_BTN | WDF_UNCLICK_BUTTONS,
+	_ask_merge_subsidiaries_widgets,
+	AskMergeSubsidiariesWndProc
+};
+
+void AskMergeSubsidiaries(byte player)
+{
+	AllocateWindowDescFront(&_ask_merge_subsidiaries_desc, player);
+}
+
+static const WindowDesc _ask_send_money_desc = {
+	WDP_CENTER, WDP_CENTER, 180, 92,
+	WC_SUBSIDIARIES_ASK_MERGER,0,
+	WDF_STD_TOOLTIPS | WDF_DEF_WIDGET | WDF_STD_BTN | WDF_UNCLICK_BUTTONS,
+	_ask_send_money_widgets,
+	AskSendMoneyWndProc
+};
+
+void AskSendMoney(byte player, int32 amount)
+{
+	_ask_send_money_amount = amount;
+	AllocateWindowDescFront(&_ask_send_money_desc, player);
+}
+
+static const WindowDesc _ask_sell_share_desc = {
+	WDP_CENTER, WDP_CENTER, 180, 92,
+	WC_SUBSIDIARIES_ASK_MERGER,0,
+	WDF_STD_TOOLTIPS | WDF_DEF_WIDGET | WDF_STD_BTN | WDF_UNCLICK_BUTTONS,
+	_ask_sell_share_widgets,
+	AskSellShareWndProc
+};
+
+void AskSellShare(byte player)
+{
+	AllocateWindowDescFront(&_ask_sell_share_desc, player);
+}
+
+static const Widget _subsidiary_send_money[] = {
+{    WWT_TEXTBTN,    RESIZE_NONE,	14,     0,    10,     0,    13, STR_00C5,											STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,    RESIZE_NONE,	14,    11,   319,     0,    13, STR_SUBSIDIARY_SEND_TO,				STR_018C_WINDOW_TITLE_DRAG_THIS},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,		 0,   319,    14,    72, 0x0,														STR_NULL},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,     0,   159,    73,    84, STR_SUBSIDIARY_ADD_CASH,				STR_SUBSIDIARY_ADD_CASH_E},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,   160,   319,    73,    84, STR_SUBSIDIARY_SUB_CASH,				STR_SUBSIDIARY_SUB_CASH_E},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,   182,   317,    16,    27, STR_SUBSIDIARIES_SEND_MONEY,		STR_SUBSIDIARIES_SEND_MONEY_E},
+{   WIDGETS_END},
+};
+
+static const Widget _subsidiary_request_money[] = {
+{    WWT_TEXTBTN,    RESIZE_NONE,	14,     0,    10,     0,    13, STR_00C5,											STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,    RESIZE_NONE,	14,    11,   319,     0,    13, STR_SUBSIDIARY_REQUEST_FROM,		STR_018C_WINDOW_TITLE_DRAG_THIS},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     0,   319,    14,    72, 0x0,														STR_NULL},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,     0,   159,    73,    84, STR_SUBSIDIARY_ADD_CASH,				STR_SUBSIDIARY_ADD_CASH_E},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,   160,   319,    73,    84, STR_SUBSIDIARY_SUB_CASH,				STR_SUBSIDIARY_SUB_CASH_E},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,   182,   317,    16,    27, STR_SUBSIDIARIES_REQUEST_MONEY,STR_SUBSIDIARIES_REQUEST_MONEY_E},
+{   WIDGETS_END},
+};
+
 static const Widget _player_finances_widgets[] = {
 {    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,					STR_018B_CLOSE_WINDOW},
 {    WWT_CAPTION,   RESIZE_NONE,    14,    11,   379,     0,    13, STR_700E_FINANCES,	STR_018C_WINDOW_TITLE_DRAG_THIS},
@@ -143,7 +403,103 @@
 {   WIDGETS_END},
 };
 
+static void SubsidiaryMoneyTransferWndProc(Window *w, WindowEvent *e)
+{
+	Player *p = GetPlayer(_subsidiaries_money_target);
 
+	switch(e->event){
+		case WE_PAINT:
+
+			SetDParam(0, p->name_1);
+			SetDParam(1, p->name_2);
+			SetDParam(2, GetPlayerNameString(p->index, 3));
+			SetDParam(3, 10000);
+
+			w->caption_color = _local_player;
+
+			DrawWindowWidgets(w);
+
+			DrawString(10, 32, STR_SUBSIDIARY_TARGET_HAS, 0);
+			SetDParam64(0, p->player_money);
+			DrawStringRightAligned(315, 32, STR_SUBSIDIARY_AMOUNT_TARGET, 0);
+
+			DrawString(10, 46, STR_SUBSIDIARY_SEND_AMOUNT, 0);
+			DrawString(10, 60, STR_SUBSIDIARY_REQUEST_AMOUNT, 0);
+			SetDParam64(0, _subsidiaries_money_amount);
+			DrawStringRightAligned(315, 46, STR_SUBSIDIARY_AMOUNT_SEND, 0);
+			SetDParam64(0,  _subsidiaries_money_amount - (_subsidiaries_money_amount / 16));
+			DrawStringRightAligned(315, 60, STR_SUBSIDIARY_AMOUNT_GET, 0);
+
+			break;
+
+		case WE_CLICK:
+			switch(e->click.widget){
+			case 3:{ /* Increase amount */
+					uint64 oldAmount = _subsidiaries_money_amount;
+					if(_shift_pressed){
+						_subsidiaries_money_amount += 100000;
+					}else if(_ctrl_pressed){
+						_subsidiaries_money_amount *= 2;
+					}else{
+						_subsidiaries_money_amount += 10000;
+					}
+					if(_subsidiaries_money_amount > 0x7FFFFFFFFFFFFFL)
+						_subsidiaries_money_amount = oldAmount;
+
+					SetWindowDirty(w);
+					}break;
+
+				case 4:{ /* Decrease amount */
+					uint64 oldAmount = _subsidiaries_money_amount;
+					if(_shift_pressed){
+						_subsidiaries_money_amount -= 100000;
+					}else if(_ctrl_pressed){
+						_subsidiaries_money_amount /= 2;
+					}else{
+						_subsidiaries_money_amount -= 10000;
+					}
+					if(_subsidiaries_money_amount > 0x7FFFFFFFFFFFFFL)
+						_subsidiaries_money_amount = oldAmount;
+					SetWindowDirty(w);
+					}break;
+
+				case 5:{/* Perform transaction */
+					WindowNumber wn = w->window_number;
+					//Player *me = GetPlayer(_local_player);
+
+					if(IsWindowOfPrototype(w,_subsidiary_send_money)){
+						if(!DoCommandP(0,_subsidiaries_money_target,_subsidiaries_money_amount, NULL, CMD_SUBSIDIARY_SEND_MONEY | CMD_MSG(STR_SUBSIDIARY_GET_ERROR))){
+							SetDParam(0,_subsidiaries_money_amount);
+							ShowErrorMessage(STR_0003_NOT_ENOUGH_CASH_REQUIRES, STR_SUBSIDIARY_GET_ERROR, 0,0);
+						}
+					}else{
+						if(!_networking){
+							// don't ask for getting money
+							_current_player = p->index;
+							if(!DoCommandP(0, _local_player, _subsidiaries_money_amount, NULL, CMD_SUBSIDIARY_SEND_MONEY | CMD_MSG(STR_SUBSIDIARY_GET_ERROR))){
+								SetDParam(0,_subsidiaries_money_amount);
+								ShowErrorMessage(STR_0003_NOT_ENOUGH_CASH_REQUIRES, STR_SUBSIDIARY_GET_ERROR, 0,0);
+							}
+							_current_player = _local_player;
+						}else{
+							// ask target company if it allows to get money
+							DoCommandP(0, p->index, _subsidiaries_money_amount,NULL, CMD_SUBSIDIARY_GET_MONEY);
+						}
+
+					}
+					DeleteWindowById(WC_SUBSIDIARIES_MONEY, wn);
+					}break;
+			}
+			break;
+
+		case WE_MOUSELOOP:
+			/* redraw the window every now and then */
+			if ((++w->vscroll.pos & 0x1F) == 0)
+				SetWindowDirty(w);
+			break;
+	}
+}
+
 static void PlayerFinancesWndProc(Window *w, WindowEvent *e)
 {
 	switch(e->event) {
@@ -152,10 +508,19 @@
 
 		w->disabled_state = p->current_loan != 0 ? 0 : (1 << 7);
 
+		if(( _patches.subsidiaries && !_networking && (GetMotherCompany(p) != p->index || _local_player != GetMotherCompany(p))) ||
+			(((_patches.subsidiaries && _networking) || !_patches.subsidiaries) && _local_player != p->index)){
+			w->disabled_state |= 0x1 << 6;
+			if(p->current_loan <= 0 || _local_player != p->index){
+				w->disabled_state |= 0x1 << 7;
+			}
+		}
+
 		SetDParam(0, p->name_1);
 		SetDParam(1, p->name_2);
 		SetDParam(2, GetPlayerNameString((byte)w->window_number, 3));
 		SetDParam(4, 10000);
+
 		DrawWindowWidgets(w);
 
 		DrawPlayerEconomyStats(p, (byte)WP(w,def_d).data_1);
@@ -225,7 +590,8 @@
 	Window *w;
 	int mode;
 
-	mode = ((byte)player != _local_player)*2 + show_small;
+	mode = (!IsSisterCompany((byte)player,_local_player))*2 + show_small;
+
 	w = AllocateWindowDescFront( desc_table[mode], player);
 	if (w) {
 		w->caption_color = w->window_number;
@@ -300,6 +666,30 @@
 	}
 }
 
+static const WindowDesc _subsidiary_send_money_desc = {
+	-1,-1,  320, 85,
+	WC_SUBSIDIARIES_MONEY,0,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS,
+	_subsidiary_send_money,
+	SubsidiaryMoneyTransferWndProc
+};
+
+static const WindowDesc _subsidiary_request_money_desc = {
+	-1,-1,  320, 85,
+	WC_SUBSIDIARIES_MONEY,0,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS,
+	_subsidiary_request_money,
+	SubsidiaryMoneyTransferWndProc
+};
+
+static void ShowSubsidiaryMoneyTransfer(byte player, bool send){
+	Window *w;
+	_subsidiaries_money_target = player;
+	_subsidiaries_money_amount = 0;
+
+	w = AllocateWindowDescFront( send ? &_subsidiary_send_money_desc : &_subsidiary_request_money_desc, GetMotherCompany(GetPlayer(player)));
+}
+
 static const Widget _select_player_color_widgets[] = {
 {    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5,STR_018B_CLOSE_WINDOW},
 {    WWT_CAPTION,   RESIZE_NONE,    14,    11,   149,     0,    13, STR_7007_NEW_COLOR_SCHEME, STR_018C_WINDOW_TITLE_DRAG_THIS},
@@ -381,7 +771,8 @@
 {      WWT_EMPTY,   RESIZE_NONE,    14,     0,   355,    32,    43, 0x0,                     STR_NULL},
 {      WWT_EMPTY,   RESIZE_NONE,    14,     0,   355,    32,    43, 0x0,                     STR_NULL},
 { WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   266,   355,   138,   149, STR_COMPANY_PASSWORD,    STR_COMPANY_PASSWORD_TOOLTIP},
-{   WIDGETS_END},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,	14,   266,   355,    32,    43, STR_SUBSIDIARIES,			STR_SUBSIDIARIES_MANAGEMENT},
+{WIDGETS_END},
 };
 
 static const Widget _other_player_company_widgets[] = {
@@ -412,19 +803,51 @@
 {      WWT_EMPTY,   RESIZE_NONE,    14,     0,   355,    32,    43, 0x0,                     STR_NULL},
 {      WWT_EMPTY,   RESIZE_NONE,    14,     0,   355,    32,    43, 0x0,                     STR_NULL},
 { WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   266,   355,   138,   149, STR_COMPANY_PASSWORD,    STR_COMPANY_PASSWORD_TOOLTIP},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,	14,   266,   355,    46,    57, STR_SUBSIDIARIES,			STR_SUBSIDIARIES_MANAGEMENT},
 {   WIDGETS_END},
 };
 
+static Widget _subsidiary_management_widgets[] = {
+{    WWT_TEXTBTN,    RESIZE_NONE,	14,     0,    10,     0,    13, STR_00C5,					STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,    RESIZE_NONE,	14,    11,   379,     0,    13, STR_YOUR_SUBSIDIARIES,		STR_018C_WINDOW_TITLE_DRAG_THIS},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     0,   379,    14,   120, 0x0,								STR_NULL},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     2,   247,    16,    27, 0x0,STR_SUBSIDIARY_TOGGLE},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     2,   247,    35,    46, 0x0,STR_SUBSIDIARY_TOGGLE},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     2,   247,    47,    58, 0x0,STR_SUBSIDIARY_TOGGLE},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     2,   247,    59,    70, 0x0,STR_SUBSIDIARY_TOGGLE},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     2,   247,    71,    82, 0x0,STR_SUBSIDIARY_TOGGLE},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     2,   247,    83,    94, 0x0,STR_SUBSIDIARY_TOGGLE},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     2,   247,    95,   106, 0x0,STR_SUBSIDIARY_TOGGLE},
+{     WWT_IMGBTN,    RESIZE_NONE,	14,     2,   247,   107,   118, 0x0,STR_SUBSIDIARY_TOGGLE},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,   264,   377,    18,    29, STR_SUBSIDIARIES_ADMINISTRATE,		STR_SUBSIDIARIES_ADMINISTRATE_E},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,   264,   377,    32,    43, STR_SUBSIDIARIES_SEND_MONEY,			STR_SUBSIDIARIES_SEND_MONEY_E},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,   264,   377,    46,    57, STR_SUBSIDIARIES_REQUEST_MONEY,	STR_SUBSIDIARIES_REQUEST_MONEY_E},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,   264,   377,    60,    71, STR_SUBSIDIARIES_MERGER,					STR_SUBSIDIARIES_MERGER_E},
+{ WWT_PUSHTXTBTN,    RESIZE_NONE,	14,   264,   377,   107,   118, STR_SUBSIDIARY_CREATE,						STR_SUBSIDIARY_CREATE_E},
+{   WIDGETS_END},
+};
+
+static void SubsidiaryManagementWndProc(Window *w, WindowEvent *e);
+
+static const WindowDesc _subsidiary_management_desc = {
+	-1,-1, 380, 121,
+	WC_SUBSIDIARIES,0,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS,
+	_subsidiary_management_widgets,
+	SubsidiaryManagementWndProc
+};
+
 static void DrawPlayerVehiclesAmount(int player)
 {
 	const int x = 110;
 	int y = 72;
 	Vehicle *v;
-	uint train,road,air,ship;
+	uint train,road,air,ship, subtrain, subroad, subair, subship;
 
 	DrawString(x, y, STR_7039_VEHICLES, 0);
 
 	train = road = air = ship = 0;
+	subtrain = subair = subroad = subship = 0;
 
 	FOR_ALL_VEHICLES(v) {
 		if (v->owner == player) {
@@ -440,6 +863,19 @@
 				ship++;
 			}
 		}
+		if(IsSisterCompany(v->owner, player)){
+			if (v->type == VEH_Train) {
+				if (v->subtype == TS_Front_Engine)
+					subtrain++;
+			} else if (v->type == VEH_Road) {
+				subroad++;
+			} else if (v->type == VEH_Aircraft) {
+				if (v->subtype <= 2)
+					subair++;
+			} else if (v->type == VEH_Ship) {
+				subship++;
+			}
+		}
 	}
 
 	if (train+road+air+ship == 0) {
@@ -447,25 +883,50 @@
 	} else {
 		if (train != 0) {
 			SetDParam(0, train);
-			DrawString(x + 70, y, STR_TRAINS, 0);
+			SetDParam(0, train);
+			if(_patches.subsidiaries && subtrain > 0){
+				SetDParam(1, subtrain);
+				SetDParam(2, (uint16)(((double)train / (double)subtrain) * 100 + 0.5));
+				DrawString(x + 70, y, STR_TRAINS_SUB, 0);
+			}else{
+				DrawString(x + 70, y, STR_TRAINS, 0);
+			}
 			y += 10;
 		}
 
 		if (road != 0) {
 			SetDParam(0, road);
-			DrawString(x + 70, y, STR_ROAD_VEHICLES, 0);
+			if(_patches.subsidiaries && subroad > 0){
+				SetDParam(1, subroad);
+				SetDParam(2, (uint16)(((double)road / (double)subroad) * 100 + 0.5));
+				DrawString(x + 70, y, STR_ROAD_VEHICLES_SUB, 0);
+			}else{
+				DrawString(x + 70, y, STR_ROAD_VEHICLES, 0);
+			}
 			y += 10;
 		}
 
 		if (air != 0) {
 			SetDParam(0, air);
-			DrawString(x + 70, y, STR_AIRCRAFT, 0);
+			if(_patches.subsidiaries && subair > 0){
+				SetDParam(1, subair);
+				SetDParam(2, (uint16)(((double)air / (double)subair) * 100 + 0.5));
+				DrawString(x + 70, y, STR_AIRCRAFT_SUB, 0);
+			}else{
+				DrawString(x + 70, y, STR_AIRCRAFT, 0);
+			}
 			y += 10;
 		}
 
 		if (ship != 0) {
 			SetDParam(0, ship);
-			DrawString(x + 70, y, STR_SHIPS, 0);
+			if(_patches.subsidiaries && subship > 0){
+				SetDParam(1, subship);
+				SetDParam(2, (uint16)(((double)ship / (double)subship) * 100 + 0.5));
+				DrawString(x + 70, y, STR_SHIPS_SUB, 0);
+			}else{
+				DrawString(x + 70, y, STR_SHIPS, 0);
+			}
 		}
 	}
 }
@@ -484,21 +945,30 @@
 	Player *p2;
 	int amt;
 
-	FOR_ALL_PLAYERS(p2) {
-		if ((amt=GetAmountOwnedBy(p, p2->index)) != 0) {
-			num++;
 
-			SetDParam(num*3+0, amt*25);
-			SetDParam(num*3+1, p2->name_1);
-			SetDParam(num*3+2, p2->name_2);
+	if(_patches.subsidiaries && GetMotherCompany(p) != p->index){
+		SetDParam(0,GetPlayer(GetMotherCompany(p))->name_1);
+		SetDParam(1,GetPlayer(GetMotherCompany(p))->name_2);
 
-			if (num != 0)
-				break;
+		DrawString(120, 124, STR_SUBSIDIARY_OF, 0);
+
+	}else{
+		FOR_ALL_PLAYERS(p2) {
+			if ((amt=GetAmountOwnedBy(p, p2->index)) != 0) {
+				num++;
+
+				SetDParam(num*3+0, amt*25);
+				SetDParam(num*3+1, p2->name_1);
+				SetDParam(num*3+2, p2->name_2);
+
+				if (num != 0)
+					break;
+			}
 		}
+
+		if (num >= 0)
+			DrawString(120, 124, STR_707D_OWNED_BY+num, 0);
 	}
-
-	if (num >= 0)
-		DrawString(120, 124, STR_707D_OWNED_BY+num, 0);
 }
 
 static void PlayerCompanyWndProc(Window *w, WindowEvent *e)
@@ -508,10 +978,19 @@
 		Player *p = GetPlayer(w->window_number);
 		uint32 dis = 0;
 
+		if (_patches.subsidiaries && IsWindowOfPrototype(w, _other_player_company_widgets) && GetMotherCompany(p) != p->index && IsSisterCompany(_local_player,p->index)){
+			DeleteWindowById(WC_COMPANY, w->window_number);
+			ShowPlayerCompany(p->index);
+			return;
+		}
+
 		if (!IsWindowOfPrototype(w, _other_player_company_widgets)) {
 			AssignWidgetToWindow(w, (p->location_of_house != 0) ? _my_player_company_bh_widgets : _my_player_company_widgets);
 
-			if (!_networking) SETBIT(w->hidden_state, 11); // hide company-password widget
+			if (!_networking || (_networking && _patches.subsidiaries && _local_player != p->index)) SETBIT(w->hidden_state, 11); // hide company-password widget
+			if (!_patches.subsidiaries) w->hidden_state |= (1 << 12); // hide subsidiairies widget
+			if (_networking && _patches.subsidiaries && _local_player != p->index) dis |= 0xF << 3;
+
 		} else {
 			if (p->location_of_house == 0) SETBIT(dis, 7);
 
@@ -519,8 +998,11 @@
 				/* If all shares are owned by someone (none by nobody), disable buy button */
 				if (GetAmountOwnedBy(p, OWNER_SPECTATOR) == 0) SETBIT(dis, 9);
 
-				/* Only 25% left to buy. If the player is human, disable buying it up.. TODO issues! */
-				if (GetAmountOwnedBy(p, OWNER_SPECTATOR) == 1 && !p->is_ai) SETBIT(dis, 9);
+				/* We can buy out real players in a network game only if subsidiairies are enabled*/
+				/* and target company isn't already part of a sub group (except if it's the mother company)*/
+				if ((GetAmountOwnedBy(p, OWNER_SPECTATOR) == 1 && !p->is_ai && !_patches.subsidiaries) ||
+					(_patches.subsidiaries && (IsSisterCompany(_local_player,p->index) || GetMotherCompany(p) != p->index)))
+					SETBIT(dis, 9);
 
 				/* If the player doesn't own any shares, disable sell button */
 				if (GetAmountOwnedBy(p, _local_player) == 0) SETBIT(dis, 10);
@@ -535,10 +1017,23 @@
 		SetDParam(1, p->name_2);
 		SetDParam(2, GetPlayerNameString((byte)w->window_number, 3));
 
+		if(_patches.subsidiaries && IsSubsidiary(p) && (GetPlayer(_local_player) != p))
+		{
+			if(IsWindowOfPrototype(w, _my_player_company_widgets))
+				dis |= 1 << 7;
+			else
+				dis |= 1 << 8;
+		}
+		
+		if(_patches.subsidiaries && (GetMotherCompany(p) != p->index)){
+			dis |= 1 <<10;
+			dis |= 1 << 9;
+		}
+
 		w->disabled_state = dis;
 		DrawWindowWidgets(w);
 
-		SetDParam(0, p->inaugurated_year + 1920);
+		SetDParam(0, p->inaugurated_year);
 		DrawString(110, 25, STR_7038_INAUGURATED, 0);
 
 		DrawPlayerVehiclesAmount(w->window_number);
@@ -624,6 +1119,11 @@
 			}
 			#endif
 		}	break;
+
+		case 12: /* Manage Subsidiaries */
+			if(_patches.subsidiaries)
+				ShowSubsidiariesManagement();
+			break;
 		}
 
 	case WE_MOUSELOOP:
@@ -644,6 +1144,7 @@
 	case WE_DESTROY:
 		DeleteWindowById(WC_PLAYER_COLOR, w->window_number);
 		DeleteWindowById(WC_PLAYER_FACE, w->window_number);
+		DeleteWindowById(WC_SUBSIDIARIES, GetMotherCompany(GetPlayer(w->window_number)));
 		break;
 
 	case WE_ON_EDIT_TEXT: {
@@ -671,7 +1172,182 @@
 	}
 }
 
+static void SubsidiaryManagementWndProc(Window *w, WindowEvent *e)
+{
+	int i = 0;
+	int selected = -1;
+	Player *selectedPlayer;
+	Player *p;
 
+	switch(e->event) {
+	case WE_PAINT: {
+
+		w->caption_color = _local_player;
+
+		w->disabled_state = 0;
+		if((GetSubsidiariesCount() <= 1) || ((w->click_state & 0x7F8) == 0))
+			w->disabled_state = 0xF << 11;
+
+		// disable create new sub in network mode
+		if(_networking)
+			w->disabled_state |= (1 << 15) | (1 << 14) | (1 << 11);
+
+		DrawWindowWidgets(w);
+
+		// highlight commanded company
+		if(_local_player == GetMotherCompany(GetPlayer(_local_player))){
+			DrawFrameRect(2, 16, 247, 27, 5, 0x60);
+		}else{
+			FOR_ALL_PLAYERS(p) {
+				if(_local_player == p->index){
+					DrawFrameRect(2, 35+i*12, 247, 46+i*12, 5, 0x60);
+					break;
+				}
+				if(IsSubsidiary(p) && p->index != GetMotherCompany(p) && p->is_active)
+					i++;
+			}
+		}
+
+		p = GetPlayer(GetMotherCompany(GetPlayer(_local_player)));
+
+		DrawPlayerIcon(p->index, 4, 18);
+
+		SetDParam(0, p->name_1);
+		SetDParam(1, p->name_2);
+		SetDParam(2, GetPlayerNameString(p->index, 3));
+		DrawString(21,17,STR_7021, !HASBIT(w->click_state >> 3, 0) ? 0x10 : 0xC);
+
+		i = 0;
+		FOR_ALL_PLAYERS(p) {
+			if (!p->is_active || !IsSubsidiary(p) || p->index == GetMotherCompany(GetPlayer(_local_player)))
+				continue;
+
+			DrawPlayerIcon(p->index, 4, 37+i*12);
+
+			SetDParam(0, p->name_1);
+			SetDParam(1, p->name_2);
+			SetDParam(2, GetPlayerNameString(p->index, 3));
+			DrawString(21,36+i*12,STR_7021, !HASBIT(w->click_state >> 3, i+1) ? 0x10 : 0xC);
+			i++;
+		}
+
+	} break;
+
+	case WE_CLICK:
+		if (IS_INT_INSIDE(e->click.widget, 3, 3+GetSubsidiariesCount())) {
+			i = 1;
+
+			FOR_ALL_PLAYERS(p){
+				if(_local_player == p->index){
+					if(GetMotherCompany(GetPlayer(_local_player)) == _local_player)
+						i = 0;
+					break;
+				}
+				if(GetMotherCompany(GetPlayer(_local_player)) == p->index)
+					continue;
+				if(IsSubsidiary(p) && p->is_active)
+					i++;
+			}
+			if(i+3 != e->click.widget){
+				int old_state = w->click_state;
+				w->click_state &= ((0xFFFFFFFF >> 11) << 11) & 0x7;
+				w->click_state ^= (1 << (e->click.widget));
+				if(old_state == w->click_state)
+					w->click_state &= ((0xFFFFFFFF >> 11) << 11) & 0x7;
+				SetWindowDirty(w);
+			}
+
+		}else{
+			// determin selected Subsidiary, if any
+			for(i = 3; i < (3+GetSubsidiariesCount());i++){
+				if(HASBIT(w->click_state , i)){
+					selected = i-3;
+				}
+			}
+
+			//determin selected player
+			i = 0;
+			if(selected == 0){
+				selectedPlayer = GetPlayer(GetMotherCompany(GetPlayer(_local_player)));
+			}else{
+				i = 1;
+				FOR_ALL_PLAYERS(selectedPlayer) {
+					if (!selectedPlayer->is_active || !IsSubsidiary(selectedPlayer) || (GetMotherCompany(GetPlayer(_local_player)) == selectedPlayer->index))
+						continue;
+
+					if (i == selected) break;
+					i++;
+				}
+			}
+
+			switch(e->click.widget){
+				case 11: /* Administrate */
+					p = GetPlayer(_local_player);
+					w->click_state &= ((0xFFFFFFFF >> 11) << 11) & 0x7;
+					_local_player = selectedPlayer->index;
+					MarkWholeScreenDirty();
+					break;
+
+				case 12: /* Send Money */
+					DeleteWindowById(WC_SUBSIDIARIES_MONEY, w->window_number);
+					ShowSubsidiaryMoneyTransfer(selectedPlayer->index, true);
+					w->click_state &= ((0xFFFFFFFF >> 11) << 11) & 0x7;
+					SetWindowDirty(w);
+					break;
+
+				case 13: /* Request Money */
+					DeleteWindowById(WC_SUBSIDIARIES_MONEY, w->window_number);
+					ShowSubsidiaryMoneyTransfer(selectedPlayer->index, false);
+					w->click_state &= ((0xFFFFFFFF >> 11) << 11) & 0x7;
+					SetWindowDirty(w);
+					break;
+
+				case 14: /* Merger */
+					AskMergeSubsidiaries(selectedPlayer->index);
+					w->click_state &= ((0xFFFFFFFF >> 11) << 11) & 0x7;
+					SetWindowDirty(w);
+					break;
+
+				case 15:{/* Create */
+					Player *newp;
+					int i = 0;
+					newp = DoStartupNewPlayer(false);
+					if(newp == 0){
+						ShowErrorMessage(STR_SUBSIDIARY_PLAYER_ERROR, STR_TOO_MANY_PLAYERS, 0,0);
+						break;
+					}
+
+					newp->money64 = newp->player_money = newp->current_loan = 0;
+					for(i = 0; i < 4; i++){
+						newp->share_owners[i] = w->window_number;
+					}
+					ShowPlayerCompany(newp->index);
+					w->click_state &= ((0xFFFFFFFF >> 11) << 11) & 0x7;
+					MarkWholeScreenDirty();
+					}break;
+
+			}
+			//clear the selection
+		}
+
+		break;
+
+	case WE_MOUSELOOP:
+		/* redraw the window every now and then */
+		if ((++w->vscroll.pos & 0x1F) == 0)
+			SetWindowDirty(w);
+		break;
+
+	case WE_DESTROY: /* Destroy side windows */
+		DeleteWindowById(WC_SUBSIDIARIES_MONEY, w->window_number);
+		break;
+	}
+}
+
+void ShowSubsidiariesManagement(void){
+	AllocateWindowDescFront(&_subsidiary_management_desc ,  ((Player*)GetPlayer(GetMotherCompany(GetPlayer(_local_player))))->index);
+}
+
 static const WindowDesc _my_player_company_desc = {
 	-1,-1, 360, 170,
 	WC_COMPANY,0,
@@ -691,13 +1367,11 @@
 void ShowPlayerCompany(int player)
 {
 	Window *w;
-	w = AllocateWindowDescFront((byte)player == _local_player ? &_my_player_company_desc : &_other_player_company_desc,  player);
+	w = AllocateWindowDescFront(((IsSisterCompany(player, _local_player) && _patches.subsidiaries) || (!_patches.subsidiaries && (byte)player == _local_player)) ? &_my_player_company_desc : &_other_player_company_desc,  player);
 	if (w)
 		w->caption_color = w->window_number;
 }
 
-
-
 static void BuyCompanyWndProc(Window *w, WindowEvent *e)
 {
 	switch(e->event) {
Index: bridge.h
===================================================================
--- bridge.h	(Revision 2953)
+++ bridge.h	(Arbeitskopie)
@@ -8,7 +8,8 @@
 /** Struct containing information about a single bridge type
  */
 typedef struct Bridge {
-	byte avail_year;     ///< the year in which the bridge becomes available
+//	byte avail_year;     ///< the year in which the bridge becomes available
+	uint avail_year;     ///< the year in which the bridge becomes available
 	byte min_length;     ///< the minimum length of the bridge (not counting start and end tile)
 	byte max_length;     ///< the maximum length of the bridge (not counting start and end tile)
 	uint16 price;        ///< the relative price of the bridge
Index: win32.c
===================================================================
--- win32.c	(Revision 2953)
+++ win32.c	(Arbeitskopie)
@@ -834,7 +834,104 @@
 	return _fios_items;
 }
 
+#ifdef WITH_PNG
+// Get a list of PNGs
+FiosItem *FiosGetPNGList(int *num, int mode)
+{
+	FiosItem *fios;
+	WIN32_FIND_DATA fd;
+	HANDLE h;
+	int sort_start;
 
+	if (_fios_scn_path == NULL) {
+		_fios_scn_path = malloc(MAX_PATH);
+		strcpy(_fios_scn_path, _path.scenario_dir);
+	}
+
+	_fios_path = _fios_scn_path;
+
+	// Parent directory, only if not of the type C:\.
+	if (_fios_path[3] != '\0' && mode != SLD_NEW_GAME) {
+		fios = FiosAlloc();
+		fios->type = FIOS_TYPE_PARENT;
+		fios->mtime = 0;
+		strcpy(fios->title, ".. (Parent directory)");
+	}
+
+	// Show subdirectories first
+	h = MyFindFirstFile(_fios_scn_path, "*.*", &fd);
+	if (h != INVALID_HANDLE_VALUE && mode != SLD_NEW_GAME) {
+		do {
+			if (fd.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY &&
+					strcmp(fd.cFileName, ".") != 0 &&
+					strcmp(fd.cFileName, "..") != 0) {
+				fios = FiosAlloc();
+				fios->type = FIOS_TYPE_DIR;
+				fios->mtime = 0;
+				ttd_strlcpy(fios->name, fd.cFileName, lengthof(fios->name));
+				snprintf(fios->title, lengthof(fios->title), "%s\\ (Directory)", fd.cFileName);
+			}
+		} while (FindNextFile(h, &fd));
+		FindClose(h);
+	}
+
+	{
+		/* XXX ugly global variables ... */
+		byte order = _savegame_sort_order;
+		_savegame_sort_order = 2; // sort ascending by name
+		qsort(_fios_items, _fios_count, sizeof(FiosItem), compare_FiosItems);
+		_savegame_sort_order = order;
+	}
+
+	// this is where to start sorting
+	sort_start = _fios_count;
+
+	/* Show PNGs */
+	h = MyFindFirstFile(_fios_scn_path, "*.*", &fd);
+	if (h != INVALID_HANDLE_VALUE) {
+		do {
+			char *t;
+
+			if ((fd.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY)) continue;
+
+			t = strrchr(fd.cFileName, '.');
+			if (t == NULL) continue;
+
+			if (strcasecmp(t, ".png") == 0) { // OpenTTD
+				fios = FiosAlloc();
+				fios->type = FIOS_TYPE_PNG;
+				fios->mtime = *(uint64*)&fd.ftLastWriteTime;
+				ttd_strlcpy(fios->name, fd.cFileName, lengthof(fios->name));
+
+				*t = '\0'; // strip extension
+				ttd_strlcpy(fios->title, fd.cFileName, lengthof(fios->title));
+			}
+		} while (FindNextFile(h, &fd));
+		FindClose(h);
+	}
+
+	qsort(_fios_items + sort_start, _fios_count - sort_start, sizeof(FiosItem), compare_FiosItems);
+
+	// Drives
+	if (mode != SLD_NEW_GAME) {
+		char drives[256];
+		const char *s;
+
+		GetLogicalDriveStrings(sizeof(drives), drives);
+		for (s = drives; *s != '\0';) {
+			fios = FiosAlloc();
+			fios->type = FIOS_TYPE_DRIVE;
+			sprintf(fios->name, "%c:", s[0]);
+			sprintf(fios->title, "%c:", s[0]);
+			while (*s++ != '\0') {}
+		}
+	}
+
+	*num = _fios_count;
+	return _fios_items;
+}
+#endif //WITH_PNG
+
 // Free the list of savegames
 void FiosFreeSavegameList(void)
 {
@@ -870,7 +967,12 @@
 		case FIOS_TYPE_FILE:
 		case FIOS_TYPE_OLDFILE:
 		case FIOS_TYPE_SCENARIO:
-		case FIOS_TYPE_OLD_SCENARIO: {
+#ifdef WITH_PNG
+		case FIOS_TYPE_OLD_SCENARIO:
+		case FIOS_TYPE_PNG: {
+#else //WITH_PNG
+	case FIOS_TYPE_OLD_SCENARIO: {
+#endif //WITH_PNG
 			static char str_buffr[512];
 
 			sprintf(str_buffr, "%s\\%s", path, item->name);
Index: os2.c
===================================================================
--- os2.c	(Revision 2953)
+++ os2.c	(Arbeitskopie)
@@ -320,7 +320,117 @@
 	return _fios_items;
 }
 
+#ifdef WITH_PNG
+// Get a list of PNGs
+FiosItem *FiosGetPNGList(int *num, int mode)
+{
+	FiosItem *fios;
+	DIR *dir;
+	struct dirent *dirent;
+	struct stat sb;
+	int sort_start;
+	char filename[MAX_PATH];
 
+	if (_fios_scn_path == NULL) {
+		_fios_scn_path = malloc(MAX_PATH);
+		strcpy(_fios_scn_path, _path.scenario_dir);
+	}
+
+	_fios_path = _fios_scn_path;
+
+	// Parent directory, only if not of the type C:\.
+	if (_fios_path[3] != '\0' && mode != SLD_NEW_GAME) {
+		fios = FiosAlloc();
+		fios->type = FIOS_TYPE_PARENT;
+		fios->mtime = 0;
+		strcpy(fios->title, ".. (Parent directory)");
+	}
+
+	// Show subdirectories first
+	dir = opendir(_fios_path);
+	if (dir != NULL) {
+		while ((dirent = readdir(dir)) != NULL) {
+			append_path(filename, _fios_path, dirent->d_name);
+			if (!stat(filename, &sb) && S_ISDIR(sb.st_mode) &&
+					strcmp(dirent->d_name, ".") != 0 &&
+					strcmp(dirent->d_name, "..") != 0) {
+				fios = FiosAlloc();
+				fios->type = FIOS_TYPE_DIR;
+				fios->mtime = 0;
+				ttd_strlcpy(fios->name, dirent->d_name, lengthof(fios->name));
+				snprintf(fios->title, lengthof(fios->title), "%s\\ (Directory)", dirent->d_name);
+			}
+		}
+		closedir(dir);
+	}
+
+	{
+		/* XXX ugly global variables ... */
+		byte order = _savegame_sort_order;
+		_savegame_sort_order = 2; // sort ascending by name
+		qsort(_fios_items, _fios_count, sizeof(FiosItem), compare_FiosItems);
+		_savegame_sort_order = order;
+	}
+
+	// this is where to start sorting
+	sort_start = _fios_count;
+
+	/* Show PNGs */
+	dir = opendir(_fios_path);
+	if (dir != NULL) {
+		while ((dirent = readdir(dir)) != NULL) {
+			char *t;
+
+			append_path(filename, _fios_path, dirent->d_name);
+			if (stat(filename, &sb) || S_ISDIR(sb.st_mode)) continue;
+
+			t = strrchr(dirent->d_name, '.');
+			if (t == NULL) continue;
+
+			if (strcasecmp(t, ".png") == 0) {
+				fios = FiosAlloc();
+				fios->type = FIOS_TYPE_PNG;
+				fios->mtime = sb.st_mtime;
+				ttd_strlcpy(fios->name, dirent->d_name, lengthof(fios->name));
+
+				*t = '\0'; // strip extension
+				ttd_strlcpy(fios->title, dirent->d_name, lengthof(fios->title));
+			}
+		}
+		closedir(dir);
+	}
+
+	qsort(_fios_items + sort_start, _fios_count - sort_start, sizeof(FiosItem), compare_FiosItems);
+
+	// Drives
+	if (mode != SLD_NEW_GAME) {
+		unsigned save, disk, disk2, total;
+
+		/* save original drive */
+		_dos_getdrive(&save);
+
+		/* get available drive letters */
+
+		for (disk = 1; disk < 27; ++disk) {
+			_dos_setdrive(disk, &total);
+			_dos_getdrive(&disk2);
+
+			if (disk == disk2) {
+				fios = FiosAlloc();
+				fios->type = FIOS_TYPE_DRIVE;
+				sprintf(fios->name, "%c:", 'A' + disk - 1);
+				sprintf(fios->title, "%c:", 'A' + disk - 1);
+			}
+		}
+
+		_dos_setdrive(save, &total);
+	}
+
+	*num = _fios_count;
+	return _fios_items;
+}
+#endif //WITH_PNG
+
 // Free the list of savegames
 void FiosFreeSavegameList(void)
 {
@@ -356,7 +466,12 @@
 		case FIOS_TYPE_FILE:
 		case FIOS_TYPE_OLDFILE:
 		case FIOS_TYPE_SCENARIO:
-		case FIOS_TYPE_OLD_SCENARIO: {
+#ifdef WITH_PNG
+		case FIOS_TYPE_OLD_SCENARIO:
+		case FIOS_TYPE_PNG: {
+#else //WITH_PNG
+	case FIOS_TYPE_OLD_SCENARIO: {
+#endif //WITH_PNG
 			static char str_buffr[512];
 
 			sprintf(str_buffr, "%s\\%s", path, item->name);
Index: water_cmd.c
===================================================================
--- water_cmd.c	(Revision 2953)
+++ water_cmd.c	(Arbeitskopie)
@@ -14,6 +14,7 @@
 #include "news.h"
 #include "sound.h"
 #include "depot.h"
+#include "economy.h"
 #include "vehicle_gui.h"
 
 const SpriteID _water_shore_sprites[15] = {
@@ -89,7 +90,7 @@
 {
 	TileIndex tile2;
 
-	if (!CheckTileOwnership(tile))
+	if (!CheckTileOwnership(tile) && !(_patches.allow_track_removal && IsSisterCompany(_current_player, GetTileOwner(tile))))
 		return CMD_ERROR;
 
 	if (!EnsureNoVehicle(tile))
Index: economy.c
===================================================================
--- economy.c	(Revision 2953)
+++ economy.c	(Arbeitskopie)
@@ -72,6 +72,74 @@
 	MarkTileDirtyByTile(tile + TileDiffXY(1, 1));
 }
 
+int32 GetSubsidiaries(void)
+{
+	int64 list = 0;
+	int i = 0;
+	Player *p;
+
+	FOR_ALL_PLAYERS(p){
+		if(p->is_active && IsSubsidiary(p)){
+			list |= 1 << i;
+		}
+		i++;
+	}
+
+	return list;
+}
+
+/* Can be used even if _patches.subsidiaries is false */
+byte GetMotherCompany(Player *p)
+{
+	int i;
+
+	for(i=1;p->share_owners[i] == p->share_owners[0];) {
+		if (++i == 4 && p->share_owners[0] != 0xFF) {
+			return p->share_owners[0];
+		}
+	}
+
+	return p->index;
+}
+
+bool IsSisterCompanyIgnorePatch(byte c1, byte c2){
+	if(c1 > MAX_PLAYERS || c2 > MAX_PLAYERS)
+			return false;
+	return GetMotherCompany(GetPlayer(c1)) == GetMotherCompany(GetPlayer(c2));
+}
+
+bool IsSisterCompany(byte c1, byte c2)
+{
+	if (!_patches.subsidiaries){
+		return c1 == c2;
+	}else{
+		if(c1 > MAX_PLAYERS || c2 > MAX_PLAYERS)
+			return false;
+		return GetMotherCompany(GetPlayer(c1)) == GetMotherCompany(GetPlayer(c2));
+	}
+}
+
+bool IsSubsidiary(Player *p)
+{
+	byte playerOwner = GetMotherCompany(GetPlayer(_local_player));
+	byte paramOwner = GetMotherCompany(p);
+
+	return (playerOwner == paramOwner);
+}
+
+byte GetSubsidiariesCount(void)
+{
+	Player *p;
+	int count = 0;
+
+	FOR_ALL_PLAYERS(p){
+		if(p->is_active && IsSubsidiary(p))
+			count++;
+	}
+
+	return count;
+}
+
 int64 CalculateCompanyValue(Player *p) {
 	byte owner = p->index;
 	int64 value;
@@ -1348,6 +1416,9 @@
 				unloading_time += v->cargo_count; /* TTDBUG: bug in original TTD */
 				profit += DeliverGoods(v->cargo_count, v->cargo_type, v->cargo_source, last_visited, v->cargo_days);
 				result |= 1;
+				ge->cargo_amount[STS_AMOUNT_IN].this_month += v->cargo_count;
+				if (ge->months_counted == 0) ge->months_counted = 1;
+				InvalidateWindow(WC_STATION_STATS, st->index);
 				v->cargo_count = 0;
 			} else if (u->current_order.flags & ( OF_UNLOAD | OF_TRANSFER) ) {
 				/* unload goods and let it wait at the station */
@@ -1361,6 +1432,9 @@
 
 				v_profit_total += v_profit;
 
+				ge->cargo_amount[STS_AMOUNT_TRANSFER].this_month += v->cargo_count;
+				if (ge->months_counted == 0) ge->months_counted = 1;
+				InvalidateWindow(WC_STATION_STATS, st->index);
 
 				unloading_time += v->cargo_count;
 				if ((t=ge->waiting_acceptance & 0xFFF) == 0) {
@@ -1391,14 +1465,21 @@
 
 		/* update stats */
 		ge->days_since_pickup = 0;
+		ge->last_vehicle_type = u->type;
+
+		// TODO: use max-speed of whole consist for trains
 		t = u->max_speed;
+		if (u->type == VEH_Train) t = u->u.rail.cached_max_speed;
 		if (u->type == VEH_Road) t >>=1;
-		if (u->type == VEH_Train) t = u->u.rail.cached_max_speed;
-
+		ge->last_vehicle_speed = t;
+		
+		ge->last_vehicle_speed = t;
 		// if last speed is 0, we treat that as if no vehicle has ever visited the station.
 		ge->last_speed = t < 255 ? t : 255;
+		// TODO: use age of oldest wagon of this type
 		ge->last_age = _cur_year - v->build_year;
 
+
 		// If there's goods waiting at the station, and the vehicle
 		//  has capacity for it, load it on the vehicle.
 		if ((count=ge->waiting_acceptance & 0xFFF) != 0 &&
@@ -1429,6 +1510,11 @@
 			ge->waiting_acceptance -= cap;
 			v->profit_this_year -= feeder_profit_share;
 			ge->feeder_profit -= feeder_profit_share;
+
+			ge->cargo_amount[STS_AMOUNT_OUT].this_month += cap;
+			if (ge->months_counted == 0) ge->months_counted = 1;
+			InvalidateWindow(WC_STATION_STATS, st->index);
+
 			unloading_time += cap;
 			st->time_since_load = 0;
 
@@ -1437,6 +1523,52 @@
 			v->cargo_days = ge->enroute_time;
 			result |= 2;
 			st->last_vehicle = v->index;
+
+			// And tax the vehicle if the cargo was picked up at another player's station
+			if(u->owner != st->owner){
+				int32 tax = 0;
+				byte backup = _current_player;
+				if(IsSisterCompany(u->owner, st->owner)){
+					tax = _patches.shared_stations_pickuptax_subsidiary;
+				}else if(_patches.shared_stations){
+					tax = _patches.shared_stations_pickuptax_others;
+				}
+
+				_current_player = u->owner;
+				switch(u->type){
+					case VEH_Train: SET_EXPENSES_TYPE(EXPENSES_TRAIN_RUN); break;
+					case VEH_Road: SET_EXPENSES_TYPE(EXPENSES_ROADVEH_RUN); break;
+					case VEH_Ship: SET_EXPENSES_TYPE(EXPENSES_SHIP_RUN); break;
+					case VEH_Aircraft: SET_EXPENSES_TYPE(EXPENSES_AIRCRAFT_RUN); break;
+					default: SET_EXPENSES_TYPE(EXPENSES_OTHER); break;
+				}
+				u->profit_this_year -= cap * tax / 2;
+				SubtractMoneyFromPlayer(cap * tax / 2);
+
+				_current_player = st->owner;
+				SET_EXPENSES_TYPE(EXPENSES_PROPERTY);
+				SubtractMoneyFromPlayer(-(int32)(cap * tax / 2));
+
+				if(v->owner != GetTileOwner(v->tile)){
+
+					_current_player = u->owner;
+					switch(v->type){
+						case VEH_Train: SET_EXPENSES_TYPE(EXPENSES_TRAIN_RUN); break;
+						case VEH_Road: SET_EXPENSES_TYPE(EXPENSES_ROADVEH_RUN); break;
+						case VEH_Ship: SET_EXPENSES_TYPE(EXPENSES_SHIP_RUN); break;
+						case VEH_Aircraft: SET_EXPENSES_TYPE(EXPENSES_AIRCRAFT_RUN); break;
+						default: SET_EXPENSES_TYPE(EXPENSES_OTHER); break;
+					}
+					SubtractMoneyFromPlayer(cap * tax / 2);
+					u->profit_this_year -= cap * tax / 2;
+
+					_current_player = GetTileOwner(u->tile);
+					SET_EXPENSES_TYPE(EXPENSES_PROPERTY);
+					SubtractMoneyFromPlayer(-(int32)(cap * tax / 2));
+				}
+
+				_current_player = backup;
+			}
 		}
 	}
 
@@ -1469,11 +1601,65 @@
 			InvalidateWindow(WC_STATION_VIEW, last_visited);
 
 		if (profit != 0) {
+			switch(v->type){
+				case VEH_Train: SET_EXPENSES_TYPE(EXPENSES_TRAIN_INC); break;
+				case VEH_Road: SET_EXPENSES_TYPE(EXPENSES_ROADVEH_INC); break;
+				case VEH_Ship: SET_EXPENSES_TYPE(EXPENSES_SHIP_INC); break;
+				case VEH_Aircraft: SET_EXPENSES_TYPE(EXPENSES_AIRCRAFT_INC); break;
+				default: SET_EXPENSES_TYPE(EXPENSES_OTHER); break;
+			}
 			v->profit_this_year += profit;
 			SubtractMoneyFromPlayer(-profit);
 
-			if (IsLocalPlayer()) SndPlayVehicleFx(SND_14_CASHTILL, v);
+			if (IsLocalPlayer()) 
+				SndPlayVehicleFx(SND_14_CASHTILL, v);
+				
+			if(v->owner != st->owner){
+				byte curr = _current_player;
+				byte tax = 0;
 
+				if(IsSisterCompany(v->owner, st->owner)){
+					tax = _patches.shared_stations_tax;
+				}else if(_patches.shared_stations){
+					tax = _patches.shared_stations_tax_others;
+				}
+
+				switch(v->type){
+					case VEH_Train: SET_EXPENSES_TYPE(EXPENSES_TRAIN_RUN); break;
+					case VEH_Road: SET_EXPENSES_TYPE(EXPENSES_ROADVEH_RUN); break;
+					case VEH_Ship: SET_EXPENSES_TYPE(EXPENSES_SHIP_RUN); break;
+					case VEH_Aircraft: SET_EXPENSES_TYPE(EXPENSES_AIRCRAFT_RUN); break;
+					default: SET_EXPENSES_TYPE(EXPENSES_OTHER); break;
+				}
+				SubtractMoneyFromPlayer(profit * tax / 200);
+				v->profit_this_year -= profit * tax / 200;
+
+				_current_player = st->owner;
+				SET_EXPENSES_TYPE(EXPENSES_PROPERTY);
+				SubtractMoneyFromPlayer(-profit * tax / 200);
+				_current_player = curr;
+
+				if(v->owner != GetTileOwner(v->tile)){
+					curr = _current_player;
+
+					switch(v->type){
+						case VEH_Train: SET_EXPENSES_TYPE(EXPENSES_TRAIN_RUN); break;
+						case VEH_Road: SET_EXPENSES_TYPE(EXPENSES_ROADVEH_RUN); break;
+						case VEH_Ship: SET_EXPENSES_TYPE(EXPENSES_SHIP_RUN); break;
+						case VEH_Aircraft: SET_EXPENSES_TYPE(EXPENSES_AIRCRAFT_RUN); break;
+						default: SET_EXPENSES_TYPE(EXPENSES_OTHER); break;
+					}
+					SubtractMoneyFromPlayer(profit * tax / 200);
+					v->profit_this_year -= profit* tax / 200;
+
+					_current_player = GetTileOwner(v->tile);
+					SET_EXPENSES_TYPE(EXPENSES_PROPERTY);
+					SubtractMoneyFromPlayer(-profit * tax / 200);
+					_current_player = curr;
+				}
+			}
+
+
 			ShowCostOrIncomeAnimation(v->x_pos, v->y_pos, v->z_pos, -profit);
 		}
 	}
@@ -1494,7 +1680,7 @@
 	SubsidyMonthlyHandler();
 }
 
-static void DoAcquireCompany(Player *p)
+void DoAcquireCompany(Player *p)
 {
 	Player *owner;
 	int i,pi;
@@ -1530,8 +1716,136 @@
 	RebuildVehicleLists();	//Updates the open windows to add the newly acquired vehicles to the lists
 }
 
+extern void ShowErrorMessage(StringID msg_1, StringID msg_2, int x, int y);
+
+int32 CmdSubsidiaryBuyShareResponse(int x, int y, uint32 flags, uint32 p1, uint32 p2){
+
+	Player *p;
+	Player *player2;
+	int motherIndex;
+	Player *mother;
+	int64 cost;
+	byte *b;
+	int i;
+	byte old_cp;
+
+	p = GetPlayer(_current_player);
+	cost = CalculateCompanyValue(GetPlayer(_current_player)) >> 2;
+
+	if(flags & DC_EXEC){
+		if(p2 == 0){
+			if(p1 == _local_player){
+				ShowErrorMessage(STR_SUBSIDIARY_SELL_SHARE_DENIED, STR_NULL ,0,0);
+			}
+			return 0;
+		}
+
+		b = p->share_owners;
+		while (*b != 0xFF) b++; /* share owners is guaranteed to contain at least one 0xFF */
+		*b = GetMotherCompany(GetPlayer(p1));
+
+		for(i=0;p->share_owners[i] == GetMotherCompany(GetPlayer(p1));) {
+			if (++i == 4) {
+				// The buying company is taking over this one.
+				p->is_ai = 0;
+				motherIndex = GetMotherCompany(GetPlayer(p1));
+
+				/* The bought out company must surrender its shares into other companies, to the */
+				/* buying one. */
+				FOR_ALL_PLAYERS(player2){
+					for(i = 0; i < 4; i++){
+						if(player2->share_owners[i] == p->index)
+							player2->share_owners[i] = motherIndex;
+					}
+				}
+
+				/* At this point, due to the share exchanges, it is possible that the buying company */
+				/* holds shares of itself, clean the mess */
+				mother = GetPlayer(motherIndex);
+				for(i = 0; i < 4; i ++){
+					if(mother->share_owners[i] == motherIndex)
+						mother->share_owners[i] = 0xFF;
+				}
+
+				MarkWholeScreenDirty();
+				break;
+			}
+		}
+		InvalidateWindow(WC_COMPANY, (int)p1);
+		if(p1 == _local_player){
+			//HACK!!!!
+			//Should use network message etc.
+			ShowErrorMessage(STR_SUBSIDIARY_SELL_SHARE_GRANTED, STR_NULL ,0,0);
+		}
+		old_cp = _current_player;
+		_current_player = p1;
+		SubtractMoneyFromPlayer(cost);
+		_current_player = old_cp;
+	}
+//		return cost;
+	return 0;
+}
+
+int32 CmdSubsidiarySendMoneyOnRequest(int x, int y, uint32 flags, uint32 p1, uint32 p2){
+	byte old_cp;
+	SET_EXPENSES_TYPE(EXPENSES_OTHER);
+
+	if((int32)p2 == -1){
+		// request denied
+		if(_local_player == p1){
+			ShowErrorMessage(STR_SUBSIDIARY_CASH_REQUEST_DENIED,STR_NULL,0,0);
+		}
+		return 0;
+	}
+
+	if(_local_player == p1){
+		ShowErrorMessage(STR_SUBSIDIARY_CASH_REQUEST_GRANTED,STR_NULL,0,0);
+	}
+
+	// Add money to player
+	if(flags & DC_EXEC){
+		old_cp = _current_player;
+		_current_player = p1;
+		SubtractMoneyFromPlayer(-(int32)p2 + (p2 / 16)); // don't forget to correct for tax
+		_current_player = old_cp;
+	}
+
+	// Subtract money from local-player
+	return (int32)p2;
+}
+
+// p1 = destination
+// p2 = amount
+extern void AskSendMoney(byte player,int32 amount);
+int32 CmdSubsidiaryGetMoney(int x, int y, uint32 flags, uint32 p1, uint32 p2)
+{
+	if(_local_player == p1){
+		AskSendMoney(_current_player,p2);
+	}
+	return 0;
+}
+
+// p1 = destination
+// p2 = amount
+int32 CmdSubsidiarySendMoney(int x, int y, uint32 flags, uint32 p1, uint32 p2)
+{
+	byte old_cp;
+	SET_EXPENSES_TYPE(EXPENSES_OTHER);
+
+	// Add money to player
+	if(flags & DC_EXEC){
+		old_cp = _current_player;
+		_current_player = p1;
+		SubtractMoneyFromPlayer(-(int32)p2 + (p2 / 16)); // don't forget to correct for tax
+		_current_player = old_cp;
+	}
+
+	// Subtract money from local-player
+	return (int32)p2;
+}
+
 extern int GetAmountOwnedBy(Player *p, byte owner);
-
+extern void AskSellShare(byte player);
 /** Acquire shares in an opposing company.
  * @param x,y unused
  * @param p1 player to buy the shares from
@@ -1540,6 +1854,9 @@
 int32 CmdBuyShareInCompany(int x, int y, uint32 flags, uint32 p1, uint32 p2)
 {
 	Player *p;
+	Player *player2;
+	int motherIndex;
+	Player *mother;
 	int64 cost;
 
 	/* Check if buying shares is allowed (protection against modified clients */
@@ -1549,26 +1866,77 @@
 	p = GetPlayer(p1);
 
 	/* Protect new companies from hostile takeovers */
-	if (_cur_year - p->inaugurated_year < 6) return_cmd_error(STR_7080_PROTECTED);
+	if (_cur_year - p->inaugurated_year < _patches.years_of_protection + 1 && _patches.years_of_protection > 0) {
+		_error_message = STR_7080_PROTECTED;
+		return CMD_ERROR;
+	}
 
+	/* Check if buying shares is allowed (protection against modified clients */
+	if (!_patches.allow_shares && !_patches.subsidiaries)
+		return CMD_ERROR;
+
 	/* Those lines are here for network-protection (clients can be slow) */
 	if (GetAmountOwnedBy(p, OWNER_SPECTATOR) == 0) return 0;
 
 	/* We can not buy out a real player (temporarily). TODO: well, enable it obviously */
-	if (GetAmountOwnedBy(p, OWNER_SPECTATOR) == 1 && !p->is_ai) return 0;
+	if (GetAmountOwnedBy(p, OWNER_SPECTATOR) == 1 && !p->is_ai && !_patches.subsidiaries) return 0;
 
 	cost = CalculateCompanyValue(p) >> 2;
+
+	// if we are networking and the subsidiaries patch is active, popup a confirmation box
+	if(_patches.subsidiaries && _networking) {
+		if(flags & DC_EXEC) {
+			if(_local_player == p1 && flags & DC_EXEC) {
+				AskSellShare(_current_player);
+			}
+			return 0;
+		}
+		//evil hack returns the cost on the simulated run to check for enough cash,
+		//but doesn't charge on the real run until the seller agrees to sell
+		else
+			return cost;
+	}
+
 	if (flags & DC_EXEC) {
 		int i;
 		byte *b = p->share_owners;
 
 		while (*b != 0xFF) b++; /* share owners is guaranteed to contain at least one 0xFF */
-		*b = _current_player;
+		if(_patches.subsidiaries)
+			*b = GetMotherCompany(GetPlayer(_current_player));
+		else
+			*b = _current_player;
 
 		for (i = 0; p->share_owners[i] == _current_player;) {
 			if (++i == 4) {
-				p->bankrupt_value = 0;
-				DoAcquireCompany(p);
+				// The buying company is taking over this one.
+				if(!_patches.subsidiaries){
+					p->bankrupt_value = 0;
+					DoAcquireCompany(p);
+					motherIndex = _current_player;
+				}else{
+					p->is_ai = 0;
+					motherIndex = GetMotherCompany(GetPlayer(_current_player));
+				}
+
+				/* The bought out company must surrender its shares into other companies, to the */
+				/* buying one. */
+				FOR_ALL_PLAYERS(player2){
+					for(i = 0; i < 4; i++){
+						if(player2->share_owners[i] == p->index)
+							player2->share_owners[i] = motherIndex;
+					}
+				}
+
+				/* At this point, due to the share exchanges, it is possible that the buying company */
+				/* holds shares of itself, clean the mess */
+				mother = GetPlayer(motherIndex);
+				for(i = 0; i < 4; i ++){
+					if(mother->share_owners[i] == motherIndex)
+						mother->share_owners[i] = 0xFF;
+				}
+
+				MarkWholeScreenDirty();
 				break;
 			}
 		}
@@ -1604,6 +1972,8 @@
 		byte *b = p->share_owners;
 		while (*b != _current_player) b++; /* share owners is guaranteed to contain player */
 		*b = 0xFF;
+		if(!_networking)
+			p->is_ai = true;
 		InvalidateWindow(WC_COMPANY, (int)p1);
 	}
 	return cost;
Index: town_cmd.c
===================================================================
--- town_cmd.c	(Revision 2953)
+++ town_cmd.c	(Arbeitskopie)
@@ -733,7 +733,7 @@
 
 		// Try to grow the town from this point
 		GrowTownInTile(&tile,mask,block,t);
-
+		
 		// Exclude the source position from the bitmask
 		// and return if no more road blocks available
 		CLRBIT(mask, (block ^ 2));
@@ -976,7 +976,7 @@
 
 	t->townnametype = SPECSTR_TOWNNAME_START + _opt.town_name;
 	t->townnameparts = townnameparts;
-
+	
 	UpdateTownVirtCoord(t);
 	_town_sort_dirty = true;
 
@@ -988,6 +988,7 @@
 	UpdateTownRadius(t);
 
 	i = x * 4;
+
 	do {
 		GrowTown(t);
 	} while (--i);
@@ -1102,6 +1103,7 @@
 			break;
 
 		DoCreateTown(t, tile, townnameparts);
+		
 		return t;
 	} while (--attempts);
 	return NULL;
Index: economy.h
===================================================================
--- economy.h	(Revision 2953)
+++ economy.h	(Arbeitskopie)
@@ -62,7 +62,17 @@
 void DeleteSubsidyWithStation(uint16 index);
 void RemoteSubsidyAdd(Subsidy *s_new);
 
+void DoAcquireCompany(Player *p);
+
 int32 GetTransportedGoodsIncome(uint num_pieces, uint dist, byte transit_days, byte cargo_type);
 uint MoveGoodsToStation(TileIndex tile, int w, int h, int type, uint amount);
 
+
+bool IsSisterCompany(byte c1, byte c2);
+bool IsSisterCompanyIgnorePatch(byte c1, byte c2);
+byte GetMotherCompany(Player *p);
+bool IsSubsidiary(Player *p);
+int32 GetSubsidiaries(void);
+byte GetSubsidiariesCount(void);
+
 #endif /* ECONOMY_H */
Index: unix.c
===================================================================
--- unix.c	(Revision 2953)
+++ unix.c	(Arbeitskopie)
@@ -281,7 +281,93 @@
 	return _fios_items;
 }
 
+#ifdef WITH_PNG
+// Get a list of PNGs
+// FIXME: Gross code duplication with FiosGetSavegameList()
+FiosItem *FiosGetPNGList(int *num, int mode)
+{
+	FiosItem *fios;
+	DIR *dir;
+	struct dirent *dirent;
+	struct stat sb;
+	int sort_start;
+	char filename[MAX_PATH];
 
+	if (_fios_scn_path == NULL) {
+		_fios_scn_path = malloc(MAX_PATH);
+		strcpy(_fios_scn_path, _path.scenario_dir);
+	}
+
+	_fios_path = _fios_scn_path;
+
+	// Parent directory, only if not of the type C:\.
+	if (_fios_path[1] != '\0' && mode != SLD_NEW_GAME) {
+		fios = FiosAlloc();
+		fios->type = FIOS_TYPE_PARENT;
+		fios->mtime = 0;
+		strcpy(fios->title, ".. (Parent directory)");
+	}
+
+	// Show subdirectories first
+	dir = opendir(_fios_path);
+	if (dir != NULL) {
+		while ((dirent = readdir(dir)) != NULL) {
+			snprintf(filename, lengthof(filename), "%s/%s",
+				_fios_path, dirent->d_name);
+			if (!stat(filename, &sb) && S_ISDIR(sb.st_mode) &&
+					dirent->d_name[0] != '.') {
+				fios = FiosAlloc();
+				fios->type = FIOS_TYPE_DIR;
+				fios->mtime = 0;
+				ttd_strlcpy(fios->name, dirent->d_name, lengthof(fios->name));
+				snprintf(fios->title, lengthof(fios->title), "%s/ (Directory)", dirent->d_name);
+			}
+		}
+		closedir(dir);
+	}
+
+	{
+		/* XXX ugly global variables ... */
+		byte order = _savegame_sort_order;
+		_savegame_sort_order = 2; // sort ascending by name
+		qsort(_fios_items, _fios_count, sizeof(FiosItem), compare_FiosItems);
+		_savegame_sort_order = order;
+	}
+
+	// this is where to start sorting
+	sort_start = _fios_count;
+
+	/* Show PNG files */
+	dir = opendir(_fios_path);
+	if (dir != NULL) {
+		while ((dirent = readdir(dir)) != NULL) {
+			char *t;
+
+			snprintf(filename, lengthof(filename), "%s/%s", _fios_path, dirent->d_name);
+			if (stat(filename, &sb) || S_ISDIR(sb.st_mode)) continue;
+
+			t = strrchr(dirent->d_name, '.');
+			if (t == NULL) continue;
+			
+			if (strcasecmp(t, ".png") == 0) {
+				fios = FiosAlloc();
+				fios->type = FIOS_TYPE_PNG;
+				fios->mtime = sb.st_mtime;
+				ttd_strlcpy(fios->name, dirent->d_name, lengthof(fios->name));
+
+				*t = '\0'; // strip extension
+				ttd_strlcpy(fios->title, dirent->d_name, lengthof(fios->title));
+			}
+		}
+		closedir(dir);
+	}
+
+	qsort(_fios_items + sort_start, _fios_count - sort_start, sizeof(FiosItem), compare_FiosItems);
+	*num = _fios_count;
+	return _fios_items;
+}
+#endif //WITH_PNG
+
 // Free the list of savegames
 void FiosFreeSavegameList(void)
 {
@@ -313,7 +399,12 @@
 		case FIOS_TYPE_FILE:
 		case FIOS_TYPE_OLDFILE:
 		case FIOS_TYPE_SCENARIO:
-		case FIOS_TYPE_OLD_SCENARIO: {
+#ifdef WITH_PNG
+		case FIOS_TYPE_OLD_SCENARIO:
+		case FIOS_TYPE_PNG: {
+#else //WITH_PNG
+	case FIOS_TYPE_OLD_SCENARIO: {
+#endif //WITH_PNG
 			static char str_buffr[512];
 
 			sprintf(str_buffr, "%s/%s", path, item->name);
Index: ship_cmd.c
===================================================================
--- ship_cmd.c	(Revision 2953)
+++ ship_cmd.c	(Arbeitskopie)
@@ -15,6 +15,7 @@
 #include "gui.h"
 #include "player.h"
 #include "sound.h"
+#include "economy.h"
 #include "npf.h"
 #include "depot.h"
 #include "vehicle_gui.h"
@@ -77,7 +78,8 @@
 	} else {
 		FOR_ALL_DEPOTS(depot) {
 			tile = depot->xy;
-			if (IsValidDepot(depot) && IsTileDepotType(tile, TRANSPORT_WATER) && IsTileOwner(tile, v->owner)) {
+			if (IsValidDepot(depot) && IsTileDepotType(tile, TRANSPORT_WATER) && (IsSisterCompany(GetTileOwner(tile),v->owner) || _patches.shared_stations)) {
+
 				dist = DistanceManhattan(tile, tile2);
 				if (dist < best_dist) {
 					best_dist = dist;
@@ -446,6 +448,10 @@
 
 static void ShipArrivesAt(Vehicle *v, Station *st)
 {
+	st->vehicles[STS_VEH_SHIP].this_month++;
+	if (st->months_counted == 0) st->months_counted = 1;
+	InvalidateWindow(WC_STATION_STATS, st->index);
+
 	/* Check if station was ever visited before */
 	if (!(st->had_vehicle_of_type & HVOT_SHIP)) {
 		uint32 flags;
@@ -871,7 +877,7 @@
 	/* The ai_new queries the vehicle cost before building the route,
 	 * so we must check against cheaters no sooner than now. --pasky */
 	if (!IsTileDepotType(tile, TRANSPORT_WATER)) return CMD_ERROR;
-	if (!IsTileOwner(tile, _current_player)) return CMD_ERROR;
+	if (!IsSisterCompany(GetTileOwner(tile),_current_player)) return CMD_ERROR;
 
 	v = AllocateVehicle();
 	if (v == NULL || IsOrderPoolFull() ||
Index: main_gui.c
===================================================================
--- main_gui.c	(Revision 2953)
+++ main_gui.c	(Arbeitskopie)
@@ -25,6 +25,7 @@
 #include "signs.h"
 #include "waypoint.h"
 #include "variables.h"
+#include "station.h"
 
 #include "network_data.h"
 #include "network_client.h"
@@ -32,7 +33,7 @@
 
 /* Min/Max date for scenario editor */
 static const uint MinDate = 0;     // 1920-01-01 (MAX_YEAR_BEGIN_REAL)
-static const uint MaxDate = 29220; // 2000-01-01
+static const uint MaxDate = 11758979; // 2000-01-01
 
 static int _rename_id;
 static int _rename_what;
@@ -44,6 +45,14 @@
 extern void GenerateIndustries(void);
 extern void GenerateTowns(void);
 
+extern void ShowSubsidiariesManagement(void);
+
+extern void DrawPlayerIcon(int p, int x, int y);
+
+extern uint GetCurrentCurrencyRate(void);
+
+extern void CcTerraform(bool success, uint tile, uint32 p1, uint32 p2);
+
 void HandleOnEditTextCancel(void)
 {
 	switch(_rename_what) {
@@ -306,22 +315,22 @@
 
 static void MenuClickShowTrains(int index)
 {
-	ShowPlayerTrains(index, -1);
+	ShowPlayerTrains(index, INVALID_STATION);
 }
 
 static void MenuClickShowRoad(int index)
 {
-	ShowPlayerRoadVehicles(index, -1);
+	ShowPlayerRoadVehicles(index, INVALID_STATION);
 }
 
 static void MenuClickShowShips(int index)
 {
-	ShowPlayerShips(index, -1);
+	ShowPlayerShips(index, INVALID_STATION);
 }
 
 static void MenuClickShowAir(int index)
 {
-	ShowPlayerAircraft(index, -1);
+	ShowPlayerAircraft(index, INVALID_STATION);
 }
 
 static void MenuClickBuildRail(int index)
@@ -1094,6 +1103,10 @@
 {   WIDGETS_END},
 };
 
+#ifdef WITH_PNG
+void LoadLandscapeFromPNG(void);
+#endif//WITH_PNG
+
 // Ask first to reset landscape or to make a random landscape
 static void AskResetLandscapeWndProc(Window *w, WindowEvent *e)
 {
@@ -1102,7 +1115,8 @@
 	switch(e->event) {
 	case WE_PAINT:
 		DrawWindowWidgets(w);
-		DrawStringMultiCenter(90, 38, mode?STR_022D_ARE_YOU_SURE_YOU_WANT_TO:STR_GENERATE_RANDOM_LANDSCAPE , 168);
+		DrawStringMultiCenter(90, 38, mode==2?STR_PNGMAP_ARE_YOU_SURE:
+								mode==1?STR_022D_ARE_YOU_SURE_YOU_WANT_TO:STR_GENERATE_RANDOM_LANDSCAPE , 168);
 		break;
 	case WE_CLICK:
 		switch(e->click.widget) {
@@ -1115,7 +1129,11 @@
 			DeleteWindowByClass(WC_TOWN_VIEW);
 			DeleteWindowByClass(WC_LAND_INFO);
 
-			if (mode) { // reset landscape
+			if (mode==2) { // load landscape from png
+#ifdef WITH_PNG
+				ShowSaveLoadDialog(SLD_LOAD_PNG);
+#endif//WITH_PNG
+			} else if (mode==1) { // reset landscape
 				ResetLandscape();
 			} else { // make random landscape
 				SndPlayFx(SND_15_BEEP);
@@ -1252,7 +1270,7 @@
 {   WWT_TEXTBTN,   RESIZE_NONE,     7,     0,    10,     0,    13, STR_00C5,                  STR_018B_CLOSE_WINDOW},
 {   WWT_CAPTION,   RESIZE_NONE,     7,    11,   169,     0,    13, STR_0223_LAND_GENERATION,  STR_018C_WINDOW_TITLE_DRAG_THIS},
 { WWT_STICKYBOX,   RESIZE_NONE,     7,   170,   181,     0,    13, STR_NULL,                  STR_STICKY_BUTTON},
-{    WWT_IMGBTN,   RESIZE_NONE,     7,     0,   181,    14,   101, STR_NULL,                  STR_NULL},
+{    WWT_IMGBTN,   RESIZE_NONE,     7,     0,   181,    14,   114, STR_NULL,                  STR_NULL},
 
 {    WWT_IMGBTN,   RESIZE_NONE,    14,     2,    23,    14,    35, SPR_IMG_DYNAMITE,          STR_018D_DEMOLISH_BUILDINGS_ETC},
 {    WWT_IMGBTN,   RESIZE_NONE,    14,    24,    45,    14,    35, SPR_IMG_TERRAFORM_DOWN,    STR_018F_RAISE_A_CORNER_OF_LAND},
@@ -1266,6 +1284,7 @@
 {   WWT_TEXTBTN,   RESIZE_NONE,    14,   139,   149,    56,    67, STR_0225,                  STR_0229_DECREASE_SIZE_OF_LAND_AREA},
 {   WWT_TEXTBTN,   RESIZE_NONE,    14,    34,   149,    75,    86, STR_0226_RANDOM_LAND,      STR_022A_GENERATE_RANDOM_LAND},
 {   WWT_TEXTBTN,   RESIZE_NONE,    14,    34,   149,    88,    99, STR_0227_RESET_LAND,       STR_022B_RESET_LANDSCAPE},
+{   WWT_TEXTBTN,   RESIZE_NONE,    14,    34,   149,   101,   112, STR_LOAD_LAND_FROM_PNG,    STR_LOAD_LANDSCAPE_FROM_PNG},
 {   WIDGETS_END},
 };
 
@@ -1405,9 +1424,12 @@
 			AskResetLandscape(0);
 			break;
 		case 15: /* reset landscape */
-			HandleButtonClick(w,15);
+			HandleButtonClick(w, 15);
 			AskResetLandscape(1);
 			break;
+		case 16: /* landscape from png */
+			HandleButtonClick(w, 16);
+			AskResetLandscape(2);
 		}
 		break;
 
@@ -1436,7 +1458,7 @@
 }
 
 static const WindowDesc _scen_edit_land_gen_desc = {
-	-1,-1, 182, 102,
+	-1,-1, 182, 115,
 	WC_SCEN_LAND_GEN,0,
 	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_STICKY_BUTTON,
 	_scen_edit_land_gen_widgets,
@@ -1445,7 +1467,11 @@
 
 static inline void ShowEditorTerraformToolBar(void)
 {
-	AllocateWindowDescFront(&_scen_edit_land_gen_desc, 0);
+	Window * w;
+	w = AllocateWindowDescFront(&_scen_edit_land_gen_desc, 0);
+#ifndef WITH_PNG
+	SETBIT(w->disabled_state, 16);
+#endif
 }
 
 static void ToolbarScenGenLand(Window *w)
@@ -1898,10 +1924,10 @@
 		case WKC_F10:ShowOperatingProfitGraph(); break;
 		case WKC_F11: ShowCompanyLeagueTable(); break;
 		case WKC_F12: ShowBuildIndustryWindow(); break;
-		case WKC_SHIFT | WKC_F1: ShowPlayerTrains(local, -1); break;
-		case WKC_SHIFT | WKC_F2: ShowPlayerRoadVehicles(local, -1); break;
-		case WKC_SHIFT | WKC_F3: ShowPlayerShips(local, -1); break;
-		case WKC_SHIFT | WKC_F4: ShowPlayerAircraft(local, -1); break;
+		case WKC_SHIFT | WKC_F1: ShowPlayerTrains(local, INVALID_STATION); break;
+		case WKC_SHIFT | WKC_F2: ShowPlayerRoadVehicles(local, INVALID_STATION); break;
+		case WKC_SHIFT | WKC_F3: ShowPlayerShips(local, INVALID_STATION); break;
+		case WKC_SHIFT | WKC_F4: ShowPlayerAircraft(local, INVALID_STATION); break;
 		case WKC_SHIFT | WKC_F5: ToolbarZoomInClick(w); break;
 		case WKC_SHIFT | WKC_F6: ToolbarZoomOutClick(w); break;
 		case WKC_SHIFT | WKC_F7: ShowBuildRailToolbar(_last_built_railtype,-1); break;
@@ -2196,7 +2222,7 @@
 		}
 	}
 
-	if (!FillDrawPixelInfo(&tmp_dpi, NULL, 141, 1, 358, 11))
+	if (!FillDrawPixelInfo(&tmp_dpi, NULL, 141, 1, 338, 11))
 		return true;
 
 	old_dpi = _cur_dpi;
@@ -2224,6 +2250,11 @@
 			DrawStringCentered(570, 1, p->player_money >= 0 ? STR_0004 : STR_0005, 0);
 		}
 
+		if(p){ // draw player icon
+			DrawPlayerIcon(p->index, 482, 2);
+			DrawPlayerIcon(p->index, 496, 2);
+		}
+
 		// Draw status bar
 		if (w->message.msg) { // true when saving is active
 			DrawStringCentered(320, 1, STR_SAVING_GAME, 0);
@@ -2240,7 +2271,7 @@
 				// This is the default text
 				SetDParam(0, p->name_1);
 				SetDParam(1, p->name_2);
-				DrawStringCentered(320, 1,	STR_02BA, 0);
+				DrawStringCentered(310, 1,	STR_02BA, 0);
 			}
 		}
 
@@ -2253,11 +2284,24 @@
 		break;
 
 	case WE_CLICK:
-		switch (e->click.widget) {
-			case 1: ShowLastNewsMessage(); break;
-			case 2: if (_local_player != OWNER_SPECTATOR) ShowPlayerFinances(_local_player); break;
+		switch(e->click.widget){
+			case 1:	ShowLastNewsMessage(); break;
+			case 2: 
+				if (_local_player != OWNER_SPECTATOR)
+				{
+					if(!_patches.subsidiaries)
+						ShowPlayerCompany(_local_player);
+					else
+						ShowSubsidiariesManagement();
+				}
+				break;
+
+			case 3:
+				if (_local_player != OWNER_SPECTATOR) 
+					ShowPlayerFinances(_local_player);
+				break;
 			default: ResetObjectToPlace();
-		}
+			}
 		break;
 
 	case WE_TICK: {
@@ -2282,8 +2326,9 @@
 
 static const Widget _main_status_widgets[] = {
 {     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   139,     0,    11, 0x0,	STR_NULL},
-{ WWT_PUSHIMGBTN,   RESIZE_NONE,    14,   140,   499,     0,    11, 0x0, STR_02B7_SHOW_LAST_MESSAGE_OR_NEWS},
-{ WWT_PUSHIMGBTN,   RESIZE_NONE,    14,   500,   639,     0,    11, 0x0, STR_NULL},
+{ WWT_PUSHIMGBTN,   RESIZE_NONE,    14,   140,   479,     0,    11, 0x0, STR_02B7_SHOW_LAST_MESSAGE_OR_NEWS},
+{ WWT_PUSHIMGBTN,   RESIZE_NONE,	14,   480,   511,     0,    11, 0x0, STR_NULL},
+{ WWT_PUSHIMGBTN,   RESIZE_NONE,    14,   512,   639,     0,    11, 0x0, STR_NULL},
 {   WIDGETS_END},
 };
 
Index: roadveh_gui.c
===================================================================
--- roadveh_gui.c	(Revision 2953)
+++ roadveh_gui.c	(Arbeitskopie)
@@ -16,6 +16,8 @@
 #include "command.h"
 #include "player.h"
 #include "engine.h"
+#include "economy.h"
+#include "network.h"
 #include "depot.h"
 #include "vehicle_gui.h"
 
@@ -50,7 +52,7 @@
 	y += 10;
 
 	/* Design date - Life length */
-	SetDParam(0, ymd.year + 1920);
+	SetDParam(0, ymd.year);
 	SetDParam(1, e->lifelength);
 	DrawString(x, y, STR_PURCHASE_INFO_DESIGNED_LIFE, 0);
 	y += 10;
@@ -61,7 +63,7 @@
 	y += 10;
 }
 
-static void DrawRoadVehImage(const Vehicle *v, int x, int y, VehicleID selection)
+void DrawRoadVehImage(const Vehicle *v, int x, int y, VehicleID selection)
 {
 	int image = GetRoadVehImage(v, 6);
 	uint32 ormod = SPRITE_PALETTE(PLAYER_SPRITE_COLOR(v->owner));
@@ -131,7 +133,7 @@
 		DrawRoadVehImage(v, 3, 57, INVALID_VEHICLE);
 
 		SetDParam(0, GetCustomEngineName(v->engine_type));
-		SetDParam(1, 1920 + v->build_year);
+		SetDParam(1, v->build_year);
 		SetDParam(2, v->value);
 		DrawString(34, 57, STR_9011_BUILT_VALUE, 0);
 
@@ -240,7 +242,7 @@
 		Vehicle *v = GetVehicle(w->window_number);
 		StringID str;
 
-		w->disabled_state = (v->owner != _local_player) ? (1<<8 | 1<<7) : 0;
+		w->disabled_state = (!IsSisterCompany(v->owner,_local_player)) ? (1<<8 | 1<<7) : 0;
 
 		/* draw widgets & caption */
 		SetDParam(0, v->string_id);
@@ -557,8 +559,7 @@
 	tile = w->window_number;
 
 	/* setup disabled buttons */
-	w->disabled_state =
-		IsTileOwner(tile, _local_player) ? 0 : ((1<<4) | (1<<7) | (1<<8));
+	w->disabled_state = IsSisterCompany(GetTileOwner(tile), _local_player) ? 0 : ((1<<4) | (1<<7) | (1<<8));
 
 	/* determine amount of items for scroller */
 	num = 0;
@@ -776,6 +777,7 @@
 		case 4:
 			if (!HASBIT(w->disabled_state, 4) &&
 					WP(w,traindepot_d).sel != INVALID_VEHICLE)	{
+				byte backup = _current_player;
 				Vehicle *v;
 
 				HandleButtonClick(w, 4);
@@ -786,8 +788,10 @@
 				_backup_orders_tile = v->tile;
 				BackupVehicleOrders(v, _backup_orders_data);
 
+				_current_player = v->owner;
 				if (!DoCommandP(v->tile, v->index, 0, NULL, CMD_SELL_ROAD_VEH | CMD_MSG(STR_9014_CAN_T_SELL_ROAD_VEHICLE)))
 					_backup_orders_tile = 0;
+				_current_player = backup;
 			}
 			break;
 		default:
@@ -897,9 +901,19 @@
 		int max;
 		int i;
 
-		BuildVehicleList(vl, VEH_Road, owner, station);
+		BuildVehicleListMasked(vl, &w->listopt, owner);
 		SortVehicleList(vl);
 
+		if (_local_player != owner){
+			if(IsWindowOfPrototype(w,_player_roadveh_widgets)){
+				w->disabled_state |= (1<<10);
+			}else{
+				w->disabled_state |= (1<<9);
+			}
+		}else{
+			w->disabled_state &= ~(1<<9);
+		}
+
 		SetVScrollCount(w, vl->list_length);
 
 		// disable 'Sort By' tooltip on Unsorted sorting criteria
@@ -933,7 +947,7 @@
 			Vehicle *v = GetVehicle(vl->sort_list[i].index);
 			StringID str;
 
-			assert(v->type == VEH_Road && v->owner == owner);
+			assert(v->type == VEH_Road && (IsSisterCompany(v->owner, owner) || _patches.shared_stations));
 
 			DrawRoadVehImage(v, x + 22, y + 6, INVALID_VEHICLE);
 			DrawVehicleProfitButton(v, x, y + 13);
@@ -1078,17 +1092,23 @@
 	PlayerRoadVehWndProc
 };
 
-
 void ShowPlayerRoadVehicles(int player, int station)
 {
 	Window *w;
 
-	if ( player == _local_player) {
+	if (IsSisterCompany(player,_local_player)) {
 		w = AllocateWindowDescFront(&_player_roadveh_desc, (station << 16) | player);
 	} else  {
 		w = AllocateWindowDescFront(&_other_player_roadveh_desc, (station << 16) | player);
 	}
 	if (w) {
+		w->listopt.cargo_mask = CARGO_MASK_ALL;
+		w->listopt.type_mask = 1 << VEH_Road;
+		if (station != INVALID_STATION)
+			w->listopt.xy = GetStation(station)->xy;
+		else
+			w->listopt.xy = INVALID_TILE;
+
 		w->caption_color = player;
 		w->vscroll.cap = 7; // maximum number of vehicles shown
 		w->widget[7].unkA = (w->vscroll.cap << 8) + 1;
Index: Makefile
===================================================================
--- Makefile	(Revision 2953)
+++ Makefile	(Arbeitskopie)
@@ -331,19 +331,19 @@
 # these compilerflags makes the app run as fast as possible without making the app unstable. It works on G3 or newer
 BASECFLAGS += -O3 -funroll-loops -fsched-interblock -falign-loops=16 -falign-jumps=16 -falign-functions=16 -falign-jumps-max-skip=15 -falign-loops-max-skip=15 -mdynamic-no-pic -mpowerpc-gpopt -force_cpusubtype_ALL
 else
-ifdef MORPHOS
-BASECFLAGS += -I/gg/os-include -O2 -noixemul -fstrict-aliasing -fexpensive-optimizations
-BASECFLAGS += -mcpu=604 -fno-inline -mstring -mmultiple
-else
-BASECFLAGS += -O2
+	ifdef MORPHOS
+		BASECFLAGS += -I/gg/os-include -O2 -noixemul -fstrict-aliasing -fexpensive-optimizations
+		BASECFLAGS += -mcpu=604 -fno-inline -mstring -mmultiple
+	else
+		BASECFLAGS += -O2
+	endif
+	ifndef PROFILE
+		ifndef IRIX
+			BASECFLAGS += -fomit-frame-pointer
+		endif
+	endif
 endif
-ifndef PROFILE
-ifndef IRIX
-BASECFLAGS += -fomit-frame-pointer
 endif
-endif
-endif
-endif
 
 ifdef STATIC
 ifndef OSX	# OSX can't build static if -static flag is used
Index: pathfind.c
===================================================================
--- pathfind.c	(Revision 2953)
+++ pathfind.c	(Arbeitskopie)
@@ -10,6 +10,8 @@
 #include "debug.h"
 #include "variables.h"
 
+extern bool IsSisterCompany(byte c1, byte c2);
+
 // remember which tiles we have already visited so we don't visit them again.
 static bool TPFSetTileBit(TrackPathFinder *tpf, TileIndex tile, int dir)
 {
@@ -154,7 +156,7 @@
 		if (IsTileType(tile, MP_RAILWAY) || IsTileType(tile, MP_STATION) || IsTileType(tile, MP_TUNNELBRIDGE))
 			/* Check if we are on the middle of a bridge (has no owner) */
 			if (!IsTileType(tile, MP_TUNNELBRIDGE) || (_m[tile].m5 & 0xC0) != 0xC0)
-				if (owner != -1 && !IsTileOwner(tile, owner))
+				if (owner != -1 && !IsSisterCompany(GetTileOwner(tile),owner) && !_patches.shared_tracks)
 					return;
 	}
 
@@ -295,7 +297,7 @@
 				/* Check if we are on a bridge (middle parts don't have an owner */
 				if (!IsTileType(tile, MP_TUNNELBRIDGE) || (_m[tile].m5 & 0xC0) != 0xC0)
 					if (!IsTileType(tile_org, MP_TUNNELBRIDGE) || (_m[tile_org].m5 & 0xC0) != 0xC0)
-						if (GetTileOwner(tile_org) != GetTileOwner(tile))
+						if (!IsSisterCompany(GetTileOwner(tile_org), GetTileOwner(tile)) && !_patches.shared_tracks)
 							return;
 	}
 
Index: order_cmd.c
===================================================================
--- order_cmd.c	(Revision 2953)
+++ order_cmd.c	(Arbeitskopie)
@@ -12,6 +12,7 @@
 #include "station.h"
 #include "player.h"
 #include "news.h"
+#include "economy.h"
 #include "saveload.h"
 #include "vehicle_gui.h"
 
@@ -174,7 +175,7 @@
 			st = GetStation(new_order.station);
 
 			if (!IsValidStation(st) ||
-					(st->airport_type != AT_OILRIG && !(IsBuoy(st)) && !CheckOwnership(st->owner))) {
+					(st->airport_type != AT_OILRIG && !(IsBuoy(st)) && !CheckOwnership(st->owner)&& !_patches.shared_stations)) {
 				return CMD_ERROR;
 			}
 
@@ -206,9 +207,14 @@
 				case 0:
 				case OF_FULL_LOAD:
 				case OF_UNLOAD:
+				case OF_FULL_LOAD | OF_TRANSFER:
+				case OF_UNLOAD | OF_TRANSFER:
 				case OF_NON_STOP:
+				case OF_NON_STOP | OF_TRANSFER:
 				case OF_NON_STOP | OF_FULL_LOAD:
 				case OF_NON_STOP | OF_UNLOAD:
+				case OF_NON_STOP | OF_FULL_LOAD | OF_TRANSFER:
+				case OF_NON_STOP | OF_UNLOAD | OF_TRANSFER:
 					break;
 
 				default: return CMD_ERROR;
@@ -224,7 +230,7 @@
 				st = GetStation(new_order.station);
 
 				if (!IsValidStation(st) ||
-						(st->airport_type != AT_OILRIG && !CheckOwnership(st->owner)) ||
+						(st->airport_type != AT_OILRIG && !CheckOwnership(st->owner) && !_patches.shared_stations) ||
 						!(st->facilities & FACIL_AIRPORT) ||
 						GetAirport(st->airport_type)->nof_depots == 0) {
 					return CMD_ERROR;
@@ -236,7 +242,7 @@
 				dp = GetDepot(new_order.station);
 
 				if (!IsValidDepot(dp) ||
-						!CheckOwnership(GetTileOwner(dp->xy))) {
+						(!CheckOwnership(GetTileOwner(dp->xy)) && !_patches.shared_stations)) {
 					return CMD_ERROR;
 				}
 
@@ -277,7 +283,7 @@
 			if (!IsWaypointIndex(new_order.station)) return CMD_ERROR;
 			wp = GetWaypoint(new_order.station);
 
-			if (!CheckOwnership(GetTileOwner(wp->xy))) return CMD_ERROR;
+			if (!CheckOwnership(GetTileOwner(wp->xy)) && !_patches.shared_stations) return CMD_ERROR;
 
 			switch (new_order.flags) {
 				case 0:
@@ -351,6 +357,25 @@
 			/* Increase amount of orders */
 			u->num_orders++;
 
+			// count vehicles scheduled for station
+			if (new_order.type == OT_GOTO_WAYPOINT) {
+				GetWaypoint(new_order.station)->veh_scheduled++;
+			} else {
+				Station *st = GetStation(new_order.station);
+				switch (u->type)
+				{
+					case VEH_Train:		st->veh_scheduled[STS_VEH_TRAIN]++;	break;
+					case VEH_Ship:		st->veh_scheduled[STS_VEH_SHIP]++;	break;
+					case VEH_Aircraft:	st->veh_scheduled[STS_VEH_AIRCRAFT]++;	break;
+					case VEH_Road:		st->veh_scheduled[STS_VEH_ROAD]++;
+						if (u->cargo_type == CT_PASSENGERS)
+							st->veh_scheduled[STS_VEH_BUS]++;
+						else
+							st->veh_scheduled[STS_VEH_TRUCK]++;
+						break;
+				}
+			}
+
 			/* If the orderlist was empty, assign it */
 			if (u->orders == NULL) u->orders = v->orders;
 
@@ -432,12 +457,25 @@
 			GetVehicleOrder(v, sel_ord - 1)->next = order->next;
 		}
 
-		/* Give the item free */
-		order->type = OT_NOTHING;
-		order->next = NULL;
-
 		u = GetFirstVehicleFromSharedList(v);
 		while (u != NULL) {
+			if (order->type == OT_GOTO_WAYPOINT) {
+				GetWaypoint(order->station)->veh_scheduled--;
+			} else {
+				Station *st = GetStation(order->station);
+				switch (u->type)
+				{
+					case VEH_Train:		st->veh_scheduled[STS_VEH_TRAIN]--;	break;
+					case VEH_Ship:		st->veh_scheduled[STS_VEH_SHIP]--;	break;
+					case VEH_Aircraft:	st->veh_scheduled[STS_VEH_AIRCRAFT]--;	break;
+					case VEH_Road:		st->veh_scheduled[STS_VEH_ROAD]--;
+						if (u->cargo_type == CT_PASSENGERS)
+							st->veh_scheduled[STS_VEH_BUS]--;
+						else
+							st->veh_scheduled[STS_VEH_TRUCK]--;
+						break;
+				}
+			}
 			u->num_orders--;
 
 			if (sel_ord < u->cur_order_index)
@@ -462,6 +500,10 @@
 			u = u->next_shared;
 		}
 
+		/* Give the item free */
+		order->type = OT_NOTHING;
+		order->next = NULL;
+
 		RebuildVehicleLists();
 	}
 
@@ -604,7 +646,7 @@
 			src = GetVehicle(veh_src);
 
 			/* Sanity checks */
-			if (src->type == 0 || !CheckOwnership(src->owner) || dst->type != src->type || dst == src)
+			if (src->type == 0 || !(CheckOwnership(src->owner) || _patches.shared_stations) || dst->type != src->type || dst == src)
 				return CMD_ERROR;
 
 			/* Trucks can't share orders with busses (and visa versa) */
@@ -653,7 +695,7 @@
 			src = GetVehicle(veh_src);
 
 			/* Sanity checks */
-			if (src->type == 0 || !CheckOwnership(src->owner) || dst->type != src->type || dst == src)
+			if (src->type == 0 || !(CheckOwnership(src->owner) || _patches.shared_stations) || dst->type != src->type || dst == src)
 				return CMD_ERROR;
 
 			/* Trucks can't copy all the orders from busses (and visa versa) */
@@ -1036,6 +1078,24 @@
 
 	order = NULL;
 	while (cur != NULL) {
+		// decrease vehicles scheduled for station
+		if (cur->type == OT_GOTO_WAYPOINT) {
+			GetWaypoint(cur->station)->veh_scheduled--;
+		} else {
+			Station *st = GetStation(cur->station);
+			switch (v->type)
+			{
+				case VEH_Train:		st->veh_scheduled[STS_VEH_TRAIN]--;	break;
+				case VEH_Ship:		st->veh_scheduled[STS_VEH_SHIP]--;	break;
+				case VEH_Aircraft:	st->veh_scheduled[STS_VEH_AIRCRAFT]--;	break;
+				case VEH_Road:		st->veh_scheduled[STS_VEH_ROAD]--;
+					if (v->cargo_type == CT_PASSENGERS)
+						st->veh_scheduled[STS_VEH_BUS]--;
+					else
+						st->veh_scheduled[STS_VEH_TRUCK]--;
+					break;
+			}
+		}
 		if (order != NULL) {
 			order->type = OT_NOTHING;
 			order->next = NULL;
Index: openttd.vcproj
===================================================================
--- openttd.vcproj	(Revision 2953)
+++ openttd.vcproj	(Arbeitskopie)
@@ -3,6 +3,7 @@
 	ProjectType="Visual C++"
 	Version="7.10"
 	Name="openttd"
+	RootNamespace="openttd"
 	SccProjectName=""
 	SccLocalPath="">
 	<Platforms>
@@ -28,7 +29,8 @@
 				FavorSizeOrSpeed="2"
 				OmitFramePointers="TRUE"
 				OptimizeForProcessor="1"
-				PreprocessorDefinitions="WIN32;NDEBUG;_CONSOLE;WIN32_EXCEPTION_TRACKER;WIN32_ENABLE_DIRECTMUSIC_SUPPORT;WITH_ZLIB;WITH_PNG;ENABLE_NETWORK"
+				AdditionalIncludeDirectories="..\openttd_useful"
+				PreprocessorDefinitions="WIN32;NDEBUG;_CONSOLE;WIN32_EXCEPTION_TRACKER;WIN32_ENABLE_DIRECTMUSIC_SUPPORT;WITH_ZLIB;WITH_PNG;ENABLE_NETWORK;WITH_REV_HACK=\&quot;Subs_2865\&quot;"
 				StringPooling="TRUE"
 				ExceptionHandling="FALSE"
 				RuntimeLibrary="4"
@@ -58,6 +60,7 @@
 				OutputFile=".\Release/openttd.exe"
 				LinkIncremental="1"
 				SuppressStartupBanner="TRUE"
+				AdditionalLibraryDirectories="..\openttd_useful"
 				ProgramDatabaseFile=".\Release/openttd.pdb"
 				GenerateMapFile="TRUE"
 				MapFileName=".\Release/openttd.map"
@@ -101,7 +104,8 @@
 			<Tool
 				Name="VCCLCompilerTool"
 				Optimization="0"
-				PreprocessorDefinitions="WIN32;_DEBUG;_CONSOLE;WIN32_ENABLE_DIRECTMUSIC_SUPPORT;WITH_ZLIB;WITH_PNG;ENABLE_NETWORK"
+				AdditionalIncludeDirectories="..\openttd_useful"
+				PreprocessorDefinitions="WIN32;_DEBUG;_CONSOLE;WIN32_ENABLE_DIRECTMUSIC_SUPPORT;WITH_ZLIB;WITH_PNG;ENABLE_NETWORK;WITH_REV_HACK=\&quot;Subs_2865\&quot;"
 				BasicRuntimeChecks="3"
 				RuntimeLibrary="5"
 				UsePrecompiledHeader="2"
@@ -125,6 +129,7 @@
 				OutputFile=".\Debug/openttd.exe"
 				LinkIncremental="0"
 				SuppressStartupBanner="TRUE"
+				AdditionalLibraryDirectories="..\openttd_useful"
 				GenerateDebugInformation="TRUE"
 				ProgramDatabaseFile=".\Debug/openttd.pdb"
 				SubSystem="2"
@@ -154,6 +159,64 @@
 			<Tool
 				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
 		</Configuration>
+		<Configuration
+			Name="Quick Release|Win32"
+			OutputDirectory="$(ConfigurationName)"
+			IntermediateDirectory="$(ConfigurationName)"
+			ConfigurationType="1"
+			UseOfMFC="0"
+			ATLMinimizesCRunTimeLibraryUsage="FALSE"
+			CharacterSet="2"
+			WholeProgramOptimization="TRUE">
+			<Tool
+				Name="VCCLCompilerTool"
+				Optimization="0"
+				AdditionalIncludeDirectories="..\openttd_useful"
+				PreprocessorDefinitions="WIN32;NDEBUG;_CONSOLE;WIN32_EXCEPTION_TRACKER;WIN32_ENABLE_DIRECTMUSIC_SUPPORT;WITH_ZLIB;WITH_PNG;ENABLE_NETWORK;WITH_REV_HACK=\&quot;Subs_2865\&quot;"
+				ExceptionHandling="FALSE"
+				RuntimeLibrary="4"
+				StructMemberAlignment="3"
+				BufferSecurityCheck="FALSE"
+				DefaultCharIsUnsigned="TRUE"
+				WarningLevel="3"
+				WarnAsError="TRUE"
+				SuppressStartupBanner="TRUE"
+				CompileAs="1"/>
+			<Tool
+				Name="VCCustomBuildTool"/>
+			<Tool
+				Name="VCLinkerTool"
+				AdditionalDependencies="winmm.lib ws2_32.lib libpng.lib zlibstat.lib"
+				LinkIncremental="1"
+				SuppressStartupBanner="TRUE"
+				AdditionalLibraryDirectories="..\openttd_useful"
+				SubSystem="2"
+				OptimizeForWindows98="1"
+				TargetMachine="1"/>
+			<Tool
+				Name="VCMIDLTool"
+				TypeLibraryName=".\Release/openttd.tlb"
+				HeaderFileName=""/>
+			<Tool
+				Name="VCPostBuildEventTool"/>
+			<Tool
+				Name="VCPreBuildEventTool"/>
+			<Tool
+				Name="VCPreLinkEventTool"/>
+			<Tool
+				Name="VCResourceCompilerTool"
+				PreprocessorDefinitions="NDEBUG"/>
+			<Tool
+				Name="VCWebServiceProxyGeneratorTool"/>
+			<Tool
+				Name="VCXMLDataGeneratorTool"/>
+			<Tool
+				Name="VCWebDeploymentTool"/>
+			<Tool
+				Name="VCManagedWrapperGeneratorTool"/>
+			<Tool
+				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
+		</Configuration>
 	</Configurations>
 	<References>
 	</References>
@@ -241,6 +304,12 @@
 			</File>
 			<File
 				RelativePath=".\minilzo.c">
+				<FileConfiguration
+					Name="Quick Release|Win32">
+					<Tool
+						Name="VCCLCompilerTool"
+						UsePrecompiledHeader="0"/>
+				</FileConfiguration>
 			</File>
 			<File
 				RelativePath=".\misc.c">
@@ -376,6 +445,13 @@
 			</File>
 			<File
 				RelativePath=".\music\win32_m.c">
+				<FileConfiguration
+					Name="Quick Release|Win32">
+					<Tool
+						Name="VCCLCompilerTool"
+						UsePrecompiledHeader="0"
+						CompileAs="2"/>
+				</FileConfiguration>
 			</File>
 			<File
 				RelativePath=".\sound\win32_s.c">
Index: settings.c
===================================================================
--- settings.c	(Revision 2953)
+++ settings.c	(Arbeitskopie)
@@ -778,6 +778,7 @@
 	{"frame_freq",			SDT_UINT8 | SDT_NOSAVE,	(void*)0,			&_network_frame_freq,		NULL},
 	{"max_join_time",		SDT_UINT16,	(void*)500,	&_network_max_join_time,	NULL},
 	{"pause_on_join",		SDT_BOOL, (void*)false, &_network_pause_on_join, NULL},
+	{"pause_on_no_clients", SDT_BOOL, (void*)false, &_network_pause_on_no_clients, NULL},
 	{"server_bind_ip",	SDT_STRINGBUF | (lengthof(_network_server_bind_ip_host) << 16),	"0.0.0.0",	&_network_server_bind_ip_host,	NULL},
 	{"server_port",			SDT_UINT,	(void*)NETWORK_DEFAULT_PORT,	&_network_server_port,	NULL},
 	{"server_advertise",SDT_BOOL, (void*)false, &_network_advertise, NULL},
@@ -849,11 +850,14 @@
 	{"window_snap_radius",  SDT_UINT8,  (void*)10,    &_patches.window_snap_radius,   NULL},
 
 	{"autorenew",						SDT_BOOL,		(void*)false,	&_patches.autorenew,						NULL},
-	{"autorenew_months",		SDT_INT16,	(void*)-6,		&_patches.autorenew_months,			NULL},
+	{"autorenew_months",		SDT_INT32,	(void*)-6,		&_patches.autorenew_months,			NULL},
 	{"autorenew_money",			SDT_INT32,	(void*)100000,&_patches.autorenew_money,			NULL},
 
 	{"population_in_label",	SDT_BOOL,		(void*)true,	&_patches.population_in_label,	NULL},
+	{"show_town_rating_value",	SDT_BOOL,		(void*)false,	&_patches.show_town_rating_value,	NULL},
 
+	{"day_length",			SDT_UINT8,	(void*)1,	&_patches.day_length, NULL},
+
 	{NULL,									0,					NULL,					NULL,																						NULL}
 };
 
@@ -867,6 +871,11 @@
 	{"full_load_any",				SDT_BOOL,		(void*)true,	&_patches.full_load_any,				NULL},
 	{"modified_catchment", 	SDT_BOOL,		(void*)true,	&_patches.modified_catchment,		NULL},
 
+	{"nsr_speed",	SDT_BOOL,	(void*)true,	&_patches.nsr_speed,	NULL},
+	{"nsr_age",	SDT_BOOL,	(void*)true,	&_patches.nsr_age,	NULL},
+	{"nsr_wait_days",	SDT_BOOL,	(void*)true,	&_patches.nsr_wait_days,	NULL},
+	{"nsr_wait_cargo",	SDT_BOOL,	(void*)true,	&_patches.nsr_wait_cargo,	NULL},
+	{"nsr_town_rating",	SDT_BOOL,	(void*)true,	&_patches.nsr_town_rating,	NULL},
 
 	{"inflation",						SDT_BOOL,		(void*)true,	&_patches.inflation,						NULL},
 	{"selectgoods",					SDT_BOOL,		(void*)true,	&_patches.selectgoods,					NULL},
@@ -917,6 +926,23 @@
 
 	{"colored_news_date",		SDT_UINT32, (void*)2000,	&_patches.colored_news_date,		NULL},
 
+	{"smooth_economy",			SDT_BOOL,		(void*)false, &_patches.smooth_economy,				NULL},
+	
+	{"subsidiaries",				           SDT_BOOL,  (void*)true,  &_patches.subsidiaries,					                NULL},
+	{"allow_track_removal",	           SDT_BOOL,  (void*)true,  &_patches.allow_track_removal,	                NULL},
+	{"shared_stations_tax",            SDT_UINT8, (void*)10,		&_patches.shared_stations_tax,	                NULL},
+	{"shared_tracks_sub_tax",          SDT_INT32, (void*)6,			&_patches.shared_tracks_tax_subsidiary,	        NULL},
+	{"shared_tracks",				           SDT_BOOL,  (void*)false,	&_patches.shared_tracks,				                NULL},
+	{"shared_tracks_other_tax",        SDT_INT32, (void*)12,	  &_patches.shared_tracks_tax_others,	            NULL},
+
+	{"shared_stations_subs_cargotax",  SDT_INT32, (void*)20,    &_patches.shared_stations_pickuptax_subsidiary, NULL},
+	{"shared_stations",			           SDT_BOOL,  (void*)false, &_patches.shared_stations,			                NULL},
+	{"shared_stations_tax_others",     SDT_UINT8, (void*)20,    &_patches.shared_stations_tax_others,           NULL},
+	{"shared_stations_other_cargotax", SDT_INT32, (void*)40,    &_patches.shared_stations_pickuptax_others,     NULL},
+	{"years_of_protection",            SDT_UINT8,	(void*)0,			&_patches.years_of_protection,	                NULL},
+	{"shared_depots",			           SDT_BOOL,  (void*)false, &_patches.shared_depots,			                NULL},
+
+	{"dist_local_authority",SDT_UINT8,	(void*)20,		&_patches.dist_local_authority, NULL},
 	{"extra_dynamite",			SDT_BOOL,		(void*)false, &_patches.extra_dynamite,				NULL},
 
 	{"never_expire_vehicles",SDT_BOOL,	(void*)false, &_patches.never_expire_vehicles,NULL},
@@ -991,8 +1017,10 @@
 	{"npf_water_curve_penalty",     SDT_UINT32, (void*)(NPF_TILE_LENGTH / 4),   &_patches.npf_water_curve_penalty,      NULL},
 	/* This is the penalty for road, same as for rail. */
 	{"npf_road_curve_penalty",      SDT_UINT32, (void*)(1),                     &_patches.npf_road_curve_penalty,       NULL},
-	/* This is the penalty for level crossings, for both road and rail vehicles */
+	/* This is the penalty for level crossings, for road vehicles */
  	{"npf_crossing_penalty",        SDT_UINT32, (void*)(3 * NPF_TILE_LENGTH),   &_patches.npf_crossing_penalty,         NULL},
+	/* Penalty for busy roads */
+	{"npf_busy_road_penalty",       SDT_UINT32, (void*)(NPF_TILE_LENGTH),       &_patches.npf_busy_road_penalty,        NULL},
 
 	{NULL,                          0,          NULL,                           NULL,                                   NULL}
 };
Index: disaster_cmd.c
===================================================================
--- disaster_cmd.c	(Revision 2953)
+++ disaster_cmd.c	(Arbeitskopie)
@@ -945,10 +945,10 @@
 };
 
 typedef struct {
-	byte min,max;
+	uint32 min,max;
 } DisasterYears;
 
-#define MK(a,b) {a-20,b-20}
+#define MK(a,b) {a+1900,b+1900}
 static const DisasterYears _dis_years[8] = {
 	MK(30,55),
 	MK(40,70),
@@ -964,7 +964,7 @@
 static void DoDisaster(void)
 {
 	byte buf[8];
-	byte year = _cur_year;
+	uint32 year = _cur_year;
 	int i,j;
 
 	for(i=j=0; i!=lengthof(_dis_years); i++) {
Index: waypoint.c
===================================================================
--- waypoint.c	(Revision 2953)
+++ waypoint.c	(Arbeitskopie)
@@ -16,6 +16,7 @@
 #include "variables.h"
 #include "table/sprites.h"
 #include "table/strings.h"
+#include "gui.h"
 
 enum {
 	/* Max waypoints: 64000 (8 * 8000) */
@@ -45,7 +46,7 @@
 	Waypoint *wp;
 
 	FOR_ALL_WAYPOINTS(wp) {
-		if (wp->xy == 0) {
+		if (wp->xy == INVALID_TILE || wp->xy == 0) {
 			uint index = wp->index;
 
 			memset(wp, 0, sizeof(Waypoint));
@@ -138,7 +139,7 @@
 	uint thres = 8, cur_dist;
 
 	FOR_ALL_WAYPOINTS(wp) {
-		if (wp->deleted && wp->xy) {
+		if (wp->deleted > 0 && wp->xy != INVALID_TILE) {
 			cur_dist = DistanceManhattan(tile, wp->xy);
 			if (cur_dist < thres) {
 				thres = cur_dist;
@@ -207,6 +208,7 @@
 		wp->deleted = 0;
 		wp->xy = tile;
 		wp->build_date = _date;
+		InitializeWaypointStats(wp);
 
 		if (wp->town_index == STR_NULL)
 			MakeDefaultWaypointName(wp);
@@ -223,7 +225,7 @@
 {
 	Order order;
 
-	wp->xy = 0;
+	wp->xy = INVALID_TILE;
 
 	order.type = OT_GOTO_WAYPOINT;
 	order.station = wp->index;
@@ -407,7 +409,7 @@
 
 	/* Convert the old 'town_or_string', to 'string' / 'town' / 'town_cn' */
 	FOR_ALL_WAYPOINTS(wp) {
-		if (wp->xy == 0)
+		if (wp->xy == INVALID_TILE)
 			continue;
 
 		wp->town_index = ClosestTownFromTile(wp->xy, (uint)-1)->index;
@@ -433,21 +435,40 @@
 	SLE_VAR(Waypoint, string, SLE_UINT16),
 	SLE_VAR(Waypoint, deleted, SLE_UINT8),
 
-	SLE_CONDVAR(Waypoint, build_date, SLE_UINT16, 3, 255),
+	SLE_CONDVAR(Waypoint, build_date, SLE_FILE_U16 | SLE_VAR_U32, 3, 15),
+	SLE_CONDVAR(Waypoint, build_date, SLE_UINT32, 16, 255),
 	SLE_CONDVAR(Waypoint, stat_id, SLE_UINT8, 3, 255),
 
+//	save waypoint stats... change xx to savegame-revision
+//	SLE_CONDVAR(Waypoint,months_counted,	SLE_UINT16, xx, 255),
+
 	SLE_END()
 };
 
+//	save waypoint stats... change xx to savegame-revision
+//static const SaveLoad _stats_desc[] = {
+//	SLE_CONDVAR(StationStats,this_month,	SLE_UINT16, xx, 255),
+//	SLE_CONDVAR(StationStats,last_month,	SLE_UINT16, xx, 255),
+//	SLE_CONDVAR(StationStats,month_min,	SLE_UINT16, xx, 255),
+//	SLE_CONDVAR(StationStats,month_max,	SLE_UINT16, xx, 255),
+//	SLE_CONDVAR(StationStats,average,	SLE_UINT32, xx, 255),
+//	SLE_END()
+//};
+
 static void Save_WAYP(void)
 {
 	Waypoint *wp;
+//	int i;
 
 	FOR_ALL_WAYPOINTS(wp) {
 		if (wp->xy != 0) {
 			SlSetArrayIndex(wp->index);
 			SlObject(wp, _waypoint_desc);
 		}
+// save waypoint stats
+//		for (i = 0; i < STS_VEH_TYPES; i++) 
+//			SlObject(&wp->vehicles[i], _stats_desc);
+
 	}
 }
 
@@ -463,9 +484,227 @@
 
 		wp = GetWaypoint(index);
 		SlObject(wp, _waypoint_desc);
+		InitializeWaypointStats(wp);
 	}
 }
 
 const ChunkHandler _waypoint_chunk_handlers[] = {
 	{ 'CHKP', Save_WAYP, Load_WAYP, CH_ARRAY | CH_LAST},
 };
+
+void WaypointMonthlyLoop(void)
+{
+	Waypoint *wp;
+	StationStats *sts;
+	int i;
+
+ 	FOR_ALL_WAYPOINTS(wp) {
+		if (wp->months_counted != STS_NO_MONTHS_COUNTED)
+		{
+			// update vehicle-counts and min/max
+			for (i = WPS_MONTHLY_STATS_START; i < WPS_MONTHLY_STATS_END; i++) {
+				sts = &wp->vehicles[i];
+				sts->month_min = min(sts->month_min, sts->this_month);
+				sts->month_max = max(sts->month_max, sts->this_month);
+				sts->average = CalcNewAverage(sts->average, sts->this_month * AVERAGE_MULTIPLIER, wp->months_counted);
+				sts->last_month = sts->this_month;
+				sts->this_month = 0;
+			}
+			if (wp->months_counted == (wp->months_counted / 12) * 12)
+			{ // do this once a year to have yearly stats
+				for (i = WPS_YEARLY_STATS_START; i < WPS_YEARLY_STATS_END; i++) {
+					sts = &wp->vehicles[i];
+					sts->month_min = min(sts->month_min, sts->this_month);
+					sts->month_max = max(sts->month_max, sts->this_month);
+					sts->average = CalcNewAverage(sts->average, sts->this_month * AVERAGE_MULTIPLIER, wp->months_counted / 12);
+					sts->last_month = sts->this_month;
+					sts->this_month = 0;
+				}
+			}
+			wp->months_counted++; // one more month counted
+		}
+		InvalidateWindow(WC_STATION_STATS, wp->index);
+	}
+}
+
+void SearchVehiclesForWaypoint(Waypoint *wp)
+{
+	Vehicle *v;
+	Order* ord = NULL;
+
+	if (wp->xy == INVALID_TILE || wp->xy == 0) return;
+	wp->veh_scheduled = 0;
+	
+	FOR_ALL_VEHICLES(v) {
+		//Now run this stuff for sane vehicles only
+		if ( (v->num_orders != 0) && (v->owner == GetTileOwner(wp->xy)) &&
+			( (v->type == VEH_Train) && (v->subtype == TS_Front_Engine) ) ) //Trains (first engine, that contains the orders)
+		{
+			ord = v->orders;
+			while(ord != NULL) {
+				if (ord->station == wp->index && ord->type == OT_GOTO_WAYPOINT) {
+					wp->veh_scheduled++;
+					break;
+				}
+				ord = ord->next;
+			}
+		}
+	} 
+}
+
+void InitializeWaypointStats(Waypoint *wp)
+{
+	StationStats *sts;
+
+	wp->months_counted = STS_NO_MONTHS_COUNTED;
+	for (sts = wp->vehicles; sts != endof(wp->vehicles); sts++) {
+		sts->last_month = 0;
+		sts->this_month = 0;
+		sts->month_min = STS_INIT_MINIMUM;
+		sts->month_max = 0;
+		sts->average = 0;
+	}
+	SearchVehiclesForWaypoint(wp);
+}
+
+void WaypointStatsWndProc(Window *w, WindowEvent *e);
+
+Widget _waypoint_stats_widgets[] = {
+{    WWT_TEXTBTN,   RESIZE_NONE,    14,     0,    10,     0,    13, STR_00C5, STR_018B_CLOSE_WINDOW},
+{    WWT_CAPTION,   RESIZE_NONE,    14,    11,   288,     0,    13, STR_WAYPOINT_VIEWPORT, STR_018C_WINDOW_TITLE_DRAG_THIS},
+{  WWT_STICKYBOX,   RESIZE_NONE,    14,   289,   300,     0,    13, 0x0,         STR_STICKY_BUTTON},
+{      WWT_EMPTY,   RESIZE_NONE,     0,     0,     0,     0,     0, 0x0, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,   150,    14,    25, STR_RESET_STATISTICS, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,   151,   300,    14,    25, STR_TRAINS, 0x0},
+{ WWT_PUSHTXTBTN,   RESIZE_NONE,    14,     0,   300,    26,    37, STR_STS_TOGGLE_MONTH_YEAR, 0x0},
+{     WWT_IMGBTN,   RESIZE_NONE,    14,     0,   300,    38,   140, 0x0, 0x0},
+{      WIDGETS_END},
+};
+
+WindowDesc _waypoint_view_stats = {
+	-1, -1, 301, 141,
+	WC_WAYPOINT_STATS, 0,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET | WDF_UNCLICK_BUTTONS | WDF_STICKY_BUTTON,
+	_waypoint_stats_widgets,
+	WaypointStatsWndProc
+};
+
+void DrawWaypointStatWindow(Window *w, Waypoint *wp)
+{
+	int i, j;
+	enum {
+		STAT_LINE_START = 40,
+		STAT_LINE_PREVIOUS = 60,
+		STAT_LINE_THIS = 72,
+		STAT_LINE_AVERAGE = 90,
+		STAT_LINE_MIN = 102,
+		STAT_LINE_MAX = 114,
+		STAT_LINE_COUNTED = 130,
+		STAT_COLUMN_TEXT = 10,
+		STAT_COLUMN_SCHEDULED = 170,
+		STAT_COLUMN_NOT_SCHEDULED = 290,
+		COL_DIF = STAT_COLUMN_NOT_SCHEDULED - STAT_COLUMN_SCHEDULED,
+	};
+
+	//Get the Station name
+	SetDParam(0, wp->index);
+	//First draw the widgets
+	DrawWindowWidgets(w);
+
+	DrawString(STAT_COLUMN_TEXT, STAT_LINE_START,	STR_SCHEDULED, 0);
+	if (w->listopt.type_mask == STS_SHOW_YEARLY_STATS) {
+		DrawString(STAT_COLUMN_TEXT, STAT_LINE_PREVIOUS,	STR_STS_VEHICLES_LAST_YEAR, 0);
+		DrawString(STAT_COLUMN_TEXT, STAT_LINE_THIS,	STR_STS_VEHICLES_THIS_YEAR, 0);
+		SetDParam(0, max((wp->months_counted - 1) / 12 ,0));
+		DrawString(STAT_COLUMN_TEXT, STAT_LINE_COUNTED,	STR_STS_YEARS_COUNTED_NUM, 0);
+	} else {
+		DrawString(STAT_COLUMN_TEXT, STAT_LINE_PREVIOUS,	STR_VEHICLES_MONTH, 0);
+		DrawString(STAT_COLUMN_TEXT, STAT_LINE_THIS,	STR_VEHICLES_CURRENT, 0);
+		SetDParam(0, max(wp->months_counted - 1,0));
+		DrawString(STAT_COLUMN_TEXT, STAT_LINE_COUNTED,	STR_MONTHS_COUNTED_NUM, 0);
+	}
+	DrawString(STAT_COLUMN_TEXT, STAT_LINE_AVERAGE,	STR_AVERAGE, 0);
+	DrawString(STAT_COLUMN_TEXT, STAT_LINE_MIN,	STR_MINIMUM, 0);
+	DrawString(STAT_COLUMN_TEXT, STAT_LINE_MAX,	STR_MAXIMUM, 0);
+
+	SetDParam(0, wp->veh_scheduled);
+	DrawStringRightAligned(STAT_COLUMN_SCHEDULED, STAT_LINE_START, STR_NUMBER, 0);
+	DrawStringRightAligned(STAT_COLUMN_NOT_SCHEDULED, STAT_LINE_START, STR_STS_NOT_SCHEDULED, 0);
+	if (wp->veh_scheduled != 0) {
+		CLRBIT(w->disabled_state, 5);
+	} else {
+		SETBIT(w->disabled_state, 5);
+	}
+
+	j = (w->listopt.type_mask == STS_SHOW_YEARLY_STATS) ? WPS_YEARLY_STATS_START : WPS_MONTHLY_STATS_START;
+	for (i = 0; i < WPS_STATS_TYPES / 2; i++)
+	{
+		SetDParam(0, wp->vehicles[i+j].last_month);
+		DrawStringRightAligned(STAT_COLUMN_SCHEDULED + i * COL_DIF, STAT_LINE_PREVIOUS, STR_NUMBER, 0);
+		SetDParam(0, wp->vehicles[i+j].this_month);
+		DrawStringRightAligned(STAT_COLUMN_SCHEDULED + i * COL_DIF, STAT_LINE_THIS, STR_WHITE_NUMBER, 0);
+
+		if (wp->months_counted > ((w->listopt.type_mask == STS_SHOW_YEARLY_STATS) ? 12 : 1)) {
+			SetDParam(0, wp->vehicles[i+j].average / AVERAGE_MULTIPLIER);
+			DrawStringRightAligned(STAT_COLUMN_SCHEDULED + i * COL_DIF, STAT_LINE_AVERAGE, STR_SILVER_NUMBER, 0);
+			SetDParam(0, wp->vehicles[i+j].month_min);
+			DrawStringRightAligned(STAT_COLUMN_SCHEDULED + i * COL_DIF, STAT_LINE_MIN, STR_ORANGE_NUMBER, 0);
+			SetDParam(0, wp->vehicles[i+j].month_max);
+			DrawStringRightAligned(STAT_COLUMN_SCHEDULED + i * COL_DIF, STAT_LINE_MAX, STR_LTBLUE_NUMBER, 0);
+		}
+	}
+}
+
+void WaypointStatsWndProc(Window *w, WindowEvent *e)
+{
+	Waypoint *wp = GetWaypoint(w->window_number);
+	switch(e->event)
+	{
+		case WE_TICK: {
+			w->custom[0] = wp->veh_scheduled;
+			InvalidateWindow(WC_WAYPOINT_STATS, w->window_number);
+			break;
+		}
+		case WE_PAINT: {
+			DrawWaypointStatWindow(w, wp);
+			break;
+			}
+		case WE_CLICK: {
+			switch (e->click.widget)
+			{
+			case 4:	// Reset Statistics
+				if (GetTileOwner(wp->xy) == _current_player) {
+					InitializeWaypointStats(wp);
+					InvalidateWindow(WC_WAYPOINT_STATS, w->window_number);
+				}
+				break;
+			case 5:	// Show Trains
+				ShowWaypointTrains(GetTileOwner(wp->xy), wp->index);
+				break;
+			case 6:	// Toggle Monthly/Yearly Stats
+				if (w->listopt.type_mask == STS_SHOW_YEARLY_STATS)
+					w->listopt.type_mask = STS_SHOW_MONTHLY_STATS;
+				else
+					w->listopt.type_mask = STS_SHOW_YEARLY_STATS;
+				InvalidateWindow(WC_WAYPOINT_STATS, w->window_number);
+				break;
+			}
+		} break;
+		case WE_DESTROY: {
+			DeleteWindowById(WC_TRAINS_LIST, GetTileOwner(wp->xy) + ( (wp->index + 1) << 8));
+		} break;
+	}
+}
+
+void ShowWaypointStatsWindow(Waypoint *wp)
+{
+	Window *w;
+	byte color;
+
+	w = AllocateWindowDescFront(&_waypoint_view_stats, wp->index);
+	if (w) {
+		color = GetTileOwner(wp->xy);
+		w->listopt.type_mask = STS_SHOW_MONTHLY_STATS;
+		if (color != OWNER_NONE) w->caption_color = color;
+	}
+}
Index: waypoint.h
===================================================================
--- waypoint.h	(Revision 2953)
+++ waypoint.h	(Arbeitskopie)
@@ -4,7 +4,23 @@
 #define WAYPOINT_H
 
 #include "pool.h"
+#include "station.h"
 
+enum {
+	WPS_STATS_TYPES = 4,
+
+	WPS_MONTHLY_STATS_START = 0,
+	WPS_MONTHLY_STATS_END = 2,
+
+	WPS_YEARLY_STATS_START = 2,
+	WPS_YEARLY_STATS_END = 4,
+
+	WPS_ORDER_MONTH = 0, // reached WP by order
+	WPS_PATHFIND_MONTH = 1, // reached WP by normal pathfinding
+	WPS_ORDER_YEAR = 2, // yearly stats by order
+	WPS_PATHFIND_YEAR =3 , // yearly stats by pathfinding
+};
+
 struct Waypoint {
 	TileIndex xy;
 	uint16 index;
@@ -13,12 +29,20 @@
 	byte town_cn;          // The Nth waypoint for this town (consecutive number)
 	StringID string;       // If this is zero, town + town_cn is used for naming
 
+	StationStats vehicles[WPS_STATS_TYPES];
+	uint16 veh_scheduled;
+	uint16 months_counted;
+
 	ViewportSign sign;
-	uint16 build_date;
+	uint32 build_date;
 	byte stat_id;
 	byte deleted;          // this is a delete counter. when it reaches 0, the waypoint struct is deleted.
 };
 
+void InitializeWaypointStats(Waypoint *wp);
+void ShowWaypointStatsWindow(Waypoint *wp);
+void ShowWaypointTrains(int player, int waypoint);
+
 enum {
 	RAIL_TYPE_WAYPOINT = 0xC4,
 	RAIL_WAYPOINT_TRACK_MASK = 1,
Index: train_gui.c
===================================================================
--- train_gui.c	(Revision 2953)
+++ train_gui.c	(Arbeitskopie)
@@ -16,8 +16,11 @@
 #include "command.h"
 #include "player.h"
 #include "engine.h"
+#include "economy.h"
+#include "network.h"
 #include "vehicle_gui.h"
 #include "depot.h"
+#include "waypoint.h"
 
 int _traininfo_vehicle_pitch = 0;
 
@@ -71,7 +74,7 @@
 	y += 10;
 
 	/* Design date - Life length */
-	SetDParam(0, ymd.year + 1920);
+	SetDParam(0, ymd.year);
 	SetDParam(1, e->lifelength);
 	DrawString(x,y, STR_PURCHASE_INFO_DESIGNED_LIFE, 0);
 	y += 10;
@@ -341,7 +344,7 @@
 	}
 }
 
-static void DrawTrainImage(const Vehicle *v, int x, int y, int count, int skip, VehicleID selection)
+void DrawTrainImage(const Vehicle *v, int x, int y, int count, int skip, VehicleID selection)
 {
 	int max_x = x + count * 29;
 
@@ -376,8 +379,7 @@
 	tile = w->window_number;
 
 	/* setup disabled buttons */
-	w->disabled_state =
-		IsTileOwner(tile, _local_player) ? 0 : ((1 << 4) | (1 << 5) | (1 << 8) | (1<<9));
+	w->disabled_state = IsSisterCompany(GetTileOwner(tile),_local_player) ? 0 : ((1 << 4) | (1 << 5) | (1 << 8) | (1<<9));
 
 	/* determine amount of items for scroller */
 	num = 0;
@@ -712,14 +714,18 @@
 			HandleButtonClick(w, e->click.widget);
 
 			sell_cmd = (e->click.widget == 5 || _ctrl_pressed) ? 1 : 0;
-
-			if (v->subtype != TS_Front_Engine) {
-				DoCommandP(v->tile, v->index, sell_cmd, NULL, CMD_SELL_RAIL_WAGON | CMD_MSG(STR_8839_CAN_T_SELL_RAILROAD_VEHICLE));
-			} else {
-				_backup_orders_tile = v->tile;
-				BackupVehicleOrders(v, _backup_orders_data);
-				if (!DoCommandP(v->tile, v->index, sell_cmd, NULL, CMD_SELL_RAIL_WAGON | CMD_MSG(STR_8839_CAN_T_SELL_RAILROAD_VEHICLE)))
-					_backup_orders_tile = 0;
+			{
+				byte backup = _current_player;
+				_current_player = v->owner;
+				if (v->subtype != TS_Front_Engine) {
+					DoCommandP(v->tile, v->index, sell_cmd, NULL, CMD_SELL_RAIL_WAGON | CMD_MSG(STR_8839_CAN_T_SELL_RAILROAD_VEHICLE));
+				} else {
+					_backup_orders_tile = v->tile;
+					BackupVehicleOrders(v, _backup_orders_data);
+					if (!DoCommandP(v->tile, v->index, sell_cmd, NULL, CMD_SELL_RAIL_WAGON | CMD_MSG(STR_8839_CAN_T_SELL_RAILROAD_VEHICLE)))
+						_backup_orders_tile = 0;
+				}
+				_current_player = backup;
 			}
 		}	break;
 
@@ -908,7 +914,7 @@
 
 		v = GetVehicle(w->window_number);
 
-		w->disabled_state = (v->owner == _local_player) ? 0 : 0x380;
+		w->disabled_state = (IsSisterCompany(v->owner, _local_player)) ? 0 : 0x380;
 
 		SETBIT(w->disabled_state, 12);
 
@@ -1090,7 +1096,7 @@
 
 	if (!(rvi->flags & RVI_WAGON)) {
 		SetDParam(0, GetCustomEngineName(v->engine_type));
-		SetDParam(1, v->build_year + 1920);
+		SetDParam(1, v->build_year);
 		SetDParam(2, v->value);
 		DrawString(x, y, STR_882C_BUILT_VALUE, 0x10);
 	} else {
@@ -1155,7 +1161,7 @@
 	SetVScrollCount(w, num);
 
 	w->disabled_state = 1 << (det_tab + 9);
-	if (v->owner != _local_player)
+	if (!IsSisterCompany(v->owner,_local_player))
 		w->disabled_state |= (1 << 2);
 
 	if (!_patches.servint_trains) // disable service-scroller when interval is set to disabled
@@ -1374,9 +1380,19 @@
 		int max;
 		int i;
 
-		BuildVehicleList(vl, VEH_Train, owner, station);
+		BuildVehicleListMasked(vl, &w->listopt, owner);
 		SortVehicleList(vl);
 
+		if (_local_player != owner){
+			if(IsWindowOfPrototype(w,_player_trains_widgets)){
+				w->disabled_state |= (1<<10);
+			}else{
+				w->disabled_state |= (1<<9);
+			}
+		}else{
+			w->disabled_state &= ~(1<<9);
+		}
+
 		SetVScrollCount(w, vl->list_length);
 
 		// disable 'Sort By' tooltip on Unsorted sorting criteria
@@ -1410,7 +1426,7 @@
 			Vehicle *v = GetVehicle(vl->sort_list[i].index);
 			StringID str;
 
-			assert(v->type == VEH_Train && v->owner == owner);
+			assert(v->type == VEH_Train && (IsSisterCompany(v->owner, owner) || _patches.shared_stations));
 
 			DrawTrainImage(
 				v, x + 21, y + 6 + _traininfo_vehicle_pitch, w->hscroll.cap, 0, INVALID_VEHICLE);
@@ -1464,7 +1480,7 @@
 
 				v = GetVehicle(vl->sort_list[id_v].index);
 
-				assert(v->type == VEH_Train && v->subtype == TS_Front_Engine && v->owner == owner);
+				assert(v->type == VEH_Train && v->subtype == TS_Front_Engine && IsSisterCompany(v->owner, owner));
 
 				ShowTrainViewWindow(v);
 			}
@@ -1564,12 +1580,19 @@
 {
 	Window *w;
 
-	if (player == _local_player) {
+	if (IsSisterCompany(player,_local_player)) {
 		w = AllocateWindowDescFront(&_player_trains_desc, (station << 16) | player);
 	} else {
 		w = AllocateWindowDescFront(&_other_player_trains_desc, (station << 16) | player);
 	}
 	if (w) {
+		w->listopt.cargo_mask = CARGO_MASK_ALL;
+		w->listopt.type_mask = 1 << VEH_Train;
+		if (station != INVALID_STATION)
+			w->listopt.xy = GetStation(station)->xy;
+		else
+			w->listopt.xy = INVALID_TILE;
+
 		w->caption_color = player;
 		w->hscroll.cap = 10;
 		w->vscroll.cap = 7; // maximum number of vehicles shown
@@ -1579,3 +1602,27 @@
 		w->resize.height = 220 - (PLY_WND_PRC__SIZE_OF_ROW_SMALL * 3); /* Minimum of 4 vehicles */
 	}
 }
+
+void ShowWaypointTrains(int player, int waypoint)
+{
+	Window *w;
+
+	if (player == _local_player) {
+		w = AllocateWindowDescFront(&_player_trains_desc, (waypoint << 16) | player);
+	} else {
+		w = AllocateWindowDescFront(&_other_player_trains_desc, (waypoint << 16) | player);
+	}
+	if (w) {
+		w->listopt.cargo_mask = CARGO_MASK_ALL;
+		w->listopt.type_mask = 1 << VEH_Train;
+		w->listopt.xy = GetWaypoint(waypoint)->xy;
+
+		w->caption_color = player;
+		w->hscroll.cap = 10;
+		w->vscroll.cap = 7; // maximum number of vehicles shown
+		w->widget[7].unkA = (w->vscroll.cap << 8) + 1;
+		w->resize.step_height = PLY_WND_PRC__SIZE_OF_ROW_SMALL;
+		w->resize.step_width = 29;
+		w->resize.height = 220 - (PLY_WND_PRC__SIZE_OF_ROW_SMALL * 3); /* Minimum of 4 vehicles */
+	}
+}
Index: news.h
===================================================================
--- news.h	(Revision 2953)
+++ news.h	(Arbeitskopie)
@@ -6,7 +6,7 @@
 struct NewsItem {
 	StringID string_id;
 	uint16 duration;
-	uint16 date;
+	uint32 date;
 	byte flags;
 	byte display_mode;
 	byte type;
Index: station.h
===================================================================
--- station.h	(Revision 2953)
+++ station.h	(Arbeitskopie)
@@ -9,6 +9,110 @@
 #include "tile.h"
 #include "vehicle.h"
 
+enum {
+	RP_NUM_TYPES = 4,
+};
+
+enum {
+	RP_T_SPEED_CAP = 300,
+	RP_T_SPEED_PASS_BONUS = -85,
+	RP_T_SPEED_CARGO_BONUS = -60,
+	RP_SPEED_MULT = 2,
+	RP_R_SPEED_PASS_BONUS = -20,
+	RP_R_SPEED_CARGO_BONUS = 5,
+	RP_S_SPEED_MULT = 2,
+	RP_MAX_SPEED_POINTS = 170,
+
+	RP_AGE_BONUS_0 = 13,
+	RP_AGE_BONUS_1 = 9,
+	RP_AGE_BONUS_2 = 6,
+	RP_AGE_BONUS_3 = 4,
+	RP_AGE_BONUS_4 = 2,
+	RP_AGE_BONUS_5 = 1,
+	RP_AGE_T_CLAMP = 15,
+	RP_AGE_R_CLAMP = 8,
+	RP_AGE_S_CLAMP = 20,
+	RP_AGE_A_CLAMP = 12,
+	RP_MAX_AGE = 20,
+	RP_MAX_AGE_POINTS = 20,
+
+	RP_OTHER_STATUE = 6,
+	RP_OTHER_LA_MULT = 50,
+
+	RP_DAYS_T_CLAMP = 28,
+	RP_DAYS_R_CLAMP = 56,
+	RP_DAYS_S_CLAMP = 112,
+	RP_DAYS_A_CLAMP = 14,
+	RP_MAX_DAYS = 28,
+	RP_DAYS_BONUS_0 = 18,
+	RP_DAYS_BONUS_1 = 17,
+	RP_DAYS_BONUS_2 = 16,
+	RP_DAYS_BONUS_3 = 10,
+	RP_DAYS_BONUS_4 = 9,
+	RP_DAYS_BONUS_5 = 8,
+	RP_DAYS_BONUS_6 = 2,
+	RP_DAYS_BONUS_7 = 1,
+	RP_MAX_DAYS_POINTS = 112,
+
+	RP_WAIT_T_CLAMP = 1800,
+	RP_WAIT_R_CLAMP = 900,
+	RP_WAIT_S_CLAMP = 1500,
+	RP_WAIT_A_CLAMP = 1200,
+	RP_MAX_WAIT = 120,
+	RP_MAX_WAIT_POINTS = 30,
+	RP_WAIT_BONUS_0 = 10,
+	RP_WAIT_BONUS_1 = 7,
+	RP_WAIT_BONUS_2 = 5,
+	RP_WAIT_BONUS_3 = 3,
+	RP_WAIT_BONUS_4 = 2,
+	RP_WAIT_BONUS_5 = 1,
+
+	MAX_CARGO_WAITING = 0xFFF,
+};
+
+enum {
+	STS_NO_MONTHS_COUNTED = 0,
+	STS_AMOUNT_IN = 0,
+	STS_AMOUNT_OUT = 1,
+	STS_AMOUNT_TRANSFER = 2,
+	STS_VEH_TRAIN = 0,
+	STS_VEH_ROAD = 1,
+	STS_VEH_BUS = 2,
+	STS_VEH_TRUCK = 3,
+	STS_VEH_SHIP = 4,
+	STS_VEH_AIRCRAFT = 5,
+	STS_VEH_TYPES = 6,
+	STS_AMNT_TYPES = 3,
+	AVERAGE_MULTIPLIER = 10000, // controls how much digits behind comma are stored for average
+	STS_SHOW_MONTHLY_STATS = 0,
+	STS_SHOW_YEARLY_STATS = 1,
+	STS_SHOW_AVERAGE_STATS = 1,
+	STS_INIT_MINIMUM = 0xFFFF,
+};
+
+enum {
+	ST_VIEW_HEIGHT         = 122,
+	ST_VIEW_EXP_HEIGHT     = 222,
+};
+
+enum {
+	RATING_WAITING = 0,
+	RATING_SPEED = 1,
+	RATING_AGE = 2,
+	RATING_PICKUP = 3,
+	RATING_OTHER = 4,
+	RATING_TOTAL = 5,
+	NUM_RATINGS = 6,
+};
+
+typedef struct StationStats {
+	uint16 this_month;
+	uint16 last_month;
+	uint16 month_min;
+	uint16 month_max;
+	uint32 average;
+} StationStats;
+
 typedef struct GoodsEntry {
 	uint16 waiting_acceptance;
 	byte days_since_pickup;
@@ -17,7 +121,12 @@
 	byte enroute_time;
 	byte last_speed;
 	byte last_age;
+
+	StationStats cargo_amount[STS_AMNT_TYPES];
+	uint16 months_counted;
 	int32 feeder_profit;
+	int last_vehicle_type;
+	uint16 last_vehicle_speed;
 } GoodsEntry;
 
 typedef enum RoadStopType {
@@ -26,10 +135,14 @@
 } RoadStopType;
 
 enum {
-	INVALID_STATION = 0xFFFF,
-	INVALID_SLOT = 0xFFFF,
-	NUM_SLOTS = 2,
-	ROAD_STOP_LIMIT = 8,
+	INVALID_STATION     = 0xFFFF,
+	INVALID_STATION_OLD = 0xFF,
+	INVALID_SLOT        = 0xFFFF,
+	INVALID_AGE         = 0xFF,
+	INVALID_TIME        = 0xFF,
+	NUM_SLOTS           = 2,
+	ROAD_STOP_LIMIT     = 8,
+	RATING_START_VALUE  = 175,
 };
 
 typedef uint16 StationID;
@@ -46,6 +159,14 @@
 	struct RoadStop *prev;
 } RoadStop;
 
+typedef struct RatingStats {
+	uint16 last_speed;
+	byte last_age;
+	byte days_since_pickup;
+	uint16 waiting;
+	int16 ratings[NUM_RATINGS];
+} RatingStats;
+
 struct Station {
 	TileIndex xy;
 	RoadStop *bus_stops;
@@ -72,7 +193,7 @@
 
 	byte class_id; // custom graphics station class
 	byte stat_id; // custom graphics station id in the @class_id class
-	uint16 build_date;
+	uint32 build_date;
 
 	//uint16 airport_flags;
 	uint32 airport_flags;
@@ -80,7 +201,12 @@
 
 	VehicleID last_vehicle;
 	GoodsEntry goods[NUM_CARGO];
+	RatingStats rating_stats[NUM_CARGO];
 
+	StationStats vehicles[STS_VEH_TYPES];
+	uint16 veh_scheduled[STS_VEH_TYPES];
+	uint16 months_counted;
+
 	/* Stuff that is no longer used, but needed for conversion */
 	TileIndex bus_tile_obsolete;
 	TileIndex lorry_tile_obsolete;
@@ -123,11 +249,18 @@
 	CA_AIR_INTER = 8,
 };
 
-void ModifyStationRatingAround(TileIndex tile, byte owner, int amount, uint radius);
+void ModifyStationRatingAround(TileIndex tile, PlayerID owner, int amount, uint radius);
 
+void SearchVehiclesForStation(Station *st);
+void ShowStationStatsWindow(StationID station);
+void InitializeStationStats(Station *st);
+uint32 CalcNewAverage(uint32 average, uint32 lastamount, uint16 times_counted);
+void ShowPlayerVehicles(PlayerID player, StationID station, TypeMask type_mask, CargoMask cargo_mask, TileIndex xy);
+
 TileIndex GetStationTileForVehicle(const Vehicle *v, const Station *st);
 
-void ShowStationViewWindow(int station);
+void ShowStationViewWindow(StationID station);
+void ShowStationRatingDetail(StationID station);
 void UpdateAllStationVirtCoord(void);
 
 VARDEF SortStruct *_station_sort;
@@ -324,4 +457,6 @@
 	return (_m[tile].m5 - 0x43) & 3;
 }
 
+int32 ClickResetStationCheat(int32 cheat_activated, int32 NOT_USED);
+
 #endif /* STATION_H */
Index: network_client.c
===================================================================
--- network_client.c	(Revision 2953)
+++ network_client.c	(Arbeitskopie)
@@ -303,7 +303,7 @@
 		_network_lobby_company_count++;
 
 		NetworkRecv_string(MY_CLIENT, p, _network_player_info[current].company_name, sizeof(_network_player_info[current].company_name));
-		_network_player_info[current].inaugurated_year = NetworkRecv_uint8(MY_CLIENT, p);
+		_network_player_info[current].inaugurated_year = NetworkRecv_uint32(MY_CLIENT, p);
 		_network_player_info[current].company_value = NetworkRecv_uint64(MY_CLIENT, p);
 		_network_player_info[current].money = NetworkRecv_uint64(MY_CLIENT, p);
 		_network_player_info[current].income = NetworkRecv_uint64(MY_CLIENT, p);
Index: rail_gui.c
===================================================================
--- rail_gui.c	(Revision 2953)
+++ rail_gui.c	(Arbeitskopie)
@@ -26,7 +26,20 @@
 static byte _build_depot_direction;
 static byte _waypoint_count=1;
 static byte _cur_waypoint_type;
+static byte _cur_signal_type;
+static byte _cur_presig_type;
+static bool _cur_autosig_compl;
+ 
+static const StringID _presig_types_dropdown[] = {
+	STR_SIGNAL_NORMAL,
+	STR_SIGNAL_ENTRANCE,
+	STR_SIGNAL_EXIT,
+	STR_SIGNAL_COMBO,
+	STR_SIGNAL_PBS,
+	INVALID_STRING_ID
+};
 
+
 struct {
 	byte orientation;
 	byte numtracks;
@@ -39,6 +52,7 @@
 static void ShowBuildTrainDepotPicker(void);
 static void ShowBuildWaypointPicker(void);
 static void ShowStationBuilder(void);
+static void ShowSignalBuilder(void);
 
 typedef void OnButtonClick(Window *w);
 
@@ -174,8 +188,10 @@
 	if (trackstat != 0) {	while (!(trackstat & 1)) { i++; trackstat >>= 1; }}
 
 	if (!_remove_button_clicked) {
-		DoCommandP(tile, i + (_ctrl_pressed ? 8 : 0), 0, CcPlaySound1E,
-			CMD_BUILD_SIGNALS | CMD_AUTO | CMD_MSG(STR_1010_CAN_T_BUILD_SIGNALS_HERE));
+		DoCommandP(tile, i + (_ctrl_pressed ? 8 : 0) +
+		                 (!HASBIT(_cur_signal_type, 0) != !_ctrl_pressed ? 16 : 0) +
+		                 (_cur_presig_type << 5) ,
+		                 0, CcPlaySound1E, CMD_BUILD_SIGNALS | CMD_AUTO | CMD_MSG(STR_1010_CAN_T_BUILD_SIGNALS_HERE));
 	} else {
 		DoCommandP(tile, i, 0, CcPlaySound1E,
 			CMD_REMOVE_SIGNALS | CMD_AUTO | CMD_MSG(STR_1013_CAN_T_REMOVE_SIGNALS_FROM));
@@ -274,7 +290,8 @@
 
 static void BuildRailClick_AutoSignals(Window *w)
 {
-	HandlePlacePushButton(w, 13, ANIMCURSOR_BUILDSIGNALS, VHM_RECT, PlaceRail_AutoSignals);
+	if (HandlePlacePushButton(w, 13, ANIMCURSOR_BUILDSIGNALS, VHM_RECT, PlaceRail_AutoSignals))
+		ShowSignalBuilder();
 }
 
 static void BuildRailClick_Bridge(Window *w)
@@ -353,10 +370,17 @@
 	// _patches.drag_signals_density is given as a parameter such that each user in a network
 	// game can specify his/her own signal density
 	DoCommandP(TileVirtXY(thd->selstart.x, thd->selstart.y), TileVirtXY(thd->selend.x, thd->selend.y),
+/*
 	(_ctrl_pressed ? 1 << 3 : 0) | (trackstat << 4) | (_patches.drag_signals_density << 24),
 	CcPlaySound1E,
 	(_remove_button_clicked ?	CMD_REMOVE_SIGNAL_TRACK | CMD_AUTO | CMD_NO_WATER | CMD_MSG(STR_1013_CAN_T_REMOVE_SIGNALS_FROM) :
 	                          CMD_BUILD_SIGNAL_TRACK  | CMD_AUTO | CMD_NO_WATER | CMD_MSG(STR_1010_CAN_T_BUILD_SIGNALS_HERE) ) );
+*/
+		(!HASBIT(_cur_signal_type, 0) != !_ctrl_pressed ? 1 << 3 : 0) | (trackstat << 4) |
+		(_patches.drag_signals_density << 24) | (_cur_autosig_compl ? 2 : 0),
+		CcPlaySound1E,
+		(_remove_button_clicked ?	CMD_REMOVE_SIGNAL_TRACK | CMD_AUTO | CMD_NO_WATER | CMD_MSG(STR_1013_CAN_T_REMOVE_SIGNALS_FROM) :
+		                          CMD_BUILD_SIGNAL_TRACK  | CMD_AUTO | CMD_NO_WATER | CMD_MSG(STR_1010_CAN_T_BUILD_SIGNALS_HERE) ) );
 }
 
 static OnButtonClick * const _build_railroad_button_proc[] = {
@@ -442,6 +466,7 @@
 	}
 
 	case WE_PLACE_MOUSEUP:
+		_thd.height_follow = 0;
 		if (e->click.pt.x != -1) {
 			TileIndex start_tile = e->place.starttile;
 			TileIndex end_tile = e->place.tile;
@@ -476,6 +501,9 @@
 		if (w != NULL) WP(w,def_d).close=true;
 		w = FindWindowById(WC_BUILD_DEPOT, 0);
 		if (w != NULL) WP(w,def_d).close=true;
+		w = FindWindowById(WC_BUILD_SIGNALS, 0);
+		if (w != NULL) WP(w,def_d).close=true;
+
 		break;
 
 	case WE_PLACE_PRESIZE: {
@@ -893,11 +921,125 @@
 	w->hscroll.count = _waypoint_count + 1;
 }
 
+static void BuildSignalWndProc(Window *w, WindowEvent *e)
+{
+	switch(e->event) {
+	case WE_PAINT: {
+		/* XXX TODO: dont always hide the buttons when more than 2 signal types are available */
+		w->hidden_state = (1 << 3) | (1 << 6);
 
+		/* XXX TODO: take into account the scroll position for setting the click state */
+		w->click_state = ((1 << 4) << _cur_signal_type) | (_cur_autosig_compl ? 1 << 9 : 0);
+
+		SetDParam(10, _presig_types_dropdown[_cur_presig_type]);
+		DrawWindowWidgets(w);
+
+		// Draw the string for current signal type
+		DrawStringCentered(69, 49, STR_SIGNAL_TYPE_STANDARD + _cur_signal_type, 0);
+
+		// Draw the strings for drag density
+		DrawStringCentered(69, 60, STR_SIGNAL_DENSITY_DESC, 0);
+		SetDParam(0, _patches.drag_signals_density);
+		DrawString( 50, 71, STR_SIGNAL_DENSITY_TILES , 0);
+
+		// Draw the '<' and '>' characters for the decrease/increase buttons
+		DrawStringCentered(30, 72, STR_6819, 0);
+		DrawStringCentered(40, 72, STR_681A, 0);
+
+		break;
+		}
+	case WE_CLICK: {
+		switch(e->click.widget) {
+			case 3: case 6: // scroll signal types
+				/* XXX TODO: implement scrolling */
+				break;
+			case 4: case 5: // select signal type
+				/* XXX TODO: take into account the scroll position for changing selected type */
+				_cur_signal_type = e->click.widget - 4;
+				SndPlayFx(SND_15_BEEP);
+				SetWindowDirty(w);
+				break;
+			case 7: // decrease drag density
+				if (_patches.drag_signals_density > 1) {
+					_patches.drag_signals_density--;
+					SndPlayFx(SND_15_BEEP);
+					SetWindowDirty(w);
+				};
+				break;
+			case 8: // increase drag density
+				if (_patches.drag_signals_density < 20) {
+					_patches.drag_signals_density++;
+					SndPlayFx(SND_15_BEEP);
+					SetWindowDirty(w);
+				};
+				break;
+			case 9: // autosignal mode toggle button
+				_cur_autosig_compl ^= 1;
+				SndPlayFx(SND_15_BEEP);
+				SetWindowDirty(w);
+				break;
+			case 10: case 11: // presignal-type dropdown list
+				ShowDropDownMenu(w, _presig_types_dropdown, _cur_presig_type, 11, 0, 0);
+				break;
+		}
+		break;
+	case WE_DROPDOWN_SELECT: // change presignal type
+		_cur_presig_type = e->dropdown.index;
+		SetWindowDirty(w);
+		break;
+	}
+
+	case WE_MOUSELOOP:
+		if (WP(w,def_d).close)
+			DeleteWindow(w);
+		return;
+
+	case WE_DESTROY:
+		if (!WP(w,def_d).close)
+			ResetObjectToPlace();
+		break;
+	}
+}
+
+static const Widget _build_signal_widgets[] = {
+{   WWT_CLOSEBOX, RESIZE_NONE,    7,    0,   10,    0,   13, STR_00C5                 , STR_018B_CLOSE_WINDOW},
+{   WWT_CAPTION,  RESIZE_NONE,    7,   11,  139,    0,   13, STR_SIGNAL_SELECTION     , STR_018C_WINDOW_TITLE_DRAG_THIS},
+{   WWT_PANEL,    RESIZE_NONE,    7,    0,  139,   14,  114, 0x0                      , STR_NULL},
+{   WWT_PANEL,    RESIZE_NONE,    7,   22,   30,   29,   39, SPR_ARROW_LEFT           , STR_SIGNAL_TYPE_TIP},
+{   WWT_PANEL,    RESIZE_NONE,    7,   43,   64,   24,   45, 0x50B                    , STR_SIGNAL_TYPE_TIP},
+{   WWT_PANEL,    RESIZE_NONE,    7,   75,   96,   24,   45, SPR_SEMA                 , STR_SIGNAL_TYPE_TIP},
+{   WWT_PANEL,    RESIZE_NONE,    7,  109,  117,   29,   39, SPR_ARROW_RIGHT          , STR_SIGNAL_TYPE_TIP},
+{   WWT_IMGBTN,   RESIZE_NONE,    3,   25,   34,   72,   80, 0x0                      , STR_SIGNAL_DENSITY_TIP},
+{   WWT_IMGBTN,   RESIZE_NONE,    3,   35,   44,   72,   80, 0x0                      , STR_SIGNAL_DENSITY_TIP},
+{   WWT_TEXTBTN,  RESIZE_NONE,    7,   20,  119,   84,   95, STR_SIGNAL_COMPLETION    , STR_SIGNAL_COMPLETION_TIP},
+{   WWT_6,        RESIZE_NONE,    7,   10,  129,   99,  110, STR_SIGNAL_PRESIG_COMBO  , STR_SIGNAL_PRESIG_TIP},
+{   WWT_CLOSEBOX, RESIZE_NONE,    7,  118,  128,  100,  109, STR_0225                 , STR_SIGNAL_PRESIG_TIP},
+{   WIDGETS_END},
+};
+
+static const WindowDesc _build_signal_desc = {
+	-1,-1, 140, 115,
+	WC_BUILD_SIGNALS,WC_BUILD_TOOLBAR,
+	WDF_STD_TOOLTIPS | WDF_STD_BTN | WDF_DEF_WIDGET,
+	_build_signal_widgets,
+	BuildSignalWndProc
+};
+
+static void ShowSignalBuilder(void)
+{
+	_cur_presig_type = 0;
+	AllocateWindowDesc(&_build_signal_desc);
+}
+
+
+
 void InitializeRailGui(void)
 {
 	_build_depot_direction = 3;
 	_railstation.numtracks = 1;
 	_railstation.platlength = 1;
 	_railstation.dragdrop = true;
+	_cur_signal_type = 0;
+	_cur_presig_type = 0;
+	_cur_autosig_compl = false;
 }
Index: tile.c
===================================================================
--- tile.c	(Revision 2953)
+++ tile.c	(Arbeitskopie)
@@ -15,7 +15,90 @@
 	return GB(_m[tile].extra, 0, 2);
 }
 
+uint GetTileSlopeAtHeight(TileIndex tile, uint h)
+{
+	uint a;
+	uint b;
+	uint c;
+	uint d;
+	uint min;
+	uint r;
 
+	assert(tile < MapSize());
+
+	if (TileX(tile) == MapMaxX() || TileY(tile) == MapMaxY()) {
+		return 0;
+	}
+	
+	h /= 8;	
+	
+	min = a = max(TileHeight(tile), h);
+	b = max(TileHeight(tile + TileXY(1,0)), h);
+	if (min >= b) min = b;
+	c = max(TileHeight(tile + TileXY(0,1)), h);
+	if (min >= c) min = c;
+	d = max(TileHeight(tile + TileXY(1,1)), h);
+	if (min >= d) min = d;
+	
+	r = 0;
+	if ((a -= min) != 0) { r += (--a << 4) + 8; }
+	if ((c -= min) != 0) { r += (--c << 4) + 4; }
+	if ((d -= min) != 0) { r += (--d << 4) + 2; }
+	if ((b -= min) != 0) { r += (--b << 4) + 1; }
+
+	return r;
+}
+
+uint GetTileSlopeToHeight(uint h1, uint h2, uint dir)
+{
+	uint a;
+	uint b;
+	uint c;
+	uint d;
+	uint min;
+	uint r;
+	
+	h1 /= 8;
+	h2 /= 8;
+	
+	if (h1 >= h2)
+		return 0;
+	
+	if (dir == 0) {
+		min = a = h2;
+		b = h1;
+		c = h2;
+		d = h1;
+	} else if (dir == 1) {
+		min = a = h1;
+		b = h1;
+		c = h2;
+		d = h2;
+	} else if (dir == 2) {
+		min = a = h1;
+		b = h2;
+		c = h1;
+		d = h2;	
+	} else {
+		min = a = h2;
+		b = h2;
+		c = h1;
+		d = h1;	
+	}
+
+	if (min >= b) min = b;
+	if (min >= c) min = c;
+	if (min >= d) min = d;
+	
+	r = 0;
+	if ((a -= min) != 0) { r += (--a << 4) + 8; }
+	if ((c -= min) != 0) { r += (--c << 4) + 4; }
+	if ((d -= min) != 0) { r += (--d << 4) + 2; }
+	if ((b -= min) != 0) { r += (--b << 4) + 1; }
+
+	return r;
+}
+
 uint GetTileSlope(TileIndex tile, uint *h)
 {
 	uint a;
Index: tile.h
===================================================================
--- tile.h	(Revision 2953)
+++ tile.h	(Arbeitskopie)
@@ -48,6 +48,8 @@
 uint GetMapExtraBits(TileIndex tile);
 
 uint GetTileSlope(TileIndex tile, uint *h);
+uint GetTileSlopeAtHeight(TileIndex tile, uint h);
+uint GetTileSlopeToHeight(uint h1, uint h2, uint dir);
 uint GetTileZ(TileIndex tile);
 
 static inline bool CorrectZ(uint tileh)
Index: settings_gui.c
===================================================================
--- settings_gui.c	(Revision 2953)
+++ settings_gui.c	(Arbeitskopie)
@@ -15,6 +15,7 @@
 #include "engine.h"
 #include "screenshot.h"
 #include "newgrf.h"
+#include "economy.h"
 #include "network.h"
 #include "console.h"
 #include "town.h"
@@ -676,6 +677,7 @@
 	{PE_UINT8,	PF_0ISDIS | PF_PLAYERBASED, STR_CONFIG_PATCHES_SNAP_RADIUS, "window_snap_radius", &_patches.window_snap_radius,     1, 32,  1, NULL},
 	{PE_BOOL,		PF_PLAYERBASED, STR_CONFIG_PATCHES_INVISIBLE_TREES,	"invisible_trees", &_patches.invisible_trees,					0,  1,  1, &InvisibleTreesActive},
 	{PE_BOOL,		PF_PLAYERBASED, STR_CONFIG_PATCHES_POPULATION_IN_LABEL, "population_in_label", &_patches.population_in_label, 0, 1, 1, &PopulationInLabelActive},
+	{PE_BOOL,		PF_PLAYERBASED, STR_CONFIG_PATCHES_SHOW_TOWN_RATING_VALUES, "show_town_rating_value", &_patches.show_town_rating_value, 0, 1, 1, NULL},
 
 	{PE_INT32, 0, STR_CONFIG_PATCHES_MAP_X, "map_x", &_patches.map_x, 6, 11, 1, NULL},
 	{PE_INT32, 0, STR_CONFIG_PATCHES_MAP_Y, "map_y", &_patches.map_y, 6, 11, 1, NULL},
@@ -734,6 +736,12 @@
 	{PE_BOOL,		0, STR_CONFIG_PATCHES_SERVICEATHELIPAD, "service_at_helipad", &_patches.serviceathelipad,					0,  0,  0, NULL},
 	{PE_BOOL, 0, STR_CONFIG_PATCHES_CATCHMENT, "modified_catchment", &_patches.modified_catchment, 0, 0, 0, NULL},
 
+	{PE_BOOL,		0, STR_CONFIG_PATCHES_NSR_SPEED, "nsr_speed", &_patches.nsr_speed,					0,  0,  0, NULL},
+	{PE_BOOL,		0, STR_CONFIG_PATCHES_NSR_AGE, "nsr_age", &_patches.nsr_age,					0,  0,  0, NULL},
+	{PE_BOOL,		0, STR_CONFIG_PATCHES_NSR_TOWN_RATING, "nsr_town_rating", &_patches.nsr_town_rating,					0,  0,  0, NULL},
+	{PE_BOOL,		0, STR_CONFIG_PATCHES_NSR_WAIT_DAYS, "nsr_wait_days", &_patches.nsr_wait_days,					0,  0,  0, NULL},
+	{PE_BOOL,		0, STR_CONFIG_PATCHES_NSR_WAIT_CARGO, "nsr_wait_cargo", &_patches.nsr_wait_cargo,					0,  0,  0, NULL},
+
 };
 
 static const PatchEntry _patches_economy[] = {
@@ -750,6 +758,8 @@
 
 	{PE_BOOL,		0, STR_CONFIG_PATCHES_SMOOTH_ECONOMY,		"smooth_economy", &_patches.smooth_economy,						0,  0,  0, NULL},
 	{PE_BOOL,		0, STR_CONFIG_PATCHES_ALLOW_SHARES,			"allow_shares", &_patches.allow_shares,						0,  0,  0, NULL},
+	{PE_UINT8,		0, STR_CONFIG_PATCHES_DAY_LENGTH,			"day_length", &_patches.day_length,						1, 32, 1, NULL},
+
 };
 
 static const PatchEntry _patches_ai[] = {
@@ -761,6 +771,21 @@
 	{PE_BOOL,		0, STR_CONFIG_PATCHES_AI_BUILDS_SHIPS,"ai_disable_veh_ship",&_patches.ai_disable_veh_ship,			0,  0,  0, NULL},
 };
 
+static const PatchEntry _patches_cooperation[] = {
+	{PE_BOOL,			0, STR_CONFIG_PATCHES_SUBSIDIARIES,														"subsidiaries",										&_patches.subsidiaries,													0,  0,  0, NULL},
+	{PE_BOOL,			0, STR_CONFIG_PATCHES_SUBS_ALLOW_REMOVE,											"allow_track_removal",						&_patches.allow_track_removal,									0,	0,	0, NULL},
+	{PE_UINT8,		0, STR_CONFIG_PATCHES_SHARED_ST_TAX,													"shared_stations_tax",						&_patches.shared_stations_tax,  								0,100,  1, NULL},
+	{PE_CURRENCY,	0, STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_SUB_CONFIG,	"shared_tracks_sub_tax",					&_patches.shared_tracks_tax_subsidiary,  				0,100,	1, NULL},
+	{PE_CURRENCY,	0, STR_CONFIG_PATCHES_SHARED_STATIONS_SUBS_CARGOTAX,					"shared_stations_subs_cargotax",	&_patches.shared_stations_pickuptax_subsidiary,	0,100,  1, NULL},
+	{PE_BOOL,			0, STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_CONFIG,			"shared_tracks",									&_patches.shared_tracks,  											0,	0,  0, NULL},
+	{PE_CURRENCY,	0, STR_CONFIG_PATCHES_SUBSIDIARIES_SHARED_TRACKS_OTHER_CONFIG,"shared_tracks_other_tax",				&_patches.shared_tracks_tax_others,  						0,100,  1, NULL},
+	{PE_BOOL,			0, STR_CONFIG_PATCHES_SHARED_STATIONS,												"shared_stations",								&_patches.shared_stations,  										0,	0,  0, NULL},
+	{PE_UINT8,		0, STR_CONFIG_PATCHES_SHARED_ST_TAX_OTHERS,										"shared_stations_tax_others",			&_patches.shared_stations_tax_others,  					0,100,  1, NULL},
+	{PE_CURRENCY,	0, STR_CONFIG_PATCHES_SHARED_STATIONS_OTHERS_CARGOTAX,				"shared_stations_other_cargotax",	&_patches.shared_stations_pickuptax_others,  		0,100,  1, NULL},
+	{PE_UINT8,		0, STR_CONFIG_PATCHES_YEARS_OF_PROTECTION,										"years_of_protection",						&_patches.years_of_protection,  								0,100,  1, NULL},
+	{PE_BOOL,			0, STR_CONFIG_PATCHES_SHARED_DEPOTS,												"shared_depots",								&_patches.shared_depots,  										0,	0,  0, NULL},
+};
+
 typedef struct PatchPage {
 	const PatchEntry *entries;
 	uint num;
@@ -773,6 +798,7 @@
 	{_patches_stations,			lengthof(_patches_stations) },
 	{_patches_economy,			lengthof(_patches_economy) },
 	{_patches_ai,						lengthof(_patches_ai) },
+	{_patches_cooperation,			lengthof(_patches_cooperation)},
 };
 
 
@@ -994,7 +1020,7 @@
 
 			break;
 		}
-		case 4: case 5: case 6: case 7: case 8: case 9:
+		case 4: case 5: case 6: case 7: case 8: case 9: case 10:
 			WP(w,def_d).data_1 = e->click.widget - 4;
 			DeleteWindowById(WC_QUERY_STRING, 0);
 			SetWindowDirty(w);
@@ -1150,6 +1176,7 @@
 {   WWT_CLOSEBOX,   RESIZE_NONE,     3,   271,   357,    16,    27, STR_CONFIG_PATCHES_STATIONS,			STR_NULL},
 {   WWT_CLOSEBOX,   RESIZE_NONE,     3,    10,    96,    28,    39, STR_CONFIG_PATCHES_ECONOMY,			STR_NULL},
 {   WWT_CLOSEBOX,   RESIZE_NONE,     3,    97,   183,    28,    39, STR_CONFIG_PATCHES_AI,						STR_NULL},
+{   WWT_CLOSEBOX,   RESIZE_NONE,     3,   184,   270,    28,    39, STR_CONFIG_PATCHES_COOP,						STR_NULL},
 {   WIDGETS_END},
 };
 
Index: console_cmds.c
===================================================================
--- console_cmds.c	(Revision 2953)
+++ console_cmds.c	(Arbeitskopie)
@@ -1390,6 +1390,9 @@
 	IConsoleVarRegister("pause_on_join",         &_network_pause_on_join, ICONSOLE_VAR_BOOLEAN, "Set if the server should pause gameplay while a client is joining. This might help slow users");
 	IConsoleVarHookAdd("pause_on_join",          ICONSOLE_HOOK_ACCESS, ConHookServerOnly);
 
+	IConsoleVarRegister("pause_on_no_clients",   &_network_pause_on_no_clients, ICONSOLE_VAR_BOOLEAN, "Set if the server should pause gameplay when there are no clients connected.");
+	IConsoleVarHookAdd("pause_on_no_clients",    ICONSOLE_HOOK_ACCESS, ConHookServerOnly);
+
 	IConsoleVarRegister("autoclean_companies",   &_network_autoclean_companies, ICONSOLE_VAR_BOOLEAN, "Automatically shut down inactive companies to free them up for other players. Customize with 'autoclean_(un)protected'");
 	IConsoleVarHookAdd("autoclean_companies",    ICONSOLE_HOOK_ACCESS, ConHookServerOnly);
 
Index: network_server.c
===================================================================
--- network_server.c	(Revision 2953)
+++ network_server.c	(Arbeitskopie)
@@ -750,8 +750,9 @@
 			}
 		}
 
-		if (_network_pause_on_join) {
+		if (_network_pause_on_join && !(_network_pause_on_no_clients && _network_dedicated && _network_game_info.clients_on == 1)) {
 			/* Now pause the game till the client is in sync */
+			/* If pause on no clients is enabled and this is the first client, then it will already be paused */
 			DoCommandP(0, 1, 0, NULL, CMD_PAUSE);
 
 			NetworkServer_HandleChat(NETWORK_ACTION_CHAT, DESTTYPE_BROADCAST, 0, "Game paused (incoming client)", NETWORK_SERVER_INDEX);
@@ -957,7 +958,7 @@
 		/* Now he is! Unpause the game */
 		cs->status = STATUS_ACTIVE;
 
-		if (_network_pause_on_join) {
+		if (_network_pause_on_join || (_network_pause_on_no_clients && _network_dedicated && _network_game_info.clients_on == 1)) {
 			DoCommandP(0, 0, 0, NULL, CMD_PAUSE);
 			NetworkServer_HandleChat(NETWORK_ACTION_CHAT, DESTTYPE_BROADCAST, 0, "Game unpaused", NETWORK_SERVER_INDEX);
 		}
Index: town_gui.c
===================================================================
--- town_gui.c	(Revision 2953)
+++ town_gui.c	(Arbeitskopie)
@@ -136,7 +136,22 @@
 					(str++, r <= RATING_EXCELLENT) ||											// Excellent
 					(str++, true);														// Outstanding
 
-					SetDParam(4, str);
+					/*	WARNING ugly hack!
+							GetPlayerNameString sets up (Player #) if the player is human in an extra DPARAM16
+							It seems that if player is non-human, nothing is set up, so param is 0. GetString doesn't like
+							that because there is another param after it.
+							So we'll just shift the rating one back if player is AI and all is fine
+						*/
+					// H O O K: Show rating value instead of rating word
+					if(! _patches.show_town_rating_value) {
+					    SetDParam((IS_HUMAN_PLAYER(p->index) ? 4 : 3), str);
+					} else {
+					    // todo this without changing the lang file, we set the 
+					    // string to be a number and then set the number to be the value we want.
+					    SetDParam((IS_HUMAN_PLAYER(p->index) ? 4 : 3), STR_TOWN_RATING);
+					    SetDParam((IS_HUMAN_PLAYER(p->index) ? 5 : 4), str);
+					    SetDParam((IS_HUMAN_PLAYER(p->index) ? 6 : 5), r);
+					}
 					if (t->exclusivity == p->index) // red icon for player with exclusive rights
 						DrawSprite((SPR_BLOT) | PALETTE_TO_RED, 18, y);
 
Index: currency.h
===================================================================
--- currency.h	(Revision 2953)
+++ currency.h	(Arbeitskopie)
@@ -11,7 +11,7 @@
 typedef struct {
 	uint16 rate;
 	char separator;
-	uint16 to_euro;
+	uint32 to_euro;
 	char prefix[16];
 	char suffix[16];
 } CurrencySpec;
Index: window.c
===================================================================
--- window.c	(Revision 2953)
+++ window.c	(Arbeitskopie)
@@ -1183,7 +1183,7 @@
 {
 	Window *w;
 	ViewPort *vp;
-	int dx,dy, x, y, sub;
+//	int dx,dy, x, y, sub;
 
 	if (!_scrolling_viewport)
 		return true;
@@ -1208,52 +1208,9 @@
 		_cursor.delta.x = _cursor.delta.y = 0;
 		return false;
 	} else {
-		// scroll the smallmap ?
-		int hx;
-		int hy;
-		int hvx;
-		int hvy;
-
+		// scrolling the small map
 		_cursor.fix_at = true;
-
-		dx = _cursor.delta.x;
-		dy = _cursor.delta.y;
-
-		x = WP(w,smallmap_d).scroll_x;
-		y = WP(w,smallmap_d).scroll_y;
-
-		sub = WP(w,smallmap_d).subscroll + dx;
-
-		x -= (sub >> 2) << 4;
-		y += (sub >> 2) << 4;
-		sub &= 3;
-
-		x += (dy >> 1) << 4;
-		y += (dy >> 1) << 4;
-
-		if (dy & 1) {
-			x += 16;
-			sub += 2;
-			if (sub > 3) {
-				sub -= 4;
-				x -= 16;
-				y += 16;
-			}
-		}
-
-		hx = (w->widget[4].right  - w->widget[4].left) / 2;
-		hy = (w->widget[4].bottom - w->widget[4].top ) / 2;
-		hvx = hx * -4 + hy * 8;
-		hvy = hx *  4 + hy * 8;
-		if (x < -hvx) { x = -hvx; sub = 0; }
-		if (x > (int)MapMaxX() * 16 - hvx) { x = MapMaxX() * 16 - hvx; sub = 0; }
-		if (y < -hvy) { y = -hvy; sub = 0; }
-		if (y > (int)MapMaxY() * 16 - hvy) { y = MapMaxY() * 16 - hvy; sub = 0; }
-
-		WP(w,smallmap_d).scroll_x = x;
-		WP(w,smallmap_d).scroll_y = y;
-		WP(w,smallmap_d).subscroll = sub;
-
+		ScrollSmallmap(_cursor.delta.x, _cursor.delta.y);
 		_cursor.delta.x = _cursor.delta.y = 0;
 
 		SetWindowDirty(w);
Index: ship_gui.c
===================================================================
--- ship_gui.c	(Revision 2953)
+++ ship_gui.c	(Arbeitskopie)
@@ -16,6 +16,8 @@
 #include "command.h"
 #include "player.h"
 #include "engine.h"
+#include "economy.h"
+#include "network.h"
 #include "depot.h"
 #include "vehicle_gui.h"
 
@@ -51,7 +53,7 @@
 	/* Design date - Life length */
 	e = GetEngine(engine_number);
 	ConvertDayToYMD(&ymd, e->intro_date);
-	SetDParam(0, ymd.year + 1920);
+	SetDParam(0, ymd.year);
 	SetDParam(1, e->lifelength);
 	DrawString(x,y, STR_PURCHASE_INFO_DESIGNED_LIFE, 0);
 	y += 10;
@@ -62,7 +64,7 @@
 	y += 10;
 }
 
-static void DrawShipImage(const Vehicle *v, int x, int y, VehicleID selection)
+void DrawShipImage(const Vehicle *v, int x, int y, VehicleID selection)
 {
 	int image = GetShipImage(v, 6);
 	uint32 ormod = SPRITE_PALETTE(PLAYER_SPRITE_COLOR(v->owner));
@@ -207,7 +209,7 @@
 
 		DrawShipImage(v, 3, 57, INVALID_VEHICLE);
 
-		SetDParam(1, 1920 + v->build_year);
+		SetDParam(1, v->build_year);
 		SetDParam(0, GetCustomEngineName(v->engine_type));
 		SetDParam(2, v->value);
 		DrawString(74, 57, STR_9816_BUILT_VALUE, 0);
@@ -479,7 +481,7 @@
 				IsTileDepotType(v->tile, TRANSPORT_WATER))
 				disabled = 0;
 
-			if (v->owner != _local_player)
+			if (!IsSisterCompany(v->owner,_local_player))
 				disabled |= 1<<8 | 1<<7;
 			w->disabled_state = disabled;
 
@@ -633,9 +635,8 @@
 	tile = w->window_number;
 
 	/* setup disabled buttons */
-	w->disabled_state =
-		IsTileOwner(tile, _local_player) ? 0 : ((1 << 4) | (1 << 7));
-
+	w->disabled_state = (IsSisterCompany(GetTileOwner(tile),_local_player)) ? 0 : ((1<<4)|(1<<7));
+	
 	/* determine amount of items for scroller */
 	num = 0;
 	FOR_ALL_VEHICLES(v) {
@@ -856,6 +857,7 @@
 		case 4:
 			if (!HASBIT(w->disabled_state, 4) &&
 					WP(w,traindepot_d).sel != INVALID_VEHICLE)	{
+				byte backup = _current_player;
 				Vehicle *v;
 
 				HandleButtonClick(w, 4);
@@ -866,8 +868,10 @@
 				_backup_orders_tile = v->tile;
 				BackupVehicleOrders(v, _backup_orders_data);
 
+				_current_player = v->owner;
 				if (!DoCommandP(v->tile, v->index, 0, NULL, CMD_SELL_SHIP | CMD_MSG(STR_980C_CAN_T_SELL_SHIP)))
 					_backup_orders_tile = 0;
+				_current_player = backup;
 			}
 			break;
 		default:
@@ -1001,9 +1005,19 @@
 		int max;
 		int i;
 
-		BuildVehicleList(vl, VEH_Ship, owner, station);
+		BuildVehicleListMasked(vl, &w->listopt, owner);
 		SortVehicleList(vl);
 
+		if (_local_player != owner){
+			if(IsWindowOfPrototype(w,_player_ships_widgets)){
+				w->disabled_state |= (1<<10);
+			}else{
+				w->disabled_state |= (1<<9);
+			}
+		}else{
+			w->disabled_state &= ~(1<<9);
+		}
+
 		SetVScrollCount(w, vl->list_length);
 
 		// disable 'Sort By' tooltip on Unsorted sorting criteria
@@ -1190,12 +1204,19 @@
 {
 	Window *w;
 
-	if ( player == _local_player) {
+	if ( IsSisterCompany(player,_local_player)) {
 		w = AllocateWindowDescFront(&_player_ships_desc, (station << 16) | player);
 	} else  {
 		w = AllocateWindowDescFront(&_other_player_ships_desc, (station << 16) | player);
 	}
 	if (w) {
+		w->listopt.cargo_mask = CARGO_MASK_ALL;
+		w->listopt.type_mask = 1 << VEH_Ship;
+		if (station != INVALID_STATION)
+			w->listopt.xy = GetStation(station)->xy;
+		else
+			w->listopt.xy = INVALID_TILE;
+
 		w->caption_color = w->window_number;
 		w->vscroll.cap = 4;
 		w->widget[7].unkA = (w->vscroll.cap << 8) + 1;
Index: hal.h
===================================================================
--- hal.h	(Revision 2953)
+++ hal.h	(Arbeitskopie)
@@ -62,6 +62,9 @@
 	FIOS_TYPE_OLDFILE = 4,
 	FIOS_TYPE_SCENARIO = 5,
 	FIOS_TYPE_OLD_SCENARIO = 6,
+#ifdef WITH_PNG
+	FIOS_TYPE_PNG = 7,
+#endif //WITH_PNG
 };
 
 
@@ -79,6 +82,12 @@
 FiosItem *FiosGetSavegameList(int *num, int mode);
 // Get a list of scenarios
 FiosItem *FiosGetScenarioList(int *num, int mode);
+
+#ifdef WITH_PNG
+// Get a list of PNGs
+FiosItem *FiosGetPNGList(int *num, int mode);
+#endif //WITH_PNG
+
 // Free the list of savegames
 void FiosFreeSavegameList(void);
 // Browse to. Returns a filename w/path if we reached a file.
Index: window.h
===================================================================
--- window.h	(Revision 2953)
+++ window.h	(Arbeitskopie)
@@ -37,6 +37,40 @@
    That was all.. good luck, and enjoy :) -- TrueLight */
 
 enum {
+	SUBTYPE_AIRCRAFT = 2,
+	SUBTYPE_NONE     = 0,
+	CARGO_MASK_ALL   = 0xFFFFFFFFFFFFFFFFll,
+	VEHICLE_TYPE_ALL = 0xF0000,
+};
+
+/** Options for building vehicle-lists
+  * stored in the window-struct and used in BuildVehicleList()
+  * 
+  * xy:         xy-value of the station/waypoint/depot the vehicle should be scheduled for
+  *             use INVALID_STATION if you dont want vehicles scheduled for a specific destination
+  * cargo_mask: 64-bit mask using global cargo ids
+  *             determines which vehicles should be selected by cargo-type
+  *             use CARGO_MASK_ALL if you dont want to distinguish by cargo-type
+  * type_mask:  32-bit mask that controls varios parts of the list
+  *             currently implemented:
+  *             Vehicle type: uses bits 16 to 19 (VEH_Train = 16, VEH_Aircraft = 19)
+  *                           to determine which vehicletypes should be selected
+  *                           use VEHICLE_TYPE_ALL if you dont want to distinguish by vehicletype
+  *             also used for statistics-windows to store whether to show monthly, yearly or average statistics
+  *
+  *             planned:
+  *             vehicle-age: select only yehicles older/newer/at given age
+  *             more specific vehicle type: e.g. select a specific Train-Engine to be shown only
+  *             flags: should age be same/higher/lower as given value?
+  *                    include or exclude given vehicle?
+  */
+typedef struct DisplayListOptions {
+	TileIndex xy;
+	CargoMask cargo_mask;
+	TypeMask type_mask;
+} DisplayListOption;
+
+enum {
 	RESIZE_NONE   = 0,
 
 	RESIZE_LEFT   = 1,
@@ -307,6 +341,8 @@
 
 	Message message;
 	byte custom[WINDOW_CUSTOM_SIZE];
+	
+	DisplayListOption listopt; // Options for displaying vehicle-lists
 };
 
 typedef struct {
Index: command.c
===================================================================
--- command.c	(Revision 2953)
+++ command.c	(Arbeitskopie)
@@ -160,8 +160,14 @@
 DEF_COMMAND(CmdReplaceVehicle);
 
 DEF_COMMAND(CmdCloneVehicle);
+DEF_COMMAND(CmdResetStationCheat);
 
+DEF_COMMAND(CmdSubsidiaryGetMoney);
+DEF_COMMAND(CmdSubsidiarySendMoney);
+DEF_COMMAND(CmdSubsidiarySendMoneyOnRequest);
+DEF_COMMAND(CmdSubsidiaryBuyShareResponse);
 
+
 /* The master command table */
 static const Command _command_proc_table[] = {
 	{CmdBuildRailroadTrack,                  0}, /*   0 */
@@ -304,6 +310,13 @@
 	{CmdChangePatchSetting,         CMD_SERVER}, /* 114 */
 	{CmdReplaceVehicle,                      0}, /* 115 */
 	{CmdCloneVehicle,						 0}, /* 116 */
+
+	{CmdSubsidiarySendMoney,				 0}, /* 117 */
+	{CmdSubsidiaryGetMoney,				     0}, /* 118 */
+	{CmdSubsidiarySendMoneyOnRequest,	     0}, /* 119 */
+	{CmdSubsidiaryBuyShareResponse,	         0}, /* 120 */
+
+	{CmdResetStationCheat,                   0}, /* 121 */
 };
 
 /* This function range-checks a cmd, and checks if the cmd is not NULL */
Index: order_gui.c
===================================================================
--- order_gui.c	(Revision 2953)
+++ order_gui.c	(Arbeitskopie)
@@ -15,6 +15,7 @@
 #include "town.h"
 #include "command.h"
 #include "viewport.h"
+#include "economy.h"
 #include "depot.h"
 #include "waypoint.h"
 
@@ -59,7 +60,7 @@
 
 	v = GetVehicle(w->window_number);
 
-	w->disabled_state = (v->owner == _local_player) ? 0 : (
+	w->disabled_state = (IsSisterCompany(v->owner,_local_player)) ? 0 : (
 		1 << 4 |   //skip
 		1 << 5 |   //delete
 		1 << 6 |   //non-stop
@@ -196,7 +197,8 @@
 	if (_patches.gotodepot) {
 		switch (GetTileType(tile)) {
 		case MP_RAILWAY:
-			if (v->type == VEH_Train && IsTileOwner(tile, _local_player)) {
+			if (v->type == VEH_Train &&
+					(IsSisterCompany(GetTileOwner(tile), _local_player) || _patches.shared_depots)) {
 				if ((_m[tile].m5&0xFC)==0xC0) {
 					order.type = OT_GOTO_DEPOT;
 					order.flags = OF_PART_OF_ORDERS;
@@ -207,7 +209,8 @@
 			break;
 
 		case MP_STREET:
-			if ((_m[tile].m5 & 0xF0) == 0x20 && v->type == VEH_Road && IsTileOwner(tile, _local_player)) {
+			if ((_m[tile].m5 & 0xF0) == 0x20 && v->type == VEH_Road &&
+					(IsSisterCompany(GetTileOwner(tile), _local_player) || _patches.shared_depots)) {
 				order.type = OT_GOTO_DEPOT;
 				order.flags = OF_PART_OF_ORDERS;
 				order.station = GetDepotByTile(tile)->index;
@@ -217,7 +220,8 @@
 
 		case MP_STATION:
 			if (v->type != VEH_Aircraft) break;
-			if (IsAircraftHangarTile(tile) && IsTileOwner(tile, _local_player)) {
+			if (IsAircraftHangarTile(tile) &&
+					(IsSisterCompany(GetTileOwner(tile), _local_player) || _patches.shared_depots)) {
 				order.type = OT_GOTO_DEPOT;
 				order.flags = OF_PART_OF_ORDERS | OF_NON_STOP;	//XXX - whats the nonstop stuff doing here?
 				order.station = _m[tile].m2;
@@ -227,8 +231,9 @@
 
 		case MP_WATER:
 			if (v->type != VEH_Ship) break;
+
 			if (IsTileDepotType(tile, TRANSPORT_WATER) &&
-					IsTileOwner(tile, _local_player)) {
+					(IsSisterCompany(GetTileOwner(tile), _local_player) || _patches.shared_depots)) {
 				switch (_m[tile].m5) {
 					case 0x81: tile -= TileDiffXY(1, 0); break;
 					case 0x83: tile -= TileDiffXY(0, 1); break;
@@ -247,8 +252,8 @@
 	// check waypoint
 	if (IsTileType(tile, MP_RAILWAY) &&
 			v->type == VEH_Train &&
-			IsTileOwner(tile, _local_player) &&
-			(_m[tile].m5 & 0xFE) == 0xC4) {
+			(IsSisterCompany(GetTileOwner(tile), _local_player) || _patches.shared_stations) &&
+			(_m[tile].m5&0xFE)==0xC4) {
 		order.type = OT_GOTO_WAYPOINT;
 		order.flags = 0;
 		order.station = GetWaypointByTile(tile)->index;
@@ -258,7 +263,7 @@
 	if (IsTileType(tile, MP_STATION)) {
 		st = GetStation(st_index = _m[tile].m2);
 
-		if (st->owner == _current_player || st->owner == OWNER_NONE) {
+		if (IsSisterCompany(st->owner, _current_player) || _patches.shared_stations || st->owner == OWNER_NONE) {
 			byte facil;
 			(facil=FACIL_DOCK, v->type == VEH_Ship) ||
 			(facil=FACIL_TRAIN, v->type == VEH_Train) ||
@@ -610,7 +615,7 @@
 
 	_alloc_wnd_parent_num = veh;
 
-	if (v->owner != _local_player) {
+	if (!IsSisterCompany(v->owner, _local_player)) {
 		w = AllocateWindowDesc( &_other_orders_desc);
 	} else
 		w = AllocateWindowDesc( (v->type == VEH_Train) ? &_orders_train_desc : &_orders_desc);
Index: airport.c
===================================================================
--- airport.c	(Revision 2953)
+++ airport.c	(Arbeitskopie)
@@ -370,7 +370,12 @@
 
 	// 1980-1-1 is --> 21915
 	// 1990-1-1 is --> 25568
+/*
 	if (_date >= 21915) {SETBIT(bytemask, 3);}	// metropilitan airport 1980
 	if (_date >= 25568) {SETBIT(bytemask, 4);}	// international airport 1990
 	return bytemask;
+*/
+	if (_cur_year >= 1980) {SETBIT(bytemask, 3);}	// metropolitan airport 1980
+	if (_cur_year >= 1990) {SETBIT(bytemask, 4);}	// international airport 1990
+	return bytemask;
 }
Index: command.h
===================================================================
--- command.h	(Revision 2953)
+++ command.h	(Arbeitskopie)
@@ -136,9 +136,14 @@
 	CMD_CHANGE_PATCH_SETTING = 114,
 
 	CMD_REPLACE_VEHICLE = 115,
-
 	CMD_CLONE_VEHICLE = 116,
 
+	CMD_SUBSIDIARY_SEND_MONEY = 117,
+	CMD_SUBSIDIARY_GET_MONEY = 118,
+	CMD_SUBSIDIARY_SEND_MONEY_ON_REQUEST = 119,
+	CMD_SUBSIDIARY_BUY_SHARE_RESPONSE = 120,
+
+	CMD_RESET_STATION_CHEAT = 121,
 };
 
 enum {
Index: airport.h
===================================================================
--- airport.h	(Revision 2953)
+++ airport.h	(Arbeitskopie)
@@ -57,4 +57,5 @@
  */
 uint32 GetValidAirports(void);
 
+
 #endif /* AIRPORT_H */
